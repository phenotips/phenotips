<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>ClinicalInformationCode</web>
<name>ImageDisplayer</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>xwiki:XWiki.Admin</creator>
<author>xwiki:XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>xwiki:XWiki.Admin</contentAuthor>
<creationDate>1323918579000</creationDate>
<date>1324435385000</date>
<contentUpdateDate>1324435385000</contentUpdateDate>
<version>1.1</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.JavaScriptExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<disabled>0</disabled>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<disabled>0</disabled>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>ClinicalInformationCode.ImageDisplayer</name>
<number>0</number>
<className>XWiki.JavaScriptExtension</className>
<guid>92c4c790-a961-4909-a1e5-ec02c0cf2e85</guid>
<property>
<cache>long</cache>
</property>
<property>
<code>var XWiki = (function(XWiki) {
  /** Handles the gallery buttons directly in the current page without reloading the window. */
  XWiki.MultiImageSelector = Class.create({
     DEDUPLICATION_PREFIX : "IMAGE_SELECTOR",
    /**
     * Constructor.
     *
     * @param dialog the modal dialog where the gallery was loaded
     */
    initialize : function(dialog, reloadTargetId) {
      this.dialog = dialog;
      this.gallery = dialog.dialogBox;
      this.reloadTargetId = reloadTargetId;
      this.filterFormUpload();
      this.addDeleteListeners();
      this.addCloseListener();
    },
    /**
     * Catches the upload form submission and stops it if the selected file is not of the accepted types (or not selected at all),
     * and saves the underlying form (if any) so that any unsaved changes won't be lost.
     */
    filterFormUpload : function() {
      this.form = this.gallery.down('form');
      if (typeof (XWiki.FileUploader) != 'undefined') {
        // -------------------------------------------------------
        // HTML5 ajax file uploader is available, use it
        // -------------------------------------------------------
        // Make sure unsaved selections are not lost 
        this.gallery.select('.attachment-item input[type=checkbox]').each(function(item) {
          var twin = $(item.id.substring(XWiki.MultiImageSelector.prototype.DEDUPLICATION_PREFIX.length));
          if (twin) {item.checked = twin.checked;}
        });
        // Update the url that will provide the submission result
        var xredirect = this.form.down('input[type=hidden][name=xredirect]');
        var ajaxxredirect = this.form.down('input[type=hidden][name=ajaxxredirect]');
        if (xredirect &amp;&amp; ajaxxredirect) {
          xredirect.value = ajaxxredirect.value + "&amp;manage=true&amp;dprefix="+ this.DEDUPLICATION_PREFIX;;
          //ajaxxredirect.remove();
        }
        new XWiki.FileUploader(this.form, {enablePreview : false, enableFileInfo: false});
        this.form.observe('xwiki:ajaxupload:finish', function(event) {
           var responseContainer = this.gallery.down('.progress-info .upload-response');
           if (responseContainer) {
             var attachmentField = responseContainer.down('.attachment-item input[type=checkbox]');
             if (attachmentField) {
               // is this just another verson of another attachment that already exists?
               this.gallery.select('.attachment-list .attachment-item input[type=checkbox][value=' + attachmentField.value + ']').each(function (item) {
                 item.up('.attachment-item').remove();
               })
               var list = this.gallery.down('.attachment-list');
               // if the attachment list contained some "Empty list" message, make sure to remove it
               if (!list.down('.attachment-item')) {
                 list.update('');
               }
               // only update the gallery with valid attachment-item elements
               list.insert({top: responseContainer.innerHTML});
               responseContainer.update('');
               // delete listener for the new-comer
               var newItemAction = list.down('.attachment-item .action.delete')
               if (newItemAction) {
                 newItemAction.observe('click', this.onDelete.bindAsEventListener(this));
               }
             }
           }
        }.bindAsEventListener(this));
      } else {
        // -------------------------------------------------------
        // The browser does not support AJAX file upload. Do what you can...
        // -------------------------------------------------------
        new XWiki.widgets.Notification("This feature works better in more advanced browsers (Mozilla Firefox 4.0+, Google Chrome). Please consider upgrading.", 'info');
        // Hide checkboxes, they are of no use here
        this.gallery.select('.attachment-item input[type=checkbox]').invoke('setStyle', {'display' : 'none'});
        // Update the url that will provide the submission result
        var xredirect = this.form.down('input[type=hidden][name=xredirect]');
        if (xredirect) {
          xredirect.value = window.location.toString().replace(/#.*/g, "") + (this.reloadTargetId ? '#' + this.reloadTargetId : '');
        }
        // Setup the allowed extensions for each file input
        this.form.select('.upload-attachment input[type=file]').each(function(fileInput) {
          fileInput.__allowedExtensions = fileInput.title.toLowerCase().replace(/\s*[,|; ]\s*/g, " ").strip();
          if (fileInput.__allowedExtensions != '') {
            fileInput.__allowedExtensions = fileInput.__allowedExtensions.split(" ");
          } else {
            fileInput.__allowedExtensions = false;
          }
        });
        // On submit, check file extensions and make sure no data is lost
        this.form.observe('submit', function(event) {
          event.stop();
          var uploadForm = event.element();
          var hasErrors = false;
          uploadForm.select('input[type=file]').each(function(fileInput) {
            if (fileInput.value == '') {
              new XWiki.widgets.Notification("$msg.get('xe.attachmentSelector.upload.error.noFile')", 'error');
              hasErrors = true;
            } else if (fileInput.__allowedExtensions &amp;&amp; fileInput.__allowedExtensions.indexOf(this.getFileExtension(fileInput.value)) == -1) {
              new XWiki.widgets.Notification("$msg.get('xe.attachmentSelector.upload.error.badExtension')", 'error');
              hasErrors = true;
            }
          }.bind(this));
          // No form submission by AJAX right now, because file uploads can't be done this way without HTML5, this is future work
          // Save the document before submitting, since the current form data will be lost otherwise
          if (!hasErrors) {
            document.observe('xwiki:document:saved', function() {
              new XWiki.widgets.Notification("$msg.get('xe.attachmentSelector.upload.inProgress')", 'inprogress');
              uploadForm.submit();
            })
            document.fire('xwiki:actions:save', {'continue': true, form: $('edit') || $('inline')});
          }
        }.bindAsEventListener(this));
      }
    },
    getFileExtension : function(filename) {
      var fpath = filename.replace('\\', '/');
      var pieces = fpath.split('/');
      if (pieces.length == 0) {
        return null;
      }
      var basename = pieces[pieces.length-1];
      pieces = basename.split('.');
      return pieces[pieces.length-1].toLowerCase();
    },

    /** Catch attachment delete requests. */
    addDeleteListeners : function() {
      this.gallery.select('.action.delete').invoke('observe', 'click', this.onDelete.bindAsEventListener(this));
    },

    /** AJAX deletion of attachments. */
    onDelete : function(event) {
      event.stop();
      deleteTool = event.element();
      if (!deleteTool.disabled) {
        new XWiki.widgets.ConfirmedAjaxRequest(
          deleteTool.readAttribute('href'),
          {
            onCreate : function() { deleteTool.disabled = true },
            onSuccess : function() {
              var imgElt = deleteTool.up('.attachment-item');
              var list = imgElt.up('.attachment-list');
              if (imgElt) {
                imgElt.remove();
              }
              if (!list.down('.attachment-item')) {
                list.update(new Element('span', {'class' : 'hint'}).update('No photos available'));
              }
            }.bind(this),
            onComplete : function() {
              deleteTool.disabled = false;
            }
          },
          {
            confirmationText: "$msg.get('core.viewers.attachments.delete.confirm')",
            progressMessageText : "$msg.get('core.viewers.attachments.delete.inProgress')",
            successMessageText : "$msg.get('core.viewers.attachments.delete.done')",
            failureMessageText : "$msg.get('core.viewers.attachments.delete.failed')"
          }
        );
      }
    },

    addCloseListener : function () {
      var closeButton = $('attachment-picker-close');
      if (closeButton) {
        closeButton.observe('click', function(event) {
          event.stop();
          this.dialog.closeDialog();
        }.bindAsEventListener(this));
      }
    }
  });

  var loading = new Element('div', {'class' : 'imgcenter'}).update("&lt;img src=\"$xwiki.getSkinFile('icons/xwiki/ajax-loader-large.gif')\"/&gt;");
  var dialog;

  /* Hook onto the picker buttons so that the gallery is loaded via AJAX in a modal dialog. */
  document.observe('xwiki:dom:loaded', function() {
    $$('.manage-images-button').invoke('observe', 'click', function(event) {
      event.stop();
      var targetElement = event.element();
      var reloadTargetId = targetElement.up('*[id]');
      if (reloadTargetId) {
        reloadTargetId = reloadTargetId.id;
      }
      var url = targetElement.href;
      if (url.indexOf('?') &lt; 0) {
        url += '?';
      }
      url += "&amp;xpage=plain&amp;dprefix="+ XWiki.MultiImageSelector.prototype.DEDUPLICATION_PREFIX;
      dialog = new MS.widgets.ModalPopup(
        loading, {}, {
          'verticalPosition' : 'top',
          'removeOnClose' : true,
          'title' : targetElement.innerHTML,
           onClose : function() {
             var newList = new Element('div', {'class' : 'attachment-list'});
             this.dialogBox.select('.attachment-item').each(function(item) {
                var label = item.down('label');
                var input = label.down('input');
                var image = item.down('.attachment-preview img');
                var id = input.id.substring(XWiki.MultiImageSelector.prototype.DEDUPLICATION_PREFIX.length);
                var lItem = new Element('div', {'class' : 'attachment-item'});
                lItem.insert({
                  'top' : new Element(
                     'label', {'for' : id, 'title' : input.value}
                   ).update(input.value).insert({top : new Element('input', {
                     'type' : 'checkbox',
                     'checked' : input.checked,
                     'id' : id,
                     'name' : input.name.substring(XWiki.MultiImageSelector.prototype.DEDUPLICATION_PREFIX.length),
                     'value' : input.value
                   }),
                  'bottom': new Element ('div', {'class' : 'attachment-preview'}).update(image)})
                });
                newList.insert({bottom: lItem});
             });
             // is there at least one 
             if (!newList.down('.attachment-item')) {
               newList.update(this.dialogBox.down('.attachment-list').innerHTML);
             }
             targetElement.up('.actions').next('.attachment-list').replace(newList);
           }
        }
      );
      dialog.shortcuts.close.keys = [];
      dialog.showDialog();
      if (window.browser.isIE6x) {
        dialog.dialog.down().setStyle({position: "absolute"});
      } else {
        dialog.dialog.down().setStyle({position: "fixed"});
      }
      //dialog.dialog.setStyle({top: document.viewport.getScrollOffsets().top + "px", position: "absolute"});
      //dialog.dialogBox.setStyle({overflow: "hidden"});
      new Ajax.Updater(loading.up(), url, {
        onComplete : function() {
          // Play nice with the Lightbox widget
          if (window.gallery_lb) {
            window.gallery_lb.updateImageList();
          }
          // Manually convert the special rel values into target attributes for the newly inserted content (rel="_something" =&gt; target="something")
          if (typeof (XWiki.fixLinksTargetAttribute) == 'function') {
            // Trick the function into updating link targets in inline mode; normally the conversion only takes place in view mode
            var __tmp = XWiki.contextaction;
            XWiki.contextaction = 'view';
            XWiki.fixLinksTargetAttribute(dialog.dialog);
            XWiki.contextaction = __tmp;
          }
          new XWiki.MultiImageSelector(dialog, reloadTargetId);
        }
      });
    });
  });
  return XWiki;
}(XWiki || {}));</code>
</property>
<property>
<name>Ajax photo management</name>
</property>
<property>
<parse>1</parse>
</property>
<property>
<use>currentPage</use>
</property>
</object>
<object>
<class>
<name>XWiki.JavaScriptExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<disabled>0</disabled>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<disabled>0</disabled>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>ClinicalInformationCode.ImageDisplayer</name>
<number>1</number>
<className>XWiki.JavaScriptExtension</className>
<guid>71632e63-756b-45e6-94bc-6b81867954b3</guid>
<property>
<cache>long</cache>
</property>
<property>
<code>var XWiki = (function(XWiki) {
  if (typeof (FileReader) == 'undefined' || typeof (FormData) == 'undefined') {return XWiki;}
  XWiki.FileUploader = Class.create({
    options : {
      maxFilesize : 5*1048576, // 5MB
      fileFilter  : /^(image\/gif|image\/jpeg|image\/png|image\/tiff)$/i,
      enablePreview : true,
      enableFileInfo : true,
      enableProgressInfo : true,
    },
    PROGRESS_BAR_FULL_WIDTH_PERCENTAGE: 0.92,

    initialize : function(form, options) {
      this.options = Object.extend(Object.clone(this.options), options || { });

      // initialize upload variables
      this.resetUploadData();

      // attach listeners
      this.form = form;
      this.form.select('input[type=file]').invoke('observe', 'change', this.fileSelected.bindAsEventListener(this));
      this.form.observe('submit', this.startUploading.bindAsEventListener(this));

      //initialize messages
      this.initFeedbackMessages();
    },

    resetUploadData : function () {
      this.fileIsValid = false;
      this.bytesUploaded = 0;
      this.bytesTotal = 0;
      this.previousBytesLoaded = 0;
      this.timer = 0;
      this.resultFileSize = '';
    },

    initFeedbackMessages : function() {
      var _getElt = function (cssClass, content) {
        return new Element('div', {'class' : cssClass}).update(content ? content : '');
      };

      if (this.options.enablePreview || this.options.enableFileInfo) {
        this.PREVIEW = new Element('img', {'class' : 'preview'});
        this.form.insert({bottom : this.PREVIEW});
        if (!this.options.enablePreview) {
          this.PREVIEW.style.display = 'none';
        }
      }

      if (this.options.enableFileInfo) {
        this.FILE_INFO = _getElt('file-info');
        this.FILE_NAME = _getElt('file-name');
        this.FILE_SIZE = _getElt('file-size');
        this.FILE_TYPE = _getElt('file-type');
        this.FILE_DIM  = _getElt('file-dim');

        this.FILE_INFO.insert({
               top: this.FILE_NAME,
               bottom: this.FILE_SIZE
             }).insert({
               bottom: this.FILE_TYPE
             }).insert({
               bottom: this.FILE_DIM
             });

        this.FILE_INFO.style.display = 'none';
        this.form.insert({bottom : this.FILE_INFO});
      }

      if (this.options.enableProgressInfo) {
        this.PROGRESS_INFO       = _getElt('progress-info');
        this.PROGRESS            = _getElt('progress');
        this.PROGRESS_PERCENTAGE = _getElt('progress-percentage', '&amp;nbsp;');
        this.PROGRESS_SPEED      = _getElt('progress-speed', '&amp;nbsp;');
        this.PROGRESS_REMAINING  = _getElt('progress-remaining', '&amp;nbsp;');
        this.PROGRESS_TRANSFERED = _getElt('progress-transfered', '&amp;nbsp;');
        this.UPLOAD_RESPONSE     = _getElt('upload-response');

        this.PROGRESS_INFO.insert({
             top: this.PROGRESS,
             bottom: this.PROGRESS_PERCENTAGE
           }).insert({
             bottom: new Element('div', {'class' : 'clear'})
           }).insert({
             bottom: new Element('div').insert({
                                       top: this.PROGRESS_SPEED,
                                       bottom: this.PROGRESS_REMAINING
                                     }).insert({
                                       bottom: this.PROGRESS_TRANSFERED
                                     }).insert({
                                       bottom: new Element('div', {'class' : 'clear'})
                                     })
           }).insert({
             bottom: this.UPLOAD_RESPONSE
           });

        this.PROGRESS_HIDE = _getElt('progress-hide', 'hide');
        this.PROGRESS_INFO.insert({bottom: this.PROGRESS_HIDE}).insert({bottom: new Element('div', {'class' : 'clear'})});
        this.PROGRESS_HIDE.observe('click', function (event) {
          this.PROGRESS_HIDE.style.display = 'none';
          this.PROGRESS_INFO.style.display = 'none';
        }.bindAsEventListener(this));

        this.PROGRESS_HIDE.style.display = 'none';
        this.PROGRESS_INFO.style.display = 'none';
        this.form.insert({bottom : this.PROGRESS_INFO});
      }

      this.MESSAGE_CONTAINER      = _getElt('');
      this.INVALID_FILE_MESSAGE   = _getElt('errormessage', 'The selected file is not acceptable. Please select only image files');
      this.UNKNOWN_ERROR_MESSAGE  = _getElt('errormessage', 'An error occurred while uploading the file');
      this.UPLOAD_ABORTED_MESSAGE = _getElt('errormessage' , 'The upload has been canceled by the user or the browser dropped the connection');
      this.UPLOAD_SIZE_MESSAGE    = _getElt('errormessage' , 'The selected file is too large. Please choose files under ' + this.bytesToSize(this.options.maxFilesize));
     
      this.form.insert({top : this.MESSAGE_CONTAINER});
    },

    secondsToTime : function (secs) { // we will use this function to convert seconds in normal time format
      var hr = Math.floor(secs / 3600);
      var min = Math.floor((secs - (hr * 3600))/60);
      var sec = Math.floor(secs - (hr * 3600) -  (min * 60));

      if (hr &lt; 10) {hr = "0" + hr; }
      if (min &lt; 10) {min = "0" + min;}
      if (sec &lt; 10) {sec = "0" + sec;}
      if (hr) {hr = "00";}
      return hr + ':' + min + ':' + sec;
    },

    bytesToSize : function (bytes) {
      var sizes = ['Bytes', 'KB', 'MB'];
      if (bytes == 0) return 'n/a';
      var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    },

    fileSelected : function (event) {
      // hide different warnings
      this.MESSAGE_CONTAINER.update('');
      this.UPLOAD_RESPONSE.update('');

      // get selected file element
      var lFile = event.element().files[0];

      // filter files
      if (! this.options.fileFilter.test(lFile.type)) {
        this.MESSAGE_CONTAINER.update(this.INVALID_FILE_MESSAGE);
        this.fileIsValid = false;
        return;
      }

      // little test for filesize
      if (lFile.size &gt; this.options.maxFilesize) {
        this.MESSAGE_CONTAINER.update(this.UPLOAD_SIZE_MESSAGE);
        this.fileIsValid = false;
        return;
      }

      this.fileIsValid = true;

      // get preview element
      var imgPreview = this.PREVIEW;

      // prepare HTML5 FileReader
      var fileReader = new FileReader();
      fileReader.onload = function(e){
        if (imgPreview) {
          // e.target.result contains the DataURL which we will use as a source of the image
          imgPreview.src = e.target.result;
        }
        if (this.options.enableFileInfo) {
          imgPreview.onload = function () { // binding onload event
            // we are going to display some custom image information here
            this.resultFileSize = this.bytesToSize(lFile.size);
            this.FILE_NAME.update('Name: ' + lFile.name);
            this.FILE_SIZE.update('Size: ' + this.resultFileSize);
            this.FILE_TYPE.update('Type: ' + lFile.type);
            this.FILE_DIM.update('Dimension: ' + imgPreview.naturalWidth + ' x ' + imgPreview.naturalHeight);
            this.FILE_INFO.style.display = 'block';
          }.bindAsEventListener(this);
        }
      }.bindAsEventListener(this);

    // read selected file as DataURL
    fileReader.readAsDataURL(lFile);
  },

  startUploading : function (event) {
    event.stop();
    var fileExists = false;
    this.form.select('input[type=file]').each(function(item) {
      if (item.value != '') {
         fileExists = true;
      }
    });
    this.fileIsValid = this.fileIsValid &amp;&amp; fileExists;
    if (!this.fileIsValid) {return;}
    // cleanup all temp states
    this.MESSAGE_CONTAINER.update('');
    this.resetUploadData();

    if (this.options.enableProgressInfo) {
      this.UPLOAD_RESPONSE.update('');
      this.PROGRESS_INFO.style.display = 'block';
      this.PROGRESS.style.display = 'block';
      this.PROGRESS.style.width = '0px';
    }
    // get form data for POSTing
    //var vFD = this.form.getFormData(); // for FF3
    var vFD = new FormData(this.form); 

    // create XMLHttpRequest object, adding few event listeners, and POSTing our data
    var oXHR = new XMLHttpRequest();
    oXHR.upload.addEventListener('progress', this.uploadProgress.bindAsEventListener(this), false);
    oXHR.addEventListener('load', this.uploadFinish.bindAsEventListener(this), false);
    oXHR.addEventListener('error', this.uploadError.bindAsEventListener(this), false);
    oXHR.addEventListener('abort', this.uploadAbort.bindAsEventListener(this), false);
    oXHR.open('POST', this.form.action);
    oXHR.send(vFD);

    // set inner timer
    this.timer = setInterval(this.doInnerUpdates.bind(this), 30);
  },

  doInnerUpdates : function () { // we will use this function to display upload speed
    if (this.options.enableProgressInfo) {
      var iCB = this.bytesUploaded;
      var iDiff = iCB - this.previousBytesLoaded;

      // if nothing new loaded - exit
      if (iDiff == 0)
        return;

      this.previousBytesLoaded = iCB;
      iDiff = iDiff * 2;
      var iBytesRem = this.bytesTotal - this.previousBytesLoaded;
      var secondsRemaining = iBytesRem / iDiff;

      // update speed info
      var iSpeed = iDiff.toString() + 'B/s';
      if (iDiff &gt; 1024 * 1024) {
        iSpeed = (Math.round(iDiff * 100/(1024*1024))/100).toString() + 'MB/s';
      } else if (iDiff &gt; 1024) {
        iSpeed =  (Math.round(iDiff * 100/1024)/100).toString() + 'KB/s';
      }
      this.PROGRESS_SPEED.update(iSpeed);
      this.PROGRESS_REMAINING.update('| ' + this.secondsToTime(secondsRemaining));
    }
  },

  uploadProgress : function(e) { // upload process in progress
    if (this.options.enableProgressInfo) {
      if (e.lengthComputable) {
        this.bytesUploaded = e.loaded;
        this.bytesTotal = e.total;
        var iPercentComplete = Math.round(e.loaded * 100 / e.total);
        var iBytesTransfered = this.bytesToSize(this.bytesUploaded);

        this.PROGRESS_PERCENTAGE.update(iPercentComplete.toString() + '%');
        this.PROGRESS.style.width = (iPercentComplete * this.PROGRESS_BAR_FULL_WIDTH_PERCENTAGE).toString() + '%';
        this.PROGRESS_TRANSFERED.update(iBytesTransfered);
        if (iPercentComplete == 100) {
          this.UPLOAD_RESPONSE.update('Processing...');
          this.UPLOAD_RESPONSE.style.display = 'block';
        }
      } else {
        this.PROGRESS.update('unable to compute');
      }
    }
  },

  uploadFinish : function(e) { // upload successfully finished
    if (this.options.enableProgressInfo) {
      this.UPLOAD_RESPONSE.update(e.target.responseText);
      this.UPLOAD_RESPONSE.style.display = 'block';

      this.PROGRESS_PERCENTAGE.update('100%');
      this.PROGRESS.style.width = (this.PROGRESS_BAR_FULL_WIDTH_PERCENTAGE * 100) + "%";
      if (this.options.enableFileInfo) {
        this.FILE_SIZE.update(this.resultFileSize);
      }
      this.PROGRESS_REMAINING.update('| 00:00:00');
      this.PROGRESS_HIDE.style.display = '';
    }
    clearInterval(this.timer);

    this.form.fire('xwiki:ajaxupload:finish');
  },

  uploadError : function(e) { // upload error
    this.uploadAbnormalFinish(this.UNKNOWN_ERROR_MESSAGE);
  }, 

  uploadAbort : function(e) { // upload abort
    this.uploadAbnormalFinish(this.UPLOAD_ABORTED_MESSAGE);
  },

  uploadAbnormalFinish : function (message) {
    this.MESSAGE_CONTAINER.update(message);
    if (this.options.enableProgressInfo) {
      this.PROGRESS_HIDE.style.display = '';
    }
    clearInterval(this.timer);
  }
  });
  return XWiki;
}(XWiki || {}));</code>
</property>
<property>
<name>HTML5 file upload</name>
</property>
<property>
<parse></parse>
</property>
<property>
<use>currentPage</use>
</property>
</object>
<object>
<class>
<name>XWiki.StyleSheetExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<disabled>0</disabled>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<disabled>0</disabled>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>ClinicalInformationCode.ImageDisplayer</name>
<number>0</number>
<className>XWiki.StyleSheetExtension</className>
<guid>138649f5-23c9-4416-884f-37b72d3b2309</guid>
<property>
<cache>forbid</cache>
</property>
<property>
<code>#template('colorThemeInit.vm')
.editbody .image-gallery {
  background-color: $theme.backgroundSecondaryColor;
  padding: 0.5em 1em;
}
.image-gallery {
  margin: 0.5em 1em .5em 0;
  position: relative;
}
.image-gallery .caption {
  font-variant: small-caps;
  font-weight: bold;
  text-transform: lowercase;
}
.image-gallery .actions {
    ## float: right;
    position: absolute;
    right: 0;
    top: 0.25em;
}
.image-gallery .attachment-list {
}
.image-gallery .attachment-list label.selected {
  background-color: transparent; ##$theme.pageContentBackgroundColor; ##$theme.highlightColor;
  margin: 0;
  padding: 0 5px;
  font-weight: normal;
}
.image-gallery .xGallery {
}
.attachment-item {
  position: relative;
  width: 110px;
  float: left;
  margin: .5em;
  overflow: hidden;
  -moz-border-radius: 4px;
  -webkit-border-radius: 4px;
  border-radius: 4px;
  -moz-box-shadow: 0 0 4px #aaa;
  -webkit-box-shadow: 0 0 4px #aaa;
  box-shadow: 0 0 4px #aaa;
}
.attachment-item:hover {
  background-color: $theme.pageContentBackgroundColor; ##$theme.highlightColor
}
.attachment-item label {
    font-size: 0.9em;
    overflow: hidden;
    white-space: nowrap;
    padding: 0 5px;
}
.attachment-item label input{
    margin-left: 0px;
}
.attachment-item .action {
    background-position: center center;
    display: none;
    height: 18px;
    position: absolute;
    right: 0;
    top: -0.25em;
    width: 18px;
}
.attachment-item:hover .action {
  display: inline-block;
}
.attachment-item .attachment-preview {
  padding: 5px;
  text-align: center;
  width: 100px;
  height: 60px;
}
.attachment-item .attachment-preview img{
  max-width: 100px;
  max-height: 60px;
  width: auto;
}
.xdialog-modal-container, .xnotification-container {
  z-index: 100015 !important;
}</code>
</property>
<property>
<name>Image selector ui</name>
</property>
<property>
<parse>1</parse>
</property>
<property>
<use>onDemand</use>
</property>
</object>
<object>
<class>
<name>XWiki.StyleSheetExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<disabled>0</disabled>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<disabled>0</disabled>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>ClinicalInformationCode.ImageDisplayer</name>
<number>1</number>
<className>XWiki.StyleSheetExtension</className>
<guid>a716b014-bd8a-43c3-b18c-38f84a651e81</guid>
<property>
<cache>long</cache>
</property>
<property>
<code>.preview {
  max-width: 400px;
}
.file-info {
    font-style: italic;
    display:none;
    margin: .5em 0;
    opacity: .5;
}

.progress-info, .file-info {
    font-size: .9em;
}
.progress-info .progress-hide {
    font-style: italic;
    opacity: .5;
    cursor: pointer;
    float: right;
}
.progress-info .progress-speed, .progress-info .progress-remaining {
    opacity: .5;
    float:left;
    width:100px;
}
.progress-info .progress-transfered {
    opacity: .5;
    float:right;
    text-align:right;
}
.progress-info .progress-percentage {
    opacity: .5;
    float:right;
}
.progress-info .progress {
    border:1px solid #ccc;
    display:none;
    float:left;
    height:14px;

    border-radius:10px;
    -moz-border-radius:10px;
    -ms-border-radius:10px;
    -o-border-radius:10px;
    -webkit-border-radius:10px;

    background: -moz-linear-gradient(#66cc00, #4b9500);
    background: -ms-linear-gradient(#66cc00, #4b9500);
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #66cc00), color-stop(100%, #4b9500));
    background: -webkit-linear-gradient(#66cc00, #4b9500);
    background: -o-linear-gradient(#66cc00, #4b9500);
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#66cc00', endColorstr='#4b9500');
    -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr='#66cc00', endColorstr='#4b9500')";
    background: linear-gradient(#66cc00, #4b9500);
}
.progress-info /*.upload-response*/ {
    margin-top: .5em;
    padding: 10px;
    overflow: hidden;
    display: none;
    border: 1px solid #ccc;

    border-radius:10px;
    -moz-border-radius:10px;
    -ms-border-radius:10px;
    -o-border-radius:10px;
    -webkit-border-radius:10px;

    box-shadow: 0 0 5px #ccc;
    background: -moz-linear-gradient(#bbb, #eee);
    background: -ms-linear-gradient(#bbb, #eee);
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #bbb), color-stop(100%, #eee));
    background: -webkit-linear-gradient(#bbb, #eee);
    background: -o-linear-gradient(#bbb, #eee);
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#bbb', endColorstr='#eee');
    -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr='#bbb', endColorstr='#eee')";
    background: linear-gradient(#bbb, #eee);
}*/</code>
</property>
<property>
<name>HTML5 file upload UI</name>
</property>
<property>
<parse></parse>
</property>
<property>
<use>currentPage</use>
</property>
</object>
<content>{{velocity output=false}}
#set ($displayerName = 'ClinicalInformationCode.ImageDisplayer')
#set ($displayer = $xwiki.getDocument($displayerName))
#set($options = {
  'fieldName' : "",
  'filter' : ['png', 'jpg', 'gif'],
  'manage' : false
})

#set($options.mode = "$!{context.action}")

#if ("$!{name}" != '' &amp;&amp; "$!{prefix}" != '' &amp;&amp; "$!{value}" != '' &amp;&amp; "$!{object}" != '')
  ## In displayer mode
  #set ($targetDoc = $doc)
  #set ($property = "$!{name}")
  #set ($propValue = $value)
  #set ($fieldName = "$!{prefix}$!{name}")
#elseif ("$!{request.doc}" != '' &amp;&amp; "$!{request.classname}" != '' &amp;&amp; "$!{request.object}" != '' &amp;&amp; "$!{request.property}" != '')
  ## In external mode
  #set ($targetDoc = $xwiki.getDocument("$!{request.doc}"))
  #set ($property = "$!{request.property}")
  #set ($object = $targetDoc.getObject("$!{request.classname}", $util.parseInt("$!{request.object}")))
  #set ($propValue = $object.getProperty("$!{request.property}").value)
  #if ("$!{propValue.size()}" == '')
    #set ($propValue = [])
  #end
  #set ($fieldName = "$!{request.dprefix}$!{request.classname}_$!{request.object}_$!{request.property}")
  #if ("$!{request.mode}" != '')
    #set($options.mode = "$!{request.mode}")
  #else
    #set($options.mode = "$!{context.action}")
  #end
  #if ("$!{request.manage}" != '')
    #set($options.manage = true)
  #end
#end

#set ($qString = "doc=$!escapetool.url($!{targetDoc.fullName})&amp;property=$!{property}&amp;classname=$!escapetool.url($!{object.xWikiClass.name})&amp;object=${object.number}")

#if ($options.filter &amp;&amp; $options.filter.size() &gt; 0)
  #foreach($item in $options.filter)
    #set($options.rawfilter = "$!{options.rawfilter}, ${item}")
  #end
  #if ($options.rawfilter)
    #set($options.rawfilter = $options.rawfilter.substring(2))
  #end
#end

#macro (__displaySelectableAttachment $attachment $targetDocument $selection)
  {{html wiki=true clean=false}}&lt;div class="attachment-item"&gt;
  &lt;label for='${fieldName}_${attachment.filename}' title='${attachment.filename}'&gt; 
  {{html wiki=false clean=false}}&lt;input id='${fieldName}_${attachment.filename}' type='checkbox' name='${fieldName}' value='${attachment.filename}'#if($selection.contains(${attachment.filename})) checked='checked'#{end}/&gt;{{/html}}${attachment.filename}&lt;/label&gt;##
  #if ($options.manage)
  &lt;a class='action delete' href="$targetDocument.getAttachmentURL(${attachment.filename}, 'delattachment', "form_token=$!{services.csrf.getToken()}&amp;xredirect=$!{escapetool.url($doc.getURL($context.action, $request.queryString))}")" title="Delete"&gt;Delete&lt;/a&gt;##
  #end
  (% class="attachment-preview" %)((([[image:${targetDoc.fullName}@${attachment.filename}||width="100" title="${attachment.filename}"]])))##
  &lt;/div&gt;{{/html}}##
#end

#macro (__displaySelectableAttachmentList $targetDocument $selection)
  {{html wiki=false clean=false}}&lt;input type='hidden' name='${fieldName}' value=''/&gt;{{/html}}##
  (% class="attachment-list" %)(((
  #set ($sortedAttachments = $sorttool.sort($targetDocument.getAttachmentList(), 'date:desc') )
  #if ($sortedAttachments.size() == 0)(% class="hint" %)No photos available(%%)#end
  #foreach ($attachment in $sortedAttachments)
    #set ($extension = $attachment.getFilename())
    #set ($extension = $extension.substring($mathtool.add($extension.lastIndexOf('.'), 1)).toLowerCase())
    #if ($options.filter.size() == 0 || $options.filter.contains($extension))
      #__displaySelectableAttachment($attachment $targetDocument $selection)
    #end
  #end
  )))(% class="clear" %)((()))###
#end

#macro (__displayLastAttachmentSelected $targetDocument)
  #set ($sortedAttachments = $sorttool.sort($targetDocument.getAttachmentList(), 'date:desc') )
  #if ($sortedAttachments.size() &gt; 0)
    #set ($attachment = $sortedAttachments.get(0))
    #set ($extension = $attachment.getFilename())
    #set ($extension = $extension.substring($mathtool.add($extension.lastIndexOf('.'), 1)).toLowerCase())
    #if ($options.filter.size() == 0 || $options.filter.contains($extension))
      #__displaySelectableAttachment($attachment $targetDocument [${attachment.filename}])
    #end
  #end
#end

#macro (__displayUploadForm $targetDocument)
  {{html wiki=false clean=false}}
  &lt;form action="$targetDocument.getURL('upload')" enctype="multipart/form-data" method="post" id="${fieldName}-upload2" class="upload-attachment xform"&gt;
  &lt;div&gt;
    #if (${options.rawfilter} != '')
      &lt;span class="xHint"&gt;Accepted file formats: ${options.rawfilter}&lt;/span&gt;
    #end
    &lt;input type="file" name="filepath" id="attachfile2" class="attachment" size="30" title="$!{escapetool.xml($options.rawfilter)}"/&gt;
    &lt;input type="hidden" name="xredirect" value="$!{escapetool.xml($doc.getURL($context.action, $request.queryString))}" /&gt;
    &lt;input type="hidden" name="ajaxxredirect" value="$!{escapetool.xml($displayer.getURL('get', "$!{qString}&amp;xaction=lastatt" ))}" /&gt;
    &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
    &lt;input type="submit" name="action_upload" class="button" value='Upload and select'  title='Upload and select'/&gt;
  &lt;/div&gt;
  &lt;/form&gt;
  {{/html}}
#end

#macro (__displayGallery $targetDocument  $selection)
  #set ($content = '')
  #foreach ($name in  $selection)
    #if ("$!{targetDocument.getAttachment(${name})}" != '')
      #set ($content = "$!{content}image:${targetDocument.fullName}@${name}${util.newline}")
    #end
  #end
  #if ($content != '')
{{gallery}}
$content
{{/gallery}}

  #end
#end

{{/velocity}}

{{velocity}}
#if ("$!{request.xaction}" == 'lastatt')
#__displayLastAttachmentSelected($targetDoc)
#else
  $xwiki.ssx.use($displayerName)##
  $xwiki.jsx.use($displayerName, {'minify' : false})##
  ## check if the property exists and its value has the right type (is a list)
  #if ("$!{propValue.size()}" != '')
    #if ($options.mode == 'edit')
      (% id=$!{fieldName}_container %)(((
      #if ($options.manage)
        #__displayUploadForm($targetDoc)
      #else
        #set ($actionURL = $displayer.getURL('view', "$!{qString}&amp;mode=edit&amp;manage=true"))
        {{html wiki=false clean=false}}&lt;div class="actions"&gt;&lt;span class="buttonwrapper"&gt;&lt;a class="add-data-button button manage-images-button" href="${actionURL}"&gt;Upload and manage&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;{{/html}}
      #end
      #__displaySelectableAttachmentList($targetDoc $propValue)
      )))
    #else## not edit
      #__displayGallery($targetDoc $propValue)
    #end## context action check
  #end## target object &amp; property exist and are valid
#end## not a custom action
{{/velocity}}
</content></xwikidoc>