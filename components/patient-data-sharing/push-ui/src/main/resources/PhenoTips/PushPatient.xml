<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>PushPatient</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1401822203000</creationDate>
  <parent>PhenoTips.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1401822203000</date>
  <contentUpdateDate>1401822203000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content/>
  <object>
    <name>PhenoTips.PushPatient</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>767e254e-4d44-413d-8243-c88835562b5e</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>var PhenoTips = (function (PhenoTips) {
  var widgets = PhenoTips.widgets = PhenoTips.widgets || {};
  widgets.PushPatientWidget = Class.create({
    initialize : function() {
      // Due to loading problems, this will be instantiated on first use
      this._consentsModule = null;

      // ---------------------------------------------------------------------
      // Search for the push patient elements. Exist if missing.
      // ---------------------------------------------------------------------
      this._pushManyPatients = false;

      var pushTargets = $$("div[id^=push-patient]");
      if (pushTargets.length == 0) {
          pushTargets = $$("a[id^=pushall-server]");
          if (pushTargets.length == 0) {
              return;
          }
          this._pushManyPatients = true;
      }

      this._serviceURL = new XWiki.Document('PushPatientService', 'PhenoTips').getURL('get', 'outputSyntax=plain');
      this._patientId  = XWiki.currentDocument.page;
      //if (!this._pushManyPatients)
      //    console &amp;&amp; console.log("PUSH UI: Patient: " + this._patientId + ", serviceURL: " + this._serviceURL);
      //else
      //    console &amp;&amp; console.log("PUSH UI: multipush, serviceURL: " + this._serviceURL);

      // ---------------------------------------------------------------------
      // Initialize the UI
      // ---------------------------------------------------------------------
      this._initUI();

      // ---------------------------------------------------------------------
      // Attach launcher behavior:
      // ---------------------------------------------------------------------
      var _this = this;

      for (var server = 0; server &lt; pushTargets.length; server++) {
          var nextServer = pushTargets[server];
          var pushLauncher = this._pushManyPatients ? nextServer : nextServer.down('a');
          if (!pushLauncher) continue;

          var serverName = nextServer.readAttribute("name");

          var createLauncher = function(serverID) {
            return function(event) {
              event.stop();
              event.findElement().blur();

              _this._selectedServer = serverID;
              //console &amp;&amp; console.log("Initializing push to " + serverID);

              // If there are any unsaved changes, save before pushing
              PhenoTips.widgets.FormUtils.getFormState().saveIfFormDirty(_this._launchUI.bind(_this));
            }
          }
          pushLauncher.observe('click', createLauncher(serverName));
      }
      // ---------------------------------------------------------------------
      // Initialization done
      // ---------------------------------------------------------------------
    },

    _initUI: function() {
      var generateSection = function(id, title, intro, hint) {
         var section = new Element('div', {'id': id, 'class' : 'section'});
         if (title) {section.insert(title &amp;&amp; new Element('h2').update(title) || '');}
         if (intro) {section.insert(intro &amp;&amp; new Element('p', {'id': id+'-intro', 'class' : 'intro xHint'}).update(intro) || '');}
         section.insert(new Element ('div', {'class' : 'section-contents'}));
         if (hint) {section.insert(hint &amp;&amp; new Element('p', {'id': id+'-hint', 'class' : 'hint xHint'}).update(hint) || '');}
         return section;
      };

      this._authenticationLabel = "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.authentication.label'))";
      this._authenticationHint = "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.authentication.hint'))";
      this._remoteGroupLabel = "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.remoteGroup.label'))";
      this._remoteRegistrationHint = "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.remoteRegistration'))";

      this._container = new Element('form', {'id' : 'push-patients-ui', 'class' : 'xform', 'method' : 'post', 'action' : this._serviceURL});
      this._container.insert(generateSection('server-selection'))
                     .insert(generateSection('user-selection', this._authenticationLabel, this._authenticationHint, this._remoteRegistrationHint))
                     .insert(generateSection('group-selection', this._remoteGroupLabel));

      this._container.insert(generateSection('consents-section',
        "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.consents.label'))",
        "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.consents.defaulthint'))"));

      // TODO: DATAPREVIEW: implement preview of the data being pushed which works with multi-patient push and with all data fields

      this._retryButtonClass = 'button secondary push-retry-button';

      this._checkBoxApprove = new Element('input',{type:'checkbox', 'id':'approve-checkbox', 'value':'approve'});
      this._approveMessage = new Element('span', {'class': 'field-no-user-select'});
      var labelApprove = new Element('label', {'id':'approve-label'}).update(this._checkBoxApprove).insert(this._approveMessage);
      this._approveElement = new Element('div', {'class' : 'confirm-push plainmessage'});
      this._approveElement.insert(labelApprove);
      this._container.insert(this._approveElement);

      this._serverManager = this._container.down('#server-selection .section-contents');
      this._userManager   = this._container.down('#user-selection .section-contents');
      this._groupManager  = this._container.down('#group-selection .section-contents');

      this._consentsSection = this._container.down('#consents-section');
      this._consentsManager = this._consentsSection.down('.section-contents');
      // the section should appear only if the remote has consents configured
      this._consentsSection.hide();
      // inserting the error message
      this._consentsManager.insert('&lt;div class="box warningmessage hidden error"&gt;' +
        "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.consents.warning'))&lt;/div&gt;");

      this._initServerSelector();
      this._initMainFormActions();

      this._dialogTitle = this._pushManyPatients ? "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.title.multiplePatients'))" : "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.title.singlePatient'))";
      this._dialog = new PhenoTips.widgets.ModalPopup(this._container, false, {'title': this._dialogTitle, 'verticalPosition': 'top', 'removeOnClose': false});
    },

    _updateConsentHint: function(hint) {
        var consentHint = $('consents-section').down('.intro');
        if (consentHint) {
          consentHint.update(hint);
        }
    },

    _generateNoServerListMessage: function() {
      var retryButton = new Element('input', {type: 'button', name : 'retry', 'value': "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.retry'))", 'class': this._retryButtonClass}).wrap('span', {'class' : 'buttonwrapper'});
      var _this = this;
      retryButton.observe('click', function(event) {
        _this._launchUI();
      });
      return new Element('div', {'class' : 'errormessage'}).update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.noServerListMessage'))").insert(retryButton);
    },

    _generateCantConnectToServerMessage: function(failMessage, username, password) {
      var retryButton = new Element('input', {type: 'button', name : 'retry', 'value': "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.retry'))", 'class': this._retryButtonClass}).wrap('span', {'class' : 'buttonwrapper'});
      var _this = this;
      retryButton.observe('click', function(event) {
        _this._loginAndGetConfig(username, password);
      });
      return new Element('div', {'class' : 'errormessage'}).update(failMessage + " ").insert(retryButton);
    },

    _generateNoPushServerConfiguredMessage: function() {
          return new Element('div', {'class' : 'errormessage'}).update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.noPushServerConfiguredMessage'))");
    },

    _generateIncorrectCredentialsMessage: function() {
          return new Element('div', {'class' : 'errormessage'}).update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.noPushServerConfiguredMessage'))");
    },

    _generateFailedToPushPatient: function(errorMessage, retryButton, retryAsNew) {
      var result = new Element('div', {'class' : 'errormessage'}).update(errorMessage);

      if (retryButton)
      {
        var retryButton = new Element('input', {type: 'button', name : 'retry', 'value': "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.retry'))", 'class': this._retryButtonClass}).wrap('span', {'class' : 'buttonwrapper'});
        var _this = this;
        retryButton.observe('click', function(event) {
          _this._pushPatient();
        });
        result.insert(retryButton);
      }
      if (retryAsNew)
      {
        var retryAsNewButton = new Element('input', {type: 'button', name : 'retry', 'value': "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.retryAsNew'))", 'class': this._retryButtonClass}).wrap('span', {'class' : 'buttonwrapper'});
        var _this = this;
        retryAsNewButton.observe('click', function(event) {
          _this._selectPushNewPatient();
          _this._pushPatient();
        });
        result.insert(retryAsNewButton);
      }
      return result;
    },

    _onUnapprovedUser: function() {
      this._patientData = undefined;
      this._groupManager.up().hide();
      this._consentsSection.hide();

      // TODO: DATAPREVIEW: if preview is implemented on the main push dialog page, need to display
      //                    this._generateServerAndUserFirstMessage() error there

      this._pushButton.disable();   // disabled until the user is successfully logged to the server
      this._approveElement.hide();

      this._pushResultSection.update("");

      this._patientFieldList = undefined;
      this._userGroupsList   = undefined;

      this._lastApprovedUser  = undefined;
      this._lastSelectedGroup = undefined;
      this._userLoginError    = undefined;
    },

    _disableControl: function(control) {
        // disables the control and makes sure that even if all controls are now disabled
        // and will get re-enabled later this one wont get re-enabled
        control.disable();
        control.__wasDisabledState = true;  // see _disableInputs()
    },

    _disableInputs: function(disableCancelAsWell) {
       // disable all UI elements while waiting for AJAX request to complete
       this._container.addClassName('loading-indicator-large');
       var allInputs = this._container.getElementsByTagName('input');
       for (var i = 0; i &lt; allInputs.length; i++) {
          if (allInputs[i].disabled) {
            allInputs[i].__wasDisabledState = true;
          } else {
            allInputs[i].disable();
          }
       }
       // but enable the cancel button
       if (!disableCancelAsWell) {
          this._cancelButton.enable();
       }
    },

    _restoreInputs: function() {
       this._container.removeClassName('loading-indicator-large');
       // but do not enable what was disbaled before
       var allInputs = this._container.getElementsByTagName('input');
       for (var i = 0; i &lt; allInputs.length; i++) {
          if  (allInputs[i].__wasDisabledState) {
             delete(allInputs[i].__wasDisabledState);
          } else {
             allInputs[i].enable();
          }
       }
    },

    _launchUI : function() {
      var _this = this;

      if (this.__launchUIAjaxInProgress) { return; }

      this._consentsModule = PhenoTips.widgets.ConsentsModule.createNew();

      // reset data about available push servers
      this._remoteServers       = {};
      this._numAvailableServers = 0;
      this._serverInfo.hide();

      this._onUnapprovedUser();

      this._container.addClassName('loading-indicator-large');

      //AJAX 1: Get available remote servers
      new Ajax.Request(this._serviceURL, {
        method: _this._container.method,
        parameters : {'do':'getremotes', 'patientId': _this._patientId},
        onCreate : function() {
          _this.__launchUIAjaxInProgress = true;
          _this._dialog.showDialog();
          _this._container.up('.msdialog-modal-container').style.zIndex = 3001;
        },
        onSuccess : function (response) {
          console &amp;&amp; console.log("PUSH: Got response for the getremotes request");
          var data = response.responseJSON;

          if (!data || data.length == 0) {
            //console &amp;&amp; console.log("PUSH: no remotes defined");
            // if there are no configured servers, display warning message
            _this._serverLoadMessages.update(_this._generateNoPushServerConfiguredMessage());
          } else {
            //console &amp;&amp; console.log("PUSH: Found " + data.length + " remotes: " + stringifyObject(data));
            // otherwise show the list of servers to pick from
            _this._serverLoadMessages.hide();
            _this._populateServerList(data);
          }
        },
        onFailure : function(response) {
          _this._serverLoadMessages.update(_this._generateNoServerListMessage());
        },
        on0 : function (response) {
          response.request.options.onFailure(response);
        },
        onComplete : function() {
          _this.__launchUIAjaxInProgress = false;
          _this._container.removeClassName('loading-indicator-large');
          console &amp;&amp; console.log("PUSH: getting remotes - complete");
        }
      });
    },

    _queryStoredUserName: function() {
      var _this = this;
      this._userManager.update("");
      //AJAX 2: Get the user name last used for this server
      new Ajax.Request(this._serviceURL, {
        method: _this._container.method,
        parameters : {'do':'getuser', 'serverid': this._selectedServer },
        onCreate : function() {
          console &amp;&amp; console.log("PUSH: get username - start");
          _this._disableInputs();
        },
        onSuccess : function (response) {
          //console &amp;&amp; console.log("PUSH: Got user last used for the server (JSON: " + stringifyObject(response.responseJSON) + ")");
          if (response.responseJSON.remoteUserName) {
            _this._lastApprovedUser = response.responseJSON.remoteUserName;
          }
        },
        onFailure : function(response) {
          console &amp;&amp; console.error("PUSH: couldn't not get the user last used for this server");
          // just ignore the failure and let user manualy enter username/password
        },
        on0 : function (response) {
          response.request.options.onFailure(response);
        },
        onComplete : function() {
          _this._restoreInputs();
          console &amp;&amp; console.log("PUSH: getting username - complete");
          if (_this._lastApprovedUser) {
              _this._loginAndGetConfig(_this._lastApprovedUser, null);  // attempt a password-less login using stored token
          }
          else {
              _this._updateUserList();
          }
        }
      });
    },

    _loginAndGetConfig: function(username, password) {
      console &amp;&amp; console.log("loginAndGetConfig: probing " + username);

      var _this = this;
      // TODO: suport workflow when tokens are not enabled e.g. on the server side (have to remember username/password in JS)
      var params = {'do':'getremoteconfig', 'serverid': this._selectedServer, 'savetoken':true };
      if (password) {
        params['usr'] = username;
        params['pwd'] = password;
      }     // else atempt a passwordless login using the stored username

      //AJAX 3: attempt to authorize on the remote server + get remote config
      new Ajax.Request(this._serviceURL, {
        method: _this._container.method,
        parameters : params,
        onCreate : function() {
          console &amp;&amp; console.log("PUSH: get remote config - start");
          _this._disableInputs();
        },
        onSuccess : function (response) {
          if (response.hasOwnProperty("responseJSON") &amp;&amp; response.responseJSON) {
            console &amp;&amp; console.log("PUSH: Got response from server: " + stringifyObject(response.responseJSON));
            _this._lastLoginResponse = response.responseJSON;    // TODO: store per user+server locally, so that there is no need to AJAX again for the same user if selected again?
          } else {
            console &amp;&amp; console.warn("PUSH: No response from local service");
            _this._lastLoginResponse =  {"status":"error", "nolocalresponse":true};
          }
        },
        onFailure : function(response) {
          console &amp;&amp; console.error("PUSH: unable to get a response from remote server");
          _this._lastLoginResponse = {"status":"error", "serverconnectproblem":true};  // simulate "unable to connect" response from script service
        },
        on0 : function (response) {
          response.request.options.onFailure(response);
        },
        onComplete : function() {
          this._restoreInputs();
          console &amp;&amp; console.log("PUSH: get remote config - complete");

          if (this._lastLoginResponse.status == "success") {
            console &amp;&amp; console.log("--&gt; login successful!");
            $('user-selection-intro').hide();
            $('user-selection-hint').hide();
            this._lastApprovedUser = username;
            this._updateUserList();  // update current user list with an indication that this user has successfully logged in
            this._populateGroupsAndData(this._lastLoginResponse.groups, this._lastLoginResponse.serverfields, this._lastLoginResponse.updatesEnabled);
            this._populateConsentsList(this._lastLoginResponse.consents);
          }
          else {
            console &amp;&amp; console.warn("--&gt; login failed!");
            if (this._lastApprovedUser == username) {
              this._lastApprovedUser = undefined;   // this user is no longer approved
            }
            this._updateUserList(username, this._lastLoginResponse, username, password);
          }
        }.bind(this)
      });
    },

    _logoutUser: function() {
      var _this = this;
      var params = {'do':'removetokens', 'serverid': this._selectedServer };

      new Ajax.Request(this._serviceURL, {
        method: _this._container.method,
        parameters : params,
        onCreate : function() {
          console &amp;&amp; console.log("PUSH: logout user");
          try{
          _this._disableInputs();
          } catch (e) {console &amp;&amp; console.error("ERROR: " + e); }
        },
        onSuccess : function (response) {
          $('user-selection-intro').show();
          $('user-selection-hint').show();
          _this._lastLoginResponse = undefined;
          _this._lastApprovedUser  = undefined;
          _this._updateUserList();
        },
        onFailure : function(response) {
          alert("Failed to log out");
        },
        on0 : function (response) {
          response.request.options.onFailure(response);
        },
        onComplete : function() {
          this._restoreInputs();
          console &amp;&amp; console.log("PUSH: logout - complete");
        }.bind(this)
      });
    },

    _updateUserList: function(selectedUserName, lastLoginResponse, user_when_failed, password_when_failed) {
      if (lastLoginResponse) {
        $('group-selection').hide();
        if (this._lastLoginResponse.nolocalresponse) {
          this._userManager.update(this._generateCantConnectToServerMessage("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.noLocalResponse'))", user_when_failed, password_when_failed));
          return;
        }
        if (this._lastLoginResponse.unauthorizedserver) {
          this._userManager.update(this._generateCantConnectToServerMessage("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.unauthorizedServer'))", user_when_failed, password_when_failed));
          return;
        }
        if (this._lastLoginResponse.serverconnectproblem) {
          this._userManager.update(this._generateCantConnectToServerMessage("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.serverConnectProblem'))", user_when_failed, password_when_failed));
          return;
        }
        if (this._lastLoginResponse.serverdoesnotsupportclientprotocol) {
          this._userManager.update(this._generateCantConnectToServerMessage("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.unsupportedClientProtocol'))", user_when_failed, password_when_failed));
          return;
        }
        if (this._lastLoginResponse.clientdoesnotsupportserverprotocol) {
          this._userManager.update(this._generateCantConnectToServerMessage("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.unsupportedServerProtocol'))", user_when_failed, password_when_failed));
          return;
        }
      }

      console &amp;&amp; console.log("updateUserList: " + selectedUserName + ", last approved: " + this._lastApprovedUser);
      var _this = this;

      var userList = new Element('table', {id : 'user-list'});

      // either show only the username/password inputs + "authorize" button or
      // a radiobox [last approved user] and [the inputs + button above]
      // =&gt; re-login at every change

      // 1) if `lastApprovedUser` and `selectedUserName` are not set: only username/password inputs (selected)
      // 1) if `lastApprovedUser` is not set and `selectedUserName` is set: only username/password inputs (selected and prefilled)
      // 1) if `lastApprovedUser` is set and `selectedUserName` is not or equal to `lastApproved`: select lastApproved
      // 2) if `lastApprovedUser` is set and `selectedUserName` is also set and different: show username/password (selected &amp; prefilled) + an option to switch to `lastApproved`

      if (this._lastApprovedUser) {
        var logoutButton = new Element('input', {type: 'button', name : 'logout', 'value': "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.logOut'))", 'class' : 'button secondary'}).wrap('span', {'class' : 'buttonwrapper'});
        logoutButton.observe('click', function(event) {
           this._onUnapprovedUser();
           this._logoutUser();
        }.bind(this));
        var label = new Element('label', {'class' : 'fa fa-user'}).insert("    $!escapetool.javascript($services.localization.render('phenotips.PushPatient.currentlyAuthenticatedMessage'))".replace("__lastApprovedUser__", "&lt;strong&gt;"+this._lastApprovedUser+"&lt;/strong&gt; &amp;nbsp;"))
                                                                   .insert(logoutButton);
        userList.insert(label.wrap('td').wrap('tr'));
      } else {
	    // add an option to enter username &amp; password manually
	    var userPasswrodBox = new Element("span", {'class' : 'user-password-box'});
	    var userNameBox = new Element("input", {type: 'text', "id": "newusername", "value": "", "placeholder": "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.userName'))", size: 12});
	    if (selectedUserName) {
	      userNameBox.value = selectedUserName;
	    }
		var passwordBox = new Element("input", {type:'password', "id": "password", "value": "", "placeholder": "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.password'))", size: 12});
		var authorizeButton = new Element('input', {type: 'button', id:"authorizenewuser", 'name':'authorize', 'value':"$!escapetool.javascript($services.localization.render('phenotips.PushPatient.logIn'))", 'class':'button secondary'});
	    authorizeButton.observe('click', function(event) {
		  if (passwordBox.value != "") {
		    this._userLoginError.hide();
		    this._loginAndGetConfig(userNameBox.value, passwordBox.value);
		  } else {
		    this._userLoginError.update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.noPassword'))");
		    this._userLoginError.show();
		  }
		}.bind(this));
        userPasswrodBox.insert(userNameBox.wrap('label', {'class' : 'fa fa-user'}))
                        .insert(" ")
                        .insert(passwordBox.wrap('label', {'class' : 'fa fa-key'}))
                        .insert(" ")
                        .insert(authorizeButton.wrap('span', {'class' : 'buttonwrapper'}));
        userList.insert(userPasswrodBox.wrap('td', {'class' : 'controlled-element'}).wrap('tr'));
      }

      this._userLoginError = new Element('div', {'class' : 'errormessage'});
      this._userLoginError.hide();
      this._userManager.update(userList).insert(this._userLoginError);

      if (lastLoginResponse) {
        if (this._lastLoginResponse.loginfailed &amp;&amp; password_when_failed != "") {   // ignore unseccessful passwrodless logins - maybe token has expired, it is OK

          if (this._lastLoginResponse.usernameNotCanonical) {
            this._userLoginError.update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.cantAuthorizeNonCanonicalUserName'))");
          } else {
            this._userLoginError.update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.cantAuthorizeUser'))");
          }
          this._userLoginError.show();
        }
      }
    },

    // ---------------------------------------------------------------------
    // Display group picker and data preview - once server/user are known
    // ---------------------------------------------------------------------
    _populateGroupsAndData: function(groupList, fieldList, serverUpdatesEnabled) {
      //console &amp;&amp; console.log("Fields: " + stringifyObject(fieldList));
      if (!serverUpdatesEnabled) {
          this._remoteServers[this._selectedServer]["noUpdates"] = true;
      }
      this._displayGroupPicker(groupList);

      this._showApproveCheckbox();

      // TODO: DATAPREVIEW: patient data should be shown at this point. Note that we have both single- and multi- patient push.
      //                    for inspiration check previous implementation in git, search for _generateDataPreview()
      //                    (which used _displayPatientData(), generateNoPatientJSONMessage(), _generatePatientDataPreview())
    },

    _displayGroupPicker: function(groupList) {
      if (!groupList) {
        groupList = this._userGroupsList;
        if (!this._userGroupsList) return;
      }
      else {
        this._userGroupsList = groupList;
      }
      if (groupList.length == 0 || this._updatingExistingPatient()) {
        $('group-selection').hide();
      } else {
        $('group-selection').show();
      }
      console &amp;&amp; console.log("Groups: " + stringifyObject(groupList));

      var groupListElement = new Element('table', {id : 'user-list'});

      var _addGroupOption = function (checked, iconType, labelText, value) {
        var optionWrapper = new Element('tr');
        var input = new Element('input', {"type" : "radio", "value": value, "name": "select-group"});
        if (checked) {
          input.checked = true;
        }
        var label = new Element('label').insert(input).insert(labelText);
        optionWrapper.insert(new Element('span', {'class' : 'fa fa-' + iconType}).wrap('td')).insert(label.wrap('td'));
        return optionWrapper;
      };

      var loggedInUser = "&lt;strong&gt;"+this._lastApprovedUser+"&lt;/strong&gt; &amp;nbsp;";
      groupListElement.insert(_addGroupOption(true, "user", loggedInUser, "__self"));
      groupList.each(function (group) {
            groupListElement.insert(_addGroupOption(false, "group", group, group));
        });

      this._groupManager.update(groupListElement);

      if (this._remoteServers[this._selectedServer]["noUpdates"]) {
          this._disableUpdateOption();
      }
    },

    _showApproveCheckbox: function() {
      this._checkBoxApprove.checked = false;
      this._checkBoxApprove.enable();
      this._approveElement.show();
    },

    // ---------------------------------------------------------------------
    // Generate consents section UI
    // ---------------------------------------------------------------------
    _populateConsentsList: function(consentJSONArray) {
        if (consentJSONArray == null || consentJSONArray.length == 0) {
            this._consentsSection.hide();
            return;
        }

        var onConsentStateChange = function(consentName, consentState) {
            this._pushResultSection.update("");
            this._enablePushButton();
        }.bind(this);
        this._consentsManager.update("");
        this._updateConsentHint(this._selectedServer + " " + "$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.consents.hint'))");
        this._consentsModule.init(this._consentsManager, "edit", consentJSONArray, false /* do not display consent details */, onConsentStateChange);

        this._consentsSection.show();
    },

    // ---------------------------------------------------------------------
    // Generate server selection UI
    // ---------------------------------------------------------------------
    _populateServerList: function(pushServerList) {
      //console &amp;&amp; console.log("Server list input: " + stringifyObject(pushServerList));

      this._remoteServers = {};

      this._numAvailableServers = pushServerList.length;
      for (var i = 0; i &lt; pushServerList.length; i++) {
          var serverInfo = pushServerList[i].serverinfo;
          var pushInfo   = pushServerList[i].pushinfo;
          var name       = serverInfo.serverID;

          serverInfo.serverURL = this._addHTTP(serverInfo.serverURL);

          var pushAge    = pushInfo ? pushInfo.lastPushAgeInHours : -1;
          var remoteID   = pushInfo ? pushInfo.remotePatientID : "";
          var remoteGUID = pushInfo ? pushInfo.remotePatientGUID : "";
          var remoteURL  = pushInfo ? (serverInfo.serverURL + pushInfo.remotePatientURL) : "";
          var serverRegistrationURL = serverInfo.serverRegistrationURL || "";
          this._remoteServers[name] = {"url": serverInfo.serverURL,
                                       "registrationURL": serverRegistrationURL,
                                       "desc": serverInfo.serverDescription,
                                       "pushAgeHours": pushAge,
                                       "remoteID": remoteID,
                                       "remoteGUID": remoteGUID,
                                       "remoteURL": remoteURL};
      }

      //console &amp;&amp; console.log("Remote servers as cached: " + stringifyObject(this._remoteServers))

      this._selectServer(this._selectedServer);
    },

    _selectServer: function(serverName, keepUserAndGroup) {
        this._selectedServer = serverName;
        var serverData = this._remoteServers[serverName];
        var serverLink = new Element('a', {'href' : serverData.url, 'target' : '_blank', 'class' : 'remote-server-name'}).update(this._selectedServer);

        if (this._numAvailableServers == 1) {
            this._serverInfo.update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.oneServerMessage'))");
        }

        var dialogTitle = this._dialogTitle.replace("__serverID__", this._selectedServer).replace("__patientID__", this._patientId);
        $('push-patients-ui').up('.msdialog-box').down('.msdialog-title').innerHTML = dialogTitle;
        var userSelection = this._authenticationLabel.replace("__serverID__", this._selectedServer);
        $$('#user-selection h2')[0].innerHTML = userSelection;
        var userSelectionHint = this._authenticationHint.replace(/__serverID__/g, this._selectedServer);
        $('user-selection-intro').innerHTML = userSelectionHint;
        $('user-selection-intro').show();
        var groupSelection = this._remoteGroupLabel.replace("__serverID__", this._selectedServer);
        $$('#group-selection h2')[0].innerHTML = groupSelection;
        if (serverData.registrationURL != "" &amp;&amp; !this._lastApprovedUser) {
           var remoteRegistration = this._remoteRegistrationHint.replace("__serverID__", this._selectedServer).replace("__registrationUrl__", "&lt;a target=\"_blank\" href=\""+serverData.registrationURL+"\"&gt;"+serverData.registrationURL+"&lt;/a&gt;");
           $('user-selection-hint').innerHTML = remoteRegistration;
           $('user-selection-hint').show();
        } else {
           $('user-selection-hint').innerHTML = '';
        }
        var existingPatientDataInfo = '';

        if (serverData.pushAgeHours !== undefined &amp;&amp; serverData.pushAgeHours &gt;=0) {
           var _this = this;

           existingPatientDataInfo = new Element('dd');

           var description = new Element('p', {'id': 'server-description'});
           var linkToNew = " &lt;a href='" + serverData.remoteURL + "' target='_blank'&gt;" + serverData.remoteID + "&lt;/a&gt;";
           var lastUpdated = serverData.pushAgeHours;
           var days = Math.floor(lastUpdated/24);
           if (lastUpdated &lt; 1) {
              description.insert(" $!escapetool.javascript($services.localization.render('phenotips.PushPatient.patientUploadedLessThanHour'))".replace("__serverID__", this._selectedServer).replace("__patientID__", linkToNew) +".");
           } else {
              if (lastUpdated &gt;= 48) {
                  description.insert(" $!escapetool.javascript($services.localization.render('phenotips.PushPatient.patientUploadedDays'))".replace("__daysN__", days).replace("__serverID__", this._selectedServer).replace("__patientID__", linkToNew) +".");
              } else {
                  description.insert(" $!escapetool.javascript($services.localization.render('phenotips.PushPatient.patientUploadedHours'))".replace("__hoursN__", lastUpdated).replace("__serverID__", this._selectedServer).replace("__patientID__", linkToNew) +".");
              }
           }
           description.insert("&lt;br/&gt;$!escapetool.javascript($services.localization.render('phenotips.PushPatient.patientUploadedUpdate'))".replace("__serverID__", this._selectedServer))
           existingPatientDataInfo.insert(description);

           var selectPushType = new Element('p');
           var radio1 = new Element('input', {"type" : "radio", "value": "update", "id":"choice-update-patient", "name": "new-or-update"});
           radio1.checked = true;
           radio1.observe('change', function() { _this._displayGroupPicker() });
           var label1 = new Element('label', {"hidden": true}).insert(new Element('span', {'class' : 'fa fa-refresh'}).update(' ')).insert(radio1).insert("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.updateRemotePatient'))");
           var radio2 = new Element('input', {"type" : "radio", "value": "new", "id":"choice-new-patient", "name": "new-or-update"});
           radio2.observe('change', function() { _this._displayGroupPicker() } );
           var label2 = new Element('label', {"hidden": true}).insert(new Element('span', {'class' : 'fa fa-plus-square'}).update(' ')).insert(radio2).insert("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.createRemotePatient'))");
           existingPatientDataInfo.insert(label1).insert(label2);
        }

        this._serverInfo.update(new Element('dl').insert(serverLink.clone(true).wrap('dt')).insert(serverData.desc &amp;&amp; new Element('dd', {'class' : 'hint'}).update(serverData.desc) || '').insert(existingPatientDataInfo || ''));

        this._approveMessage.update("$!escapetool.javascript($services.localization.render('phenotips.patientSharing.push.dialog.confirmation.label'))".replace("__serverID__", this._selectedServer) + " $!escapetool.javascript($services.localization.render('phenotips.PushPatient.required'))");

        if (!keepUserAndGroup) {
            this._serverInfo.show();
            this._queryStoredUserName();
        } else {
            this._serverInfo.down('#server-description').hide();
        }
    },

    _initServerSelector: function() {
      this._serverLoadMessages = new Element('div', {id: 'server-load-messages'});
      this._serverLoadMessages.hide();
      this._serverInfo = new Element('div', {id: 'server-info'});
      this._serverManager.update(this._serverLoadMessages).insert(this._serverInfo);
    },

    // ---------------------------------------------------------------------
    // Generate and handle main "Cancel" and "Push" buttons
    // ---------------------------------------------------------------------
    _initMainFormActions : function() {
      var _this = this;
      var buttons = new Element('div', {'class' : 'buttons'});
      buttons.insert(new Element('input', {type: 'hidden', name : 'xaction', 'value': 'push'}));
      buttons.insert(new Element('input', {type: 'hidden', name : 'patient', 'value': this._patientId}));
      var pushButtonTitle = this._pushManyPatients ? "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.button.manyPatients.push'))" : "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.button.singlePatient.push'))";
      buttons.insert(new Element('input', {type: 'submit', name : 'submit',  'value': pushButtonTitle, 'class' : 'button', 'id': 'push_patient_button'}).wrap('span', {'class' : 'buttonwrapper'}));
      buttons.insert(new Element('input', {type: 'button', name : 'close',   'value': "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.button.cancel'))", 'class' : 'button secondary'}).wrap('span', {'class' : 'buttonwrapper'}));
      this._container.insert(buttons);

      this._pushResultSection = new Element ('div', {'class' : 'section-contents'});
      this._container.insert(this._pushResultSection);

      this._cancelButton = buttons.down('input[name="close"]');
      this._cancelButton.observe('click', function(event) {
        _this._dialog.closeDialog();
      })

      this._pushButton = buttons.down('input[name="submit"]');
      this._checkBoxApprove.observe("click", function(event) {
        _this._pushResultSection.update("");
        _this._enablePushButton();
      });

      this._container.observe('submit', function(event) {
        event.stop();
        _this._pushSelectFieldsAndPatients();
      })  // observe('submit')
    },

    _enablePushButton: function() {
        if (this._checkBoxApprove.checked &amp;&amp; this._consentsModule.allRequiredChecked()) {
          this._pushButton.enable();
        } else {
          this._pushButton.disable();
        }
    },

    _updatingExistingPatient: function() {
        var pushUpdate = false;
        var radioSelectUpdate = document.getElementById('choice-update-patient');
        if (radioSelectUpdate) {
            pushUpdate = radioSelectUpdate.checked;
        }
        return pushUpdate;
    },

    _selectPushNewPatient: function() {
        var radioSelectUpdate = document.getElementById('choice-update-patient');
        var radioSelectNew    = document.getElementById('choice-new-patient');
        if (radioSelectUpdate &amp;&amp; radioSelectNew) {
            radioSelectUpdate.checked = false;
            radioSelectNew.checked    = true;
        }
    },

    _disableUpdateOption: function() {
        var radioSelectNew = document.getElementById('choice-new-patient');
        if (radioSelectNew) {
            radioSelectNew.checked = true;
        }
        var radioSelectUpdate = document.getElementById('choice-update-patient-label');
        if (radioSelectUpdate) {
            var serverDesc = document.getElementById('server-description');
            serverDesc.insert("&lt;p&gt;$!escapetool.javascript($services.localization.render('phenotips.PushPatient.serverDesc'))&lt;/p&gt;");
            radioSelectUpdate.hide()
        }
    },

    _pushPatient: function(columnList, patientID, callBack) {
        var _this = this;
        if (_this._pushManyPatients &amp;&amp; (!patientID || !callBack)) {
            return;
        }
        if (!_this._pushManyPatients) {
            _this._pushResultSection.update("");
        }

        if (columnList) {
            _this._lastSelectedColumnList = columnList;
        } else {
            columnList = _this._lastSelectedColumnList;
        }
        if (!columnList || columnList.length == 0) {
            _this._pushResultSection.update(new Element('div', {'class' : 'errormessage'}).update("No columns were selected"));
            return;
        }

        var patientID = patientID ? patientID : this._patientId;

        var params = {"do":"push", 'serverid': this._selectedServer, 'patientid': patientID};

        params["fields"] = columnList ? Object.toJSON(columnList) : Object.toJSON(this._patientFieldList);

        if (_this._pushManyPatients){
            params["guid"] = "auto";
        } else if (this._updatingExistingPatient()) {
            params["guid"] = _this._remoteServers[_this._selectedServer].remoteGUID;
        }

        var radioSelectValue = $$('input:checked[type=radio][name="select-group"]')[0].value;
        if (radioSelectValue != "__self") {
            params["groupname"] = radioSelectValue;
        }

        var patientState = { "consents" : _this._consentsModule.listGrantedConsentIDs() };
        params["patientState"] = stringifyObject(patientState);

        console &amp;&amp; console.log("PUSH request params: " + stringifyObject(params));

        new Ajax.Request(this._serviceURL, {
          method: _this._container.method,
          parameters : params,
          onCreate : function() {
            _this._disableInputs(true /* disable cancel button as well */);
          },
          onSuccess : function(response) {
            try {
                console &amp;&amp; console.log("Got response: " + stringifyObject(response.responseJSON));
                var res = response.responseJSON;
                if (_this._pushManyPatients) {
                    callBack(res, patientID);
                    return;
                }
                if (res.status == "success") {
                    _this._checkBoxApprove.checked = false;

                    // update cached value for how this patient is represented on this remote server
                    var newURL = _this._remoteServers[_this._selectedServer].url + res.patienturl;
                    _this._remoteServers[_this._selectedServer]["pushAgeHours"] = 0;
                    _this._remoteServers[_this._selectedServer]["remoteID"]     = res.patientid;
                    _this._remoteServers[_this._selectedServer]["remoteGUID"]   = res.patientguid;
                    _this._remoteServers[_this._selectedServer]["remoteURL"]    = newURL;

                    if (_this._updatingExistingPatient()) {
                        var linkToOld = "(&lt;a href='" + newURL + "' target='_blank'&gt;click here to open remote patient&lt;/a&gt;)";
                        _this._pushResultSection.update(new Element('div', {'class' : 'infomessage'}).update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.successfulUpdate')) " + linkToOld));
                    } else {
                        var linkToNew = " &lt;a href='" + newURL + "' target='_blank'&gt;" + res.patientid + "&lt;/a&gt;";
                        _this._pushResultSection.update(new Element('div', {'class' : 'infomessage'})
                                                .update("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.successfulPush'))"
                                                .replace("__serverID__", _this._selectedServer)
                                                .replace("__patientID__", linkToNew)));
                    }

                    // update UI to reflect that we have already pushed this patient: default option is now "update" 
                    _this._selectServer(_this._selectedServer, true);
                    _this._displayGroupPicker();
                } else {
                    if (res.updatesdisabled) {
                        _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedUpdatesDisabled'))".replace('__serverID__', _this._selectedServer)));
                    } else
                    if (res.invalidguid) {
                        _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedInvalidGuid'))&amp;nbsp;".replace(/__serverID__/g, _this._selectedServer), false, true));
                    } else
                    if (res.accessdeniedguid) {
                        _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedAccessDeniedGuid'))"));
                    } else
                    if (res.accessdeniedguid) {
                        _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedAccessDenied'))"));
                    } else
                    if (res.cantconnect) {
                      _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedCantConnect'))", true));
                    } else
                    if (res.missingconsent) {
                      _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedMissingConsent'))", true));
                    } else {
                      _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailed'))", true));
                    }
                }
                //_this._dialog.closeDialog();
              } catch (e) {
                console &amp;&amp; console.error("EXCEPTION: " + e);
                _this._pushResultSection.update(_this._generateFailedToPushPatient("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedException'))".replace("__e__", e), true));
              }
          },
          onFailure : function(response) {
            if (_this._pushManyPatients) {
                callBack({"status": "error"}, patientID);
                return;
            }
            var provideRetry  = false;
            var failureReason = response.statusText;
            if (response.statusText == '' || response.status == 12031 ) {   // no response + IE special case
               failureReason = 'Server not responding';
               provideRetry  = true;
            }
            _this._pushResultSection.update(_this._generateFailedToPushPatient(failureReason, provideRetry));
          },
          on0 : function (response) {
            if (_this._pushManyPatients) {
                callBack({"status": "error"}, patientID);
                return;
            }
            response.request.options.onFailure(response);
          },
          onComplete : function() {
            _this._restoreInputs();
            if (!_this._checkBoxApprove.checked) {
              _this._pushButton.disable();
            }
          }
        });
    },

    _addHTTP: function(url) {
        if (!/^(f|ht)tps?:\/\//i.test(url)) {
          url = "http://" + url;
        }
        return url;
    },


    _pushSelectFieldsAndPatients: function() {
        var _this = this;

        var doMultiPush = function(patients, columns) {
            //console &amp;&amp; console.log("Push with params: " + patients + " -&gt; " + columns + " -&gt; " + _this._selectedServer);
            _this._checkBoxApprove.checked = false;
            var pushResult = new Element("div", {"class": "multi-push-results infomessage"});
            _this._pushResultSection.update(pushResult);

            var next = 0;
            var pushSingleFunc = function(previousPushResult, prevPatientID) {
               // display previous push status
               if (previousPushResult &amp;&amp; prevPatientID) {
                   if (previousPushResult.status != "success") {
                       pushResult.className = "multi-push-results errormessage";
                       if (previousPushResult.cantconnect) {
                           pushResult.insert(" $!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedCantConnect'))");
                           return;
                       }
                       var reason = "failed.";
                       if (previousPushResult.invalidguid) {
                           reason = "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.incorrectGuid'))";
                       } else if (previousPushResult.accessdeniedguid) {
                           reason = "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.accessDenied'))";
                       } else if (previousPushResult.missingconsent) {
                           reason = "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushFailedMissingConsent'))";
                       }
                       pushResult.insert(' ' + reason + "&lt;br/&gt;");
                   } else {
                       pushResult.innerHTML = pushResult.innerHTML.replace(/Pushing (\w+?)\.\.\.$/, "");
                       var newURL       = _this._remoteServers[_this._selectedServer].url + previousPushResult.patienturl;
                       var linkToRemote = "&lt;a href='" + newURL + "' target='_blank'&gt;" + previousPushResult.patientid + "&lt;/a&gt;";
                       pushResult.insert("&lt;div class='pushed-ok-message'&gt;" + "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.successfulPushWithId'))".replace("__prevPatientID__", prevPatientID).replace("__linkToRemote__", linkToRemote) + "&lt;/div&gt;");
                   }
               }
               // push next
               if (next &lt; patients.length) {
                   var nextPatientID = patients[next++];
                   pushResult.insert("$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushing'))".replace("__nextPatientID__", nextPatientID));
                   _this._pushPatient(columns, nextPatientID, pushSingleFunc);
               }
            }

            pushSingleFunc();
        }
        var pushCallBack = function(patients, columns) {
            if (patients.length == 0) {
                return;
            }
            var confirmMessage = "$!escapetool.javascript($services.localization.render('phenotips.PushPatient.confirmMessage'))".replace("__numPatients__", patients.length).replace("__selectServer__",  _this._selectedServer)+ "&lt;br/&gt;&lt;div class='plainmessage multi-push-patient-list'&gt;&lt;ol&gt;";
            patients.each(function(item) {
                confirmMessage += "&lt;li&gt;" + item + "&lt;/li&gt;";
            });
            confirmMessage += "&lt;/ol&gt;&lt;/div&gt;"

            new XWiki.widgets.ConfirmationBox(
              { onYes : function() { doMultiPush(patients, columns); }, },
              { confirmationText: confirmMessage, showCancelButton: false }
            ).dialog.style.zIndex = 3001;
        }

        if (_this._pushManyPatients) {
          //-------------- push multiple
          var exportTool = $('phenotips_export');
          if (!exportTool) return;

          var pushPreferencesFail = function() {
            alert("Failed to get the list of patients to be pushed");
          }

          // =================================================================================
          // Generate the dialog content
          new Ajax.Request(new XWiki.Document('ExportPreferences', 'PhenoTips').getURL('get', 'space=' + /space=([^&amp;]+)/.exec(exportTool.href)[1] + '&amp;push=true&amp;multipatient=true&amp;remoteserver='+this._selectedServer), {
            parameters : {"enabledFields": this._lastLoginResponse.serverfields},
            onCreate : function() {
              _this._pushButton.insert({after: new Element('span', {'class' : "fa fa-lg fa-spinner fa-spin fa-fw"})});
              _this._pushButton.addClassName('processing');
              _this._pushButton.disable();
            },
            onSuccess: function(transport) {
              var dialog = new PhenoTips.widgets.ModalPopup(transport.responseText, false, {'title': "$!escapetool.javascript($services.localization.render('phenotips.pushPatient.selectFieldsAndPatientsTitle'))", 'verticalPosition': 'top', 'removeOnClose': true, 'extraClassName': 'export-dialog'});
              dialog.showDialog();
              var content = dialog.dialogBox._x_contentPlug;
              content.__dialog = dialog;
              document.fire('xwiki:dom:updated', {'elements': [content],
                                                  'pushPreferences': content,
                                                  'pushMulti': true,
                                                  'callbackOK': pushCallBack,
                                                  'callbackFail': pushPreferencesFail});
            },
            onComplete : function() {
              _this._pushButton.next('.fa-spinner').remove();
              _this._pushButton.removeClassName('processing');
              _this._pushButton.enable();
            }
          });
        } else {
          //-------------- push single

          var singlePushPreferencesFail = function() {
            alert("Failed to get the list of fields to be pushed");
          }

          var singlePushCallBack = function(columns) {
            _this._pushPatient(columns);
          }

          // =================================================================================
          // Generate the dialog content
          new Ajax.Request(new XWiki.Document('ExportPreferences', 'PhenoTips').getURL('get', 'push=true&amp;singlepatient=false&amp;remoteserver='+this._selectedServer), {
            parameters : {"enabledFields": this._lastLoginResponse.serverfields},
            onCreate : function() {
              _this._pushButton.insert({after: new Element('span', {'class' : "fa fa-lg fa-spinner fa-spin fa-fw"})});
              _this._pushButton.addClassName('processing');
              _this._pushButton.disable();
            },
            onSuccess: function(transport) {
              var dialog = new PhenoTips.widgets.ModalPopup(transport.responseText, false, {'title': "$!escapetool.javascript($services.localization.render('phenotips.pushPatient.selectFieldsTitle'))", 'verticalPosition': 'top', 'removeOnClose': true, 'extraClassName': 'narrow-export-dialog export-dialog'});
              dialog.showDialog();
              var content = dialog.dialogBox._x_contentPlug;
              content.__dialog = dialog;
              document.fire('xwiki:dom:updated', {'elements': [content],
                                                  'pushPreferences': content,
                                                  'pushMulti': false,
                                                  'callbackOK': singlePushCallBack,
                                                  'callbackFail': singlePushPreferencesFail});
            },
            onComplete : function() {
              _this._pushButton.next('.fa-spinner').remove();
              _this._pushButton.removeClassName('processing');
              _this._pushButton.enable();
            }
          });

        }
    }

  });
  return PhenoTips;
}(PhenoTips || {}));
//  ========================================================================
// End PhenoTips augmentation.


// overwrite the behaviour of the "export/push to" button on the export preferences page:
// get the selected patients and fields and push using this javascript
['xwiki:dom:updated'].each(function(eventName) {
    document.observe(eventName, function(event) {
        if (!event.memo || !event.memo.pushPreferences || !event.memo.callbackOK) {
            return;
        }
        var dialog       = event.memo.pushPreferences.__dialog;
        var callbackOK   = event.memo.callbackOK;
        var callbackFail = event.memo.callbackFail;
        var pushMulti = event.memo.pushMulti;

        var cancelButton = $('export_cancel');
        cancelButton &amp;&amp; cancelButton.observe('click', function(event) {
          dialog.closeDialog();
        });

        var pushButton = event.memo.pushMulti ? $('push-multiple-patients') : $('push-patient');
        pushButton &amp;&amp; pushButton.observe('click', function(event) {
            event.stop();
            var form = pushButton.up('form');
            if (form) {
                // 1) get the list of selected data columns from the form
                var selectedFields = [];
                var fields = form.down('.push-fields');
                var checkboxes = fields.select('input[name="columns"]');
                checkboxes.each(function(item) {
                    if (item.checked) {
                        selectedFields.push(item.identify().replace("columns_",""));
                    }
                });

                if (!pushMulti) {
                  dialog.closeDialog();
                  callbackOK(selectedFields);
                  return;
                }

                // 2) get the list of filtered patients from the ExportFilter page
                var liveMatchCounter = $('filter-match-count');
                var url = "$xwiki.getURL('PhenoTips.ExportFilter', 'get')?list=true&amp;" + form.serialize();
                var ajx = new Ajax.Request(url, {
                    method: 'get',
                    onSuccess: function(response) {
                        var patients = [];
                        response.responseJSON.each(function(item) {
                            patients.push(item.substring(item.lastIndexOf('.') + 1));
                        });
                        callbackOK(patients, selectedFields);
                    },
                    onFailure: function (response) {
                        callbackFail &amp;&amp; callbackFail();
                    }
                });
            };
            dialog.closeDialog();
        });
    });
});


document.observe("xwiki:dom:loaded", function() {
  new PhenoTips.widgets.PushPatientWidget();
});


//--- debug:

function stringifyObject(obj) {
    return _printObjectInternal(obj, 1);
}

function _printObjectInternal(o, level) {
    if (level &gt; 10) return "...[too deep, possibly a recursive object]...";
    var output = '';
    if (typeof o == 'object')
    {
        if (Object.prototype.toString.call(o) === '[object Array]')
        {
            output = '[';
            for (var i = 0; i &lt; o.length; i++) {
                if (i &gt; 0) output += ', ';
                output += _printObjectInternal(o[i], level+1);
            }
            output += ']';
        }
        else
        {
            output = '{';
            var idx = 0;
            if (level == 0) output += '\n';
            for (property in o) {
                if (!o.hasOwnProperty(property)) continue;

                if (level != 0 &amp;&amp; idx != 0 )
                    output += ', ';
                output += property + ': ' + _printObjectInternal(o[property], level+1);

                if (level == 0)
                    output += '\n';
                idx++;
            }
            output += '}';
        }
    }
    else if (typeof o == 'string') {
        output = "'" + o + "'";
    }
    else
        output = ''+o;
    return output;
}
</code>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>currentPage</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.PushPatient</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>039b7857-377d-4086-8a44-e16fce031439</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>#template("colorThemeInit.vm")

/* disable yellow background on hover - only for push */
.narrow-export-dialog.export-dialog .section:hover {
  background-color: inherit !important;
}

/* filed selection dialogue has more space when used for pushing, so increase some margins for better visual separation of elements */
.narrow-export-dialog.export-dialog .section .selection-tools {
  margin: 0 0 1.5em !important;
}

.section-name-header:hover {
  color: $theme.linkColor;
}

.export-dialog .field-list {
  margin: -0.2em 0 0 1em !important;
}

#push-patients-ui td {
  border: 0 none;
  padding: .3em;
  text-align: left;
  vertical-align: top;
}

#push-patient {
  display: inline;
}
#push_patient_button.processing {
  padding-right: 2em;
}
#push_patient_button.processing + .fa-spin {
  color: #FFF;
  margin-left: -1.3em;
}

#user-selection input[type="text"],
#user-selection input[type="password"]{
  width: 30%;
  box-shadow: 0px 1px 2px rgb(170, 170, 170) inset;
}

#user-selection input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
  border-color: $theme.linkColor;
}

#user-selection input.button:disabled {
  background-image: none;
}

#user-selection #rememberme-checkbox {
  margin-top: 0.5em;
}

#user-selection label {
  white-space:nowrap;
}

#user-selection h2, #group-selection h2 {
  margin-top: 1em;
}

#user-selection .section-contents, #group-selection .section-contents {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

#server-info, #fields-selection dl {
  background: none repeat scroll 0 0 #FFFFFF;
  box-shadow: 0 0 3px #AAAAAA;
  margin: 15px 0 0;
  padding: 0.5em;
  position: relative;
}

#fields-selection dl:before, #fields-selection dl:after {
  content: "";
  display: block;
  position: absolute;
  border: 10px solid transparent;
  border-top: 0 none;
  border-bottom-color: #FFF;
  top: -9px;
}

#fields-selection dl:before {
  border-bottom-color: #AAA;
  top: -10px;
}
#server-info dt,
#fields-selection dt:first-child {
  margin-top: 0;
}
#server-info .fa {
  display: inline-block;
  margin: 0 .3em;
  width: 1.2em;
}
#server-info input[type="radio"] {
  vertical-align: middle;
}

#user-selection #newusername, #user-selection #password {
  color: $theme.textColor;
}

.user-password-box label {
  color: $theme.textPrimaryColor;
}
.user-password-box label:before {
  border-radius: 4px 0 0 4px;
  display: inline-block;
  margin-right: -3px;
  padding: 0.3em;
}

#group-selection {
  margin-bottom: 1.5em;
}
#consents-section {
  margin-bottom: 1.5em;
}

#fields-selection dl {
  background: none repeat scroll 0 0 #FFFFFF;
  box-shadow: 0 0 3px #AAAAAA;
  padding: 0.5em;
}
#fields-selection dd {
  margin-left: 3em;
}
#fields-selection .negative {
  color: $theme.notificationErrorColor;;
}

.confirm-push {
  padding: .5em;
  margin: 0 0 0.5em 0;
  font-weight: bold;
}
.multi-push-results {
  overflow-y: auto;
  max-height: 150px;
}
.multi-push-results .pushed-ok-message {
  color: #336699;
}
.multi-push-patient-list {
  overflow-y: auto;
  max-height: 150px;
  width: 250px;
  padding: 0.5em;
}
.push-retry-button {
  margin-left: 0.5em !important;
}
.consents {
  margin-top: 0.75em;
  margin-right: 3em;
}
.narrow-export-dialog.export-dialog {
  width: 60% !important;
  max-width: 1000px;
}
.loading-indicator-large {
  background: url("$xwiki.getSkinFile('icons/xwiki/ajax-loader-large.gif')") no-repeat center center;
}
.field-no-user-select {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
.consent-label.required {
  font-weight: bold;
}
</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.PushPatient</name>
    <number>0</number>
    <className>XWiki.UIExtensionClass</className>
    <guid>87b251c1-821f-4c7b-8258-787134bd0cd9</guid>
    <class>
      <name>XWiki.UIExtensionClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <content>
        <disabled>0</disabled>
        <name>content</name>
        <number>3</number>
        <prettyName>Extension Content</prettyName>
        <rows>10</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </content>
      <extensionPointId>
        <disabled>0</disabled>
        <name>extensionPointId</name>
        <number>1</number>
        <prettyName>Extension Point ID</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </extensionPointId>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Extension ID</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parameters>
        <disabled>0</disabled>
        <name>parameters</name>
        <number>4</number>
        <prettyName>Extension Parameters</prettyName>
        <rows>10</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </parameters>
      <scope>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>scope</name>
        <number>5</number>
        <prettyName>Extension Scope</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>wiki=Current Wiki|user=Current User|global=Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </scope>
    </class>
    <property>
      <content>{{velocity}}
$xwiki.jsfx.use('js/scriptaculous/dragdrop.js')##
$xwiki.jsx.use('PhenoTips.PushPatient')##
$xwiki.ssx.use('PhenoTips.PushPatient')##
$xwiki.jsfx.use('uicomponents/widgets/exportData.js', {'forceSkinAction' : true, 'language': $xcontext.language})####
$xwiki.ssfx.use('uicomponents/widgets/exportData.css', true)####
#set ($service = $services.pushPatient)
#set ($configuredServers = $service.getPushTargetsWithHistory(""))
#foreach ($mapEntry in $configuredServers.entrySet())
  ## make sure PhenomeCentral is enabled/configured, and if it is list it as the first push target
  #if ($mapEntry.key.getServerID() == "PhenomeCentral")
    (% id="push-patient-pc" name="PhenomeCentral" %)((([[$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushPhenomeCentral'))&gt;&gt;path:#]])))
  #end
#end
#set ($counter = 0)
#foreach ($mapEntry in $configuredServers.entrySet())
  #set ($serverName = $mapEntry.key.getServerID())
  #if ($serverName != "PhenomeCentral")
    (% id="push-patient-$counter" name="$serverName" %)((([[$!escapetool.javascript($services.localization.render('phenotips.PushPatient.pushToAnotherServer', [$serverName]))&gt;&gt;path:#]])))
    #set( $counter = $counter + 1 )
  #end
#end
{{/velocity}}</content>
    </property>
    <property>
      <extensionPointId>org.phenotips.patientRecordMenu.moreActions</extensionPointId>
    </property>
    <property>
      <name>org.phenotips.widget.pushpatient</name>
    </property>
    <property>
      <parameters/>
    </property>
    <property>
      <scope>wiki</scope>
    </property>
  </object>
</xwikidoc>
