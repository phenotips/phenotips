/*! @source http://purl.eligrey.com/github/Blob.js/blob/master/Blob.js */

/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */

define("pedigree/model/helpers",[],function(){var e={};if(!t)var t=window.console;if(!window.console)var t={log:function(){}};return typeof String.prototype.trim!="function"&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Array.prototype.forEach||(Array.prototype.forEach=function(e){var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=arguments.length>=2?arguments[1]:void 0;for(var i=0;i<n;i++)i in t&&e.call(r,t[i],i,t)}),typeof HTMLElement!="undefined"&&!HTMLElement.prototype.click&&document.createEvent&&(HTMLElement.prototype.click=function(){var e=document.createEvent("MouseEvents");e.initEvent("click",!0,!0),this.dispatchEvent(e)}),e.clone2DArray=function(e){var t=[];for(var n=0;n<e.length;++n)t.push(e[n].slice());return t},e.cloneObject=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},e.copyProperties=function(e,t){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},e.arrayContains=function(e,t){if(Array.prototype.indexOf)return!(e.indexOf(t)<0);for(var n=0,r=e.length;n<r;++n)if(e[n]===t)return!0;return!1},e.arrayIndexOf=function(e,t){if(Array.prototype.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;++n)if(e[n]===t)return n;return-1},e.indexOfLastMinElementInArray=function(e){var t=e[0],n=0;for(var r=1,i=e.length;r<i;++r)e[r]<=t&&(n=r,t=e[r]);return n},e.filterUnique=function(e){var t={},n=[],r=e.length;while(r--)t[e[r]]||(t[e[r]]=!0,n.push(e[r]));return n},e.replaceInArray=function(e,t,n){for(var r=0,i=e.length;r<i;++r)if(e[r]===t){e[r]=n;break}},e.removeFirstOccurrenceByValue=function(e,t){for(var n=0,r=e.length;n<r;++n)if(e[n]==t){e.splice(n,1);break}},e.isObjectEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},e.numTextLines=function(e){if(e===null||e=="")return 0;var t=e.replace(/^\s+|\s+$/g,""),n=(t.match(/\n/g)||[]).length+1;return n},e.isInt=function(e){return!isNaN(e)&&parseInt(e)==parseFloat(e)},e.toObjectWithTrue=function(e){var t={};for(var n=0;n<e.length;++n)e[n]!==undefined&&(t[e[n]]=!0);return t},e.romanize=function(e){if(!+e)return!1;var t=String(+e).split(""),n=["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM","","X","XX","XXX","XL","L","LX","LXX","LXXX","XC","","I","II","III","IV","V","VI","VII","VIII","IX"],r="",i=3;while(i--)r=(n[+t.pop()+i*10]||"")+r;return Array(+t.join("")+1).join("M")+r},e.makeFlattened2DArrayCopy=function(e){var t=[].concat.apply([],e);return t},e.swap=function(e,t,n){var r=e[n];e[n]=e[t],e[t]=r},e.permute2DArrayInFirstDimension=function(t,n,r){var i=n.length;if(r==i-1){t.push(e.makeFlattened2DArrayCopy(n));return}for(var s=r;s<i;s++)e.swap(n,r,s),e.permute2DArrayInFirstDimension(t,n,r+1),e.swap(n,r,s)},e.Timer=function(){this.startTime=undefined,this.lastCheck=undefined,this.start()},e.Timer.prototype={start:function(){this.startTime=(new Date).getTime(),this.lastCheck=this.startTime},restart:function(){this.start()},report:function(){var e=(new Date).getTime(),t=e-this.lastCheck;return t},printSinceLast:function(e){var n=(new Date).getTime(),r=n-this.lastCheck;this.lastCheck=n,t.log(e+r+"ms")}},e.stringifyObject=function(e){return _printObjectInternal(e,1)},e.printObject=function(e){t.log(_printObjectInternal(e,0))},_printObjectInternal=function(e,t){if(t>10)return"...[too deep, possibly a recursive object]...";var n="";if(typeof e=="object")if(Object.prototype.toString.call(e)==="[object Array]"){n="[";for(var r=0;r<e.length;r++)r>0&&(n+=", "),n+=_printObjectInternal(e[r],t+1);n+="]"}else{n="{";var i=0;t==0&&(n+="\n");for(var s in e){if(!e.hasOwnProperty(s))continue;t!=0&&i!=0&&(n+=", "),n+=s+": "+_printObjectInternal(e[s],t+1),t==0&&(n+="\n"),i++}n+="}"}else typeof e=="string"?n="'"+e+"'":n=""+e;return n},e.padString=function(t,n,r,i){return n<=t.length?t:e.padString(i?r+t:t+r,n,r,i)},e}),define("pedigree/undoRedoManager",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(){this._currentState=0,this._stack=[],this._MAXUNDOSIZE=100,this._savedState=""},hasUnsavedChanges:function(){var e=this._getCurrentState();return e==null?!0:this._savedState==e.serializedState?!1:!0},hasRedo:function(){return this._getNextState()?!0:!1},hasUndo:function(){return this._getPreviousState()?!0:!1},addSaveEvent:function(){var e=this._getCurrentState();if(e==null)return;this._savedState=e.serializedState},redo:function(){var e=this._getNextState();if(!e)return;this._currentState++;if(e.eventToGetToThisState){var t=e.eventToGetToThisState.memo;t.noUndoRedo=!0,document.fire(e.eventToGetToThisState.eventName,t)}else editor.getSaveLoadEngine().createGraphFromSerializedData(e.serializedState,!0);document.fire("pedigree:historychange",null)},undo:function(){var e=this._getPreviousState();if(!e)return;var t=this._getCurrentState();this._currentState--;if(t.eventToUndo){var n=t.eventToUndo.memo;n.noUndoRedo=!0,document.fire(t.eventToUndo.eventName,n)}else editor.getSaveLoadEngine().createGraphFromSerializedData(e.serializedState,!0);document.fire("pedigree:historychange",null)},addState:function(t,n,r){this._currentState<this._size()&&this._stack.splice(this._currentState,this._stack.length-this._currentState),r||(r=editor.getSaveLoadEngine().serialize());var i=new e(r,t,n),s=this._getCurrentState();if(t&&s&&s.eventToGetToThisState&&s.eventToGetToThisState.eventName=="pedigree:node:setproperty"&&this._combinableEvents(s.eventToGetToThisState,t)){s.eventToGetToThisState=t,s.serializedState=r;return}this._addNewest(i),this._size()>this._MAXUNDOSIZE&&this._removeOldest(),document.fire("pedigree:historychange",null)},_combinableEvents:function(e,t){return!e.memo.hasOwnProperty("nodeID")||!t.memo.hasOwnProperty("nodeID")||e.memo.nodeID!=t.memo.nodeID?!1:e.memo.properties.hasOwnProperty("setFirstName")&&t.memo.properties.hasOwnProperty("setFirstName")?!0:e.memo.properties.hasOwnProperty("setLastName")&&t.memo.properties.hasOwnProperty("setLastName")?!0:e.memo.properties.hasOwnProperty("setLastNameAtBirth")&&t.memo.properties.hasOwnProperty("setLastNameAtBirth")?!0:e.memo.properties.hasOwnProperty("setComments")&&t.memo.properties.hasOwnProperty("setComments")?!0:e.memo.properties.hasOwnProperty("setChildlessReason")&&t.memo.properties.hasOwnProperty("setChildlessReason")?!0:!1},_size:function(){return this._stack.length},_addNewest:function(e){this._stack.push(e),this._currentState++},_removeOldest:function(){this._stack.splice(0,1),this._currentState--},_getCurrentState:function(){return this._size()==0||this._currentState==0?null:this._stack[this._currentState-1]},_getNextState:function(){return this._size()<=1||this._currentState>=this._size()?null:this._stack[this._currentState]},_getPreviousState:function(){return this._size()==1||this._currentState<=1?null:this._stack[this._currentState-2]},_debug_print_states:function(){console.log("------------");for(var e=0;e<this._stack.length;e++)console.log("["+e+"] EventToState: "+Helpers.stringifyObject(this._stack[e].eventToGetToThisState)+"\n"+"    EventUndo: "+Helpers.stringifyObject(this._stack[e].eventToUndo)+"\n"+"    EventSerial: "+Helpers.stringifyObject(this._stack[e].serializedState));console.log("------------")}}),e=Class.create({initialize:function(e,t,n){this.serializedState=e,this.eventToGetToThisState=t,this.eventToUndo=n}});return t}),define("pedigree/controller",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(){document.observe("pedigree:autolayout",this.handleAutoLayout),document.observe("pedigree:graph:clear",this.handleClearGraph),document.observe("pedigree:undo",this.handleUndo),document.observe("pedigree:redo",this.handleRedo),document.observe("pedigree:renumber",this.handleRenumber),document.observe("pedigree:historychange",this.handleUndoHistoryChange),document.observe("pedigree:node:remove",this.handleRemove),document.observe("pedigree:node:setproperty",this.handleSetProperty),document.observe("pedigree:node:modify",this.handleModification),document.observe("pedigree:person:drag:newparent",this.handlePersonDragToNewParent),document.observe("pedigree:person:drag:newpartner",this.handlePersonDragToNewPartner),document.observe("pedigree:person:drag:newsibling",this.handlePersonDragToNewSibling),document.observe("pedigree:person:newparent",this.handlePersonNewParents),document.observe("pedigree:person:newsibling",this.handlePersonNewSibling),document.observe("pedigree:person:newpartnerandchild",this.handlePersonNewPartnerAndChild),document.observe("pedigree:partnership:newchild",this.handleRelationshipNewChild)},handleUndo:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo)),editor.getUndoRedoManager().undo()},handleRedo:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo)),editor.getUndoRedoManager().redo()},handleRenumber:function(t){var n=t.memo.hasOwnProperty("check"),r=!1,i=!1;do{var s=!1;for(var o in editor.getView().getNodeMap())if(editor.getView().getNodeMap().hasOwnProperty(o)&&editor.getGraph().isPerson(o)){var u=editor.getView().getNode(o),a=u.getPedNumber();if(r)var f="";else{var l=editor.getGraph().getGeneration(o),c=editor.getGraph().getOrderWithinGeneration(o),f=e.romanize(l)+"-"+c;if(n&&f!=a){r=!0,s=!0;break}}if(a!=f){i=!0,u.setPedNumber(f);var h=u.getProperties();editor.getGraph().setProperties(o,h)}}}while(s);var p=$("action-number");r?(p.removeClassName("disabled-menu-item"),p.addClassName("menu-item")):(p.removeClassName("menu-item"),p.addClassName("disabled-menu-item")),!t.memo.noUndoRedo&&i&&(editor.getView().unmarkAll(),editor.getUndoRedoManager().addState(t))},handleUndoHistoryChange:function(){var e=$("action-redo");editor.getUndoRedoManager().hasRedo()?(e.removeClassName("disabled-menu-item"),e.addClassName("menu-item")):(e.removeClassName("menu-item"),e.addClassName("disabled-menu-item"));var t=$("action-undo");editor.getUndoRedoManager().hasUndo()?(t.removeClassName("disabled-menu-item"),t.addClassName("menu-item")):(t.removeClassName("menu-item"),t.addClassName("disabled-menu-item"))},handleAutoLayout:function(t){try{console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=editor.getGraph().redrawAll();editor.getView().applyChanges(n,!0),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)}catch(r){console.log("Autolayout error: "+r)}},handleClearGraph:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=editor.getGraph().clearAll();editor.getView().applyChanges(n,!0),editor.getWorkspace().centerAroundNode(0,!1),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)},handleRemove:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.nodeID,r=editor.getGraph().getDisconnectedSetIfNodeRemoved(n),i=!1;if(editor.getGraph().isPerson(n)&&editor.getGraph().isOnlyChild(n)){var s=editor.getGraph().getParentRelationship(n);e.arrayContains(r,s)||(i=!0)}var o=function(){try{if(i){e.removeFirstOccurrenceByValue(r,n),editor.getGraph().setProperties(n,{gender:"U",placeholder:!0});if(!editor.getGraph().isChildless(s)){var o=editor.getView().getNode(s);o.setChildlessStatus("childless");var u=o.getProperties();editor.getGraph().setProperties(s,u)}}var a=editor.getGraph().removeNodes(r);if(i){a.removed.push(n);var f=a.changedIDSet.hasOwnProperty(n)?a.changedIDSet[n]:n;a["new"]=[f]}editor.getView().applyChanges(a,!0);var a=editor.getGraph().improvePosition();editor.getView().applyChanges(a,!0),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)}catch(l){console.log("[DEBUG] Remove error: "+l)}};if(r.length<=1||t.memo.hasOwnProperty("noUndoRedo")){o();return}editor.getView().unmarkAll();for(var u=0;u<r.length;u++){var a=r[u];editor.getView().getNode(a).getGraphics().markPermanently()}var f=function(){for(var e=0;e<r.length;e++){var t=r[e];editor.getView().getNode(t).getGraphics().unmark()}};editor.getOkCancelDialogue().show("All highlighted nodes will be removed. Do you want to proceed?","Delete nodes?",o,f)},handleSetProperty:function(n){var r=n.memo.nodeID,i=n.memo.properties,s={eventName:n.eventName,memo:{nodeID:r,properties:e.cloneObject(n.memo.properties)}},o=editor.getView().getNode(r),u=!1,a=undefined,f=!1,l=!1,c=!1,h=!1,p=!1;for(var d in i)if(i.hasOwnProperty(d)){var v=i[d];if(!t._validatePropertyValue(r,d,v))continue;var m=d.replace("set","get"),g=o[m]();if(g==v)continue;if(g&&typeof g=="object"&&typeof v=="object"&&(d=="setDeathDate"||d=="setBirthDate"))try{if(g.decade==v.decade&&g.year==v.year&&g.month==v.month&&g.day==v.day)continue}catch(y){}Object.prototype.toString.call(g)==="[object Array]"?g=g.slice(0):typeof g=="object"&&(g=e.cloneObject(g)),s.memo.properties[d]=g,d=="setLifeStatus"&&(s.memo.properties.setDeathDate=o.getDeathDate(),s.memo.properties.setGestationAge=o.getGestationAge(),s.memo.properties.setBirthDate=o.getBirthDate(),s.memo.properties.setAdopted=o.getAdopted()),d=="setDeathDate"&&(s.memo.properties.setLifeStatus=o.getLifeStatus()),d=="setChildlessStatus"&&(s.memo.properties.setChildlessReason=o.getChildlessReason()),d=="setDisorders"&&(s.memo.properties.setCarrierStatus=o.getCarrierStatus()),d=="setCarrierStatus"&&(s.memo.properties.setDisorders=o.getDisorders().slice(0)),o[d](v);if(d=="setDisorders"){var b=o[m]();if(JSON.stringify(g)==JSON.stringify(b))continue}p=!0,d=="setLastName"&&editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")&&o.getGender(r)=="M"&&(t._propagateLastNameAtBirth(r,v,g),s=null),d=="setGender"&&(o.getMonozygotic()&&(a||(a={}),a[d]=v),g=="U"&&v=="M"&&o.getLastName()==""&&o.getLastNameAtBirth()!=""&&editor.getGraph().getAllChildren(r).length==0&&(o.setLastName(o.getLastNameAtBirth()),o.setLastNameAtBirth(""),s=null)),d=="setBirthDate"&&(a||(a={}),a[d]=v),d=="setAdopted"&&(f=!0,v=="adoptedIn"&&(a||(a={}),a[d]=v),g=="adoptedIn"&&(a||(a={}),a[d]="")),(d=="setComments"||d=="setExternalID"||d=="setFirstName"||d=="setLastName")&&e.numTextLines(g)!=e.numTextLines(v)&&(h=!0);if(d=="setBirthDate"||d=="setDeathDate")h=!0;d=="setMonozygotic"&&(l=!0,a||(a={}),a[d]=v);if(d=="setConsanguinity"||d=="setBrokenStatus")l=!0;d=="setLostContact"&&(c=!0)}if(a){var w=editor.getGraph().getAllTwinsSortedByOrder(r);for(var d in a)if(a.hasOwnProperty(d)){var v=a[d];for(var E=0;E<w.length;E++){var S=w[E];if(S==r)continue;var x=editor.getView().getNode(S);x[d](v);var T=x.getProperties();console.log("Setting twin properties: "+e.stringifyObject(T)),editor.getGraph().setProperties(S,T)}}}var N=o.getProperties();editor.getGraph().setProperties(r,N);if(f){var C=editor.getGraph().updateAncestors();editor.getView().applyChanges(C,!0)}if(c){var k=editor.getGraph().getAllRelatedRelationships(r),C={moved:k};editor.getView().applyChanges(C,!0)}if(l){var L=editor.getGraph().isRelationship(r)?r:editor.getGraph().getParentRelationship(r),C={moved:[L]};editor.getView().applyChanges(C,!0)}if(h){var C=editor.getGraph().updateYPositioning();editor.getView().applyChanges(C,!0)}editor.getNodeMenu().update(),!n.memo.noUndoRedo&&p&&editor.getUndoRedoManager().addState(n,s)},handleModification:function(t){try{console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.nodeID,r=t.memo.modifications,i=editor.getView().getNode(n);for(modificationType in r)if(r.hasOwnProperty(modificationType)){var s=r[modificationType];if(modificationType=="addTwin"){var o=s-1;for(var u=0;u<o;u++){var a={gender:i.getGender()};i.getAdopted()=="adoptedIn"&&(a.adoptedStatus=i.getAdopted());var f=editor.getGraph().addTwin(n,a);editor.getView().applyChanges(f,!0)}i.assignProperties(editor.getGraph().getProperties(n))}modificationType=="makePlaceholder"}t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)}catch(l){console.log("err: "+l)}},handlePersonDragToNewParent:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.personID,r=t.memo.parentID;if(!editor.getGraph().isPerson(n)||!editor.getGraph().isValidID(r))return;if(editor.getGraph().isRelationship(r)&&editor.getGraph().isChildlessByChoice(r)){var i=editor.getView().getNode(r);i.setChildlessStatus(null);var s=i.getProperties();editor.getGraph().setProperties(r,s)}editor.getGraph().isChildless(r)&&editor.getController().handleSetProperty({memo:{nodeID:n,properties:{setAdopted:"adoptedIn"},noUndoRedo:!0}});try{var o=editor.getGraph().assignParent(r,n);editor.getView().applyChanges(o,!0),o.moved.indexOf(n)!=-1&&editor.getWorkspace().centerAroundNode(n,!0),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)}catch(u){console.log("err: "+u)}},handlePersonNewParents:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.personID;if(!editor.getGraph().isPerson(n))return;var r=editor.getGraph().addNewParents(n);return editor.getView().applyChanges(r,!0),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t),r["new"][0]},handlePersonNewSibling:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.personID,r=t.memo.childParams?e.cloneObject(t.memo.childParams):{},i=t.memo.twins?t.memo.twins:1,s=t.memo.groupSize?t.memo.groupSize:0,o=editor.getGraph().getParentRelationship(n);o===null&&(o=editor.getController().handlePersonNewParents({memo:{personID:n,noUndoRedo:!0}}));if(t.memo.twins){var u={nodeID:n,modifications:{addTwin:t.memo.twins},noUndoRedo:!0};editor.getController().handleModification({memo:u})}else{var u={partnershipID:o,childParams:r,noUndoRedo:!0};t.memo.groupSize&&(u.groupSize=t.memo.groupSize),editor.getController().handleRelationshipNewChild({memo:u})}t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)},handlePersonDragToNewSibling:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.sibling1ID,r=t.memo.sibling2ID,i=editor.getGraph().getParentRelationship(n);i==null&&(i=editor.getGraph().getParentRelationship(r)),i===null&&(i=editor.getController().handlePersonNewParents({memo:{personID:n,noUndoRedo:!0}})),editor.getGraph().getParentRelationship(r)!=i?editor.getController().handlePersonDragToNewParent({memo:{personID:r,parentID:i,noUndoRedo:!0}}):editor.getController().handlePersonDragToNewParent({memo:{personID:n,parentID:i,noUndoRedo:!0}}),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)},handlePersonNewPartnerAndChild:function(t){var n=new e.Timer;try{console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var r=t.memo.personID;if(!editor.getGraph().isPerson(r))return;var i=t.memo.preferLeft,s=t.memo.childParams?e.cloneObject(t.memo.childParams):{},o=t.memo.twins?t.memo.twins:1,u=t.memo.groupSize?t.memo.groupSize:0;editor.getGraph().isChildless(r)&&(s.adoptedStatus="adoptedIn"),u>0&&(s.numPersons=u);if(editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var a=null;editor.getGraph().getGender(r)=="M"&&(a=editor.getGraph().getLastName(r)),a&&a!=""&&(s.hasOwnProperty("gender")&&s.gender=="M"?s.lName=a:s.lNameAtB=a)}var f=editor.getGraph().addNewRelationship(r,s,i,o);editor.getView().applyChanges(f,!0),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)}catch(l){console.log("err: "+l)}n.printSinceLast("=== Total new partner+child runtime: ")},handlePersonDragToNewPartner:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.personID,r=t.memo.partnerID;if(!editor.getGraph().isPerson(n)||!editor.getGraph().isPerson(r))return;var i={};if(editor.getGraph().isChildless(n)||editor.getGraph().isChildless(r))i.adoptedStatus="adoptedIn";var s=editor.getView().getNode(n),o=editor.getView().getNode(r);if(s.getGender()=="U"&&o.getGender()!="U"){var u=editor.getGraph().getOppositeGender(r);s.setGender(u),editor.getGraph().setProperties(n,s.getProperties())}else if(s.getGender()!="U"&&o.getGender()=="U"){var a=editor.getGraph().getOppositeGender(n);o.setGender(a),editor.getGraph().setProperties(r,o.getProperties())}if(editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var f=null;s.getGender()=="M"?f=editor.getGraph().getLastName(n):o.getGender()=="M"&&(f=editor.getGraph().getLastName(r)),f&&f!=""&&(i.lNameAtB=f)}var l=editor.getGraph().assignPartner(n,r,i);editor.getView().applyChanges(l,!0),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)},handleRelationshipNewChild:function(t){console.log("event: "+t.eventName+", memo: "+e.stringifyObject(t.memo));var n=t.memo.partnershipID;if(!editor.getGraph().isRelationship(n))return;var r=t.memo.twins?t.memo.twins:1,i=e.cloneObject(t.memo.childParams);editor.getGraph().isInfertile(n)&&(i.adoptedStatus="adoptedIn");var s=t.memo.groupSize?t.memo.groupSize:0;s>0&&(i.numPersons=s);if(editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var o=editor.getGraph().getRelationshipChildLastName(n);o&&(i.gender=="M"?i.lName=o:i.lNameAtB=o)}var u=editor.getGraph().getRelationshipChildrenSortedByOrder(n);if(u.length==1&&editor.getGraph().isPlaceholder(u[0])){var a=editor.getGraph().convertPlaceholderTo(u[0],i);if(editor.getGraph().isChildlessByChoice(n)){var f=editor.getView().getNode(n);f.setChildlessStatus(null);var l=f.getProperties();editor.getGraph().setProperties(n,l)}}else var a=editor.getGraph().addNewChild(n,i,r);editor.getView().applyChanges(a,!0),t.memo.noUndoRedo||editor.getUndoRedoManager().addState(t)}});return t._validatePropertyValue=function(e,t,n){if(t=="setGender"){var r=editor.getGraph().getPossibleGenders(e);return r[n]}return!0},t._propagateLastNameAtBirth=function(e,n,r){var i=editor.getGraph().getAllChildren(e);for(var s=0;s<i.length;s++){var o=i[s],u=editor.getView().getNode(o);if(u.getLastNameAtBirth()==r||u.getLastNameAtBirth()==""&&(u.getLastName()==""||u.getGender()=="M"&&u.getLastName()==r)){u.getGender()=="M"&&u.getLastNameAtBirth()!=r?u.setLastName(n):u.setLastNameAtBirth(n);var a=u.getProperties();editor.getGraph().setProperties(o,a),u.getGender()=="M"&&t._propagateLastNameAtBirth(o,n,r)}}},t}),define("pedigree/pedigreeEditorParameters",[],function(){var e={};return e.styles={blackAndWhite:{nodeShapeFemale:{fill:"#ffffff",stroke:"#222222"},nodeShapeMale:{fill:"#ffffff",stroke:"#111111"},nodeShapeOther:{fill:"#ffffff",stroke:"#222222"},nodeShapeDiag:{fill:"#ffffff",stroke:"#222222"},nodeShapeAborted:{fill:"#ffffff",stroke:"#222222"}},gradient:{nodeShapeFemale:{fill:"0-#ffffff:0-#B8B8B8:100",stroke:"#595959"},nodeShapeMale:{fill:"0-#ffffff:0-#B8B8B8:100",stroke:"#696969"},nodeShapeOther:{fill:"45-#ffffff:0-#B8B8B8:100",stroke:"#595959"},nodeShapeDiag:{fill:"45-#ffffff:0-#B8B8B8:100",stroke:"#595959"},nodeShapeAborted:{fill:"0-#ffffff:0-#B8B8B8:100",stroke:"#595959"}}},e.attributes={radius:40,orbRadius:6,touchOrbRadius:8,personHoverBoxRadius:90,newHandles:!0,personHandleLength:75,personHandleBreakX:55,personHandleBreakY:53,personSiblingHandleLengthX:65,personSiblingHandleLengthY:30,enableHandleHintImages:!0,handleStrokeWidth:5,groupNodesScale:.85,infertileMarkerHeight:4,infertileMarkerWidth:14,twinCommonVerticalLength:6,twinMonozygothicLineShiftY:24,curvedLinesCornerRadius:25,unbornShape:{"font-size":50,"font-family":"Cambria"},carrierShape:{fill:"#595959"},carrierDotRadius:8,presymptomaticShape:{fill:"#777777",stroke:"#777777"},presymptomaticShapeWidth:8,uncertainShape:{"font-size":"45px","font-family":"Arial",fill:"#696969","font-weight":"bold"},uncertainSmallShape:{"font-size":"30px","font-family":"Arial",fill:"#696969","font-weight":"bold"},evaluationShape:{"font-size":40,"font-family":"Arial"},nodeShapeFemale:e.styles.gradient.nodeShapeFemale,nodeShapeMale:e.styles.gradient.nodeShapeMale,nodeShapeOther:e.styles.gradient.nodeShapeOther,nodeShapeDiag:e.styles.gradient.nodeShapeDiag,nodeShapeAborted:e.styles.gradient.nodeShapeAborted,nodeShapeMenuOn:{fill:"#000",stroke:"none","fill-opacity":.1},nodeShapeMenuOff:{fill:"#000",stroke:"none","fill-opacity":0},nodeShapeMenuOnPartner:{fill:"#000",stroke:"none","fill-opacity":.1},nodeShapeMenuOffPartner:{fill:"#000",stroke:"none","fill-opacity":0},boxOnHover:{fill:"gray",stroke:"none",opacity:1,"fill-opacity":.35},menuBtnIcon:{fill:"#1F1F1F",stroke:"none"},deleteBtnIcon:{fill:"#990000",stroke:"none"},btnMaskHoverOn:{opacity:.6,stroke:"none"},btnMaskHoverOff:{opacity:0},btnMaskClick:{opacity:1},orbHue:.53,phShape:{fill:"white","fill-opacity":0,stroke:"black","stroke-dasharray":"- "},dragMeLabel:{"font-size":14,"font-family":"Tahoma"},pedNumberLabel:{"font-size":19,"font-family":"Serif"},descendantGroupLabel:{"font-size":21,"font-family":"Tahoma"},label:{"font-size":20,"font-family":"Arial"},nameLabels:{"font-size":20,"font-family":"Arial"},commentLabel:{"font-size":19,"font-family":"Arial"},externalIDLabels:{"font-size":18,"font-family":"Arial"},disorderShapes:{},partnershipNode:{fill:"#dc7868",stroke:"black","stroke-width":2},partnershipRadius:6.5,partnershipHandleBreakY:18,partnershipHandleLength:36,partnershipLines:{"stroke-width":1.25,stroke:"#303058"},partnershipLinesAdoptedIn:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"--"},consangrPartnershipLines:{"stroke-width":1.25,stroke:"#402058"},noContactLines:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"-.-."},noContactAdoptedIn:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"-- ."},noContactLinesConsangr:{"stroke-width":1.25,stroke:"#402058","stroke-dasharray":"-.-."},childlessShapeAttr:{"stroke-width":2.5,stroke:"#3C3C3C"},partnershipChildlessShapeAttr:{"stroke-width":2,stroke:"#3C3C3C"},childlessLength:14,parnershipChildlessLength:27,graphToCanvasScale:12,layoutRelativePersonWidth:10,layoutRelativeOtherWidth:2,layoutScale:{xscale:12,yscale:8}},e}),define("pedigree/preferencesManager",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(e){this.preferences=e},load:function(e){var t=$xwiki.getDocument("XWiki.XWikiPreferences").getObjectNumbers("PhenoTips.PedigreeGlobalSettings");t>0&&(this.preferences.global.dateDisplayFormat="$!{xwiki.getDocument('XWiki.XWikiPreferences').getObject('PhenoTips.PedigreeGlobalSettings').getProperty('dateDisplayFormat').value}",this.preferences.global.dateEditFormat="$!{xwiki.getDocument('XWiki.XWikiPreferences').getObject('PhenoTips.PedigreeGlobalSettings').getProperty('dateInputFormat').value}",this.preferences.global.nonStandardAdoptedOutGraphic=!1,this.preferences.global.propagateFatherLastName=!1,this.preferences.global.useGradientOnNodes=!1),this.onPreferencesAvailable(),e()},onPreferencesAvailable:function(t){this.preferences||(this.preferences={}),this.preferences.hasOwnProperty("global")||(this.preferences.global={}),console.log("Loaded global preferences: "+e.stringifyObject(this.preferences.global))},getConfigurationOption:function(e){return this.preferences.pedigree.hasOwnProperty(e)?this.preferences.pedigree[e]:this.preferences.user.hasOwnProperty(e)?this.preferences.user[e]:this.preferences.global.hasOwnProperty(e)?this.preferences.global[e]:null},setConfigurationOption:function(e,t,n){if(e=="user")this.preferences.user[t]=n;else{if(e!="pedigree")throw"Unsupported options domain: "+e;this.preferences.pedigree[t]=n}}});return t}),define("pedigree/probandDataLoader",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(){this.probandData={}},load:function(e){var t=XWiki.currentDocument.page,n=(new XWiki.Document("ExportPatient","PhenoTips")).getURL("get","id="+t);n+="&rand="+Math.random(),new Ajax.Request(n,{method:"GET",onSuccess:this.onProbandDataReady.bind(this),onComplete:e?e:{}})},onProbandDataReady:function(t){t.responseJSON?this.probandData=t.responseJSON:console.log("[!] Error parsing patient JSON"),console.log("Proband data: "+e.stringifyObject(this.probandData))}});return t}),define("pedigree/view/templateSelector",["pedigree/model/helpers"],function(e){function n(e){var t=document.createElement("div");return t.innerHTML=e.replace(/&amp;/,"&"),t.innerText||t.text||t.textContent}function r(e,t,n,r){if(e.querySelector)return e.querySelector(t+"["+n+"='"+r+"']");var i=".//"+t+"[@"+n+"='"+r+"']";try{return e.selectSingleNode(i)}catch(s){throw alert("your browser is unsupported"),window.stop&&window.stop(),"Unsupported browser"}}function i(e,t,n,i,s){var o=r(e,t,n,i),u=o.innerText||o.text||o.textContent;return u||(u=""),u}var t=Class.create({initialize:function(e){this._isStartupTemplateSelector=e,this.mainDiv=new Element("div",{"class":"template-picture-container"}),this.mainDiv.update("Loading list of templates...");var t=e?[]:["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(this.mainDiv,{close:{method:this.hide.bind(this),keys:t}},{extraClassName:"pedigree-template-chooser",title:"Please select a pedigree template",displayCloseButton:!e,verticalPosition:"top"}),e&&this.dialog.show(),new Ajax.Request((new XWiki.Document("WebHome")).getRestURL("objects/PhenoTips.PedigreeClass/"),{method:"GET",onSuccess:this._onTemplateListAvailable.bind(this)})},isStartupTemplateSelector:function(){return this._isStartupTemplateSelector},_onTemplateListAvailable:function(e){this.mainDiv.update();var t=e.responseXML.documentElement.getElementsByTagName("objectSummary");for(var n=0;n<t.length;++n){var i=new Element("div",{"class":"picture-box"});i.update("Loading..."),this.mainDiv.insert(i);var s=r(t[n],"link","rel","http://www.xwiki.org/rel/properties").getAttribute("href"),o=s.substring(s.indexOf("/",s.indexOf("//")+2));new Ajax.Request(o,{method:"GET",onSuccess:this._onTemplateAvailable.bind(this,i)})}},_onTemplateAvailable:function(e,t){e.innerHTML=i(t.responseXML,"property","name","image","value").replace(/&amp;/,"&"),e.pedigreeData=i(t.responseXML,"property","name","data","value"),e.type="internal",e.description=i(t.responseXML,"property","name","description","value"),e.title=e.description,window.SVGSVGElement&&document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")?e.update(i(t.responseXML,"property","name","image","value")):e.innerHTML="<table bgcolor='#FFFAFA'><tr><td><br>&nbsp;"+e.description+"&nbsp;<br><br></td></tr></table>",e.observe("click",this._onTemplateSelected.bindAsEventListener(this,e))},_onTemplateSelected:function(e,t){this.dialog.close(),t.type=="internal"?editor.getSaveLoadEngine().createGraphFromSerializedData(t.pedigreeData,!1,!0):t.type=="simpleJSON"&&editor.getSaveLoadEngine().createGraphFromImportData(t.pedigreeData,"simpleJSON",{},!1,!0)},show:function(){this.dialog.show()},hide:function(){this.dialog.closeDialog()}});return t}),define("pedigree/saveLoadEngine",["pedigree/model/helpers","pedigree/view/templateSelector"],function(e,t){var n=Class.create({initialize:function(){this._saveInProgress=!1},serialize:function(){var e=editor.getGraph().toJSONObject();return e.settings=editor.getView().getSettings(),JSON.stringify(e)},createGraphFromSerializedData:function(e,t,n){console.log("---- load: parsing data ----"),document.fire("pedigree:load:start");try{var r=JSON.parse(e),i=editor.getGraph().fromJSONObject(r);r.hasOwnProperty("settings")&&editor.getView().loadSettings(r.settings)}catch(s){console.log("ERROR loading the graph: "+s),alert("Error loading the graph"),document.fire("pedigree:graph:clear"),document.fire("pedigree:load:finish");return}if(!t){var o=editor.getProbandDataFromPhenotips(),u=editor.getGraph().setProbandData(o);u||alert("Proband gender defined in Phenotips is incompatible with this pedigree. Setting proband gender to 'Unknown'"),e=this.serialize()}editor.getView().applyChanges(i,!1)&&editor.getWorkspace().adjustSizeToScreen(),n&&editor.getWorkspace().centerAroundNode(0),t||editor.getUndoRedoManager().addState(null,null,e),document.fire("pedigree:load:finish")},createGraphFromImportData:function(e,t,n,r,i){console.log("---- import: parsing data ----"),document.fire("pedigree:load:start");try{var s=editor.getGraph().fromImport(e,t,n);if(s==null)throw"unable to create a pedigree from imported data"}catch(o){alert("Error importing pedigree: "+o),document.fire("pedigree:load:finish");return}if(!r){var u=editor.getProbandDataFromPhenotips(),a=editor.getGraph().setProbandData(u);a||alert("Proband gender defined in Phenotips is incompatible with the imported pedigree. Setting proband gender to 'Unknown'"),JSONString=this.serialize()}editor.getView().applyChanges(s,!1)&&editor.getWorkspace().adjustSizeToScreen(),i&&editor.getWorkspace().centerAroundNode(0),r||editor.getUndoRedoManager().addState(null,null,JSONString),document.fire("pedigree:load:finish")},save:function(){if(this._saveInProgress)return;editor.getView().unmarkAll();var t=this,n=this.serialize();console.log("[SAVE] data: "+e.stringifyObject(n));var r=$("canvas"),i=r.getElementsByClassName("panning-background")[0],s=i.nextSibling,o=i.parentNode;o.removeChild(i);var u=r.down().getBBox(),a=new XWiki.widgets.Notification("Saving","inprogress");new Ajax.Request(XWiki.currentDocument.getRestURL("objects/PhenoTips.PedigreeClass/0","method=PUT"),{method:"POST",onCreate:function(){t._saveInProgress=!0;var e=$("action-close"),n=$("action-save");Element.addClassName(n,"disabled-menu-item"),Element.removeClassName(n,"menu-item"),Element.addClassName(n,"no-mouse-interaction"),Element.addClassName(e,"disabled-menu-item"),Element.removeClassName(e,"menu-item"),Element.addClassName(e,"no-mouse-interaction")},onComplete:function(){t._saveInProgress=!1;var e=editor.getAfterSaveAction();e&&e();var n=$("action-close"),r=$("action-save");Element.addClassName(r,"menu-item"),Element.removeClassName(r,"disabled-menu-item"),Element.removeClassName(r,"no-mouse-interaction"),Element.addClassName(n,"menu-item"),Element.removeClassName(n,"disabled-menu-item"),Element.removeClassName(n,"no-mouse-interaction")},onSuccess:function(){editor.getUndoRedoManager().addSaveEvent(),a.replace(new XWiki.widgets.Notification("Successfully saved"))},parameters:{"property#data":n,"property#image":r.innerHTML.replace(/xmlns:xlink=".*?"/,"").replace(/width=".*?"/,"").replace(/height=".*?"/,"").replace(/viewBox=".*?"/,'viewBox="'+u.x+" "+u.y+" "+u.width+" "+u.height+'" width="'+u.width+'" height="'+u.height+'" xmlns:xlink="http://www.w3.org/1999/xlink"')}}),o.insertBefore(i,s)},load:function(){console.log("initiating load process");var n=XWiki.currentDocument.page,r=(new XWiki.Document("ExportPatient","PhenoTips")).getURL("get","id="+n);r+="&data=pedigree",r+="&rand="+Math.random(),new Ajax.Request(r,{method:"GET",onCreate:function(){document.fire("pedigree:load:start")},onSuccess:function(n){if(n.responseJSON){console.log("[LOAD] recived JSON: "+e.stringifyObject(n.responseJSON));var r=editor.getVersionUpdater().updateToCurrentVersion(n.responseText);this.createGraphFromSerializedData(r),editor.getUndoRedoManager().addSaveEvent()}else new t(!0)}.bind(this)})}});return n}),define("pedigree/versionUpdater",[],function(){return VersionUpdater=Class.create({initialize:function(){this.availableUpdates=[{comment:"group node comment representation",introduced:"May2014",func:"updateGroupNodeComments"},{comment:"adopted status",introduced:"Nov2014",func:"updateAdoptedStatus"},{comment:"id desanitation",introduced:"Mar2015",func:"updateId"}]},updateToCurrentVersion:function(e){for(var t=0;t<this.availableUpdates.length;t++){var n=this.availableUpdates[t],r=this[n.func](e);r!==null&&(console.log("[update #"+t+"] [updating to "+n.introduced+" version] - performing "+n.comment+" update"),e=r)}return e},updateGroupNodeComments:function(e){var t=!1,n=JSON.parse(e);for(var r=0;r<n.GG.length;r++){var i=n.GG[r];i.hasOwnProperty("prop")&&i.prop.hasOwnProperty("numPersons")&&!i.prop.hasOwnProperty("comments")&&i.prop.hasOwnProperty("fName")&&i.prop.hasOwnProperty("fName")!=""&&(i.prop.comments=i.prop.fName,delete i.prop.fName,t=!0)}return t?JSON.stringify(n):null},updateAdoptedStatus:function(e){var t=!1,n=JSON.parse(e);for(var r=0;r<n.GG.length;r++){var i=n.GG[r];i.hasOwnProperty("prop")&&i.prop.hasOwnProperty("isAdopted")&&(i.prop.isAdopted&&(i.prop.adoptedStatus="adoptedIn"),delete i.prop.isAdopted,t=!0)}return t?JSON.stringify(n):null},updateId:function(e){function o(e){var t=e.replace(/__/g," ");return t=t.replace(/_C_/g,":"),t=t.replace(/_L_/g,"("),t.replace(/_J_/g,")")}var t=!1,n=JSON.parse(e);for(var r=0;r<n.GG.length;r++){var i=n.GG[r];if(i.hasOwnProperty("prop")){if(i.prop.hasOwnProperty("disorders"))for(var s=0;s<i.prop.disorders.length;s++)i.prop.disorders[s]=o(i.prop.disorders[s]),t=!0;if(i.prop.hasOwnProperty("hpoTerms"))for(var s=0;s<i.prop.hpoTerms.length;s++)i.prop.hpoTerms[s]=o(i.prop.hpoTerms[s]),t=!0;if(i.prop.hasOwnProperty("candidateGenes"))for(var s=0;s<i.prop.candidateGenes.length;s++)i.prop.candidateGenes[s]=o(i.prop.candidateGenes[s]),t=!0}}return t?JSON.stringify(n):null}}),VersionUpdater}),define("pedigree/view/lineSet",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(){this._lineCrossings={},this._lines=[]},replaceIDs:function(e){var t={};for(var n in this._lineCrossings)if(this._lineCrossings.hasOwnProperty(n)){var r=this._lineCrossings[n],i={};for(var s in r)if(r.hasOwnProperty(s)){var o=e.hasOwnProperty(s)?e[s]:s;i[o]=!0}var u=e.hasOwnProperty(n)?e[n]:n;t[u]=i}this._lineCrossings=t;for(var a=0;a<this._lines.length;a++){var s=this._lines[a].owner,o=e.hasOwnProperty(s)?e[s]:s;this._lines[a].owner=o}},addLine:function(e,t,n,r,i){this._lineCrossings.hasOwnProperty(e)||(this._lineCrossings[e]={});var s=[],o={owner:e,x1:t,y1:n,x2:r,y2:i};for(var u=0;u<this._lines.length;u++){var a=this._lines[u];if(a.owner==e)continue;var f=this._getLineCrossing(o,a);f&&(this._lineCrossings[a.owner][e]=!0,s.push(f))}return this._lines.push(o),s},removeAllLinesByOwner:function(e){if(!this._lineCrossings.hasOwnProperty(e))return{};for(var t=this._lines.length-1;t>=0;t--){var n=this._lines[t];n.owner==e&&this._lines.splice(t,1)}var r=this._lineCrossings[e];delete this._lineCrossings[e];for(var i in this._lineCrossings)if(this._lineCrossings.hasOwnProperty(i)){var s=this._lineCrossings[i];s.hasOwnProperty(e)&&delete s[e]}return r},removeAllLinesAffectedByOwnerMovement:function(e){var t=[],n={};n[e]=!0;var r=[e];while(r.length>0){var i=r.pop(),s=this.removeAllLinesByOwner(i);for(var o in s)s.hasOwnProperty(o)&&(n.hasOwnProperty(o)||(r.push(parseInt(o)),t.push(parseInt(o)),n[o]=!0))}return t},_getLineCrossing:function(e,t){var n=e.x2-e.x1,r=t.x1-t.x2,i=e.y2-e.y1,s=t.y1-t.y2,o=t.x1-e.x1,u=t.y1-e.y1,a=n*s-r*i;if(Math.abs(a)<=.001)return null;var f=(o*s-r*u)/a,l=(n*u-o*i)/a;if(f<=0||f>=1||l<=0||l>=1)return 0;var c=e.x1+f*(e.x2-e.x1),h=e.y1+f*(e.y2-e.y1);return{x:c,y:h}}});return t}),define("pedigree/view/graphicHelpers",[],function(){var e={};return e.sector=function(t,n,r,i,s,o,u,a){var f,l=s,c=n,h=r,p=i,d=t,v=Math.PI/180,m={fill:a,"stroke-width":0},g=function(e){var t=c+p*Math.cos(-e*v),n=h+p*Math.sin(-e*v);return[t,n]};if(l==="F"){if(u-o==360)return d.circle(c,h,p).attr(m);var y=g(o)[0],b=g(u)[0],w=g(o)[1],E=g(u)[1];return d.path(["M",c,h,"L",y,w,"A",p,p,0,+(u-o>180),0,b,E,"z"]).attr(m)}if(l==="M"){function S(e){return((e+45)/90).floor()%4}function x(e){var t=e*Math.PI/180;return Math.tan(t)}function T(e){var t=S(e),n={},r=t%2,i=1-t%2,s=t%3?-1:1;n.angle=(e-t*90-(t==0&&e>45?360:0))*(t<2?-1:1);var o=p*x(n.angle);return n.x=c+r*o+i*s*p,n.y=h+i*o+r*s*p,n}function N(e){var t=e%3?-1:1,n=e<2?-1:1,r={};return r.x=c+t*p,r.y=h+n*p,r}var C=S(o),k=S(u);k==0&&u>o&&(k=o>=315?0:4);var L=k-C,A=T(o),O=T(u),M=["M",O.x,O.y,"L",c,h,"L",A.x,A.y],_=C;while(L>0)M.push("L",N(_).x+" "+N(_).y),_=++_%4,L--;return M.push("L",O.x,O.y,"z"),d.path(M).attr(m)}var D=e.sector(d,c,h,p*(Math.sqrt(3)/2),"M",o,u,a);return D.transform(["...r-45,",c,h]).attr(m),D},e.generateOrb=function(e,t,n,r,i){if(!i||i=="F")return e.set(e.ellipse(t,n,r,r),e.ellipse(t,n,r-r/5,r-r/20).attr({stroke:"none",fill:"r(.5,.1)#ccc-#ccc",opacity:0}));if(i=="M"){var s=r-1;return e.set(e.rect(t-s,n-s,s*2,s*2,0),e.rect(t-s,n-s,s*2,s*2,1).attr({stroke:"none",fill:"330-#ccc-#ccc",opacity:0}))}if(i=="U"){var s=(r-1)*.9;return e.set(e.rect(t-s,n-s,s*2,s*2,0).attr({transform:"r45"}),e.rect(t-s,n-s,s*2,s*2,1).attr({stroke:"none",fill:"330-#ccc-#ccc",opacity:0}).attr({transform:"r45"}))}},e.drawCornerCurve=function(e,t,n,r,i,s,o,u,a,f,l){var c=n-e,h=t-r,p=c/2,d=c/10,v=h/2,m=h/10,g;if(i){var y="M "+e+" "+t+" C "+(e+p)+" "+(t+m)+" "+(n+d)+" "+(r+v)+" "+n+" "+r;g=editor.getPaper().path(y).attr(s).toBack()}else{var y="M "+e+" "+t+" C "+(e-d)+" "+(t-v)+" "+(n-p)+" "+(r-m)+" "+n+" "+r;g=editor.getPaper().path(y).attr(s).toBack()}if(o){var b=g.clone().toBack();g.transform("t "+u+","+a+"..."),b.transform("t "+f+","+l+"...")}},e.drawLevelChangeCurve=function(e,t,n,r,i,s,o,u,a,f){var l=n-e,c=l/2,h=" M "+e+" "+t;h+=" C "+(e+c)+" "+t+" "+(n-c)+" "+r+" "+n+" "+r,curve=editor.getPaper().path(h).attr(i).toBack();if(s){var p=curve.clone().toBack();curve.transform("t "+o+","+u+"..."),p.transform("t "+a+","+f+"...")}},e.findXInterceptGivenLineAndY=function(e,t,n,r,i){if(t==r)return t;var s=(n-i)/(t-r),o=n-s*t,u=(e-o)/s;return u},e.getElementHalfHeight=function(e){return Math.floor(e.getBBox().height/2)},e.getCaretPosition=function(e){if(e.selectionEnd)return e.selectionEnd;if(e.createTextRange){var t=document.selection.createRange();return t.moveStart("character",-e.value.length),t.text.length}return null},e.setCaretPosition=function(e,t){if(t==null||t<=0)return;if(e.setSelectionRange)e.focus(),e.setSelectionRange(t,t);else if(e.createTextRange){var n=e.createTextRange();n.collapse(!0),n.moveEnd("character",t),n.moveStart("character",t),n.select()}},Raphael.st.flatten=function(){var e=new Raphael.st.constructor;return this.forEach(function(t){e=e.concat(t.flatten())}),e},Raphael.el.flatten=function(){return this.paper.set(this)},Raphael.st.concat=function(e){var t=this.copy();return typeof e.forEach=="function"?e.forEach(function(e){t.push(e)}):t.push(e),t},Raphael.st.contains=function(e){var t=!1;return this.forEach(function(n){n==e&&(t=!0)}),t},Raphael.st.copy=function(){var e=new Raphael.st.constructor;return this.forEach(function(t){e.push(t)}),e},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),e}),define("pedigree/view/abstractNode",[],function(){var e=Class.create({initialize:function(e,t,n){this._id=n,this._comments="",!this._type&&(this._type="AbstractNode"),this._graphics=this._generateGraphics(e,t)},getID:function(){return this._id},setID:function(e){if(e==this._id)return;this._id=e,this._graphics.onSetID(e)},_generateGraphics:function(e,t){return new AbstractNodeVisuals(this,e,t)},getGraphics:function(){return this._graphics},getX:function(){return this.getGraphics().getX()},getY:function(){return this.getGraphics().getY()},setPos:function(e,t,n,r){this.getGraphics().setPos(e,t,n,r)},getType:function(){return this._type},remove:function(){this.getGraphics().remove()},getComments:function(){return this._comments},setComments:function(e){this._comments=e},getProperties:function(){var e={};return this.getComments()!=""&&(e.comments=this.getComments()),e},assignProperties:function(e){return e.hasOwnProperty("comments")&&this.getComments()!=e.comments&&this.setComments(e.comments),!0},onWidgetHide:function(){this.getGraphics().getHoverBox()&&this.getGraphics().getHoverBox().onWidgetHide()},onWidgetShow:function(){this.getGraphics().getHoverBox()&&this.getGraphics().getHoverBox().onWidgetShow()}});return e}),define("pedigree/view/childlessBehavior",[],function(){var e={getChildlessStatus:function(){return this._childlessStatus},isValidChildlessStatus:function(e){return e=="infertile"||e=="childless"},getChildlessReason:function(){return this._childlessReason},setChildlessReason:function(e){this.getChildlessStatus()==null&&(reson=""),this._childlessReason=e,this.getGraphics().updateChildlessStatusLabel()}};return e}),define("pedigree/view/abstractNodeVisuals",[],function(){var e=Class.create({initialize:function(e,t,n){this._node=e,this._absoluteX=t,this._absoluteY=n,this._hoverBox=null,this._isGrown=!1},getNode:function(){return this._node},getX:function(){return this._absoluteX},onSetID:function(e){},getY:function(){return this._absoluteY},getBottomY:function(){return this._absoluteY},setPos:function(e,t,n,r){this._absoluteX=e,this._absoluteY=t,r&&r()},grow:function(){this._isGrown=!0},shrink:function(){this._isGrown=!1},isGrown:function(){return this._isGrown},containsXY:function(e,t){return!1},isSelected:function(){return this._isSelected},setSelected:function(e){this._isSelected=e},getAllGraphics:function(){return editor.getPaper().set(this.getShapes())},getShapes:function(){return editor.getPaper().set()},remove:function(){this.getHoverBox()&&this.getHoverBox().remove(),this.getAllGraphics().remove()},getHoverBox:function(){return this._hoverBox}});return e}),define("pedigree/view/childlessBehaviorVisuals",["pedigree/pedigreeEditorParameters"],function(e){var t={getChildlessShape:function(){return this._childlessShape},getChildlessStatusLabel:function(){return this._childlessStatusLabel},updateChildlessShapes:function(){var t=this.getNode().getChildlessStatus();this._childlessShape&&this._childlessShape.remove();if(t){var n=this.getX(),r=this.getY(),i=e.attributes.infertileMarkerWidth,s=this.getBottomY()+e.attributes.infertileMarkerHeight,o=[["M",n,r],["L",n,s],["M",n-i,s],["l",2*i,0]];t=="infertile"&&o.push(["M",n-i,s+5],["l",2*i,0]),this._childlessShape=editor.getPaper().path(o),t=="childless"&&this.getChildlessShapeAttr?this._childlessShape.attr(this.getChildlessShapeAttr()):this._childlessShape.attr(e.attributes.childlessShapeAttr),this._childlessShape.toBack()}},updateChildlessStatusLabel:function(){this._childlessStatusLabel&&this._childlessStatusLabel.remove(),this._childlessStatusLabel=null;var e="";this.getNode().getChildlessReason()&&(e+=this.getNode().getChildlessReason()),e.strip()!=""&&(this._childlessStatusLabel=editor.getPaper().text(this.getX(),this.getBottomY()+18,"("+e.slice(0,15)+")"),this._childlessStatusLabel.attr({"font-size":18,"font-family":"Cambria"}),this._childlessStatusLabel.toBack()),this.drawLabels()}};return t}),define("pedigree/view/abstractHoverbox",["pedigree/pedigreeEditorParameters","pedigree/model/helpers","pedigree/view/graphicHelpers"],function(e,t,n){var r=Class.create({initialize:function(t,n,r,i,s,o,u,a){var f=this;this._node=t,this._relativeX=n,this._relativeY=r,this._nodeX=o,this._nodeY=u,this._hidden=!0,this._enabled=!1,this._width=i,this._height=s,this._isHovered=!1,this._currentHandles=null,this._currentOrbs=null,this._currentButtons=null,this._handlesZoomSz=null,this._boxOnHover=editor.getPaper().rect(this.getX(),this.getY(),this._width,this._height,5).attr(e.attributes.boxOnHover),this._backElements=editor.getPaper().set(this._boxOnHover),this._mask=this._boxOnHover.clone().attr({fill:"green",opacity:0}),this._frontElements=editor.getPaper().set().push(this._mask);var l=a.flatten();this._backElements.insertBefore(l),this._frontElements.insertAfter(l),this.animateDrawHoverZone=this.animateDrawHoverZone.bind(this),this.animateHideHoverZone=this.animateHideHoverZone.bind(this),this.getBoxOnHover().attr({opacity:0}),this.enable(),this._isMenuToggled=!1,this._justClosedMenu=!1},getX:function(){return this.getNodeX()+this._relativeX},getY:function(){return this.getNodeY()+this._relativeY},getNodeX:function(){var e=this.getNode().getGraphics();return e&&(this._nodeX=e.getX()),this._nodeX},getNodeY:function(){var e=this.getNode().getGraphics();return e&&(this._nodeY=e.getY()),this._nodeY},getWidth:function(){return this._width},getHeight:function(){return this._height},getNode:function(){return this._node},generateButtons:function(){if(this._currentButtons!==null)return;this._currentButtons=[]},regenerateButtons:function(){this.removeButtons(),this.generateButtons()},removeButtons:function(){if(!this._currentButtons)return;var e=this._enabled;e&&this.disable();for(var t=0;t<this._currentButtons.length;t++)this.getFrontElements().exclude(this._currentButtons[t]),this._currentButtons[t].remove();this._currentButtons=null,e&&this.enable()},hideButtons:function(){if(!this._currentButtons)return;for(var t=0;t<this._currentButtons.length;t++)this._currentButtons[t].hasOwnProperty("mask")&&this._currentButtons[t].mask.attr(e.attributes.btnMaskHoverOff),this._currentButtons[t].hide()},showButtons:function(){if(!this._currentButtons)return;for(var e=0;e<this._currentButtons.length;e++)this._currentButtons[e].show()},getCurrentButtons:function(){return this._currentButtons},removeHandles:function(){if(!this._currentHandles)return;var e=this._enabled;e&&this.disable();for(var t=0;t<this._currentOrbs.length;t++)this.getFrontElements().exclude(this._currentOrbs[t]);this._currentOrbs=null,e&&this.enable();for(var t=0;t<this._currentHandles.length;t++)this._currentHandles[t].remove();this._currentHandles=null},hideHandles:function(){if(!this._currentHandles)return;for(var e=0;e<this._currentHandles.length;e++)this._currentHandles[e].hide()},showHandles:function(){if(!this._currentHandles)return;for(var e=0;e<this._currentHandles.length;e++)this._currentHandles[e].show()},generateHandles:function(){if(this._currentHandles!==null)return;this._currentHandles=[],this._currentOrbs=[],this._handlesZoomSz=editor.getWorkspace().getCurrentZoomLevel()},regenerateHandles:function(){this._currentHandles&&this.removeHandles(),(!this._hidden||this.isMenuToggled())&&this.generateHandles()},createButton:function(t,n,r,i,s,o,u,a){var f=editor.getPaper().path(r).attr(s);f.transform(["t",t,n]);var l=i.width/4,c=i.height/4,h=i.width*1.5,p=i.height*1.5,d=editor.getPaper().rect(t+i.x-l,n+i.y-c,h,p,1);d.attr({fill:"gray",opacity:0,"stroke-width":0});var v=editor.getPaper().set(d,f).toFront(),m=this,g=function(){if(m._hidden){v.isClicked=!1;return}v.isClicked=!v.isClicked,v.isClicked?d.attr(e.attributes.btnMaskClick):d.attr(e.attributes.btnMaskHoverOn),o&&o()};v.click(g),v.mousedown(function(){d.attr(e.attributes.btnMaskClick)}),v.hover(function(){d.attr(e.attributes.btnMaskHoverOn),a&&d.attr({title:a})},function(){d.attr(e.attributes.btnMaskHoverOff)}),u&&v.forEach(function(e){e.node.setAttribute("class",u)}),v.icon=f,v.mask=d,this._hidden&&!this.isMenuToggled()&&v.hide(),this._currentButtons.push(v),this.disable(),this.getFrontElements().push(v),this.enable()},generateMenuBtn:function(){var t=this,n=function(){t.toggleMenu(!t.isMenuToggled())},r=e.attributes.menuBtnIcon,i=this.getX()+this.getWidth()-20-this.getWidth()/40,s=this.getY()+this.getHeight()/40;this.createButton(i,s,editor.getView().__menuButton_svgPath,editor.getView().__menuButton_BBox,r,n,"menu-trigger","node properties")},generateDeleteBtn:function(){var t=this,n=function(){t.animateHideHoverZone();var e={nodeID:t.getNode().getID()};document.fire("pedigree:node:remove",e)},r=e.attributes.deleteBtnIcon,i=this.getX()+this.getWidth()-20-this.getWidth()/40,s=this.getY()+this.getHeight()/40;this.createButton(i,s,editor.getView().__deleteButton_svgPath,editor.getView().__deleteButton_BBox,r,n,"delete","remove node")},getBoxOnHover:function(){return this._boxOnHover},isHovered:function(){return this._isHovered},setHovered:function(e){this._isHovered=e},setHighlighted:function(t){t?(this.getBoxOnHover().attr(e.attributes.boxOnHover),this.getBoxOnHover().attr("fill","green")):this.getBoxOnHover().attr(e.attributes.boxOnHover).attr("opacity",0)},getHoverZoneMask:function(){return this._mask},getFrontElements:function(){return this._frontElements},getBackElements:function(){return this._backElements},generateHandle:function(t,r,i,s,o,u,a,f){a||(a="F");var l=editor.getWorkspace().getSizeNormalizedToDefaultZoom(e.attributes.handleStrokeWidth),c=[["M",r,i],["L",s,o]],h=editor.getPaper().path(c).attr({"stroke-width":l,stroke:"gray"}).toBack();h.oPath=c;var p="createTouch"in document,d=p?e.attributes.touchOrbRadius:e.attributes.orbRadius,v=e.attributes.orbHue,m=a!="F"?{fill:"0-hsb("+v+", 1, .75)-hsb("+v+", .5, .25)",stroke:"#555","stroke-width":"0.75"}:{fill:"r(.5,.9)hsb("+v+", 1, .75)-hsb("+v+", .5, .25)",stroke:"none"},g=a!="F"?{fill:"0-hsb("+(v+.36)+", 1, .75)-hsb("+(v+.36)+", .5, .25)"}:{fill:"r(.5,.9)hsb("+(v+.36)+", 1, .75)-hsb("+(v+.36)+", .5, .25)"},y=a!="F"?"x":"cx",b=a!="F"?"y":"cy",w=n.generateOrb(editor.getPaper(),s,o,d*1.1,a).attr("cursor","pointer");w[0].attr(m);var E=editor.getPaper().set().push(h,w);E.type=t,h.insertBefore(this.getHoverZoneMask()),w.toFront();var S=this,x=!1,T=!1,N=function(){x||(x=!0,editor.getView().getCurrentDraggable()!==null&&editor.getView().enterHoverMode(S.getNode(),t),f&&f.hide())},C=!1,k=function(e,t,n){if(T)return;T=!0,C=!1;if(n.button!=0){T=!1,C=!0;return}h.toFront(),w.stop(),w.toFront(),x=!1,S.disable(),S.getFrontElements().toFront(),w.ot?(w.transform(""),w.attr(y,w.ox),w.attr(b,w.oy),w.transform(w.ot)):(w.ot=w[0].transform(),w.ox=w[0].attr(y),w.oy=w[0].attr(b)),h.ox=h.oPath[1][1],h.oy=h.oPath[1][2],E.isDragged=!1,editor.getView().setCurrentDraggable(S.getNode().getID()),setTimeout(N,100)},L=function(e,t){if(C)return;if(!T)return;N(),e/=editor.getWorkspace().zoomCoefficient,t/=editor.getWorkspace().zoomCoefficient,w.ot.length>0&&w.transform(""),w.attr(y,w.ox+e),w.attr(b,w.oy+t),w.ot.length>0&&w.transform(w.ot),h.oPath[1][1]=h.ox+e,h.oPath[1][2]=h.oy+t,h.attr("path",h.oPath);if(e>1||e<-1||t>1||t<-1)E.isDragged=!0},A=function(){x=!1,T=!1;if(C)return;var e=editor.getView().getCurrentHoveredNode();editor.getView().setCurrentDraggable(null),editor.getView().exitHoverMode();if(E.isDragged)if(w.ot.length==0){var t={};t[y]=w.ox,t[b]=w.oy,w.animate(t,1e3,"elastic",function(){})}else{var n=w.ox-w[0].attr(y),r=w.oy-w[0].attr(b);w.animate({transform:"T"+n+","+r+"R45"},1e3,"elastic",function(){w.transform(""),w.attr(y,w.ox),w.attr(b,w.oy),w.transform(w.ot)})}console.log("handle.isDragged: "+E.isDragged+", currentHover: "+e),h.oPath[1][1]=h.ox,h.oPath[1][2]=h.oy,h.animate({path:h.oPath},1e3,"elastic"),w[0].attr(m),h.insertBefore(S.getHoverZoneMask()),S.enable(),(!E.isDragged||e!=null)&&S.handleAction(E.type,E.isDragged,e)};return w.drag(L,k,A),w.hover(function(){w[0].attr(g),u&&(w[0].attr({title:u}),w[1].attr({title:u}))},function(){w[0].attr(m)}),this._currentOrbs.push(w[0]),this._currentOrbs.push(w[1]),this.disable(),this.getFrontElements().push(w[0]),this.getFrontElements().push(w[1]),this.enable(),E},isMenuToggled:function(){return!1},animateDrawHoverZone:function(){this._hidden=!1;if(editor.getView().getCurrentDraggable()!==null)return;this.getNode().getGraphics().setSelected(!0),this.getBoxOnHover().stop().animate({opacity:.7},200),this.generateButtons(),this.showButtons(),this.getCurrentButtons().forEach(function(e){e.hasOwnProperty("icon")&&e.icon.stop().animate({opacity:1},200)}),this._handlesZoomSz!=editor.getWorkspace().getCurrentZoomLevel()&&this.removeHandles(),this.generateHandles(),this.showHandles()},animateHideHoverZone:function(){this._hidden=!0;if(editor.getView().getCurrentDraggable()!==null)return;this.getNode().getGraphics().setSelected(!1),this.getBoxOnHover().stop().animate({opacity:0},200),this.hideButtons(),this.hideHandles()},disable:function(){this._enabled=!1,this.getFrontElements().unhover(this.animateDrawHoverZone,this.animateHideHoverZone)},enable:function(){this._enabled=!0,this.getFrontElements().hover(this.animateDrawHoverZone,this.animateHideHoverZone)},remove:function(){this.disable(),this.removeButtons(),this.removeHandles(),this.getBackElements().remove(),this.getFrontElements().remove()},onWidgetHide:function(){this._isMenuToggled=!1,this._justClosedMenu=!0;var e=this;setTimeout(function(){e._justClosedMenu=!1},100),this._hidden?this.animateHideHoverZone():this.animateDrawHoverZone()},onWidgetShow:function(){this._isMenuToggled=!0}});return r}),define("pedigree/view/partnershipHoverbox",["pedigree/pedigreeEditorParameters","pedigree/view/abstractHoverbox"],function(e,t){var n=Class.create(t,{initialize:function($super,t,n,r,i){var s=e.attributes.radius;$super(t,-s*.65,-s*.8,s*1.3,s*2.3,n,r,i),this._isMenuToggled=!1},generateHandles:function($super){if(this._currentHandles!==null)return;$super();if(this.getNode().getChildlessStatus()=="infertile")return;var t=this.getNodeX(),n=this.getNodeY(),r=editor.getWorkspace().getSizeNormalizedToDefaultZoom(e.attributes.handleStrokeWidth);editor.getPaper().setStart();var i=[["M",t,n],["L",t,n+e.attributes.partnershipHandleBreakY]];editor.getPaper().path(i).attr({"stroke-width":r,stroke:"gray"}).insertBefore(this.getNode().getGraphics().getJunctionShape()),this.generateHandle("child",t,n+e.attributes.partnershipHandleBreakY,t,n+e.attributes.partnershipHandleLength),this._currentHandles.push(editor.getPaper().setFinish())},generateButtons:function($super){if(this._currentButtons!==null)return;$super(),this.generateDeleteBtn(),this.generateMenuBtn()},generateMenuBtn:function(){var t=this,n=function(){t.toggleMenu(!t.isMenuToggled())},r=this.getNode().getGraphics().getJunctionShape().clone();r.attr(e.attributes.nodeShapeMenuOffPartner),r.click(n),r.hover(function(){r.attr(e.attributes.nodeShapeMenuOnPartner)},function(){r.attr(e.attributes.nodeShapeMenuOffPartner)}),r.attr("cursor","pointer"),this._currentButtons.push(r),this.disable(),this.getFrontElements().push(r),this.enable()},isMenuToggled:function(){return this._isMenuToggled},toggleMenu:function(e){if(this._justClosedMenu)return;this._isMenuToggled=e;if(e){var t=this.getBoxOnHover().getBBox(),n=t.x2,r=t.y,i=editor.getWorkspace().canvasToDiv(n+5,r);editor.getPartnershipMenu().show(this.getNode(),i.x,i.y)}},animateHideHoverZone:function($super){this._hidden=!0,this.isMenuToggled()||$super()},animateDrawHoverZone:function($super){this._hidden=!1,this.isMenuToggled()||$super()},handleAction:function(t,n,r){if(n&&r!=null){if(t=="child"){var i={personID:r,parentID:this.getNode().getID()};document.fire("pedigree:person:drag:newparent",i)}}else if(!n&&t=="child"){var s=editor.getWorkspace().canvasToDiv(this.getNodeX(),this.getNodeY()+e.attributes.partnershipHandleLength+15),o=!editor.getGraph().hasNonPlaceholderNonAdoptedChildren(this.getNode().getID());o?editor.getNodetypeSelectionBubble().show(this.getNode(),s.x,s.y):editor.getSiblingSelectionBubble().show(this.getNode(),s.x,s.y)}this.animateHideHoverZone()}});return n}),define("pedigree/view/readonlyHoverbox",["pedigree/view/abstractHoverbox"],function(e){var t=Class.create(e,{initialize:function($super,e,t,n,r){this._node=e,this._nodeX=t,this._nodeY=n,this._shapes=editor.getPaper().set()},getWidth:function(){return 0},getHeight:function(){return 0},getNode:function(){return this._node},generateButtons:function(){},removeButtons:function(){},hideButtons:function(){},showButtons:function(){},getCurrentButtons:function(){return this._currentButtons},removeHandles:function(){},hideHandles:function(){},showHandles:function(){},generateHandles:function(){},regenerateHandles:function(){},getBoxOnHover:function(){return null},isHovered:function(){return!1},setHovered:function(e){},setHighlighted:function(e){},getHoverZoneMask:function(){return null},getFrontElements:function(){return this._shapes},getBackElements:function(){return this._shapes},isMenuToggled:function(){return!1},animateDrawHoverZone:function(){},animateHideHoverZone:function(){},disable:function(){},enable:function(){},remove:function(){},onWidgetHide:function(){},onWidgetShow:function(){}});return t}),define("pedigree/view/partnershipVisuals",["pedigree/pedigreeEditorParameters","pedigree/model/helpers","pedigree/view/abstractNodeVisuals","pedigree/view/childlessBehaviorVisuals","pedigree/view/graphicHelpers","pedigree/view/partnershipHoverbox","pedigree/view/readonlyHoverbox"],function(e,t,n,r,i,s,o){var u=Class.create(n,{initialize:function($super,t,n,r){$super(t,n,r),this._childlessShape=null,this._childlessStatusLabel=null,this._junctionShape=editor.getPaper().circle(n,r,e.attributes.partnershipRadius).attr(e.attributes.partnershipNode),editor.isReadOnlyMode()?this._hoverBox=new o(t,n,r,this.getShapes()):this._hoverBox=new s(t,n,r,this.getShapes()),this.updateIDLabel(),this._childhubConnection=null,this._partnerConnections=null,this.updatePartnerConnections(),this.updateChildhubConnection()},updateIDLabel:function(){var t=this.getX(),n=this.getY();this._idLabel&&this._idLabel.remove(),this._idLabel=editor.getPaper().text(t,n-20,editor.DEBUG_MODE?this.getNode().getID():"").attr(e.attributes.dragMeLabel).insertAfter(this._junctionShape.flatten())},onSetID:function($super,e){$super(e),this.updateIDLabel()},grow:function(){if(this.area)return;this.area=this.getJunctionShape().clone().flatten().insertBefore(this.getJunctionShape().flatten()),this.area.attr({fill:"green",stroke:"none"}),this.area.ot=this.area.transform(),this.area.attr({transform:"...S2"})},shrink:function(){this.area&&this.area.remove(),delete this.area},markPregnancy:function(){if(this.mark)return;this.mark=this.getJunctionShape().glow({width:10,fill:!0,opacity:.3,color:"blue"}).insertBefore(this.getJunctionShape().flatten())},unmarkPregnancy:function(){this.mark&&this.mark.remove(),delete this.mark},markPermanently:function(){if(this.mark2)return;this.mark2=this.getJunctionShape().glow({width:18,fill:!0,opacity:.4,color:"#ee8d00"}).insertBefore(this.getJunctionShape().flatten())},unmark:function(){this.mark2&&this.mark2.remove(),delete this.mark2},getJunctionShape:function(){return this._junctionShape},getBottomY:function(){return this._absoluteY+e.attributes.partnershipRadius+e.attributes.parnershipChildlessLength},updatePartnerConnections:function(){this._partnerConnections&&this._partnerConnections.remove(),editor.getPaper().setStart();var t=editor.getGraph(),n=this.getNode().getID(),r=t.isConsangrRelationship(n),s=this.getNode().getConsanguinity();s=="N"&&(r=!1),s=="Y"&&(r=!0);var o=r?e.attributes.consangrPartnershipLines:e.attributes.partnershipLines,u=r?e.attributes.noContactLinesConsangr:e.attributes.noContactLines,a=t.getPathToParents(n),f=!0,l=e.attributes.curvedLinesCornerRadius;for(var c=0;c<a.length;c++){var h=a[c],p=h[h.length-1],d=editor.getGraph().getRelationshipLineInfo(n,p),v=editor.getGraph().getPosition(p),m=editor.convertGraphCoordToCanvasCoord(v.x,v.y),g=editor.convertGraphCoordToCanvasCoord(0,d.attachY).y,y=editor.convertGraphCoordToCanvasCoord(0,d.verticalY).y,b=g==y&&y<this.getY()&&d.attachmentPort==1?Infinity:d.numAttachPorts>1?e.attributes.radius*(1.8+d.numAttachPorts*.1-d.attachmentPort*.35):e.attributes.radius*1.6,w=!1,E=this.getX(),S=this.getY(),x=E,T=S,N=S,C=E,k=!1,L=!1;for(var A=0;A<h.length;A++){var O=h[A],v=editor.getGraph().getPosition(O),M=editor.convertGraphCoordToCanvasCoord(v.x,v.y);if(editor.DEBUG_MODE){var _=editor.getPaper().text(M.x,M.y,O).attr(e.attributes.dragMeLabel).toFront();_.node.setAttribute("class","no-mouse-interaction")}M.x<E?w=!0:M.x>E&&(w=!1);var D=N!=M.y,P=C!=M.x&&N!=M.y,H=k&&!D||!k&&D||P;A==h.length-1&&N==y&&(P=!1,H=E!=x||S!=T,D=!1),A==0&&w&&this.getNode().getBrokenStatus()&&(editor.getView().drawLineWithCrossings(n,E,S,E-16,S,o,r,w),editor.getPaper().path("M "+(E-29)+" "+(S+9)+" L "+(E-15)+" "+(S-9)).attr(o).toBack(),editor.getPaper().path("M "+(E-24)+" "+(S+9)+" L "+(E-10)+" "+(S-9)).attr(o).toBack(),E-=23),H&&(editor.getView().drawLineWithCrossings(n,E,S,x,T,o,r,w),E=x,S=T),x=M.x,T=A>=h.length-2?y:M.y,N=M.y,C=M.x,f&&(!L&&!P||A>=h.length-2&&h.length>1)&&(D&&!k?x<E?(i.drawCornerCurve(E,S,E-l,S-l,!0,o,r,2.5,-2.5,-2.5,2.5),E-=l,S-=l):(i.drawCornerCurve(E,S,E+l,S-l,!0,o,r,2.5,2.5,-2.5,-2.5),E+=l,S-=l):!D&&k?x<E?(i.drawCornerCurve(E,S,E-l,S-l,!1,o,r,-2.5,2.5,2.5,-2.5),E-=l,S-=l):(i.drawCornerCurve(E,S,E+l,S-l,!1,o,r,2.5,2.5,-2.5,-2.5),E+=l,S-=l):D?T+=l:A!=h.length-1&&(M.x>E?x-=l:x+=l)),k=D,L=P}var B=!editor.getView().getNode(p).isProband()&&editor.getView().getNode(p).getLostContact()&&editor.getGraph().isPartnershipRelatedToProband(n),j=B?u:o;S>=m.y+l*2?editor.getView().drawLineWithCrossings(n,E,S,x,g,j,r,!1):editor.getView().drawCurvedLineWithCrossings(n,E,S,y,x,g,b,j,r,w)}this._partnerConnections=editor.getPaper().setFinish().toBack(),this.getNode().getGraphics()&&(this.getHoverBox().regenerateHandles(),this.getHoverBox().regenerateButtons())},updateChildhubConnection:function(){this._childhubConnection&&this._childhubConnection.remove();var t=e.attributes.twinCommonVerticalLength,n=editor.getGraph(),r=this.getNode().getID(),s=n.getRelationshipChildhubPosition(r),o=editor.convertGraphCoordToCanvasCoord(s.x,s.y).y,u=n.getRelationshipChildrenSortedByOrder(r);if(u.length==1&&editor.getGraph().isPlaceholder(u[0])){editor.getPaper().setStart(),this._childhubConnection=editor.getPaper().setFinish();return}editor.getPaper().setStart();var a=this.getX(),f=this.getX(),l=null,c=null,h=!1,p=0,d=!0;for(var v=0;v<u.length;v++){var m=u[v],g=n.getTwinGroupId(m);if(g!=l){p++,l=g;var y=n.getAllTwinsSortedByOrder(m),b=editor.getView().getNode(y[0]).getX(),w=editor.getView().getNode(y[y.length-1]).getX(),E=editor.getView().getNode(y[0]).getY();c=(b+w)/2,y.length==3&&(c=editor.getView().getNode(y[1]).getX()),editor.getView().drawLineWithCrossings(r,c,o,c,o+t,e.attributes.partnershipLines),h=editor.getView().getNode(y[0]).getMonozygotic();if(h){var S=o+e.attributes.twinMonozygothicLineShiftY,x=i.findXInterceptGivenLineAndY(S,c,o+t,b,E),T=i.findXInterceptGivenLineAndY(S,c,o+t,w,E);editor.getView().drawLineWithCrossings(r,x,S,T,S,e.attributes.partnershipLines)}}else g==null&&(p++,h=!1);var N=editor.getView().getNode(m).getX(),C=editor.getView().getNode(m).getY(),k=l===null?N:c,L=l===null?o:o+t;k>f&&(f=k),k<a&&(a=k);var A=(editor.getGraph().isChildOfProband(m)||editor.getGraph().isSiblingOfProband(m))&&editor.getView().getNode(m).getLostContact();A||(d=!1);var O=A?e.attributes.noContactLines:e.attributes.partnershipLines;editor.getGraph().isAdoptedIn(m)&&(O=A?e.attributes.noContactAdoptedIn:e.attributes.partnershipLinesAdoptedIn);if(!h||N==b||N==w)editor.getView().drawLineWithCrossings(r,k,L,N,C,O);else{var M=i.findXInterceptGivenLineAndY(S,c,o+t,N,C);editor.getView().drawLineWithCrossings(r,M,S,N,C,O)}}var O=d?e.attributes.noContactLines:e.attributes.partnershipLines;editor.getView().drawLineWithCrossings(r,a,o,f,o,O),editor.getView().drawLineWithCrossings(r,this.getX(),this.getY(),this.getX(),o,O);if(editor.DEBUG_MODE){var _=n.DG.GG.getOutEdges(r)[0],D=editor.getPaper().text(this.getX(),o,_).attr(e.attributes.dragMeLabel).toFront();D.node.setAttribute("class","no-mouse-interaction")}p>1&&editor.getPaper().circle(this.getX(),o,e.attributes.partnershipRadius/2).attr({fill:"#666666",stroke:"#888888","stroke-width":1,opacity:1}),this._childhubConnection=editor.getPaper().setFinish()},setPos:function($super,e,t,n,r){this.getHoverBox().removeHandles(),this.getHoverBox().removeButtons();if(n)throw"Can't animate a partnership node";this.mark&&this.mark.remove(),this.mark2&&this.mark2.remove(),this.getAllGraphics().transform("t "+(e-this.getX())+","+(t-this.getY())+"..."),$super(e,t,n,r),this.updatePartnerConnections(),this.updateChildhubConnection(),this.updateChildlessStatusLabel()},remove:function(){this.getJunctionShape().remove(),this.getHoverBox().remove(),this._idLabel&&this._idLabel.remove(),this.getChildlessShape()&&this.getChildlessShape().remove(),this.getChildlessStatusLabel()&&this.getChildlessStatusLabel().remove(),this._childhubConnection&&this._childhubConnection.remove(),this._partnerConnections&&this._partnerConnections.remove(),this.area&&this.area.remove(),this.mark&&this.mark.remove(),this.mark2&&this.mark2.remove()},getShapes:function($super){return $super().push(this.getJunctionShape())},getAllGraphics:function($super){return editor.getPaper().set(this.getHoverBox().getBackElements(),this._idLabel,this._childlessShape).concat($super()).push(this.getHoverBox().getFrontElements())},drawLabels:function(){},getChildlessShapeAttr:function(){return e.attributes.partnershipChildlessShapeAttr}});return u.addMethods(r),u}),define("pedigree/view/partnership",["pedigree/view/abstractNode","pedigree/view/childlessBehavior","pedigree/view/partnershipVisuals"],function(e,t,n){var r=Class.create(e,{initialize:function($super,e,t,n,r){this._childlessStatus=null,this._childlessReason="",this._type="Partnership",this._broken=!1,this._consangrMode="A",this.setBrokenStatus(r.broken),this.setConsanguinity(r.consangr),$super(e,t,n),this.assignProperties(r)},_generateGraphics:function(e,t){return new n(this,e,t)},setChildlessStatus:function(e){return this.isValidChildlessStatus(e)||(e=null),e!=this.getChildlessStatus()&&(this._childlessStatus=e,this.setChildlessReason(null),this.getGraphics().updateChildlessShapes(),this.getGraphics().updateChildhubConnection(),this.getGraphics().getHoverBox().regenerateHandles()),this.getChildlessStatus()},setConsanguinity:function(e){e!="A"&&e!="N"&&e!="Y"&&(e="A"),this._consangrMode!=e&&(this._consangrMode=e),this.getGraphics()&&this.getGraphics().getHoverBox().regenerateButtons()},getConsanguinity:function(){return this._consangrMode},setBrokenStatus:function(e){e===undefined&&(e=!1),this._broken!=e&&(this._broken=e)},getBrokenStatus:function(){return this._broken},getSummary:function(){var e=!1,t=[];return editor.getGraph().hasNonPlaceholderNonAdoptedChildren(this.getID())?(t=!0,e=!0):editor.getGraph().hasNoNonPlaceholderChildren(this.getID())&&(t=["none"]),{identifier:{value:this.getID()},childlessSelect:{value:this.getChildlessStatus()?this.getChildlessStatus():"none",inactive:t},childlessText:{value:this.getChildlessReason()?this.getChildlessReason():"none",inactive:e},consangr:{value:this._consangrMode,inactive:!1},broken:{value:this.getBrokenStatus(),inactive:!1}}},getProperties:function($super){var e=$super();return this.getChildlessStatus()!=null&&(e.childlessStatus=this.getChildlessStatus(),e.childlessReason=this.getChildlessReason()),this.getConsanguinity()!="A"&&(e.consangr=this.getConsanguinity()),this.getBrokenStatus()&&(e.broken=this.getBrokenStatus()),e},assignProperties:function($super,e){return $super(e)?(e.childlessStatus&&e.childlessStatus!=this.getChildlessStatus()&&this.setChildlessStatus(e.childlessStatus),e.childlessReason&&e.childlessReason!=this.getChildlessReason()&&this.setChildlessReason(e.childlessReason),e.consangr&&e.consangr!=this.getConsanguinity()&&this.setConsanguinity(e.consangr),e.broken&&e.broken!=this.getBrokenStatus()&&this.setBrokenStatus(e.broken),!0):!1}});return r.addMethods(t),r}),define("pedigree/pedigreeDate",[],function(){var e=Class.create({initialize:function(e){this.decade=null,this.year=null,this.month=null,this.day=null;if(e==null||!e)return;var t=null;if(typeof e=="string"||e instanceof String){if(e.match(/^\d\d\d\ds$/))this.decade=e;else if(!isNaN(Date.parse(e))){var n=e.match(/\w\w\w (\w\w\w) (\d\d) \d\d:\d\d:\d\d \w\w\w (\d\d\d\d)/);if(n!==null){var r=n[1]+" "+n[2]+", "+n[3];t=new Date(r)}else{var n=e.match(/(\d\d\d\d)-(\d\d)-(\d\d)/);if(n!==null){var i=parseInt(n[2])-1,r=this._getMonthName("en",i)+" "+n[3]+", "+n[1];t=new Date(r)}else t=new Date(e)}}}else Object.prototype.toString.call(e)==="[object Date]"&&(t=e);t!==null?(this.year=t.getFullYear(),this.month=t.getMonth()+1,this.day=t.getDate()):typeof e=="object"&&(e.hasOwnProperty("decade")&&(this.decade=e.decade),e.hasOwnProperty("year")&&(this.year=this.parseIntOrNull(e.year)),e.hasOwnProperty("month")&&(this.month=this.parseIntOrNull(e.month)),e.hasOwnProperty("day")&&(this.day=this.parseIntOrNull(e.day))),this.year!==null&&this.decade===null&&(this.decade=this.year.toString().slice(0,-1)+"0s")},parseIntOrNull:function(e){var t=parseInt(e);return isNaN(t)?null:t},toString:function(){if(this.year===null&&this.decade!==null)return this.decade;if(this.year!==null&&this.month==null)return this.year.toString();if(this.year!==null&&this.month!==null&&this.day===null)return this.getMonthName()+" "+this.year;if(this.year!==null&&this.month!==null&&this.day!==null){var e=this.toJSDate();return e.toDateString()}return""},getMonthName:function(e){return this.getMonth()==null?"":(e=e&&e in localeMonthNames?e:"en",this._getMonthName(e,this.getMonth()-1))},_getMonthName:function(e,t){var n={en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]};return n[e][t]},toGEDCOMString:function(){return this.year===null&&this.decade!==null?"ABT "+this.getYear(!0).toString():this.toString()},isSet:function(){return this.decade!==null||this.year!==null||this.month!==null||this.day!==null},isComplete:function(){return this.decade!==null},onlyDecadeAvailable:function(){return this.decade!==null&&this.year==null},getDecade:function(){return this.decade},getSimpleObject:function(){var e={};return this.decade!==null&&(e.decade=this.decade),this.year!==null&&(e.year=this.year),this.month!==null&&(e.month=this.month),this.day!==null&&(e.day=this.day),e},toJSDate:function(){var e=this.getYear(!0),t=this.getMonth(!0)-1,n=this.getDay(!0),r=new Date(e,t,n);return r},getBestPrecisionStringYear:function(){return this.isComplete()?this.year==null?this.decade:this.year.toString():""},getMostConservativeYearEstimate:function(){return this.getBestPrecisionStringYear().replace(/s^/,"")},getBestPrecisionStringDDMMYYY:function(){if(!this.isComplete())return"";if(this.year==null)return this.decade;var e=this.getYear().toString();return this.getMonth()!=null&&(e=("0"+this.getMonth()).slice(-2)+"-"+e,this.getDay()!=null&&(e=("0"+this.getDay()).slice(-2)+"-"+e)),e},getTime:function(){return this.toJSDate().getTime()},getYear:function(e){if(this.isComplete()&&this.year==null&&e){var t=parseInt(this.decade.slice(0,-1));return t}return this.year},getMonth:function(e){return this.isComplete()&&this.month==null&&e?1:this.month},getDay:function(e){return this.isComplete()&&this.day==null&&e?1:this.day},canBeAfterDate:function(e){if(!this.isComplete())return!0;if(!e.isComplete())return!0;if(this.getTime()>e.getTime())return!0;var t=e.getYear(!0),n=e.getMonth(!0),r=e.getDay(!0),i=this.year?this.year:this.getYear(!0)+9,s=this.month?this.month:12,o=this.day?this.day:31;return i>t?!0:i<t?!1:s>n?!0:s<n?!1:o>=r}});return e}),define("pedigree/view/abstractPersonVisuals",["pedigree/pedigree","pedigree/pedigreeEditorParameters","pedigree/view/abstractNodeVisuals","pedigree/view/graphicHelpers"],function(e,t,n,r){var i=Class.create(n,{initialize:function($super,e,n,r){$super(e,n,r),this._radius=t.attributes.radius,this._width=t.attributes.radius*4,this._highlightBox=null,this._adoptedShape=null,this._genderShape=null,this._genderGraphics=null,this._numberLabel=null,this.setGenderGraphics(),this.setHighlightBox(),this.updateIDLabel(),this._hoverBox=this.generateHoverbox(n,r)},updateIDLabel:function(){if(!editor.DEBUG_MODE)return;var e=this.getX(),n=this.getY();this._idLabel&&this._idLabel.remove(),this._idLabel=editor.getPaper().text(e,n,this.getNode().getID()).attr(t.attributes.dragMeLabel).toFront(),this._idLabel.node.setAttribute("class","no-mouse-interaction")},updateNumberLabel:function(){this._numberLabel&&this._numberLabel.remove();if(this.getNode().getPedNumber()!=""){var e=this.getX(),n=this.getY();this._numberLabel=editor.getPaper().text(e,n,this.getNode().getPedNumber()).attr(t.attributes.pedNumberLabel).toFront(),this._numberLabel.node.setAttribute("class","no-mouse-interaction")}},generateHoverbox:function(e,t){return null},onSetID:function($super,e){$super(e),this.updateIDLabel()},setPos:function($super,e,t,n,r){this.getHoverBox().removeHandles(),this.getHoverBox().removeButtons();var i=e-this.getX(),s=t-this.getY();if(i==0&&s==0)return;$super(e,t,n);if(n){var o=this;this._callback=function(){o._toMark&&(o.markPermanently(),delete o._toMark),delete o._callback,r&&r()},this.getAllGraphics().animate({transform:"t "+i+","+s+"..."},900,"linear",o._callback)}else this.getAllGraphics().transform("t "+i+","+s+"..."),r&&r()},grow:function($super){$super();if(this._callback)throw"Assertion failed: grow() during animation";if(this.glow)return;this.glow=this._genderShape.glow({width:11,fill:!0,opacity:.4,color:"green"}),this.marked&&this.marked.hide()},shrink:function($super){this.glow&&this.glow.remove(),delete this.glow,this.marked&&this.marked.show(),$super()},markPermanently:function(){if(this._callback&&!this._toMark){this._toMark=!0;return}if(this.marked)return;this.marked=this._genderShape.glow({width:11,fill:!0,opacity:.6,color:"#ee8d00"})},unmark:function(){this.marked&&this.marked.remove(),delete this.marked},containsXY:function(e,t){return Math.abs(e-this.getX())<=this._radius&&Math.abs(t-this.getY())<=this._radius?!0:!1},getBottomY:function(){return this._absoluteY+this._radius+t.attributes.childlessLength},drawAdoptedShape:function(){this._adoptedShape&&this._adoptedShape.remove();if(this.getNode().getAdopted()!=""){var e=t.attributes.radius,n=this.getY()-1.3*e+2;if(this.getNode().getAdopted()=="adoptedOut"&&editor.getPreferencesManager().getConfigurationOption("nonStandardAdoptedOutGraphic"))var r=this.getX()-1.7*e,i=this.getX()+1.7*e,s=2.5;else var r=this.getX()-.9*e,i=this.getX()+.9*e,s=-2.5;brackets="M"+r+" "+n+"l"+e/s+" "+0+"l0 "+(2.6*e-4)+"l"+e/-s+" 0M"+i+" "+n+"l"+e/-s+" 0"+"l0 "+(2.6*e-4)+"l"+e/s+" 0",this._adoptedShape=editor.getPaper().path(brackets).attr("stroke-width",2.5),this._adoptedShape.toBack()}},getAdoptedShape:function(){return this._adoptedShape},getShapes:function($super){var e=$super().push(this.getGenderGraphics());return this.getAdoptedShape()&&e.push(this.getAdoptedShape()),e},getAllGraphics:function($super){return editor.getPaper().set(this.getHighlightBox(),this._idLabel,this._numberLabel).concat($super())},getGenderGraphics:function(){return this._genderGraphics},getGenderShape:function(){return this._genderShape},setGenderGraphics:function(){this.unmark(),this._genderGraphics&&this._genderGraphics.remove();var e=this.getNode().getGender();this._shapeRadius=e=="U"||e=="O"?t.attributes.radius*1.1/Math.sqrt(2):t.attributes.radius,this.getNode().isPersonGroup()&&(this._shapeRadius*=t.attributes.groupNodesScale);var n,r=this.getX(),i=this.getY(),s=this._shapeRadius;e=="F"?n=editor.getPaper().circle(r,i,s):n=editor.getPaper().rect(r-s,i-s,s*2,s*2),e=="U"?(n.attr(t.attributes.nodeShapeDiag),n.attr({transform:"...R45"})):e=="O"?(n.attr(t.attributes.nodeShapeOther),n.attr({transform:"...R45"})):e=="M"?n.attr(t.attributes.nodeShapeMale):e=="F"&&n.attr(t.attributes.nodeShapeFemale);if(!editor.isUnsupportedBrowser()){var o=n.clone().attr({stroke:"none",fill:"gray",opacity:.3});o.translate(3,3),o.insertBefore(n)}this._genderShape=n,this._genderGraphics=editor.getPaper().set(o,n)},setHighlightBox:function(){this._highlightBox&&this._highlightBox.remove();var e=t.attributes.personHoverBoxRadius;this._highlightBox=editor.getPaper().rect(this.getX()-e,this.getY()-e,e*2,e*2,5).attr(t.attributes.boxOnHover),this._highlightBox.attr({fill:"black",opacity:0,"fill-opacity":0}),this._highlightBox.insertBefore(this.getGenderGraphics().flatten())},getHighlightBox:function(){return this._highlightBox},highlight:function(){this.getHighlightBox()&&this.getHighlightBox().attr({opacity:.5,"fill-opacity":.5})},unHighlight:function(){this.getHighlightBox().attr({opacity:0,"fill-opacity":0})},remove:function($super){this.marked&&this.marked.remove(),$super()}});return i}),define("pedigree/view/abstractPerson",["pedigree/view/abstractNode","pedigree/view/abstractPersonVisuals"],function(e,t){var n=Class.create(e,{initialize:function($super,e,t,n,r){this._gender=this.parseGender(n),this._adoptedStatus="",!this._type&&(this._type="AbstractPerson"),$super(e,t,r)},_generateGraphics:function(e,n){return new t(this,e,n)},parseGender:function(e){var t=e.toUpperCase();return t=="M"||t=="F"||t=="O"?t:"U"},getGender:function(){return this._gender},isPersonGroup:function(){return this._type=="PersonGroup"},setGender:function(e){var e=this.parseGender(e);this._gender!=e&&(this._gender=e,this.getGraphics().setGenderGraphics(),this.getGraphics().getHoverBox().regenerateHandles(),this.getGraphics().getHoverBox().regenerateButtons())},setAdopted:function(e){e!=""&&e!="adoptedIn"&&e!="adoptedOut"&&(e=""),this._adoptedStatus=e,this.getGraphics().drawAdoptedShape(),this.getGraphics().getHoverBox().regenerateHandles()},getAdopted:function(){return this._adoptedStatus},getProperties:function($super){var e=$super();return e.gender=this.getGender(),e},assignProperties:function($super,e){return $super(e)?e.gender?(this.getGender()!=this.parseGender(e.gender)&&this.setGender(e.gender),!0):!1:!1}});return n}),define("pedigree/view/ageCalc",[],function(){function e(e,t){if(e.onlyDecadeAvailable())return"";var n;if(t==null)n=new Date;else{if(t.onlyDecadeAvailable())return"";n=t.toJSDate()}e=e.toJSDate();var r=1e3,i=r*60,s=i*60,o=s*24,u=o*7,a=o*30.5,f=n.getTime()-e.getTime();if(f<=0){if(t!=null)return"";if(f<0)return"not born yet"}var l=n.getFullYear()-e.getFullYear()-(n.getDayOfYear()<e.getDayOfYear()?1:0),c="",h=Math.floor(f/a);if(h<12){var p=Math.floor(f/o);if(p<21)p==1?c=p+" day":c=p+" days";else if(p<60){var d=Math.floor(f/u);c=d+" wk"}else c=h+" mo"}else c=l+" y";return c}var t={};return t.getAge=e,t}),define("pedigree/view/personHoverbox",["pedigree/pedigreeEditorParameters","pedigree/model/helpers","pedigree/view/abstractHoverbox"],function(e,t,n){var r=Class.create(n,{initialize:function($super,t,n,r,i){var s=e.attributes.personHoverBoxRadius;$super(t,-s,-s,s*2,s*2,n,r,i)},generateHandles:function($super){if(this._currentHandles!==null)return;$super();var t=this.getNodeX(),n=this.getNodeY(),r=this.getNode(),i=r.getGraphics().getGenderGraphics().flatten();editor.getPaper().setStart();if(e.attributes.newHandles){var s=editor.getWorkspace().getSizeNormalizedToDefaultZoom(e.attributes.handleStrokeWidth),o="U";r.getGender()=="F"&&(o="M"),r.getGender()=="M"&&(o="F");var u=n-e.attributes.personHandleBreakY-4,a=[["M",t,n],["L",t,u],["L",t-e.attributes.personSiblingHandleLengthX,u]];editor.getPaper().path(a).attr({"stroke-width":s,stroke:"gray"}).insertBefore(i),this.generateHandle("sibling",t-e.attributes.personSiblingHandleLengthX+s/3,u,t-e.attributes.personSiblingHandleLengthX+s/2,u+e.attributes.personSiblingHandleLengthY,"Click to create a sibling or drag to an existing parentless person (valid choices will be highlighted in green)","U");if(editor.getGraph().getParentRelationship(r.getID())===null){var f=undefined;if(e.attributes.enableHandleHintImages)var l=e.attributes.radius/2,a=[["M",t-l,n-e.attributes.personHandleLength],["L",t+l,n-e.attributes.personHandleLength]],c=editor.getPaper().path(a).attr({"stroke-width":s/3,stroke:"#555555"}).toBack(),h=editor.getPaper().rect(t-l-11,n-e.attributes.personHandleLength-5.5,11,11).attr({fill:"#CCCCCC"}).toBack(),p=editor.getPaper().circle(t+l+6,n-e.attributes.personHandleLength,6).attr({fill:"#CCCCCC"}).toBack(),f=editor.getPaper().set().push(c,h,p);this.generateHandle("parent",t,u,t,n-e.attributes.personHandleLength,"Click to create new nodes for the parents or drag to an existing person or partnership (valid choices will be highlighted in green). Dragging to a person will create a new relationship.","F",f)}else if(e.attributes.enableHandleHintImages){var a=[["M",t,u],["L",t,n-e.attributes.personHoverBoxRadius+4]];editor.getPaper().path(a).attr({"stroke-width":s,stroke:"gray"}).insertBefore(i)}if(!r.isFetus()&&r.getAdopted()!="adoptedOut"){if(r.getChildlessStatus()===null){var a=[["M",t,n],["L",t,n+e.attributes.personHandleBreakX]];editor.getPaper().path(a).attr({"stroke-width":s,stroke:"gray"}).insertBefore(i),this.generateHandle("child",t,n+e.attributes.personHandleBreakX-2,t,n+e.attributes.personHandleLength,"Click to create a new child node or drag to an existing parentless person (valid choices will be highlighted in green)","U")}var d=n,a=[["M",t,d],["L",t+e.attributes.personHandleBreakX,d]];editor.getPaper().path(a).attr({"stroke-width":s,stroke:"gray"}).insertBefore(i),this.generateHandle("partnerR",t+e.attributes.personHandleBreakX-2,d,t+e.attributes.personHandleLength,d,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)",o)}}else editor.getGraph().getParentRelationship(r.getID())===null&&this.generateHandle("parent",t,n,t,n-e.attributes.personHandleLength,"Click to create new nodes for the parents or drag to an existing person or partnership (valid choices will be highlighted in green)"),!r.isFetus()&&r.getAdopted()!="adoptedOut"&&(r.getChildlessStatus()===null&&this.generateHandle("child",t,n,t,n+e.attributes.personHandleLength,"Click to create a new child node or drag to an existing parentless node (valid choices will be highlighted in green)"),this.generateHandle("partnerR",t,n,t+e.attributes.personHandleLength,n,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)"),this.generateHandle("partnerL",t,n,t-e.attributes.personHandleLength,n,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)"));this._currentHandles.push(editor.getPaper().setFinish())},generateButtons:function($super){if(this._currentButtons!==null)return;$super(),this.generateMenuBtn(),this.getNode().isProband()||this.generateDeleteBtn()},generateMenuBtn:function(){var t=this,n=function(){t.toggleMenu(!t.isMenuToggled())},r=this.getNode().getGraphics().getGenderShape().clone();r.attr(e.attributes.nodeShapeMenuOff),r.click(n),r.hover(function(){r.attr(e.attributes.nodeShapeMenuOn)},function(){r.attr(e.attributes.nodeShapeMenuOff)}),r.attr("cursor","pointer"),this._currentButtons.push(r),this.disable(),this.getFrontElements().push(r),this.enable()},isMenuToggled:function(){return this._isMenuToggled},toggleMenu:function(e){if(this._justClosedMenu)return;this._isMenuToggled=e;if(e){this.getNode().getGraphics().unmark();var t=this.getBoxOnHover().getBBox(),n=t.x2,r=t.y,i=editor.getWorkspace().canvasToDiv(n+5,r);editor.getNodeMenu().show(this.getNode(),i.x,i.y)}},animateHideHoverZone:function($super){this._hidden=!0;if(!this.isMenuToggled()){var e=editor.getGraph().getParentRelationship(this.getNode().getID());e&&editor.getNode(e)&&editor.getNode(e).getGraphics().unmarkPregnancy(),$super()}},animateDrawHoverZone:function($super){this._hidden=!1;if(!this.isMenuToggled()){var e=editor.getGraph().getParentRelationship(this.getNode().getID());e&&editor.getNode(e)&&editor.getNode(e).getGraphics().markPregnancy(),$super()}},handleAction:function(t,n,r){console.log("handleType: "+t+", isDrag: "+n+", curHovered: "+r);if(n&&r!==null){if(t=="parent"){this.removeHandles(),this.removeButtons();var i={personID:this.getNode().getID(),parentID:r};document.fire("pedigree:person:drag:newparent",i)}else if(t=="partnerR"||t=="partnerL"){this.removeHandles();var i={personID:this.getNode().getID(),partnerID:r};document.fire("pedigree:person:drag:newpartner",i)}else if(t=="child"){var i={personID:r,parentID:this.getNode().getID()};document.fire("pedigree:person:drag:newparent",i)}else if(t=="sibling"){var i={sibling2ID:r,sibling1ID:this.getNode().getID()};document.fire("pedigree:person:drag:newsibling",i)}}else if(!n)if(t=="partnerR"||t=="partnerL"){this.removeHandles();var s=this.getNode().getGender()=="F"||t=="partnerL",i={personID:this.getNode().getID(),preferLeft:s};document.fire("pedigree:person:newpartnerandchild",i)}else if(t=="child"){var o=editor.getWorkspace().canvasToDiv(this.getNodeX(),this.getNodeY()+e.attributes.personHandleLength+15);editor.getNodetypeSelectionBubble().show(this.getNode(),o.x,o.y)}else if(t=="sibling"){var o=editor.getWorkspace().canvasToDiv(this.getNodeX()-e.attributes.personSiblingHandleLengthX,this.getNodeY()-e.attributes.personHandleBreakY+e.attributes.personSiblingHandleLengthY+15);editor.getSiblingSelectionBubble().show(this.getNode(),o.x,o.y)}else if(t=="parent"){this.removeHandles(),this.removeButtons();var i={personID:this.getNode().getID()};document.fire("pedigree:person:newparent",i)}this.animateHideHoverZone()}});return r}),define("pedigree/view/personVisuals",["pedigree/pedigreeEditorParameters","pedigree/model/helpers","pedigree/view/abstractPersonVisuals","pedigree/view/ageCalc","pedigree/view/childlessBehaviorVisuals","pedigree/view/graphicHelpers","pedigree/view/personHoverbox"],function(e,t,n,r,i,s,o){var u=Class.create(n,{initialize:function($super,e,t,n){$super(e,t,n),this._nameLabel=null,this._stillBirthLabel=null,this._ageLabel=null,this._externalIDLabel=null,this._commentsLabel=null,this._childlessStatusLabel=null,this._disorderShapes=null,this._deadShape=null,this._unbornShape=null,this._childlessShape=null,this._isSelected=!1,this._carrierGraphic=null,this._evalLabel=null},generateHoverbox:function(e,t){return editor.isReadOnlyMode()?new ReadOnlyHoverbox(this.getNode(),e,t,this.getGenderGraphics()):new o(this.getNode(),e,t,this.getGenderGraphics())},setGenderGraphics:function($super){if(this.getNode().getLifeStatus()=="aborted"||this.getNode().getLifeStatus()=="miscarriage"){this._genderGraphics&&this._genderGraphics.remove();var t=e.attributes.radius;this.getNode().isPersonGroup()&&(t*=e.attributes.groupNodesScale),this._shapeRadius=t;var n=t*Math.sqrt(3.5),r=n/Math.sqrt(2),i=this.getX()-r,s=this.getY(),o=editor.getPaper().path(["M",i,s,"l",r,-r,"l",r,r,"z"]);o.attr(e.attributes.nodeShapeAborted),this._genderShape=o,o=editor.getPaper().set(o.glow({width:5,fill:!0,opacity:.1}).transform(["t",3,3,"..."]),o),this.getNode().isProband()&&(o.transform(["...s",1.07]),o.attr("stroke-width",5));var u=this.getNode().getGender();if(u=="U"||u=="O")this._genderGraphics=o;else{i=this.getX(),s=this.getY()+t/1.4;var a=u=="M"?"Male":"Female",f=editor.getPaper().text(i,s,a).attr(e.attributes.label);this._genderGraphics=editor.getPaper().set(o,f)}}else $super();this.getNode().isProband()&&(this._genderGraphics.push(this.generateProbandArrow()),this.getGenderShape().transform(["...s",1.08]),this.getGenderShape().attr("stroke-width",5.5)),!editor.isUnsupportedBrowser()&&this.getHoverBox()&&this._genderGraphics.flatten().insertBefore(this.getFrontElements().flatten()),this.updateDisorderShapes(),this.updateCarrierGraphic(),this.updateEvaluationLabel(),this.getNode().getLifeStatus()=="unborn"&&this.updateLifeStatusShapes("unborn")},generateProbandArrow:function(){var e=editor.getPaper().path(editor.getView().__probandArrowPath).attr({fill:"#595959",stroke:"none",opacity:1}),t=this.getX()-this._shapeRadius-26,n=this.getY()+this._shapeRadius-12;return this.getNode().getGender()=="F"&&(t+=5,n-=5),e.transform(["t",t,n]),e},getBackElements:function(){return this.getHoverBox().getBackElements().concat(editor.getPaper().set(this.getChildlessStatusLabel(),this.getChildlessShape()))},getFrontElements:function(){return this.getHoverBox().getFrontElements()},updateExternalIDLabel:function(){this._externalIDLabel&&this._externalIDLabel.remove();if(this.getNode().getExternalID()){var t="["+this.getNode().getExternalID()+"]";this._externalIDLabel=editor.getPaper().text(this.getX(),this.getY()+e.attributes.radius,t).attr(e.attributes.externalIDLabels)}else this._externalIDLabel=null;this.drawLabels()},getExternalIDLabel:function(){return this._externalIDLabel},updateNameLabel:function(){this._nameLabel&&this._nameLabel.remove();var t="";this.getNode().getFirstName()&&(t=this.getNode().getFirstName()),this.getNode().getLastName()?(t+=" "+this.getNode().getLastName(),this.getNode().getLastNameAtBirth()&&this.getNode().getLastNameAtBirth()!=this.getNode().getLastName()&&(t+=" ("+this.getNode().getLastNameAtBirth()+")")):this.getNode().getLastNameAtBirth()&&(t+=" "+this.getNode().getLastNameAtBirth()),this._nameLabel&&this._nameLabel.remove(),t.strip()!=""?(this._nameLabel=editor.getPaper().text(this.getX(),this.getY()+e.attributes.radius,t).attr(e.attributes.nameLabels),this._nameLabel.node.setAttribute("class","field-no-user-select")):this._nameLabel=null,this.drawLabels()},getNameLabel:function(){return this._nameLabel},getDisorderShapes:function(){return this._disorderShapes},updateDisorderShapes:function(){this._disorderShapes&&this._disorderShapes.remove();var t=this.getNode().getAllNodeColors();if(t.length==0)return;var n=function(e,t){var n=Raphael.rgb2hsb(e),r=Raphael.hsb2rgb(n.h,n.s,n.b-.25).hex;return t+"-"+r+":0-"+e+":100"},r=editor.getPaper().set(),i,o;if(this.getNode().getLifeStatus()=="aborted"||this.getNode().getLifeStatus()=="miscarriage"){var u=e.attributes.radius;this.getNode().isPersonGroup()&&(u*=e.attributes.groupNodesScale);var a=u*Math.sqrt(3.5),f=a/Math.sqrt(2),l=this.getX()-f,c=this.getY();i=f*2/t.length;for(var h=0;h<t.length;h++){var p=[],d=l+i,v=this.getY()-(f-Math.abs(d-this.getX()));l<this.getX()&&d>=this.getX()&&(p=["L",this.getX(),this.getY()-f]);var m=editor.getPaper().path(["M",l,c,p,"L",d,v,"L",this.getX(),this.getY(),"z"]);o=editor.getPreferencesManager().getConfigurationOption("useGradientOnNodes")?n(t[h],70):t[h],r.push(m.attr({fill:o,"stroke-width":.5,stroke:"none"})),l=d,c=v}this.getNode().isProband()&&r.transform(["...s",1.04,1.04,this.getX(),this.getY()-this._shapeRadius])}else{var g=(360/t.length).round();i=360/t.length/2,t.length==1&&this.getNode().getGender()=="U"&&(i-=45);var u=this._shapeRadius-.6;this.getNode().getGender()=="U"&&(u*=1.155);for(var y=0;y<t.length;y++)o=editor.getPreferencesManager().getConfigurationOption("useGradientOnNodes")?n(t[y],y*g+i):t[y],r.push(s.sector(editor.getPaper(),this.getX(),this.getY(),u,this.getNode().getGender(),y*g,(y+1)*g,o));r.length<2?r.attr("stroke","none"):r.attr({stroke:"#595959","stroke-width":.03}),this.getNode().isProband()&&r.transform(["...s",1.04,1.04,this.getX(),this.getY()])}this._disorderShapes=r,this._disorderShapes.flatten().insertAfter(this.getGenderGraphics().flatten())},drawDeadShape:function(){var t=editor.getWorkspace().getSizeNormalizedToDefaultZoom(2.5),n,r;if(this.getNode().getLifeStatus()=="aborted"){var i=e.attributes.radius*Math.sqrt(3.5),s=i/Math.sqrt(2);this.getNode().isPersonGroup()&&(s*=e.attributes.groupNodesScale);var n=this.getX()-s/1.5;this.getNode().isPersonGroup()&&(n-=e.attributes.radius/4);var r=this.getY()+s/3;this._deadShape=editor.getPaper().path(["M",n,r,"l",s+s/3,-(s+s/3),"z"]),this._deadShape.attr("stroke-width",t)}else{n=this.getX(),r=this.getY();var o=1.25*(this.getNode().isPersonGroup()?e.attributes.groupNodesScale:1),u=n-o*e.attributes.radius,a=r+o*e.attributes.radius,f=n+o*e.attributes.radius,l=r-o*e.attributes.radius;this._deadShape=editor.getPaper().path(["M",u,a,"L",f,l]).attr("stroke-width",t)}editor.isUnsupportedBrowser()||(this._deadShape.toFront(),this._deadShape.node.setAttribute("class","no-mouse-interaction"))},getDeadShape:function(){return this._deadShape},getAgeLabel:function(){return this._ageLabel},updateAgeLabel:function(){var t,n=this.getNode();if(n.isFetus()){var i=n.getGestationAge();t=i?i+" weeks":null}else{var s=n.getBirthDate(),o=n.getDeathDate();if(editor.getPreferencesManager().getConfigurationOption("dateDisplayFormat")=="DMY")if(n.getLifeStatus()=="alive"){if(s&&s.isComplete()){t="b. "+n.getBirthDate().getBestPrecisionStringDDMMYYY();if(n.getBirthDate().getYear()!==null){var u=r.getAge(n.getBirthDate());t+=" ("+u+")"}}}else if(o&&s&&o.isComplete()&&s.isComplete()){t=n.getBirthDate().getBestPrecisionStringDDMMYYY()+"  "+n.getDeathDate().getBestPrecisionStringDDMMYYY();if(n.getBirthDate().getYear()!==null&&n.getDeathDate().getYear()!==null){var u=r.getAge(n.getBirthDate(),n.getDeathDate());t+="\n"+u}}else o&&o.isComplete()?t="d. "+n.getDeathDate().getBestPrecisionStringDDMMYYY():s&&s.isComplete()&&(t=n.getBirthDate().getBestPrecisionStringDDMMYYY()+"  ?");else if(n.getLifeStatus()=="alive"){if(s)if(s.onlyDecadeAvailable())t="b. "+s.getDecade();else{var u=r.getAge(s,null);if(s.getMonth()==null)t="b. "+s.getYear();else if(s.getDay()==null)t="b. "+s.getMonthName()+" "+s.getYear();else{t="b. "+s.getMonthName()+" "+s.getDay()+", "+s.getYear();if(u.indexOf("day")!=-1||u.indexOf("wk")!=-1)t+=" ("+u+")"}}}else if(o&&s){var u=r.getAge(s,o);o.getYear()==null||o.getMonth()==null||u.indexOf("day")==-1&&u.indexOf("wk")==-1&&u.indexOf("mo")==-1?(t=s.getBestPrecisionStringYear()+"  "+o.getBestPrecisionStringYear(),u!==""&&(t+="\n"+u)):t="d. "+o.getYear(!0)+" ("+u+")"}else o?t="d. "+o.getBestPrecisionStringYear():s&&(t=s.getBestPrecisionStringYear()+"  ?")}this.getAgeLabel()&&this.getAgeLabel().remove(),this._ageLabel=t?editor.getPaper().text(this.getX(),this.getY(),t).attr(e.attributes.label):null,this._ageLabel&&(this._ageLabel.node.setAttribute("class","field-no-user-select"),t&&t.indexOf("\n")>0&&(this._ageLabel.alignTop=!0)),this.drawLabels()},getUnbornShape:function(){return this._unbornShape},drawUnbornShape:function(){this._unbornShape&&this._unbornShape.remove(),this.getNode().getLifeStatus()=="unborn"?(this._unbornShape=editor.getPaper().text(this.getX(),this.getY(),"P").attr(e.attributes.unbornShape),editor.isUnsupportedBrowser()||this._unbornShape.insertBefore(this.getHoverBox().getFrontElements())):this._unbornShape=null},updateEvaluationLabel:function(){this._evalLabel&&this._evalLabel.remove();if(this.getNode().getEvaluated()){if(this.getNode().getLifeStatus()=="aborted"||this.getNode().getLifeStatus()=="miscarriage")var t=this.getX()+this._shapeRadius*1.6,n=this.getY()+this._shapeRadius*.6;else{var r=1.1;this.getNode().getGender()=="U"?r=1.3:this.getNode().getGender()=="M"&&(r=1.4),this.getNode().isProband&&(r*=1.1);var t=this.getX()+this._shapeRadius*r-5,n=this.getY()+this._shapeRadius*r}this._evalLabel=editor.getPaper().text(t,n,"*").attr(e.attributes.evaluationShape).toBack()}else this._evalLabel=null},getEvaluationGraphics:function(){return this._evalLabel},updateCarrierGraphic:function(){this._carrierGraphic&&this._carrierGraphic.remove();var t=this.getNode().getCarrierStatus();if(t!=""&&t!="affected"){if(t=="carrier"){if(this.getNode().getLifeStatus()=="aborted"||this.getNode().getLifeStatus()=="miscarriage")var n=this.getX(),r=this.getY()-this._radius/2;else var n=this.getX(),r=this.getY();this._carrierGraphic=editor.getPaper().circle(n,r,e.attributes.carrierDotRadius).attr(e.attributes.carrierShape)}else if(t=="uncertain"){if(this.getNode().getLifeStatus()=="aborted"||this.getNode().getLifeStatus()=="miscarriage")var n=this.getX(),r=this.getY()-this._radius/2,i=e.attributes.uncertainSmallShape;else var n=this.getX(),r=this.getY(),i=e.attributes.uncertainShape;this._carrierGraphic=editor.getPaper().text(n,r,"?").attr(i)}else if(t=="presymptomatic"){if(this.getNode().getLifeStatus()=="aborted"||this.getNode().getLifeStatus()=="miscarriage"){this._carrierGraphic=null;return}editor.getPaper().setStart();var s=this.getX()-e.attributes.presymptomaticShapeWidth/2,o=this.getY()-this._radius;editor.getPaper().rect(s,o,e.attributes.presymptomaticShapeWidth,this._radius*2).attr(e.attributes.presymptomaticShape);if(this.getNode().getGender()=="U"){editor.getPaper().path("M "+s+" "+o+"L "+this.getX()+" "+(this.getY()-this._radius*1.1)+"L "+(s+e.attributes.presymptomaticShapeWidth)+" "+o+"Z").attr(e.attributes.presymptomaticShape);var u=this.getY()+this._radius;editor.getPaper().path("M "+s+" "+u+"L "+this.getX()+" "+(this.getY()+this._radius*1.1)+"L "+(s+e.attributes.presymptomaticShapeWidth)+" "+u+"Z").attr(e.attributes.presymptomaticShape)}this._carrierGraphic=editor.getPaper().setFinish()}editor.isReadOnlyMode()?this._carrierGraphic.toFront():this._carrierGraphic.insertBefore(this.getHoverBox().getFrontElements())}else this._carrierGraphic=null},getCarrierGraphics:function(){return this._carrierGraphic},getSBLabel:function(){return this._stillBirthLabel},updateSBLabel:function(){this.getSBLabel()&&this.getSBLabel().remove(),this.getNode().getLifeStatus()=="stillborn"?this._stillBirthLabel=editor.getPaper().text(this.getX(),this.getY(),"SB").attr(e.attributes.label):this._stillBirthLabel=null,this.drawLabels()},getCommentsLabel:function(){return this._commentsLabel},updateCommentsLabel:function(){this.getCommentsLabel()&&this.getCommentsLabel().remove();if(this.getNode().getComments()!=""){var t=this.getNode().getComments().replace(/^\s+|\s+$/g,"").replace(/\n\n/gi,"\n \n");this._commentsLabel=editor.getPaper().text(this.getX(),this.getY(),t).attr(e.attributes.commentLabel),this._commentsLabel.node.setAttribute("class","field-no-user-select"),this._commentsLabel.alignTop=!0,this._commentsLabel.addGap=!0}else this._commentsLabel=null;this.drawLabels()},updateLifeStatusShapes:function(e){var t=this.getNode().getLifeStatus();this.getDeadShape()&&this.getDeadShape().remove(),this.getUnbornShape()&&this.getUnbornShape().remove(),this.getSBLabel()&&this.getSBLabel().remove();var n=e=="aborted"||e=="miscarriage",r=t=="aborted"||t=="miscarriage";n!=r&&this.setGenderGraphics(),t=="deceased"||t=="aborted"?this.drawDeadShape():t=="stillborn"?(this.drawDeadShape(),this.updateSBLabel()):t=="unborn"&&this.drawUnbornShape(),this.updateAgeLabel()},setSelected:function($super,e){$super(e),e?this.shiftLabels():this.unshiftLabels()},shiftLabels:function(){var e=this._labelSelectionOffset(),t=this.getLabels();for(var n=0;n<t.length;n++)t[n].stop().animate({y:t[n].oy+e},200,">")},unshiftLabels:function(){var e=this.getLabels(),t=this._childlessStatusLabel?1:0;for(var n=0;n<e.length;n++)e[n].stop().animate({y:e[n].oy},200,">")},getLabels:function(){var e=editor.getPaper().set();return this.getSBLabel()&&e.push(this.getSBLabel()),this.getNameLabel()&&e.push(this.getNameLabel()),this.getAgeLabel()&&e.push(this.getAgeLabel()),this.getExternalIDLabel()&&e.push(this.getExternalIDLabel()),this.getCommentsLabel()&&e.push(this.getCommentsLabel()),e},drawLabels:function(){var t=this.getLabels(),n=this._labelSelectionOffset(),r=this.getChildlessStatusLabel()?e.attributes.label["font-size"]:0;r+=this.getNode().getChildlessStatus()!==null?e.attributes.infertileMarkerHeight+2:0;var i=e.attributes.radius*(this.getNode().isPersonGroup()?e.attributes.groupNodesScale:1),o=this.getY()+i*1.8+n+r;for(var u=0;u<t.length;u++){var a=t[u].addGap&&u!=0?4:8,f=t[u].alignTop?s.getElementHalfHeight(t[u])-a:0;t[u].transform(""),t[u].attr("x",this.getX()),t[u].attr("y",o+f),t[u].oy=t[u].attr("y")-n,t[u].toBack(),u!=t.length-1&&(o=t[u].getBBox().y2+11)}},_labelSelectionOffset:function(){var t=this.isSelected()?e.attributes.radius/1.4:0;return this.isSelected()&&this.getNode().isPersonGroup()&&(t+=e.attributes.radius*(1-e.attributes.groupNodesScale)+5),this.getChildlessStatusLabel()&&(t/=2),t},getShapes:function($super){var e=editor.getPaper().set();return this.getUnbornShape()&&e.push(this.getUnbornShape()),this.getChildlessShape()&&e.push(this.getChildlessShape()),this.getChildlessStatusLabel()&&e.push(this.getChildlessStatusLabel()),this.getDeadShape()&&e.push(this.getDeadShape()),$super().concat(editor.getPaper().set(this.getDisorderShapes(),e))},getAllGraphics:function($super){return $super().push(this.getHoverBox().getBackElements(),this.getLabels(),this.getCarrierGraphics(),this.getEvaluationGraphics(),this.getHoverBox().getFrontElements())},setPos:function($super,e,t,n,r){var i=r;if(n){var s=this;this.getHoverBox().disable(),i=function(){s.getHoverBox().enable(),r&&r()}}$super(e,t,n,i)}});return u.addMethods(i),u}),define("pedigree/view/person",["pedigree/pedigreeDate","pedigree/model/helpers","pedigree/view/abstractPerson","pedigree/view/childlessBehavior","pedigree/view/childlessBehaviorVisuals","pedigree/view/personVisuals"],function(e,t,n,r,i,s){var o=Class.create(n,{initialize:function($super,e,t,n,r){this._isProband=n==0,!this._type&&(this._type="Person"),this._setDefault();var i=r.hasOwnProperty("gender")?r.gender:"U";$super(e,t,i,n),this.assignProperties(r)},_setDefault:function(){this._phenotipsId="",this._firstName="",this._lastName="",this._lastNameAtBirth="",this._birthDate=null,this._deathDate=null,this._conceptionDate="",this._gestationAge="",this._adoptedStatus="",this._externalID="",this._lifeStatus="alive",this._childlessStatus=null,this._childlessReason="",this._carrierStatus="",this._disorders=[],this._cancers={},this._hpo=[],this._ethnicities=[],this._candidateGenes=[],this._twinGroup=null,this._monozygotic=!1,this._evaluated=!1,this._pedNumber="",this._lostContact=!1},_generateGraphics:function(e,t){return new s(this,e,t)},isProband:function(){return this._isProband},getPhenotipsPatientId:function(){return this._phenotipsId},setPhenotipsPatientId:function(e){this._phenotipsId=e},getFirstName:function(){return this._firstName},setFirstName:function(e){e&&(e=e.charAt(0).toUpperCase()+e.slice(1)),this._firstName=e,this.getGraphics().updateNameLabel()},getLastName:function(){return this._lastName},setLastName:function(e){return e&&(e=e.charAt(0).toUpperCase()+e.slice(1)),this._lastName=e,this.getGraphics().updateNameLabel(),e},getExternalID:function(){return this._externalID},setPedNumber:function(e){this._pedNumber=e,this.getGraphics().updateNumberLabel()},getPedNumber:function(){return this._pedNumber},setExternalID:function(e){this._externalID=e,this.getGraphics().updateExternalIDLabel()},getLastNameAtBirth:function(){return this._lastNameAtBirth},setLastNameAtBirth:function(e){return e&&(e=e.charAt(0).toUpperCase()+e.slice(1)),this._lastNameAtBirth=e,this.getGraphics().updateNameLabel(),e},setComments:function($super,e){e!=this.getComments()&&($super(e),this.getGraphics().updateCommentsLabel())},setMonozygotic:function(e){if(e==this._monozygotic)return;this._monozygotic=e},getEvaluated:function(){return this._evaluated},setEvaluated:function(e){if(e==this._evaluated)return;this._evaluated=e,this.getGraphics().updateEvaluationLabel()},getLostContact:function(){return this._lostContact},setLostContact:function(e){if(e==this._lostContact)return;this._lostContact=e},getMonozygotic:function(){return this._monozygotic},setTwinGroup:function(e){this._twinGroup=e},getLifeStatus:function(){return this._lifeStatus},isFetus:function(){return this.getLifeStatus()!="alive"&&this.getLifeStatus()!="deceased"},_isValidLifeStatus:function(e){return e=="unborn"||e=="stillborn"||e=="aborted"||e=="miscarriage"||e=="alive"||e=="deceased"},setLifeStatus:function(e){if(this._isValidLifeStatus(e)){var t=this._lifeStatus;this._lifeStatus=e,e!="deceased"&&this.setDeathDate(""),e=="alive"&&this.setGestationAge(),this.getGraphics().updateSBLabel(),this.isFetus()&&(this.setBirthDate(""),this.setAdopted(""),this.setChildlessStatus(null)),this.getGraphics().updateLifeStatusShapes(t),this.getGraphics().getHoverBox().regenerateHandles(),this.getGraphics().getHoverBox().regenerateButtons()}},getConceptionDate:function(){return this._conceptionDate},setConceptionDate:function(e){this._conceptionDate=e?new Date(e):"",this.getGraphics().updateAgeLabel()},getGestationAge:function(){if(this.getLifeStatus()=="unborn"&&this.getConceptionDate()){var e=6048e5,t=new Date;return Math.round((t.getTime()-this.getConceptionDate().getTime())/e)}return this.isFetus()?this._gestationAge:null},setGestationAge:function(e){try{e=parseInt(e)}catch(t){e=""}if(e){this._gestationAge=e;var n=e*7,r=new Date;r.setDate(r.getDate()-n),this.setConceptionDate(r)}else this._gestationAge="",this.setConceptionDate(null);this.getGraphics().updateAgeLabel()},getBirthDate:function(){return this._birthDate},setBirthDate:function(t){t=new e(t),t.isSet()||(t=null);if(!t||!this.getDeathDate()||this.getDeathDate().canBeAfterDate(t))this._birthDate=t,this.getGraphics().updateAgeLabel()},getDeathDate:function(){return this._deathDate},setDeathDate:function(t){t=new e(t),t.isSet()||(t=null);if(!t||!this.getBirthDate()||t.canBeAfterDate(this.getBirthDate()))this._deathDate=t,this._deathDate&&this.getLifeStatus()=="alive"&&this.setLifeStatus("deceased");return this.getGraphics().updateAgeLabel(),this.getDeathDate()},_isValidCarrierStatus:function(e){return e==""||e=="carrier"||e=="uncertain"||e=="affected"||e=="presymptomatic"},setCarrierStatus:function(e){var t=this.getDisorders().length;if(e===undefined||e===null)t==0?e="":(e=this.getCarrierStatus(),e==""&&(e="affected"));if(!this._isValidCarrierStatus(e))return;t>0&&e==""?t==1&&this.getDisorders()[0]=="affected"?(this.removeDisorder("affected"),this.getGraphics().updateDisorderShapes()):e="affected":t==0&&e=="affected"&&(this.addDisorder("affected"),this.getGraphics().updateDisorderShapes()),e!=this._carrierStatus&&(this._carrierStatus=e,this.getGraphics().updateCarrierGraphic())},getCarrierStatus:function(){return this._carrierStatus},getAllNodeColors:function(){var e=[];for(var t=0;t<this.getDisorders().length;t++)e.push(editor.getDisorderLegend().getObjectColor(this.getDisorders()[t]));for(var t=0;t<this.getGenes().length;t++)e.push(editor.getGeneLegend().getObjectColor(this.getGenes()[t]));for(var n in this.getCancers())this.getCancers().hasOwnProperty(n)&&this.getCancers()[n].hasOwnProperty("affected")&&this.getCancers()[n].affected&&e.push(editor.getCancerLegend().getObjectColor(n));return e},getDisorders:function(){return this._disorders},getDisordersForExport:function(){var e=this._disorders.slice(0);return e},addDisorder:function(e){typeof e!="object"&&(e=editor.getDisorderLegend().getDisorder(e)),this.hasDisorder(e.getDisorderID())?alert("This person already has the specified disorder"):(editor.getDisorderLegend().addCase(e.getDisorderID(),e.getName(),this.getID()),this.getDisorders().push(e.getDisorderID())),this.getDisorders().length>1&&this.removeDisorder("affected")},removeDisorder:function(e){this.hasDisorder(e)?(editor.getDisorderLegend().removeCase(e,this.getID()),this._disorders=this.getDisorders().without(e)):e!="affected"&&alert("This person doesn't have the specified disorder")},setDisorders:function(e){for(var t=this.getDisorders().length-1;t>=0;t--)this.removeDisorder(this.getDisorders()[t]);for(var t=0;t<e.length;t++)this.addDisorder(e[t]);this.getGraphics().updateDisorderShapes(),this.setCarrierStatus()},getHPO:function(){return this._hpo},getHPOForExport:function(){var e=this._hpo.slice(0);return e},addHPO:function(e){typeof e!="object"&&(e=editor.getHPOLegend().getTerm(e)),this.hasHPO(e.getID())?alert("This person already has the specified phenotype"):(editor.getHPOLegend().addCase(e.getID(),e.getName(),this.getID()),this.getHPO().push(e.getID()))},removeHPO:function(e){this.hasHPO(e)?(editor.getHPOLegend().removeCase(e,this.getID()),this._hpo=this.getHPO().without(e)):alert("This person doesn't have the specified HPO term")},setHPO:function(e){for(var t=this.getHPO().length-1;t>=0;t--)this.removeHPO(this.getHPO()[t]);for(var t=0;t<e.length;t++)this.addHPO(e[t])},hasHPO:function(e){return this.getHPO().indexOf(e)!=-1},setEthnicities:function(e){this._ethnicities=e},getEthnicities:function(){return this._ethnicities},addGene:function(e){this.getGenes().indexOf(e)==-1&&(editor.getGeneLegend().addCase(e,e,this.getID()),this.getGenes().push(e))},removeGene:function(e){this.getGenes().indexOf(e)!==-1&&(editor.getGeneLegend().removeCase(e,this.getID()),this._candidateGenes=this.getGenes().without(e))},setGenes:function(e){for(var t=this.getGenes().length-1;t>=0;t--)this.removeGene(this.getGenes()[t]);for(var t=0;t<e.length;t++)this.addGene(e[t]);this.getGraphics().updateDisorderShapes()},getGenes:function(){return this._candidateGenes},addCancer:function(e,t){this.getCancers().hasOwnProperty(e)||(t.hasOwnProperty("affected")&&t.affected&&editor.getCancerLegend().addCase(e,e,this.getID()),this.getCancers()[e]=t)},removeCancer:function(e){this.getCancers().hasOwnProperty(e)&&(editor.getCancerLegend().removeCase(e,this.getID()),delete this._cancers[e])},setCancers:function(e){for(var t in this.getCancers())this.getCancers().hasOwnProperty(t)&&this.removeCancer(t);for(var t in e)e.hasOwnProperty(t)&&this.addCancer(t,e[t]);this.getGraphics().updateDisorderShapes()},getCancers:function(){return this._cancers},remove:function($super){this.setDisorders([]),this.setHPO([]),this.setGenes([]),this.setCancers([]),$super()},hasDisorder:function(e){return this.getDisorders().indexOf(e)!=-1},setChildlessStatus:function(e){return this.isValidChildlessStatus(e)||(e=null),e!=this.getChildlessStatus()&&(this._childlessStatus=e,this.setChildlessReason(null),this.getGraphics().updateChildlessShapes(),this.getGraphics().getHoverBox().regenerateHandles()),this.getChildlessStatus()},getSummary:function(){var e=editor.getGraph().hasRelationships(this.getID()),t=e?["unborn","aborted","miscarriage","stillborn"]:!1,n=!1,r=editor.getGraph().getPossibleGenders(this.getID());for(gender in r)r.hasOwnProperty(gender)&&(r[gender]||(n||(n=[]),n.push(gender)));var i=this.isFetus(),s=[];this.getDisorders().forEach(function(e){var t=editor.getDisorderLegend().getDisorder(e).getName();s.push({id:e,value:t})});var o=[];this.getHPO().forEach(function(e){var t=editor.getHPOLegend().getTerm(e).getName();o.push({id:e,value:t})});var u=this.isFetus()||editor.getGraph().hasToBeAdopted(this.getID());!u&&e&&(u=["adoptedOut","disableViaOpacity"]);var a=!0,f=!0;if(this._twinGroup!==null){var l=editor.getGraph().getAllTwinsSortedByOrder(this.getID());if(l.length>1){a=!1,f=!1;for(var c=0;c<l.length;c++)if(editor.getGraph().getGender(l[c])!=this.getGender()){f=!0;break}}}var h=[];s.length>0&&(s.length!=1||s[0].id!="affected")&&(h=[""]),(this.getLifeStatus()=="aborted"||this.getLifeStatus()=="miscarriage")&&h.push("presymptomatic");var p=this.isProband()||!editor.getGraph().isRelatedToProband(this.getID());return{identifier:{value:this.getID()},first_name:{value:this.getFirstName()},last_name:{value:this.getLastName()},last_name_birth:{value:this.getLastNameAtBirth()},external_id:{value:this.getExternalID()},gender:{value:this.getGender(),inactive:n},date_of_birth:{value:this.getBirthDate(),inactive:this.isFetus()},carrier:{value:this.getCarrierStatus(),disabled:h},disorders:{value:s},ethnicity:{value:this.getEthnicities()},candidate_genes:{value:this.getGenes()},adopted:{value:this.getAdopted(),inactive:u},state:{value:this.getLifeStatus(),inactive:t},date_of_death:{value:this.getDeathDate(),inactive:this.isFetus()},comments:{value:this.getComments(),inactive:!1},gestation_age:{value:this.getGestationAge(),inactive:!this.isFetus()},childlessSelect:{value:this.getChildlessStatus()?this.getChildlessStatus():"none",inactive:i},childlessText:{value:this.getChildlessReason()?this.getChildlessReason():undefined,inactive:i,disabled:!this.getChildlessStatus()},placeholder:{value:!1,inactive:!0},monozygotic:{value:this.getMonozygotic(),inactive:a,disabled:f},evaluated:{value:this.getEvaluated()},hpo_positive:{value:o},nocontact:{value:this.getLostContact(),inactive:p},cancers:{value:this.getCancers()},phenotipsid:{value:this.getPhenotipsPatientId()}}},getProperties:function($super){var e=$super();return this.getPhenotipsPatientId()!=""&&(e.phenotipsId=this.getPhenotipsPatientId()),this.getFirstName()!=""&&(e.fName=this.getFirstName()),this.getLastName()!=""&&(e.lName=this.getLastName()),this.getLastNameAtBirth()!=""&&(e.lNameAtB=this.getLastNameAtBirth()),this.getExternalID()!=""&&(e.externalID=this.getExternalID()),this.getBirthDate()!=null&&(e.dob=this.getBirthDate().getSimpleObject()),this.getAdopted()!=""&&(e.adoptedStatus=this.getAdopted()),this.getLifeStatus()!="alive"&&(e.lifeStatus=this.getLifeStatus()),this.getDeathDate()!=null&&(e.dod=this.getDeathDate().getSimpleObject()),this.getGestationAge()!=null&&(e.gestationAge=this.getGestationAge()),this.getChildlessStatus()!=null&&(e.childlessStatus=this.getChildlessStatus(),e.childlessReason=this.getChildlessReason()),this.getDisorders().length>0&&(e.disorders=this.getDisordersForExport()),t.isObjectEmpty(this.getCancers())||(e.cancers=this.getCancers()),this.getHPO().length>0&&(e.hpoTerms=this.getHPOForExport()),this.getEthnicities().length>0&&(e.ethnicities=this.getEthnicities()),this.getGenes().length>0&&(e.candidateGenes=this.getGenes()),this._twinGroup!==null&&(e.twinGroup=this._twinGroup),this._monozygotic&&(e.monozygotic=this._monozygotic),this._evaluated&&(e.evaluated=this._evaluated),this._carrierStatus&&(e.carrierStatus=this._carrierStatus),this.getLostContact()&&(e.lostContact=this.getLostContact()),this.getPedNumber()!=""&&(e.nodeNumber=this.getPedNumber()),e},assignProperties:function($super,e){return this._setDefault(),$super(e)?(e.phenotipsId&&this.getPhenotipsPatientId()!=e.phenotipsId&&this.setPhenotipsPatientId(e.phenotipsId),e.fName&&this.getFirstName()!=e.fName&&this.setFirstName(e.fName),e.lName&&this.getLastName()!=e.lName&&this.setLastName(e.lName),e.lNameAtB&&this.getLastNameAtBirth()!=e.lNameAtB&&this.setLastNameAtBirth(e.lNameAtB),e.externalID&&this.getExternalID()!=e.externalID&&this.setExternalID(e.externalID),e.dob&&this.getBirthDate()!=e.dob&&this.setBirthDate(e.dob),e.disorders&&this.setDisorders(e.disorders),e.cancers&&this.setCancers(e.cancers),e.hpoTerms&&this.setHPO(e.hpoTerms),e.ethnicities&&this.setEthnicities(e.ethnicities),e.candidateGenes&&this.setGenes(e.candidateGenes),e.hasOwnProperty("adoptedStatus")&&this.getAdopted()!=e.adoptedStatus&&this.setAdopted(e.adoptedStatus),e.hasOwnProperty("lifeStatus")&&this.getLifeStatus()!=e.lifeStatus&&this.setLifeStatus(e.lifeStatus),e.dod&&this.getDeathDate()!=e.dod&&this.setDeathDate(e.dod),e.gestationAge&&this.getGestationAge()!=e.gestationAge&&this.setGestationAge(e.gestationAge),e.childlessStatus&&this.getChildlessStatus()!=e.childlessStatus&&this.setChildlessStatus(e.childlessStatus),e.childlessReason&&this.getChildlessReason()!=e.childlessReason&&this.setChildlessReason(e.childlessReason),e.hasOwnProperty("twinGroup")&&this._twinGroup!=e.twinGroup&&this.setTwinGroup(e.twinGroup),e.hasOwnProperty("monozygotic")&&this._monozygotic!=e.monozygotic&&this.setMonozygotic(e.monozygotic),e.hasOwnProperty("evaluated")&&this._evaluated!=e.evaluated&&this.setEvaluated(e.evaluated),e.hasOwnProperty("carrierStatus")&&this._carrierStatus!=e.carrierStatus&&this.setCarrierStatus(e.carrierStatus),e.hasOwnProperty("nodeNumber")&&this.getPedNumber()!=e.nodeNumber&&this.setPedNumber(e.nodeNumber),e.hasOwnProperty("lostContact")&&this.getLostContact()!=e.lostContact&&this.setLostContact(e.lostContact),!0):!1}});return o.addMethods(r),o}),define("pedigree/view/personGroupHoverbox",["pedigree/pedigreeEditorParameters","pedigree/view/personHoverbox"],function(e,t){var n=Class.create(t,{initialize:function($super,t,n,r,i){var s=e.attributes.radius*2;$super(t,n,r,i)},generateHandles:function($super){if(this._currentHandles!==null)return;e.attributes.newHandles},generateButtons:function($super){if(this._currentButtons!==null)return;this._currentButtons=[],this.generateMenuBtn(),this.generateDeleteBtn()},isMenuToggled:function(){return this._isMenuToggled},toggleMenu:function(e){if(this._justClosedMenu)return;this._isMenuToggled=e;if(e){this.getNode().getGraphics().unmark();var t=this.getBoxOnHover().getBBox(),n=t.x2,r=t.y,i=editor.getWorkspace().canvasToDiv(n+5,r);editor.getNodeGroupMenu().show(this.getNode(),i.x,i.y)}}});return n}),define("pedigree/view/personGroupVisuals",["pedigree/pedigreeEditorParameters","pedigree/view/personGroupHoverbox","pedigree/view/personVisuals","pedigree/view/readonlyHoverbox"],function(e,t,n,r){var i=Class.create(n,{initialize:function($super,e,t,n){$super(e,t,n),this.setNumPersons(e.getNumPersons())},generateHoverbox:function(e,n){return editor.isReadOnlyMode()?new r(this.getNode(),e,n,this.getGenderGraphics()):new t(this.getNode(),e,n,this.getGenderGraphics())},getAllGraphics:function($super){return $super().push(this._label)},setNumPersons:function(t){this._label&&this._label.remove();var n=t&&t>1?String(t):"n",r=this.getNode().getLifeStatus()=="aborted"||this.getNode().getLifeStatus()=="miscarriage"?this.getY()-12:this.getY(),i=this.getNode().getLifeStatus()=="aborted"?this.getX()+8:this.getX();this._label=editor.getPaper().text(i,r,n).attr(e.attributes.descendantGroupLabel),this._label.node.setAttribute("class","no-mouse-interaction")}});return i}),define("pedigree/view/personGroup",["pedigree/view/person","pedigree/view/personGroupVisuals"],function(e,t){var n=Class.create(e,{initialize:function($super,e,t,n,r){this._numPersons=1,this._comment="",this._type="PersonGroup",$super(e,t,n,r)},_generateGraphics:function(e,n){return new t(this,e,n)},isProband:function(){return!1},setNumPersons:function(e){this._numPersons=e,this.getGraphics().setNumPersons(e)},getNumPersons:function(){return this._numPersons},setLifeStatus:function($super,e){$super(e),this.getGraphics().setNumPersons(this._numPersons)},getProperties:function($super){var e=$super();return e.numPersons=this.getNumPersons(),e},assignProperties:function($super,e){return $super(e)&&e.numPersons?(this.getNumPersons()!=e.numPersons&&this.setNumPersons(e.numPersons),!0):!1},getSummary:function(){var e=[];this.getDisorders().forEach(function(t){var n=editor.getDisorderLegend().getDisorder(t).getName();e.push({id:t,value:n})});var t=this.isFetus()||editor.getGraph().hasToBeAdopted(this.getID());return{identifier:{value:this.getID()},comment:{value:this.getFirstName()},gender:{value:this.getGender()},external_ids:{value:this.getExternalID()},disorders:{value:e},ethnicity:{value:this.getEthnicities()},adopted:{value:this.getAdopted(),inactive:t},comments:{value:this.getComments(),inactive:!1},state:{value:this.getLifeStatus()},numInGroup:{value:this.getNumPersons()},evaluatedGrp:{value:this.getEvaluated()}}}});return n}),define("pedigree/view/personPlaceholderVisuals",["pedigree/view/personVisuals","pedigree/view/readonlyHoverbox"],function(e,t){var n=Class.create(e,{initialize:function($super,e,t,n){$super(e,t,n)},generateHoverbox:function(e,n){return new t(this.getNode(),e,n,this.getGenderGraphics())},markPermanently:function(){},grow:function(){},setGenderGraphics:function(){this._genderGraphics&&this._genderGraphics.remove();var e=this.getX(),t=this.getY(),n=10,r=editor.getPaper().rect(e-n,t-n,n*2,n*2).hide();this._genderShape=r,this._genderGraphics=editor.getPaper().set(r)}});return n}),define("pedigree/view/personPlaceholder",["pedigree/view/person","pedigree/view/personPlaceholderVisuals"],function(e,t){var n=Class.create(e,{initialize:function($super,e,t,n,r){this._comment="",this._type="PersonPlaceholder",$super(e,t,n,{gender:"U"})},_generateGraphics:function(e,n){return new t(this,e,n)},isProband:function(){return!1},getProperties:function($super){var e={};return this.getComments()!=""&&(e.comments=this.getComments()),e.placeholder=!0,e},assignProperties:function($super,e){return $super(e)},getSummary:function(){return{type:{value:"placeholder"}}}});return n}),define("pedigree/view",["pedigree/pedigreeEditorParameters","pedigree/model/helpers","pedigree/view/lineSet","pedigree/view/graphicHelpers","pedigree/view/partnership","pedigree/view/person","pedigree/view/personGroup","pedigree/view/personPlaceholder"],function(e,t,n,r,i,s,o,u){var a=Class.create({initialize:function(){console.log("--- view init ---"),this.preGenerateGraphics(),this._nodeMap={},this.hoverModeZones=editor.getPaper().set(),this._currentMarkedNew=[],this._currentGrownNodes=[],this._currentHoveredNode=null,this._currentDraggable=null,this._lineSet=new n},getSettings:function(){return{colors:{disorders:editor.getDisorderLegend().getAllColors(),genes:editor.getGeneLegend().getAllColors(),cancers:editor.getCancerLegend().getAllColors()},names:{disorders:editor.getDisorderLegend().getAllNames()}}},loadSettings:function(e){e.hasOwnProperty("colors")&&(e.colors.hasOwnProperty("disorders")&&editor.getDisorderLegend().setAllPreferredColors(e.colors.disorders),e.colors.hasOwnProperty("genes")&&editor.getGeneLegend().setAllPreferredColors(e.colors.genes))},preGenerateGraphics:function(){this.__menuButton_svgPath="M1.213,5.849C1.213,5.849,1.213,5.849,1.213,5.849C1.213,5.849,1.213,5.848,1.213,5.848C1.213,5.848,1.213,5.849,1.213,5.849C1.213,5.849,1.213,5.849,1.213,5.849M1.213,5.848C1.213,5.848,4.676,9.3114,4.676,9.3114C4.676,9.3114,1.2126,12.774,1.2126,12.774C1.2126,12.774,2.486,14.048,2.486,14.048C2.486,14.048,7.222,9.311,7.222,9.311C7.222,9.311,2.486,4.574,2.486,4.574C2.486,4.574,1.213,5.848,1.213,5.8476C1.2131999999999998,5.8476,1.2131999999999998,5.8476,1.2131999999999998,5.8476M7.348799999999999,13.9614C7.348799999999999,13.9614,16.0002,13.9614,16.0002,13.9614C16.0002,13.9614,16.0002,12.161999999999999,16.0002,12.161999999999999C16.0002,12.161999999999999,7.348799999999999,12.161999999999999,7.348799999999999,12.161999999999999C7.348799999999999,12.161999999999999,7.348799999999999,13.9614,7.348799999999999,13.9614C7.348799999999999,13.9614,7.348799999999999,13.9614,7.348799999999999,13.9614M9.949799999999998,10.2114C9.949799999999998,10.2114,16.0002,10.2114,16.0002,10.2114C16.0002,10.2114,16.0002,8.411999999999999,16.0002,8.411999999999999C16.0002,8.411999999999999,9.949799999999998,8.411999999999999,9.949799999999998,8.411999999999999C9.949799999999998,8.411999999999999,9.949799999999998,10.2114,9.949799999999998,10.2114C9.949799999999998,10.2114,9.949799999999998,10.2114,9.949799999999998,10.2114M7.348799999999999,4.6613999999999995C7.348799999999999,4.6613999999999995,7.348799999999999,6.462,7.348799999999999,6.462C7.348799999999999,6.462,16.0002,6.462,16.0002,6.462C16.0002,6.462,16.0002,4.661,16.0,4.6614C16.0,4.6614,7.349,4.6614,7.349,4.6614C7.349,4.6614,7.349,4.6614,7.349,4.6614",this.__menuButton_BBox=Raphael.pathBBox(this.__menuButton_svgPath),this.__deleteButton_svgPath="M14.867,12.851C14.867,12.851,11.566,9.55,11.566,9.55C11.566,9.55,14.866,6.249,14.866,6.249C14.866,6.249,13.169,4.551,13.169,4.551C13.169,4.551,9.868,7.852,9.868,7.852C9.868,7.852,6.567,4.551,6.567,4.551C6.567,4.551,4.87,6.249,4.87,6.249C4.87,6.249,8.171,9.55,8.171,9.55C8.171,9.55,4.87,12.851,4.870,12.851C4.870,12.851,6.568,14.549,6.568,14.549C6.568,14.549,9.868,11.248,9.868,11.248C9.868,11.248,13.169,14.549,13.169,14.549C13.169,14.549,14.867,12.851,14.867,12.851",this.__deleteButton_BBox=Raphael.pathBBox(this.__deleteButton_svgPath),this.__arrow_svgPath="M8.348,23.029C8.348,23.029,0.791,30.584,0.791,30.584C0.791,30.584,3.515,33.308,3.515,33.308C3.515,33.308,11.07,25.752,11.0704,25.752C11.07,25.752,13.114,27.795,13.114,27.795C13.114,27.795,15.598,18.524,15.598,18.524C15.598,18.524,6.327,21.008,6.327,21.008C6.327,21.008,8.348,23.029,8.348,23.0285C8.348,23.029,8.348,23.029,8.348,23.029",this.__probandArrowPath=Raphael.transformPath(this.__arrow_svgPath,["s",1.1,1.1,0,0])},getNodeMap:function(){return this._nodeMap},getNode:function(e){if(!this._nodeMap.hasOwnProperty(e))throw console.log("ERROR: requesting non-existent node "+e),"ERROR";return this._nodeMap[e]},getPersonNodeNear:function(e,t){for(var n in this._nodeMap)if(this._nodeMap.hasOwnProperty(n)){var r=this.getNode(n);if((r.getType()=="Person"||r.getType()=="PersonGroup")&&r.getGraphics().containsXY(e,t))return r}return null},getCurrentHoveredNode:function(){return this._currentHoveredNode},getCurrentDraggable:function(){return this._currentDraggable},setCurrentDraggable:function(e){this._currentDraggable=e},removeFromNodeMap:function(e){delete this.getNodeMap()[e]},drawCurvedLineWithCrossings:function(t,n,i,s,o,u,a,f,l,c){if(i==s&&i==u)return this.drawLineWithCrossings(t,n,i,o,u,f,l,c);var h=e.attributes.curvedLinesCornerRadius*.8,p=n>o;if(isFinite(a))var d=p?o+a:o-a,v=p?o+a+h:o-a-h,m=p?o+a+h*2:o-a-h*2;else var m=o;var g=p?n-h/2:n+h/2,y=p?g-h:g+h,b=p?g-2*h:g+2*h;i<=s?this.drawLineWithCrossings(t,n,i,m,i,f,l,!p,!0):(this.drawLineWithCrossings(t,n,i,g,i,f,l,!p,!0),Math.abs(i-s)>=h*2?(p?r.drawCornerCurve(g,i,y,i-h,!0,f,l,-2.5,2.5,2.5,-2.5):r.drawCornerCurve(g,i,y,i-h,!0,f,l,2.5,2.5,-2.5,-2.5),this.drawLineWithCrossings(t,y,i-h,y,s+h,f,l,p),p?r.drawCornerCurve(y,s+h,b,s,!1,f,l,-2.5,2.5,2.5,-2.5):r.drawCornerCurve(y,s+h,b,s,!1,f,l,2.5,2.5,-2.5,-2.5)):p?r.drawLevelChangeCurve(g,i,b,s,f,l,-2.5,2.5,2.5,-2.5):r.drawLevelChangeCurve(g,i,b,s,f,l,2.5,2.5,-2.5,-2.5),this.drawLineWithCrossings(t,b,s,m,s,f,l,!p,!0)),m!=o&&(Math.abs(u-s)>=h*2?(p?r.drawCornerCurve(m,s,v,s+h,!0,f,l,2.5,2.5,-2.5,-2.5):r.drawCornerCurve(m,s,v,s+h,!0,f,l,2.5,-2.5,-2.5,2.5),this.drawLineWithCrossings(t,v,s+h,v,u-h,f,l,!p),p?r.drawCornerCurve(v,u-h,d,u,!1,f,l,2.5,2.5,-2.5,-2.5):r.drawCornerCurve(v,u-h,d,u,!1,f,l,2.5,-2.5,-2.5,2.5)):p?r.drawLevelChangeCurve(m,s,d,u,f,l,2.5,2.5,-2.5,-2.5):r.drawLevelChangeCurve(m,s,d,u,f,l,2.5,-2.5,-2.5,2.5),this.drawLineWithCrossings(t,d,u,o,u,f,l,!p))},drawLineWithCrossings:function(e,t,n,r,i,s,o,u,a){if(t>r||t==r&&n>i){var f=t,l=n;t=r,n=i,r=f,i=l}var c=n==i,h=t==r,p=this._lineSet.addLine(e,t,n,r,i),d=function(e,r){var i=(t-e.x)*(t-e.x)+(n-e.y)*(n-e.y),s=(t-r.x)*(t-r.x)+(n-r.y)*(n-r.y);return i-s};p.sort(d);for(var v=0;v<(o?2:1);v++){o&&(a?(t-=2.5,r+=2.5):(t+=-2.5+v*7.5,r+=-2.5+v*7.5),u?(n+=2.5-v*7.5,i+=2.5-v*7.5):(n+=-2.5+v*7.5,i+=-2.5+v*7.5));var m="M "+t+" "+n;for(var g=0;g<p.length;g++){var y=p[g],b=function(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)},w=c?400:81;if(b(y,{x:t,y:n})<w)continue;if(b(y,{x:r,y:i})<w)continue;c?(o&&(u?y.y+=2.5-v*7.5:y.y+=-2.5+v*7.5),m+=" L "+(y.x-10)+" "+y.y,m+=" C "+(y.x-7)+" "+(y.y+1)+" "+(y.x-7)+" "+(y.y-7)+" "+y.x+" "+(y.y-7),m+=" C "+(y.x+7)+" "+(y.y-7)+" "+(y.x+7)+" "+(y.y+1)+" "+(y.x+10)+" "+y.y):h&&(o&&(y.x+=-2.5+v*7.5),m+=" L "+y.x+" "+(y.y-10),m+=" C "+(y.x-1)+" "+(y.y-7)+" "+(y.x+7)+" "+(y.y-7)+" "+(y.x+7)+" "+y.y,m+=" C "+(y.x+7)+" "+(y.y+7)+" "+(y.x-1)+" "+(y.y+7)+" "+y.x+" "+(y.y+10))}m+=" L "+r+" "+i,editor.getPaper().path(m).attr(s).toBack()}},addNode:function(e){var t=editor.getGraph();if(!t.isValidID(e))throw"addNode(): Invalid id";var n,r=t.getProperties(e),a=t.getPosition(e),f=editor.convertGraphCoordToCanvasCoord(a.x,a.y);if(t.isRelationship(e))n=new i(f.x,f.y,e,r);else if(t.isPlaceholder(e))n=new u(f.x,f.y,e,r);else if(t.isPersonGroup(e))n=new o(f.x,f.y,e,r);else{if(!t.isPerson(e))throw"addNode(): unsupported node type";n=new s(f.x,f.y,e,r)}return this.getNodeMap()[e]=n,n},moveNode:function(e,t){var n=editor.getGraph(),r=n.getPosition(e),i=editor.convertGraphCoordToCanvasCoord(r.x,r.y);this.getNode(e).setPos(i.x,i.y,t)},changeNodeIds:function(e){var t={};for(oldID in this._nodeMap){var n=this.getNode(oldID),r=e.hasOwnProperty(oldID)?e[oldID]:oldID;n.setID(r),t[r]=n}this._nodeMap=t,this._lineSet.replaceIDs(e),editor.getCancerLegend().replaceIDs(e),editor.getGeneLegend().replaceIDs(e),editor.getHPOLegend().replaceIDs(e),editor.getDisorderLegend().replaceIDs(e)},enterHoverMode:function(e,t){var n=this,r=this.getValidDragTargets(e.getID(),t);r.each(function(e){n._currentGrownNodes.push(e);var t=n.getNode(e);t.getGraphics().grow();var r=t.getGraphics().getHoverBox().getHoverZoneMask().clone().toFront();r.hover(function(){n._currentHoveredNode=e,t.getGraphics().getHoverBox().setHighlighted(!0)},function(){n._currentHoveredNode=null,t.getGraphics().getHoverBox().setHighlighted(!1)}),n.hoverModeZones.push(r)})},exitHoverMode:function(){this._currentHoveredNode=null,this.hoverModeZones.remove();var e=this;this._currentGrownNodes.each(function(t){var n=e.getNode(t);n.getGraphics().shrink(),n.getGraphics().getHoverBox().setHighlighted(!1)}),this._currentGrownNodes=[]},unmarkAll:function(){for(var e=0;e<this._currentMarkedNew.length;e++){var t=this.getNode(this._currentMarkedNew[e]);t.getGraphics().unmark()}this._currentMarkedNew=[]},getValidDragTargets:function(e,t){var n=[];switch(t){case"sibling":n=editor.getGraph().getPossibleSiblingsOf(e);break;case"child":n=editor.getGraph().getPossibleChildrenOf(e);break;case"parent":n=editor.getGraph().getPossibleParentsOf(e);break;case"partnerR":case"partnerL":n=editor.getGraph().getPossiblePartnersOf(e);break;case"PlaceHolder":throw"TODO";default:throw"Incorrect hoverType"}return n},applyChanges:function(e,n){console.log("Change set: "+t.stringifyObject(e));if(t.isObjectEmpty(e))return;var r=new t.Timer,i=new t.Timer;try{this.unmarkAll(),e.hasOwnProperty("moved")||(e.moved=[]),e.hasOwnProperty("removed")||(e.removed=[]),e.hasOwnProperty("changedIDSet")||(e.changedIDSet={});if(e.hasOwnProperty("removed")){var s={};for(var o=0;o<e.removed.length;o++){var u=e.removed[o];this.getNodeMap()[u].remove(),this.removeFromNodeMap(u);var a=this._lineSet.removeAllLinesAffectedByOwnerMovement(u);for(var f=0;f<a.length;f++)t.arrayContains(e.removed,a[f])||(s[a[f]]=!0)}this.changeNodeIds(e.changedIDSet);for(var l in s)if(s.hasOwnProperty(l)){var c=changedIDs.hasOwnProperty(l)?changedIDs[l]:l;t.arrayContains(e.moved,c)||e.moved.push(c)}}r.printSinceLast("=== Removal runtime: ");var h=[],p=[],d=[],v=[],m={};if(e.hasOwnProperty("moved")){for(var o=0;o<e.moved.length;o++){var g=e.moved[o];if(editor.getGraph().isRelationship(g)){var a=this._lineSet.removeAllLinesAffectedByOwnerMovement(g);for(var f=0;f<a.length;f++){var l=a[f];t.arrayContains(e.moved,l)||e.moved.push(l)}}}for(var o=0;o<e.moved.length;o++){var g=e.moved[o];editor.getGraph().isRelationship(g)?p.push(g):h.push(g)}}console.log("moved: "+t.stringifyObject(e.moved));if(e.hasOwnProperty("new"))for(var o=0;o<e["new"].length;o++){var y=e["new"][o];editor.getGraph().isRelationship(y)?v.push(y):d.push(y)}r.printSinceLast("=== Bookkeeping/sorting runtime: ");for(var o=0;o<h.length;o++)this.moveNode(h[o],m.hasOwnProperty(h[o]));r.printSinceLast("=== Move persons runtime: ");for(var o=0;o<d.length;o++){var b=this.addNode(d[o]);n&&(b.getGraphics().markPermanently(),this._currentMarkedNew.push(d[o]))}r.printSinceLast("=== New persons runtime: ");for(var o=0;o<p.length;o++)this.moveNode(p[o]);r.printSinceLast("=== Move rels runtime: ");for(var o=0;o<v.length;o++)this.addNode(v[o]);r.printSinceLast("=== New rels runtime: ");if(e.hasOwnProperty("highlight"))for(var o=0;o<e.highlight.length;o++){var w=e.highlight[o];this.getNode(w).getGraphics().markPermanently(),this._currentMarkedNew.push(w)}for(var E in this._nodeMap)this._nodeMap.hasOwnProperty(E)&&editor.getGraph().isPerson(E)&&!this.getNode(E).getGraphics().getHoverBox().isMenuToggled()&&(this.getNode(E).getGraphics().getHoverBox().removeButtons(),this.getNode(E).getGraphics().getHoverBox().removeHandles());var S={memo:{check:!0,noUndoRedo:!0}};editor.getController().handleRenumber(S),r.printSinceLast("=== highlight & update handles runtime: "),i.printSinceLast("=== Total apply changes runtime: ")}catch(x){console.log("[view] update error: "+x)}}});return a}),define("pedigree/model/baseGraph",["pedigree/model/helpers"],function(e){return BaseGraph=function(e,t){this.v=[],this.inedges=[],this.maxRealVertexId=-1,this.weights=[],this.type=[],this.properties=[],this.vWidth=[],this.defaultPersonNodeWidth=e?e:10,this.defaultNonPersonNodeWidth=t?t:2},BaseGraph.TYPE={RELATIONSHIP:1,CHILDHUB:2,PERSON:3,VIRTUALEDGE:4},BaseGraph.prototype={serialize:function(e){var t=[];for(var n=0;n<this.v.length;n++){var r={};r.id=n,e&&(r.width=this.vWidth[n]),this.type[n]!=BaseGraph.TYPE.PERSON&&(this.type[n]==BaseGraph.TYPE.RELATIONSHIP?(r.rel=!0,r.hub=!0):this.type[n]==BaseGraph.TYPE.CHILDHUB?r.chhub=!0:r.virt=!0),r.prop=this.properties[n],out=[];var i=this.getOutEdges(n);for(var s=0;s<i.length;s++){var o=i[s],u=this.getEdgeWeight(n,o);u==1?out.push({to:i[s]}):out.push({to:i[s],weight:u})}out.length>0&&(r.outedges=out),t.push(r)}return t},makeGWithSplitMultiRankEdges:function(e){var t=new BaseGraph(this.defaultPersonNodeWidth,this.defaultNonPersonNodeWidth);for(var n=0;n<this.v.length;n++)t._addVertex(n,this.type[n],this.properties[n],this.vWidth[n]);for(var r=0;r<this.v.length;r++){var i=e[r];for(var n=0;n<this.v[r].length;n++){var s=this.v[r][n],o=this.getEdgeWeight(r,s),u=e[s];if(u<i)throw"Assertion failed: only forward edges";if(u==i+1||u==i)t.addEdge(r,s,o);else{var a=r;for(var f=i+1;f<=u-1;f++){var l=t._addVertex(null,BaseGraph.TYPE.VIRTUALEDGE,{fName:"_"+r+"->"+s+"_"+(f-i-1)},this.defaultNonPersonNodeWidth);e[l]=f,t.addEdge(a,l,o),a=l}t.addEdge(a,s,o)}}}return t.validate(),t},makeGWithCollapsedMultiRankEdges:function(){var e=new BaseGraph(this.defaultPersonNodeWidth,this.defaultNonPersonNodeWidth);for(var t=0;t<=this.maxRealVertexId;t++)e._addVertex(t,this.type[t],this.properties[t],this.vWidth[t]);for(var n=0;n<=this.maxRealVertexId;n++)for(var t=0;t<this.v[n].length;t++){var r=this.v[n][t],i=this.getEdgeWeight(n,r);while(r>this.maxRealVertexId)r=this.getOutEdges(r)[0];e.addEdge(n,r,i)}return e.validate(),e},getLeafAndParentlessNodes:function(){var e={parentlessNodes:[],leafNodes:[]};for(var t=0;t<=this.maxRealVertexId;t++)this.getInEdges(t).length==0?e.parentlessNodes.push(t):this.getOutEdges(t).length==0&&e.leafNodes.push(t);return e},_addVertex:function(e,t,n,r){if(e&&this.v[e])throw"addVertex: vertex with id="+e+" is already in G";var i=e==null?this.v.length:e;return this.v[i]=[],this.inedges[i]=[],this.weights[i]={},this.vWidth[i]=r,this.type[i]=t,this.properties[i]=n,t!=BaseGraph.TYPE.VIRTUALEDGE&&i>this.maxRealVertexId&&(this.maxRealVertexId=i),i},addEdge:function(e,t,n){if(this.v.length<Math.max(e,t))throw"addEdge: vertex ID="+Math.max(e,t)+"] is not in G";if(this.hasEdge(e,t))throw"addEdge: edge from ID="+e+" to ID="+t+" already exists";this.v[e].push(t),this.inedges[t].push(e),this.weights[e][t]=n},removeEdge:function(t,n){if(!this.hasEdge(t,n))throw"removeEdge: edge does not exist";e.removeFirstOccurrenceByValue(this.v[t],n),e.removeFirstOccurrenceByValue(this.inedges[n],t);var r=this.weights[t][n];return delete this.weights[t][n],r},insertVertex:function(e,t,n,r,i,s){var s=s?s:e==BaseGraph.TYPE.PERSON?this.defaultPersonNodeWidth:this.defaultNonPersonNodeWidth;e==BaseGraph.TYPE.PERSON&&!t.hasOwnProperty("gender")&&(t.gender="U");var o=e==BaseGraph.TYPE.VIRTUALEDGE?this.v.length:this.maxRealVertexId+1;if(this.v.length>=o){var u=function(e){return e>=o},a=function(e){return e+1};this._updateAllReferencesToNewIDs(u,a)}this.v.splice(o,0,[]),this.inedges.splice(o,0,[]),this.weights.splice(o,0,{}),this.vWidth.splice(o,0,s),this.type.splice(o,0,e),this.properties.splice(o,0,t),e!=BaseGraph.TYPE.VIRTUALEDGE&&this.maxRealVertexId++;for(var f=0;f<r.length;f++)this.addEdge(r[f],o,n);for(var f=0;f<i.length;f++)this.addEdge(o,i[f],n);return o},unplugVirtualVertex:function(t){if(t<=this.getMaxRealVertexId())throw"Attempting to unplug a non-virtual vertex";var n=this.inedges[t][0],r=this.v[t][0];e.replaceInArray(this.v[n],t,r),this.weights[n][r]=this.weights[n][t],delete this.weights[n][t],e.replaceInArray(this.inedges[r],t,n),this.v[t]=[],this.inedges[t]=[],this.weights[t]={}},remove:function(t){for(var n=0;n<this.v[t].length;n++){var r=this.v[t][n];e.removeFirstOccurrenceByValue(this.inedges[r],t)}for(var n=0;n<this.inedges[t].length;n++){var i=this.inedges[t][n];e.removeFirstOccurrenceByValue(this.v[i],t),delete this.weights[i][t]}this.v.splice(t,1),this.inedges.splice(t,1),this.weights.splice(t,1),this.vWidth.splice(t,1),this.type.splice(t,1),this.properties.splice(t,1),t<=this.maxRealVertexId&&this.maxRealVertexId--;var s=function(e){return e>t},o=function(e){return e-1};this._updateAllReferencesToNewIDs(s,o)},_updateAllReferencesToNewIDs:function(e,t){for(var n=0;n<this.v.length;n++){for(var r=0;r<this.v[n].length;r++)e(this.v[n][r])&&(this.v[n][r]=t(this.v[n][r]));for(var r=0;r<this.inedges[n].length;r++)e(this.inedges[n][r])&&(this.inedges[n][r]=t(this.inedges[n][r]));var i={},s=this.weights[n];for(var o in s)s.hasOwnProperty(o)&&(o=parseInt(o)),e(o)?i[t(o)]=s[o]:i[o]=s[o];this.weights[n]=i}},validate:function(){if(this.v.length==0)return;for(var e=0;e<this.v.length;e++){var t=this.getOutEdges(e),n=this.getInEdges(e);if(this.isPerson(e)){if(n.length>1)throw"Assertion failed: person nodes can't have two in-edges as people are produced by a single pregnancy (failed for "+this.getVertexDescription(e)+")";for(var r=0;r<t.length;r++)if(!this.isRelationship(t[r])&&!this.isVirtual(t[r]))throw"Assertion failed: person nodes have only out edges to relationships (failed for "+this.getVertexDescription(e)+")"}else if(this.isRelationship(e)){if(t.length==0)throw"Assertion failed: all relationships should have a childhub associated with them (failed for "+this.getVertexDescription(e)+")";if(t.length>1)throw"Assertion failed: all relationships should have only one outedge (to a childhub) (failed for "+this.getVertexDescription(e)+")";if(!this.isChildhub(t[0]))throw"Assertion failed: relationships should only have out edges to childhubs (failed for "+this.getVertexDescription(e)+")";if(n.length!=2)throw"Assertion failed: relationships should always have exactly two associated persons (failed for "+this.getVertexDescription(e)+")"}else if(this.isVirtual(e)){if(t.length!=1)throw"Assertion failed: all virtual nodes have exactly one out edge (to a virtual node or a relationship)";if(n.length!=1)throw"Assertion failed: all virtual nodes have exactly one in edge (from a person or a virtual node)";if(!this.isRelationship(t[0])&&!this.isVirtual(t[0]))throw"Assertion failed: all virtual nodes may only have an outedge to a virtual node or a relationship"}else if(this.isChildhub(e)){if(t.length<1)throw"Assertion failed: all childhubs should have at least one child associated with them";for(var r=0;r<t.length;r++)if(!this.isPerson(t[r]))throw"Assertion failed: childhubs are only connected to people (failed for "+this.getVertexDescription(e)+")"}}var i=this.getLeafAndParentlessNodes();if(i.parentlessNodes.length==0)throw"Assertion failed: pedigrees should have no cycles (no parentless nodes found)";for(var s=0;s<i.parentlessNodes.length;s++)if(this._DFSFindCycles(i.parentlessNodes[s],{}))throw"Assertion failed: pedigrees should have no cycles";var o={};this._markAllReachableComponents(i.parentlessNodes[0],o);for(var e=0;e<this.v.length;e++)if(!o.hasOwnProperty(e))throw"Assertion failed: disconnected component detected ("+this.getVertexDescription(e)+")"},_DFSFindCycles:function(e,t){t[e]=!0;var n=this.getOutEdges(e);for(var r=0;r<n.length;r++){var i=n[r];if(t.hasOwnProperty(i))return!0;if(this._DFSFindCycles(i,t))return!0}return delete t[e],!1},_markAllReachableComponents:function(e,t){t[e]=!0;var n=this.getOutEdges(e);for(var r=0;r<n.length;r++){var i=n[r];t.hasOwnProperty(i)||this._markAllReachableComponents(i,t)}var s=this.getInEdges(e);for(var o=0;o<s.length;o++){var i=s[o];t.hasOwnProperty(i)||this._markAllReachableComponents(i,t)}},getVertexNameById:function(e){var t=this.properties[e].hasOwnProperty("fName")?this.properties[e].fName:"",n=this.properties[e].hasOwnProperty("lName")?this.properties[e].lName:"";return t!=""&&n!=""&&(t+=" "),t+n},getVertexDescription:function(e){var t="id: "+e+", name: <"+this.getVertexNameById(e)+">, type: ";switch(this.type[e]){case BaseGraph.TYPE.PERSON:t+="PERSON";break;case BaseGraph.TYPE.RELATIONSHIP:t+="RELATION";break;case BaseGraph.TYPE.CHILDHUB:t+="CHILDHUB";break;case BaseGraph.TYPE.VIRTUALEDGE:t+="VIRTUAL";break;default:t+="ERROR"}return"["+t+"]"},getVertexWidth:function(e){return this.vWidth[e]},getVertexHalfWidth:function(e){return Math.floor(this.vWidth[e]/2)},getEdgeWeight:function(e,t){return this.weights[e][t]},hasEdge:function(e,t){return this.weights[e].hasOwnProperty(t)},isValidId:function(e){return e>=0&&e<this.v.length},getNumVertices:function(){return this.v.length},getMaxRealVertexId:function(){return this.maxRealVertexId},getOutEdges:function(e){return this.v[e]},getInEdges:function(e){return this.inedges[e]},getAllEdgesWithWeights:function(e){var t={},n=this.getOutEdges(e);for(var r=0;r<n.length;r++){var i=n[r];t[i]={weight:this.weights[e][i],out:!0}}var s=this.getInEdges(e);for(var r=0;r<s.length;r++){var i=s[r];t[i]={weight:this.weights[i][e],out:!1}}return t},getAllEdges:function(e){return this.getOutEdges(e).concat(this.getInEdges(e))},isRelationship:function(e){return this.type[e]==BaseGraph.TYPE.RELATIONSHIP},isChildhub:function(e){return this.type[e]==BaseGraph.TYPE.CHILDHUB},isPerson:function(e){return this.type[e]==BaseGraph.TYPE.PERSON},isPlaceholder:function(e){return!this.isPerson(e)||!this.properties[e].hasOwnProperty("placeholder")?!1:this.properties[e].placeholder?!0:!1},isVirtual:function(e){return this.type[e]==BaseGraph.TYPE.VIRTUALEDGE},isAdoptedIn:function(e){return this.properties[e].hasOwnProperty("adoptedStatus")?this.properties[e]["adoptedStatus"]=="adoptedIn":!1},isAdoptedOut:function(e){return this.properties[e].hasOwnProperty("adoptedStatus")?this.properties[e]["adoptedStatus"]=="adoptedOut":!1},getGender:function(e){if(!this.isPerson(e))throw"Assertion failed: attempting to get gender of a non-person";return this.properties[e].gender},getLastName:function(e){if(!this.isPerson(e))throw"Assertion failed: attempting to get last name of a non-person";return this.properties[e].hasOwnProperty("lName")?this.properties[e].lName:this.properties[e].hasOwnProperty("lNameAtB")?this.properties[e].lNameAtB:""},getLastNameAtBirth:function(e){if(!this.isPerson(e))throw"Assertion failed: attempting to get last name at birth of a non-person";return this.properties[e].hasOwnProperty("lNameAtB")?this.properties[e].lNameAtB:""},getOppositeGender:function(e){if(!this.isPerson(e))throw"Assertion failed: attempting to get gender of a non-person";return this.getGender(e)=="U"?"U":this.getGender(e)=="O"?"U":this.getGender(e)=="M"?"F":"M"},getRelationshipChildhub:function(e){if(!this.isRelationship(e))throw"Assertion failed: applying getRelationshipChildhub() to a non-relationship node";return this.v[e][0]},getAllRelationships:function(e){if(!this.isPerson(e))throw"Assertion failed: attempting to get relationships of a non-person";var t=this.v[e],n=[];for(var r=0;r<t.length;++r){var i=t[r],s=this.downTheChainUntilNonVirtual(i);n.push(s)}return n},getAllPartners:function(e){if(!this.isPerson(e))throw"Assertion failed: attempting to get partners of a non-person";var t=this.getAllRelationships(e),n=[];for(var r=0;r<t.length;++r){var i=this.getParents(t[r]);i[0]!=e?n.push(i[0]):n.push(i[1])}return n},getParents:function(e){if(!this.isPerson(e)&&!this.isRelationship(e))throw"Assertion failed: attempting to get parents of a non-person and non-relationship";var t=this.isPerson(e)?this.getProducingRelationship(e):e;if(t==null)return[];var n=this.getInEdges(t);if(n.length!=2)throw"Assertion failed: exactly two parents";return[this.upTheChainUntilNonVirtual(n[0]),this.upTheChainUntilNonVirtual(n[1])]},getPathToParents:function(e){var t=[];if(!this.isRelationship(e))throw"Assertion failed: incorrect v in getPathToParents()";var n=this.getInEdges(e);return t.push(this.getUpPathEndingInNonVirtual(n[0])),t.push(this.getUpPathEndingInNonVirtual(n[1])),t},getProducingRelationship:function(e){if(!this.isPerson(e))throw"Assertion failed: attempting to get producing relationship of a non-person";if(this.inedges[e].length==0)return null;var t=this.inedges[e][0];return this.inedges[t].length==0?null:this.inedges[t][0]},upTheChainUntilNonVirtual:function(e){return this.isVirtual(e)?this.upTheChainUntilNonVirtual(this.inedges[e][0]):e},downTheChainUntilNonVirtual:function(e){return this.isVirtual(e)?this.downTheChainUntilNonVirtual(this.v[e][0]):e},getUpPathEndingInNonVirtual:function(e){var t=[e];while(this.isVirtual(e))e=this.inedges[e][0],t.push(e);return t},getUnusedTwinGroupId:function(e){if(!this.isRelationship(e))throw"Assertion failed: incorrect v in getNumTwinGroups()";var t=this.v[e][0],n=this.v[t],r=[];for(var i=0;i<n.length;i++){var s=n[i];this.properties[s].hasOwnProperty("twinGroup")&&(r[this.properties[s].twinGroup]=!0)}var o=0;for(var u=0;u<r.length;u++){if(r[u]===undefined)break;o=u+1}return o},getTwinGroupId:function(e){return this.properties[e].hasOwnProperty("twinGroup")?this.properties[e].twinGroup:null},getAllSiblingsOf:function(e){if(!this.isPerson(e))throw"Assertion failed: incorrect v in getAllSiblingsOf()";if(this.inedges[e].length==0)return[e];var t=this.inedges[e][0],n=this.v[t];return n.slice(0)},getAllTwinsOf:function(e){if(!this.isPerson(e))throw"Assertion failed: incorrect v in getAllTwinsOf()";if(!this.properties[e].hasOwnProperty("twinGroup")||this.inedges[e].length==0)return[e];var t=this.properties[e].twinGroup,n=this.inedges[e][0],r=this.v[n],i=[];for(var s=0;s<r.length;s++){var o=r[s];this.properties[o].hasOwnProperty("twinGroup")&&this.properties[o]["twinGroup"]==t&&i.push(o)}return i},isParentToTwinEdge:function(e,t){return this.isPerson(t)&&this.isChildhub(e)&&this.getTwinGroupId(t)!=null?!0:!1},getAllAncestors:function(e){var t={};t[e]=!0;var n=new Queue;n.push(e);while(n.size()>0){var r=n.pop(),i=this.getInEdges(r);for(var s=0;s<i.length;s++){var e=i[s];t.hasOwnProperty(e)||(n.push(e),t[e]=!0)}}return t}},BaseGraph}),define("pedigree/model/edgeOptimization",["pedigree/model/helpers"],function(e){return VerticalPosIntOptimizer=function(e,t,n){this.pairScoreFunc=e,this.initLevels=t,this.maxOfMinlevels=1,n&&(this.maxOfMinlevels=Math.max.apply(null,n),this.maxOfMinlevels>1&&(this.minLevels=n));var r=this.computeComponents();this.components=r.components,this.crosses=r.crosses},VerticalPosIntOptimizer.prototype={numberOfLevelsPenalty:function(e,t,n){return(e-t)/(n+1)},componentScoreFunc:function(e,t){var n=0,r=0,i=1,s=this.components.getComponentEdges(t);for(var o=0;o<s.length;o++){var u=s[o];e[u]>r&&(r=e[u]),this.minLevels&&this.minLevels[u]>i&&(i=this.minLevels[u]);var a=this.crosses[u];for(var f=0;f<a.length;f++){var l=a[f];if(l>u){n+=this.pairScoreFunc(u,l,e[u],e[l],e);if(!isFinite(n))return n}}}var c=this.numberOfLevelsPenalty(r,i,s.length);return n+=c,n},computeComponents:function(){var e=new Complonents,t=[],n=[],r=this.initLevels.length;for(var i=0;i<r;i++)t[i]=[],n[i]=[];for(var i=0;i<r-1;i++)for(var s=i+1;s<r;s++)if(this.pairScoreFunc(i,s,1,1)==Infinity){t[i].push(s),t[s].push(i);var o=e.getEdgeComponent(i),u=e.getEdgeComponent(s);o===undefined&&u===undefined?(e.addToNewComponent(i),e.addToExistingComponent(s,e.getEdgeComponent(i))):o!==undefined?u!==undefined?o!=u&&e.mergeComponents(o,u):e.addToExistingComponent(s,o):e.addToExistingComponent(i,u);var a=this.pairScoreFunc(i,s,1,2),f=this.pairScoreFunc(i,s,2,1),l=e.getEdgeComponent(i);e.addRequiredPenaltyToComponent(l,Math.min(a,f)),a<f&&n[i].push(s),a>f&&n[s].push(i)}for(var l=0;l<e.getNumComponents();l++){var c=1,h=1,p=Infinity,d=e.getComponentEdges(l);for(var i=0;i<d.length;i++){var v=d[i];this.minLevels&&(this.minLevels[v]>h&&(h=this.minLevels[v]),this.minLevels[v]<p&&(p=this.minLevels[v]));var m=this.minLevels?this.minLevels[v]:1;for(var s=0;s<n[v].length;s++){var g=n[v][s],y=this.minLevels?this.minLevels[v]:1;n[g].length>0&&y==1&&y++,m=Math.max(m,y+1)}c=Math.max(c,m)}var b=e.getMinPossiblePenalty(l)==0?0:1;isFinite(p)||(p=1),c=Math.max(c,p+b);var w=this.numberOfLevelsPenalty(c,h,d.length);e.addRequiredPenaltyToComponent(l,w)}return{crosses:t,components:e}},computeVerticalPositions:function(e,t,n){this.seed=n?n:1;var r=this.initLevels;for(var i=0;i<this.components.getNumComponents();i++)this.components.getComponentEdges(i).length<=e?r=this.exhaustiveSearch(i,r):r=this.simulatedAnnellingOptimizer(i,r,t);return r},exhaustiveSearch:function(e,t){var n=this.componentScoreFunc(t,e),r=this.recursiveExhaustiveSearch(e,t.slice(0),0,{values:t,score:n});return r.values},recursiveExhaustiveSearch:function(e,t,n,r){var i=this.components.getComponentEdges(e);if(n==i.length){var s=this.componentScoreFunc(t,e);return s<r.score&&(r.values=t.slice(0),r.score=s),r}var o=i[n],u=1,a=i.length;this.minLevels&&(u=this.minLevels[o],a+=u-1);for(var f=u;f<=a;f++){t[o]=f,r=this.recursiveExhaustiveSearch(e,t,n+1,r);if(r.score==this.components.getMinPossiblePenalty(e))break}return r},makeBasicValidAssignment:function(e,t){var n=this.components.getComponentEdges(t),r=1,i=e.slice(0);for(var s=0;s<n.length;s++){var o=n[s];this.minLevels&&r<this.minLevels[o]&&(r=this.minLevels[o]),i[o]=r,r++}return i},computeNeighbour:function(e,t,n){var r=this.components.getComponentEdges(t),i=e.slice(0);do{var s=r[Math.floor(this.random()*r.length)],o=i[s],u=o,a=!0,f=!0,l={};for(var c=0;c<this.crosses[s].length;c++){var h=this.crosses[s][c],p=i[h];p>u&&(u=p),l[p]=!0,p>=o&&(f=!1),p<=o&&(a=!1)}this.minLevels&&o==this.minLevels[s]&&(a=!0)}while(f&&a);var d;do d=Math.floor(this.random()*(u+2));while(d==o||a&&d<o||f&&d>o);if(l.hasOwnProperty(d))for(var c=0;c<r.length;c++){var v=r[c];i[v]<=d&&i[v]++}return i[s]=d,this.normalize(i,r),i},normalize:function(t,n){var r=e.filterUnique(t).sort();for(var i=r.length-1;i>0;i--)if(r[i]!=r[i-1]+1){for(var s=0;s<n.length;s++){var o=n[s];t[o]>=r[i]&&t[o]--}break}for(var i=0;i<n.length;i++){var u=n[i],a=t[u],f=this.minLevels?this.minLevels[u]:1;if(a<f){var l=f-a;for(var s=0;s<n.length;s++)t[n[s]]+=l}}do{var c=!1;for(var i=0;i<n.length;i++){var u=n[i],a=t[u],f=this.minLevels?this.minLevels[u]:1;if(a>f){var h=0;for(var s=0;s<this.crosses[u].length;s++){var p=t[this.crosses[u][s]];p<a&&p>h&&(h=t[this.crosses[u][s]])}h<a-1&&(t[u]=h+1)}}}while(c)},localOptimization:function(e,t,n,r){return t},random:function(){var e=Math.sin(this.seed++)*16;return e-Math.floor(e)},doSwitchDuringAnneling:function(e,t,n){if(t<=e)return!0;var r=Math.exp(-(t-e)*Math.log((n+1)*5));return r>this.random()?!0:!1},simulatedAnnellingOptimizer:function(t,n,r){var i=this.componentScoreFunc(n,t),s=isFinite(i)?n:this.makeBasicValidAssignment(n,t),i=isFinite(i)?i:this.componentScoreFunc(s,t),o=r,u=s,a=i,f=r/6,l=r;while(i>this.components.getMinPossiblePenalty(t)&&l>=0){l<o-f&&(u=s.slice(0),a=this.localOptimization(u,i,t,!0),o=l,console.log("[asearch] reset to: "+e.stringifyObject(u)+", score: "+a+" (@ step = "+(r-l+1)+")"));var c=this.computeNeighbour(u,t,l),h=this.componentScoreFunc(c,t);this.doSwitchDuringAnneling(a,h,o-l)&&(u=c,a=h),a<i&&(console.log("[asearch] New best: "+e.stringifyObject(u)+", score: "+a+" (@ step = "+(r-l+1)+")"),s=u.slice(0),i=a,o=l),l--}return i=this.localOptimization(s,i,t),console.log("[asearch] Final optimized best: "+e.stringifyObject(s)+", score: "+i),s}},Complonents=function(){this.components=[],this.minPossiblePenalty=[],this.edgeComponents=[]},Complonents.prototype={getNumComponents:function(){return this.components.length},getComponentEdges:function(e){return this.components[e]},getEdgeComponent:function(e){return this.edgeComponents[e]},addToNewComponent:function(e){this.edgeComponents[e]=this.components.length,this.components.push([e]),this.minPossiblePenalty.push(0)},addToExistingComponent:function(e,t){this.components[t].push(e),this.edgeComponents[e]=t},mergeComponents:function(e,t){if(e==t)return;var n=Math.min(e,t),r=Math.max(e,t);for(var i=0;i<this.components[r].length;i++){var s=this.components[r][i];this.addToExistingComponent(s,n)}this.minPossiblePenalty[n]+=this.minPossiblePenalty[r],this.components.splice(r,1),this.minPossiblePenalty.splice(r,1)},addRequiredPenaltyToComponent:function(e,t){this.minPossiblePenalty[e]+=t},getMinPossiblePenalty:function(e){return this.minPossiblePenalty[e]}},VerticalPosIntOptimizer}),define("pedigree/model/ordering",["pedigree/model/helpers"],function(e){return Ordering=function(e,t){this.order=e,this.vOrder=t},Ordering.prototype={serialize:function(){return this.order},deserialize:function(e){this.order=e,this.vOrder=[];for(var t=0;t<this.order.length;t++){var n=this.order[t];for(var r=0;r<n.length;r++)this.vOrder[n[r]]=r}},insert:function(e,t,n){this.order[e].splice(t,0,n),this.vOrder[n]=t;for(var r=t+1;r<this.order[e].length;++r)this.vOrder[this.order[e][r]]++},exchange:function(e,t,n){var r=this.order[e][t],i=this.order[e][n];this.order[e][n]=r,this.order[e][t]=i,this.vOrder[r]=n,this.vOrder[i]=t},canMove:function(e,t,n){var r=t+n;return r<0?!1:r>this.order[e].length-1?!1:!0},move:function(e,t,n){if(n==0)return!0;var r=t+n;if(r<0)return!1;var i=this.order[e];if(r>i.length-1)return!1;var s=i[t];if(r>t)for(var o=t;o<r;++o){var u=i[o+1];i[o]=u,this.vOrder[u]=o}else for(var o=t;o>r;--o){var u=i[o-1];i[o]=u,this.vOrder[u]=o}return i[r]=s,this.vOrder[s]=r,!0},copy:function(){return new Ordering(e.clone2DArray(this.order),this.vOrder.slice())},moveVertexToRankAndOrder:function(e,t,n,r){var i=this.order[e][t];this.order[e].splice(t,1),this.order[n].splice(r,0,i),this.vOrder[i]=r;for(var s=r+1;s<this.order[n].length;++s){var o=this.order[n][s];this.vOrder[o]++}for(var s=t;s<this.order[e].length;++s){var o=this.order[e][s];this.vOrder[o]--}},moveVertexToOrder:function(e,t,n){var r=n<=t?n-t:n-t-1;this.move(e,t,r)},removeUnplugged:function(){var e=this.order[0].slice(0);for(var t=0;t<this.order[0].length;++t){var n=this.order[0][t];for(var r=0;r<this.order.length;++r)for(var i=0;i<this.order[r].length;++i)this.order[r][i]>n&&this.order[r][i]--;this.vOrder.splice(n,1)}return this.order[0]=[],e},remove:function(e,t){var n=this.vOrder[e];this.moveVertexToRankAndOrder(t,n,0,0),this.removeUnplugged()},insertAndShiftAllIdsAboveVByOne:function(e,t,n){for(var r=this.vOrder.length;r>e;--r)this.vOrder[r]=this.vOrder[r-1];for(var r=0;r<this.order.length;++r)for(var i=0;i<this.order[r].length;++i)this.order[r][i]>=e&&this.order[r][i]++;this.insert(t,n,e)},insertRank:function(e){this.order.splice(e,0,[])},getRightNeighbour:function(e,t){var n=this.vOrder[e];return n<this.order[t].length-1?this.order[t][n+1]:null},getLeftNeighbour:function(e,t){var n=this.vOrder[e];return n>0?this.order[t][n-1]:null},sortByOrder:function(e){var t=this.vOrder,n=e.slice(0);return n.sort(function(e,n){return t[e]-t[n]}),n},getLeftToRightTopToBottomOrdering:function(e,t){var n=[];for(var r=1;r<this.order.length;++r)for(var i=0;i<this.order[r].length;++i){var s=this.order[r][i];(!e||t.type[s]==e)&&n.push(this.order[r][i])}return n}},Ordering}),define("pedigree/model/queues",[],function(){return Queue=function(){this.data=[]},Queue.prototype={setTo:function(e){this.data=e.slice()},push:function(e){this.data.push(e)},pop:function(e){return this.data.shift()},size:function(){return this.data.length},clear:function(){this.data=[]}},Stack=function(){this.data=[]},Stack.prototype={setTo:function(e){this.data=e.slice()},push:function(e){this.data.push(e)},pop:function(e){return this.data.pop()},size:function(){return this.data.length}},Queue}),define("pedigree/model/xcoordclass",["pedigree/model/baseGraph","pedigree/model/helpers"],function(e,t){return XCoord=function(e,t){this.halfWidth=[];for(var n=0;n<t.GG.vWidth.length;n++)this.halfWidth[n]=Math.floor(t.GG.vWidth[n]/2);this.graph=t,e?this.xcoord=e:this.xcoord=this.init_xcoord()},XCoord.prototype={relationshipOrChhub:function(t){return this.graph.GG.type[t]==e.TYPE.RELATIONSHIP||this.graph.GG.type[t]==e.TYPE.CHILDHUB?!0:!1},getSeparation:function(t,n){return this.relationshipOrChhub(t)&&this.relationshipOrChhub(n)?this.graph.horizontalTwinSeparationDist:this.relationshipOrChhub(t)||this.relationshipOrChhub(n)?this.graph.horizontalRelSeparationDist:this.graph.GG.type[t]==e.TYPE.VIRTUALEDGE||this.graph.GG.type[n]==e.TYPE.VIRTUALEDGE?this.graph.GG.hasEdge(t,n)||this.graph.GG.hasEdge(n,t)?this.graph.horizontalRelSeparationDist:this.graph.horizontalTwinSeparationDist:this.graph.GG.type[t]!=e.TYPE.PERSON&&this.graph.GG.type[n]!=e.TYPE.PERSON||this.graph.GG.getTwinGroupId(t)!=this.graph.GG.getTwinGroupId(n)||this.graph.GG.getTwinGroupId(t)==null?this.graph.horizontalPersonSeparationDist:this.graph.horizontalTwinSeparationDist},init_xcoord:function(){var e=[];for(var t=0;t<this.graph.order.order.length;t++){e[this.graph.order.order[t][0]]=this.halfWidth[this.graph.order.order[t][0]];for(var n=1;n<this.graph.order.order[t].length;n++){var r=this.graph.order.order[t][n-1],i=this.graph.order.order[t][n],s=this.getSeparation(r,i);e[i]=e[r]+this.halfWidth[r]+s+this.halfWidth[i]}}return e},getLeftMostNoDisturbPosition:function(e){var t=this.graph.order.getLeftNeighbour(e,this.graph.ranks[e]);if(t!==null){var n=this.getRightEdge(t)+this.getSeparation(e,t)+this.halfWidth[e];return n}return-Infinity},getSlackOnTheLeft:function(e){return this.xcoord[e]-this.getLeftMostNoDisturbPosition(e)},getRightMostNoDisturbPosition:function(t,n){var r=this.graph.order.getRightNeighbour(t,this.graph.ranks[t]);if(r!==null){var i=this.getLeftEdge(r)-this.getSeparation(t,r)-this.halfWidth[t];if(n&&this.graph.GG.type[r]==e.TYPE.RELATIONSHIP){var s=this.getRightMostNoDisturbPosition(r),o=s-this.xcoord[r];i+=o}return i}return Infinity},getSlackOnTheRight:function(e){return this.getRightMostNoDisturbPosition(e,!1)-this.xcoord[e]},getLeftEdge:function(e){return this.xcoord[e]-this.halfWidth[e]},getRightEdge:function(e){return this.xcoord[e]+this.halfWidth[e]},shiftLeftOneVertex:function(e,t){var n=this.getLeftMostNoDisturbPosition(e),r=Math.min(t,this.xcoord[e]-n);return this.xcoord[e]-=r,r},shiftRightOneVertex:function(e,t){var n=this.getRightMostNoDisturbPosition(e),r=Math.min(t,n-this.xcoord[e]);return this.xcoord[e]+=r,r},shiftRightAndShiftOtherIfNecessary:function(e,t){this.xcoord[e]+=t;var n=this.getRightEdge(e),r=this.graph.ranks[e],i=this.graph.order.vOrder[e];for(var s=i+1;s<this.graph.order.order[r].length;s++){var o=this.graph.order.order[r][s];if(this.getLeftEdge(o)>=n+this.getSeparation(e,o))break;this.xcoord[o]=n+this.getSeparation(e,o)+this.halfWidth[o],n=this.getRightEdge(o),e=o}return t},moveNodeAsCloseToXAsPossible:function(e,t){var n=this.xcoord[e];if(n>t){var r=this.getLeftMostNoDisturbPosition(e);r<=t?this.xcoord[e]=t:this.xcoord[e]=r}else{var i=this.getRightMostNoDisturbPosition(e);i>=t?this.xcoord[e]=t:this.xcoord[e]=i}return this.xcoord[e]!=n?!0:!1},normalize:function(){var e=t.indexOfLastMinElementInArray(this.xcoord),n=this.xcoord[e]-this.halfWidth[e];for(var r=0;r<this.xcoord.length;r++)this.xcoord[r]-=n},copy:function(){var e=new XCoord(this.xcoord.slice(0),this.graph,this.halfWidth);return e},findVertexSetSlacks:function(e){var t=Infinity,n=Infinity;for(var r in e)if(e.hasOwnProperty(r)){var i=this.graph.order.getLeftNeighbour(r,this.graph.ranks[r]);e.hasOwnProperty(i)||(t=Math.min(t,this.getSlackOnTheLeft(r)));var s=this.graph.order.getRightNeighbour(r,this.graph.ranks[r]);e.hasOwnProperty(s)||(n=Math.min(n,this.getSlackOnTheRight(r)))}return{rightSlack:n,leftSlack:t}}},XCoordScore=function(e){this.score=0,this.inEdgeMaxLen=[],this.maxRealVertexId=e,this.numStraightLong=0},XCoordScore.prototype={add:function(e){this.score+=e},addEdge:function(e,t,n){t>this.maxRealVertexId&&(n==0&&e>this.maxRealVertexId&&this.numStraightLong++,n/=2);if(!this.inEdgeMaxLen[t]||n>this.inEdgeMaxLen[t])this.inEdgeMaxLen[t]=n;for(var r=0;r<t;r++)this.inEdgeMaxLen[r]===undefined&&(this.inEdgeMaxLen[r]=0)},isBettertThan:function(e){if(this.score==e.score){if(this.numStraightLong==e.numStraightLong){var t=this.inEdgeMaxLen.length==0?0:this.inEdgeMaxLen.reduce(function(e,t){return e+t}),n=e.inEdgeMaxLen.length==0?0:e.inEdgeMaxLen.reduce(function(e,t){return e+t});return t==n?Math.max.apply(null,this.inEdgeMaxLen)<Math.max.apply(null,e.inEdgeMaxLen):t<n}return this.numStraightLong>e.numStraightLong}return this.score<e.score}},VerticalLevels=function(){this.rankVerticalLevels=[],this.childEdgeLevel=[],this.outEdgeVerticalLevel=[]},VerticalLevels.prototype={copy:function(){var e=new VerticalLevels;return e.rankVerticalLevels=this.rankVerticalLevels.slice(0),e.childEdgeLevel=this.childEdgeLevel.slice(0),e.outEdgeVerticalLevel=this.outEdgeVerticalLevel.slice(0),e}},XCoord}),define("pedigree/model/positionedGraph",["pedigree/pedigreeDate","pedigree/model/edgeOptimization","pedigree/model/helpers","pedigree/model/ordering","pedigree/model/queues","pedigree/model/xcoordclass","pedigree/view/ageCalc"],function(e,t,n,r,i,s,o){function f(e,t){var r=10,i=6,s=5,o=24,a=4,f=new n.Timer;t?u=!0:u=!1;var l=new PositionedGraph(e,r,i,s,o,a);return console.log("=== Running time: "+f.report()+"ms =========="),new DynamicPositionedGraph(l)}PositionedGraph=function(e,t,n,r,i,s,o,u){this.GG=undefined,this.ranks=undefined,this.maxRank=undefined,this.order=undefined,this.positions=undefined,this.vertLevel=undefined,this.rankY=undefined,this.ancestors=undefined,this.consangr=undefined,this.initialize(e,t,n,r,i,s,o,u)},PositionedGraph.prototype={maxInitOrderingBuckets:5,maxOrderingIterations:24,maxXcoordIterations:4,xCoordEdgeWeightValue:!0,horizontalPersonSeparationDist:10,horizontalTwinSeparationDist:8,horizontalRelSeparationDist:6,yDistanceNodeToChildhub:20,yDistanceChildhubToNode:14,yExtraPerHorizontalLine:4,yAttachPortHeight:1.5,yCommentLineHeight:2.9,initialize:function(e,t,r,i,s,o,u,a){t&&(this.horizontalPersonSeparationDist=t),r&&(this.horizontalRelSeparationDist=r),i&&(this.maxInitOrderingBuckets=i),s&&(this.maxOrderingIterations=s),o&&(this.maxXcoordIterations=o);if(this.maxInitOrderingBuckets>8)throw"Too many ordering buckets: number of permutations ("+this.maxInitOrderingBuckets.toString()+"!) is too big";var f=new n.Timer;this.ranks=this.rank(e,a),this.maxRank=Math.max.apply(null,this.ranks),f.printSinceLast("=== Ranking runtime: "),this.GG=e.makeGWithSplitMultiRankEdges(this.ranks);var l=this.disconnectTwins();f.restart(),this.order=this.ordering(this.maxInitOrderingBuckets,this.maxOrderingIterations,l),f.printSinceLast("=== Ordering runtime: "),this.reRankRelationships(),this.reconnectTwins(l);var c=this.findAllAncestors();this.ancestors=c.ancestors,this.consangr=c.consangr,f.printSinceLast("=== Ancestors + re-ranking runtime: "),this.positions=this.position(),f.printSinceLast("=== Positioning runtime: "),u&&(this.vertLevel=this.positionVertically(),this.rankY=this.computeRankY(),f.printSinceLast("=== Vertical spacing runtime: "))},rank:function(e,t){if(t){var n=this.init_rank(e,t);if(n)return n}var n=this.init_rank(e);return this.lower_ranks(e,n),n},init_rank:function(e,t){if(e.v.length==0)return[];var n=1,r=[],s=[];for(var o=0;o<e.getNumVertices();o++)r.push(-1),s.push(0);var u=new i;if(t){for(var o=0;o<t.length;o++){var a=t[o];for(var f=0;f<a.length;f++)r[a[f]]=o*3+1}for(var l=0;l<e.getNumVertices();l++){if(e.isPerson(l)&&r[l]==-1)return null;e.isRelationship(l)&&u.push(l)}}else{var c=e.getLeafAndParentlessNodes().parentlessNodes;u.setTo(c)}while(u.size()>0){var h=u.pop(),p=e.getInEdges(h),d=n;for(var o=0;o<p.length;o++){var l=p[o];r[l]>=d&&(d=r[l]+1)}r[h]=d;var v=e.getOutEdges(h);for(var m=0;m<v.length;m++){var g=v[m];if(t&&r[g]!=-1&&r[g]<=r[h])return null;s[g]++;var y=e.getInEdges(g).length;s[g]==y&&u.push(g)}}return r},lower_ranks:function(e,t){if(t.length<=1)return;console.log("Re-ranking ranks before: "+n.stringifyObject(t));for(;;){var r=[],s=[],o=[];for(var u=0;u<e.getNumVertices();u++)r.push(null);var a=0;for(var u=0;u<e.getNumVertices();u++)if(r[u]==null){var f=[],l={},c=new i;c.push(u);while(c.size()>0){var h=c.pop();if(r[h]!=null)continue;r[h]=a,f.push(h);var p=t[h],d=e.getAllEdgesWithWeights(h);for(var v in d)if(d.hasOwnProperty(v)&&r[v]!=a){var m=Math.abs(p-t[v]);m==1?r[v]==null&&c.push(v):d[v].out&&(l[v]={length:m,weight:d[v].weight})}}s[a]=f,o[a]={length:Infinity,weight:0};for(var v in l)if(l.hasOwnProperty(v)){if(r[v]==a)continue;var g=l[v];if(g.length<o[a].length||g.length==o[a].length&&g.weight>o[a].weight)o[a]=g}a++}if(a==1)return;var y=0;for(var b=1;b<s.length;b++)if(o[b].weight>o[y].weight||o[b].weight==o[y].weight&&o[b].length<o[y].length)y=b;for(var u=0;u<s[y].length;u++)t[s[y][u]]+=o[y].length-1}console.log("Ranks after re-ranking: "+n.stringifyObject(t))},ordering:function(e,t,i){if(this.GG.v.length==0)return new r([],[]);var s=undefined,o=Infinity,u=this.GG.getLeafAndParentlessNodes(),a=this.findAllRootlessPartners(u);this.disconnectRootlessPartners(a);var f=this.findLeafSiblings(u);this.disconnectLeafSiblings(f);var l=this.computePossibleParentlessNodePermutations(e,u,a),c=this.computePossibleLeafNodePermutations(e,u,f,i),h=0,p=!1,d=new n.Timer;for(;;){for(var v=0;v<l.length;v++){h++,w=this.init_order_top_to_bottom(l[v],p),this.transpose(w,!1,o*4+5);var m=this.edge_crossing(w);if(m<o){s=w.copy(),o=m;if(m==0)break}}if(o==0)break;for(var g=0;g<c.length;g++){h++,w=this.init_order_bottom_to_top(c[g],p),this.transpose(w,!1,o*4+5);var m=this.edge_crossing(w);if(m<o){s=w.copy(),o=m;if(m==0)break}}if(o==0)break;if(p)break;p=!0}d.printSinceLast("Initial ordering: ");var y=this.edge_length_score(s);console.log("Initial ordering: "+n.stringifyObject(s.order)),console.log("Initial ordering:  numCrossings= "+o+",  edhgeLengthScore= "+y);var b=0,w=s.copy();for(var E=0;E<t;E++){var S=this.wmedian(w,E);this.transpose(w,!0);var m=this.edge_crossing(w),x=this.edge_length_score(w);if(m<o||m==o&&x<y)console.log("ordering: new better one selected ("+m+" crossings, "+x+" edgeLengthScore)"),s=w.copy(),o=m,y=x,b=0;else{S||b++;if(b==6)break}}this.transpose(s,!0),this.reconnectRootlessPartners(s,a),this.transpose(s,!0),this.reconnectLeafSiblings(s,f),d.restart();var T=this.transposeLongEdges(s,o);return d.printSinceLast("Ordering long edges: "),console.log("Ordering stats:  initOrderIter= "+h+",  reOrderingIter= "+E+",  noChangeIterations= "+b),console.log("Final ordering: "+n.stringifyObject(s.order)),console.log("Final ordering:  numCrossings= "+T),s},findAllRootlessPartners:function(e){var t={};for(var n=0;n<e.parentlessNodes.length;n++){var r=e.parentlessNodes[n];if(this.GG.getOutEdges(r).length==1){var i=this.GG.downTheChainUntilNonVirtual(this.GG.getOutEdges(r)[0]),s=this.GG.getParents(i),o=s[0]==r?s[1]:s[0];if(this.ranks[r]!=this.ranks[o])continue;this.GG.getInEdges(o).length>0&&(t[o]?t[o].push(r):t[o]=[r])}}return t},disconnectRootlessPartners:function(e){for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];for(var i=0;i<r.length;i++){var s=r[i],o=this.GG.getOutEdges(s),u=o[0];n.removeFirstOccurrenceByValue(this.GG.inedges[u],s)}}},reconnectRootlessPartners:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=0,i=0,s=e.vOrder[n],o=this.ranks[n],u=this.GG.getOutEdges(n);for(var a=0;a<u.length;a++)if(this.GG.isRelationship(u[a])){var f=this.GG.getInEdges(u[a]);if(f.length==2){var l=f[0]==n?f[1]:f[0];e.vOrder[l]>s?i++:r++}}var c=t[n];for(var h=0;h<c.length;h++){var p=c[h],d=this.GG.getOutEdges(p),v=d[0];this.GG.inedges[v].push(p),i<=r?(i++,e.insert(o,s+1,p)):(r++,e.insert(o,s,p))}}},findLeafSiblings:function(e){var t={};for(var n=0;n<e.leafNodes.length;n++){var r=e.leafNodes[n],i=this.GG.getInEdges(r)[0];if(t.hasOwnProperty(i))continue;var s=this.GG.getOutEdges(i);if(s.length>1){t[i]=[];var o=r;for(var u=0;u<s.length;u++){var a=s[u],f=this.GG.getOutEdges(a).length;a!=o&&f==0&&t[i].push(a)}}}return t},disconnectLeafSiblings:function(e){for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];for(var i=0;i<r.length;i++){var s=r[i];n.removeFirstOccurrenceByValue(this.GG.v[t],s)}}},reconnectLeafSiblings:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];for(var i=0;i<r.length;i++){var s=r[i];this.GG.v[n].push(s);var o=this.ranks[s];e.insert(o,0,s);var u=0,a=this.edge_crossing(e,o),f=this.edge_length_score(e,o);for(var l=0;l<e.order[o].length-1;l++){e.exchange(o,l,l+1);var c=this.edge_crossing(e,o),h=this.edge_length_score(e,o);if(c<a||c==a&&h<f)u=l+1,a=c,f=h}e.moveVertexToOrder(o,e.vOrder[s],u)}}},disconnectTwins:function(){var e={},t={};for(var r=0;r<=this.GG.getMaxRealVertexId();r++){if(t[r])continue;if(!this.GG.isPerson(r))continue;var i=this.GG.getTwinGroupId(r);if(i==null)continue;e[r]=[];var s=this.GG.getInEdges(r)[0],o=this.GG.getAllTwinsOf(r);for(var u=0;u<o.length;u++){var a=o[u];if(a==r)continue;n.removeFirstOccurrenceByValue(this.GG.v[s],a);var f=this.GG.getOutEdges(a);for(var l=0;l<f.length;l++){var c=f[l];n.replaceInArray(this.GG.inedges[c],a,r),this.GG.v[r].push(c),this.GG.weights[r].hasOwnProperty(c)?this.GG.weights[r][c]+=this.GG.weights[a][c]:this.GG.weights[r][c]=this.GG.weights[a][c]}e[r].push(a),t[a]=!0}}return e},reconnectTwins:function(e){for(var t in e)if(e.hasOwnProperty(t)){var r=this.ranks[t],i=this.GG.getInEdges(t)[0],s=e[t],o=this.GG,u=function(e,t){var n=o.getOutEdges(e).length,r=o.getOutEdges(t).length;return r-n};s.sort(u);for(var a=0;a<s.length;a++){var f=s[a],l=this.GG.getOutEdges(f);for(var c=0;c<l.length;c++){var h=l[c];n.removeFirstOccurrenceByValue(this.GG.inedges[h],t),n.removeFirstOccurrenceByValue(this.GG.v[t],h),this.GG.weights[t][h]==this.GG.weights[f][h]?delete this.GG.weights[t][h]:this.GG.weights[t][h]-=this.GG.weights[f][h],this.GG.inedges[h].push(f)}var p=this.findBestTwinInsertPosition(f,this.GG.getOutEdges(f),this.order);this.order.insert(r,p,f),this.GG.v[i].push(f);var d=this.GG.getTwinGroupId(f),l=this.GG.getOutEdges(f);for(var c=0;c<l.length;c++){var h=l[c];if(this.GG.isVirtual(h))continue;var v=this.GG.getInEdges(h),m=v[0]==f?v[1]:v[0];if(this.GG.getTwinGroupId(m)==d&&this.GG.hasEdge(i,m)){var g=this.order.vOrder[h],y=this.order.vOrder[f],b=this.order.vOrder[m];if(Math.abs(y-b)!=1){if(this.GG.getOutEdges(f).length==1)y<b?this.order.moveVertexToOrder(r,y,b):this.order.moveVertexToOrder(r,y,b+1);else{if(this.GG.getOutEdges(m).length!=1)continue;b<y?this.order.moveVertexToOrder(r,b,y):this.order.moveVertexToOrder(r,b,y+1)}g=this.order.vOrder[h],y=this.order.vOrder[f],b=this.order.vOrder[m]}y<b?this.order.moveVertexToOrder(r,g,b):this.order.moveVertexToOrder(r,g,y)}}}}},computePossibleParentlessNodePermutations:function(e,t,r){var i=[];console.log("maxInitOrderingBuckets: "+e);var s={};for(var o in r)if(r.hasOwnProperty(o)){var u=r[o];for(var a=0;a<u.length;a++)s[u[a]]=!0}for(var a=0;a<t.parentlessNodes.length;a++){var f=t.parentlessNodes[a];if(s.hasOwnProperty(f))continue;var l=[];l.push(f),s[f]=!0;if(this.GG.getOutEdges(f).length==1){var c=this.GG.downTheChainUntilNonVirtual(this.GG.getOutEdges(f)[0]),h=this.GG.getParents(c),p=h[0]==f?h[1]:h[0];!s.hasOwnProperty(p)&&this.GG.getInEdges(p).length==0&&this.GG.getOutEdges(p).length==1&&(l.push(p),s[p]=!0)}i.push(l)}i.length>e&&this.mergeBucketsUntilNoMoreThanGivenLeft(i,e);var d=[];return n.permute2DArrayInFirstDimension(d,i,0),n.printObject(i),console.log("Found "+d.length+" permutations of parentless nodes"),d},computePossibleLeafNodePermutations:function(e,t,r,i){var s=[],o={};for(var u in r)if(r.hasOwnProperty(u)){var a=r[u];for(var f=0;f<a.length;f++)o[a[f]]=!0}for(var u in i)if(i.hasOwnProperty(u)){var l=i[u];for(var f=0;f<l.length;f++)o[l[f]]=!0}var c=0;for(var f=0;f<t.leafNodes.length;f++){var h=t.leafNodes[f];if(o.hasOwnProperty(h))continue;var c=[];c.push(h),o[h]=!0;if(this.GG.getInEdges(h).length!=1)throw"Assertion failed: only one in edge into a leaf node";var p=this.GG.getInEdges(h)[0];for(var d=f+1;d<t.leafNodes.length;d++){var v=t.leafNodes[d];if(o.hasOwnProperty(v))continue;var m=this.GG.getInEdges(v)[0];p==m&&(c.push(v),o[v]=!0)}s.push(c)}s.length>e&&this.mergeBucketsUntilNoMoreThanGivenLeft(s,e,!0);var g=[];return n.permute2DArrayInFirstDimension(g,s,0),n.printObject(s),console.log("Found "+g.length+" permutations of leaf nodes"),g},mergeBucketsUntilNoMoreThanGivenLeft:function(e,t,r){console.log("original buckets: "+n.stringifyObject(e));while(e.length>t&&this.mergeMostRelatedBuckets(e,r));console.log("merged buckets: "+n.stringifyObject(e))},mergeMostRelatedBuckets:function(e,t){var n=Infinity,r=0,i=1;for(var s=0;s<e.length-1;s++)for(var o=s+1;o<e.length;o++){var u=this.findDistanceBetweenBuckets(e[s],e[o],t);if(u<n||u==n&&e[s].length+e[o].length<e[r].length+e[i].length)n=u,r=s,i=o}if(n==Infinity)throw"Assumption failed: unrelated buckets";for(var s=0;s<e[i].length;s++)e[r].push(e[i][s]);return e.splice(i,1),!0},findDistanceBetweenBuckets:function(e,t,n){var r=[];for(var s=0;s<e.length;s++)r[e[s]]=1;for(var s=0;s<t.length;s++)r[t[s]]=-1;var o=new i;o.setTo(e);var u=new i;u.setTo(t);var a=0;while(a<100){a++;if(o.size()==0&&u.size()==0)return Infinity;var f=new i;while(o.size()>0){var l=o.pop(),c=r[l],h=n?this.GG.getInEdges(l):this.GG.getOutEdges(l);for(var p=0;p<h.length;p++){var d=h[p];if(r[d]<0)return-r[d]+c;r[d]=c+1,f.push(d)}}o=f;var v=new i;while(u.size()>0){var l=u.pop(),c=r[l],h=n?this.GG.getInEdges(l):this.GG.getOutEdges(l);for(var p=0;p<h.length;p++){var d=h[p];if(r[d]>0)return r[d]-c;r[d]=c-1,v.push(d)}}u=v}throw"Assertion failed: possible loop detected"},init_order_top_to_bottom:function(e,t){var n=[],s=[];for(var o=0;o<=this.maxRank;o++)n[o]=[];for(var u=0;u<this.GG.getNumVertices();u++)s[u]=undefined;var a=t?new Stack:new i;a.setTo(e);while(a.size()>0){var f=a.pop();if(s[f]!=undefined)continue;var l=this.ranks[f],c=n[l].length;s[f]=c,n[l].push(f);var h=this.GG.getOutEdges(f);for(var p=0;p<h.length;p++)a.push(h[p])}return new r(n,s)},init_order_bottom_to_top:function(e,t){var n=[],s=[];for(var o=0;o<=this.maxRank;o++)n[o]=[];for(var u=0;u<this.GG.getNumVertices();u++)s[u]=undefined;var a=t?new Stack:new i;a.setTo(e);while(a.size()>0){var f=a.pop();if(s[f]!=undefined)continue;var l=this.ranks[f],c=n[l].length;s[f]=c,n[l].push(f);var h=this.GG.getInEdges(f);for(var p=0;p<h.length;p++)a.push(h[p])}return new r(n,s)},edge_length_score:function(t,n){var r=0,i=0,s=0,o=0;for(var u=0;u<this.GG.getNumVertices();u++){if(n){var a=this.ranks[u];if(a<n-1||a>n+1)continue}if(this.GG.isRelationship(u)){var f=this.GG.getInEdges(u);if(f.length==2){if(this.ranks[f[0]]!=this.ranks[f[1]])continue;var l=t.vOrder[f[0]],c=t.vOrder[f[1]];r+=Math.abs(l-c);var h=l<c?f[0]:f[1],p=this.GG.properties[h].gender;p=="F"&&s++}}if(this.GG.isChildhub(u)){var d=this.GG.getOutEdges(u);if(d.length>1){var v=t.sortByOrder(d),m=t.vOrder[v[0]],g=t.vOrder[v[v.length-1]];i+=g-m;var y=this.GG.properties[v[0]].hasOwnProperty("dob")?new e(this.GG.properties[v[0]].dob):null;for(var b=1;b<v.length;b++){var w=this.GG.properties[v[b]].hasOwnProperty("dob")?new e(this.GG.properties[v[b]].dob):null;w!=null&&(y==null?o++:y.getTime()>w.getTime()&&o++),y=w}}}}return r*1e5+i*1e3+s*5+o},edge_crossing:function(e,t,n){var r=0,i=t?Math.max(1,t-1):1,s=t?t:this.maxRank;for(var o=i;o<=s;++o){var u=e.order[o].length;for(var a=0;a<u-1;++a){var f=e.order[o][a],l=this.GG.isChildhub(f),c=this.GG.getOutEdges(f),h=c.length;for(var p=0;p<h;++p){var d=c[p];if(!n&&this.GG.isRelationship(d)){var v=this.GG.getInEdges(d);if(v.length==2){var m=e.vOrder[v[0]],g=e.vOrder[v[1]],y=this.numNodesWithParentsInBetween(e,o,m,g);r+=y/2}}var y=this._edge_crossing_crossingsByOneEdge(e,f,d),b=l&&this.GG.getTwinGroupId(d)!=null?2:1;r+=y*b}}}return r},_edge_crossing_crossingsByOneEdge:function(e,t,n){var r=this.ranks[t],i=this.ranks[n],s=e.vOrder[t],o=e.vOrder[n];if(r==i)return this.numNodesWithParentsInBetween(e,r,s,o);var u=0,a=e.order[r];for(var f=s+1;f<a.length;++f){var l=a[f],c=this.GG.isChildhub(l),h=this.GG.getOutEdges(l),p=h.length;for(var d=0;d<p;++d){var v=h[d];e.vOrder[v]<o&&(u++,c&&this.GG.getTwinGroupId(v)!=null&&u++)}}return u>0&&this.GG.isPerson(t)&&this.GG.isVirtual(n)&&(u-=.1),u},numNodesWithParentsInBetween:function(e,t,n,r){var i=0,s=Math.min(n,r)+1,o=Math.max(n,r)-1;for(var u=s;u<=o;u++){var a=e.order[t][u];if(this.GG.getInEdges(a).length>0)for(var f=0;f<this.GG.getInEdges(a).length;f++){var l=this.GG.getInEdges(a)[f];if(this.ranks[l]!=t)i++;else{var c=e.vOrder[l];(c<s-1||c>o+1)&&i++}}if(this.GG.isPerson(a)){var h=this.GG.getTwinGroupId(a);h!=null&&i++}}return i},wmedian:function(e,t){var n=!1;if(t%2==0)for(var r=2;r<=this.maxRank;r++){if(e.order[r].length<=1||e.order[r-1].length<=1)continue;var i=[],s=e.order[r].length;for(var o=0;o<s;o++){var u=e.order[r][o];i[u]=this.median_value(e,u,r-1)}n!=this.sort_orders(e,r,i)}else for(var r=this.maxRank-1;r>=1;r--){if(e.order[r].length<=1||e.order[r+1].length<=1)continue;var i=[],s=e.order[r].length;for(var o=0;o<s;o++){var u=e.order[r][o];i[u]=this.median_value(e,u,r+1)}n!=this.sort_orders(e,r,i)}return n},median_value:function(e,t,n){var r=this.adj_position(e,t,n);if(r.length==0)return-1;var i=Math.floor(r.length/2);if(r.length%2==1)return r[i];if(r.length==2)return(r[0]+r[1])/2;var s=r[i-1]-r[0],o=r[r.length-1]-r[i];return(r[i-1]*o+r[i]*s)/(s+o)},adj_position:function(e,t,n){var r=[],i=e.order[n],s=i.length;for(var o=0;o<s;o++){var u=i[o];(this.GG.hasEdge(u,t)||this.GG.hasEdge(t,u))&&r.push(o)}return r},sort_orders:function(e,t,n){var r=function(e,t){return n[e]-n[t]};e.order[t].sort(r);var i=!1;for(var s=0;s<e.order[t].length;s++){var o=e.order[t][s];e.vOrder[o]!=s&&(e.vOrder[o]=s,i=!0)}return i},isChhubsOrderOK:function(e,t){for(var n=0;n<t.order[e].length-1;n++){var r=t.order[e][n];if(!this.GG.isChildhub(r))continue;for(var i=n+1;i<t.order[e].length;i++)if(this.GG.isChildhub(t.order[e][i]))break;var s=t.order[e][i];if(!this.GG.isChildhub(s))continue;var o=this.GG.getInEdges(r)[0],u=this.GG.getInEdges(s)[0];if(t.vOrder[o]>t.vOrder[u])return!1}return!0},placeChhubsInCorrectOrder:function(e,t){var n=this.GG,r=function(e,r){var i=n.getInEdges(e)[0],s=n.getInEdges(r)[0];return i==s?t.vOrder[e]-t.vOrder[r]:t.vOrder[i]-t.vOrder[s]};t.order[e].sort(r);for(var i=0;i<t.order[e].length;i++)t.vOrder[t.order[e][i]]=i},transpose:function(e,t,n){var r=!0,i=this.edge_crossing(e);if(n&&i>n)return;var s=0;while(r){s++;if(!t&&s>4)break;if(s>100){console.log("Assertion failed: too many iterations in transpose(), NumIter == "+s);break}r=!1;for(var o=1;o<=this.maxRank;o++){if(o%3==0){this.placeChhubsInCorrectOrder(o,e);continue}var u=this.edge_crossing(e,o);if(!t&&u==0)continue;var a=t?this.edge_length_score(e,o):0,f=!1,l=e.order[o].length-1;for(var c=0;c<l;++c){e.exchange(o,c,c+1);var h=this.edge_crossing(e,o),p=t?this.edge_length_score(e,o):0;if(h<u||h==u&&p<a){r=!0,f=!0;var d=u-h;i-=d,u=h,a=p;if(!t){if(i==0)return;if(u==0)break}}else e.exchange(o,c,c+1)}f&&o--}}},transposeLongEdges:function(e,t,r){if(t==0)return t;var i=this.GG.getMaxRealVertexId(),s=this.GG.getNumVertices(),o=[];for(var u=i+1;u<s;u++)o[u]=!1;for(var u=i+1;u<s;u++){if(o[u]||this.ranks[u]==0)continue;var a=u;while(this.GG.isVirtual(this.GG.getInEdges(a)[0]))a=this.GG.getInEdges(a)[0];var f=[],l=a;do o[l]=!0,f.push(l),l=this.GG.getOutEdges(l)[0];while(this.GG.isVirtual(l));f.push(l);var c=t,h=undefined;console.log("Optimizing long edge placement: chain "+n.stringifyObject(f));if(f.length<=10){var p=2;r&&(p=4);for(var d=0;d<f.length-p;d++){var v=f[d],m=f[d+1],g=f[d+2],y=this.ranks[v],b=this.ranks[m],w=this.ranks[g],E=e.vOrder[v],S=e.vOrder[m],x=e.vOrder[g];for(var T=-4;T<=4;T++){if(!e.canMove(y,E,T))continue;for(var N=-4;N<=4;N++){if(!e.canMove(b,S,N))continue;for(var C=-4;C<=4;C++){if(T==0&&N==0&&C==0)continue;if(!e.canMove(w,x,C))continue;var k=e.copy();k.move(y,E,T),k.move(b,S,N),k.move(w,x,C);var L=this.edge_crossing(k,!1,r);L<c&&(c=L,h=[y,E,T,b,S,N,w,x,C])}}}}}c<t&&(e.move(h[0],h[1],h[2]),e.move(h[3],h[4],h[5]),e.move(h[6],h[7],h[8]),t=c);if(t==0)break}return t},reRankRelationships:function(){if(this.maxRank===undefined||this.GG.v.length==0)return;var e={},t=this.order.copy();for(var r=2;r<=this.maxRank;r+=3){for(var i=0;i<t.order[r].length;i++){var s=t.order[r][i];if(this.GG.isVirtual(s))continue;if(!this.GG.isRelationship(s))throw"[1] Unexpected node "+s+" at rank "+r;var o=this.GG.getInEdges(s);if(this.ranks[parent[0]]!=this.ranks[parent[1]])throw"Assertion failed: edges betwen neighbouring ranks only";var u=this.order.vOrder[o[0]],a=this.order.vOrder[o[1]],f=Math.min(u,a),l=Math.max(u,a);l==f+1&&(this.moveVertexToRankAndOrder(s,this.ranks[o[0]],l),e[s]=!0)}for(var i=0;i<t.order[r].length;i++){var s=t.order[r][i];if(this.GG.isVirtual(s))continue;if(!this.GG.isRelationship(s))throw"[2] Unexpected node "+s+" at rank "+r;if(e.hasOwnProperty(s))continue;var o=this.GG.getInEdges(s);this.order.vOrder[o[0]]>this.order.vOrder[o[1]]&&o.reverse();var c=this.ranks[o[0]],u=this.order.vOrder[o[0]],a=this.order.vOrder[o[1]];if(a==u+1)throw"Assertion failed: all relationship with parents next to each other are already handled (for parents: "+n.stringifyObject(o)+")";var h=u+1,p=this.order.order[c][u+1],d=this.order.order[c][a-1],v=!1,m=!1;this.GG.hasEdge(o[0],p)&&(v=!0),this.GG.hasEdge(o[1],d)&&(m=!0);if(m&&v){for(var g=u+2;g<=a-1;g++){var y=this.order.order[c][g];if(!this.GG.hasEdge(o[0],y)){h=g;break}}if(h==null){var b=this.GG.getInEdges(d),w=b[0]!=o[1]?b[0]:b[1],E=this.order.vOrder[w];E<u?h=a:h=u+1}}else m?h=u+1:v?h=a:h=a;this.moveVertexToRankAndOrder(s,c,h);var S=t.vOrder[s];if(S>0){var x=t.order[r][S-1];if(this.GG.isRelationship(x)&&this.order.vOrder[x]>this.order.vOrder[s]&&this.ranks[x]==this.ranks[s]){this.swapChildrenIfAllAToTheLeftOfB(x,s);var T=this.GG.getOutEdges(x)[0],N=this.GG.getOutEdges(s)[0];this.order.vOrder[T]<this.order.vOrder[N]&&this.order.exchange(this.ranks[T],this.order.vOrder[T],this.order.vOrder[N])}}if(S<t.order[c+1].length-1){var C=t.order[r][S+1];if(this.GG.isRelationship(C)&&this.order.vOrder[C]<this.order.vOrder[s]&&this.ranks[C]==this.ranks[s]){this.swapChildrenIfAllAToTheLeftOfB(s,C);var T=this.GG.getOutEdges(s)[0],N=this.GG.getOutEdges(C)[0];this.order.vOrder[T]<this.order.vOrder[N]&&this.order.exchange(this.ranks[T],this.order.vOrder[T],this.order.vOrder[N])}}}}this.removeRelationshipRanks(),this.improveOrdering();var k=this.edge_crossing(this.order,!1,!0);this.transposeLongEdges(this.order,k,!0),console.log("Final re-ordering: "+n.stringifyObject(this.order.order)),console.log("Final ranks: "+n.stringifyObject(this.ranks))},moveVertexToRankAndOrder:function(e,t,n){var r=this.ranks[e],i=this.order.vOrder[e];this.order.moveVertexToRankAndOrder(r,i,t,n),this.ranks[e]=t},swapChildrenIfAllAToTheLeftOfB:function(e,t){console.log("Attempting to swap children of "+e+" and "+t+" (due to change of order during re-ranking)");var n=this.GG.getOutEdges(e)[0],r=this.GG.getOutEdges(t)[0],i=this.GG.getOutEdges(n),s=this.GG.getOutEdges(r),o=i.concat(s),u=this.order,a=function(e,t){return u.vOrder[e]-u.vOrder[t]};o.sort(a);var f=this.ranks[o[0]],l=u.vOrder[o[0]],c=u.vOrder[o[o.length-1]];if(c-l+1!=i.length+s.length)return;for(var h=0;h<o.length;h++){var p=o[h],d=h<i.length;if(d&&this.GG.getInEdges(p)[0]!=n)return;var v=this.GG.getOutEdges(p);if(v.length>0)for(var m=0;m<v.length;m++){var g=v[m];if(this.GG.isVirtual(g))return;var y=this.GG.getParents(g);for(var b=0;b<y.length;b++){if(this.ranks[y[b]]!=f)return;if(d&&u.vOrder[y[b]]<l)return;if(!d&&u.vOrder[y[b]]>c)return}}}var w=Math.floor((l+c)/2);for(var h=l;h<=w;h++){var E=this.order.order[f][h];this.order.order[f][h]=this.order.order[f][l+c-h],this.order.order[f][l+c-h]=E,this.order.vOrder[this.order.order[f][h]]=h,this.order.vOrder[this.order.order[f][l+c-h]]=l+c-h}},removeRelationshipRanks:function(){for(var e=2;e<=this.maxRank;e+=2){if(this.order.order[e].length>0)for(var t=0;t<this.order.order[e].length;t++){var r=this.order.order[e][t];this.GG.unplugVirtualVertex(r),this.ranks[r]=0,this.order.vOrder[r]=this.order.order[0].length,this.order.order[0].push(r)}this.order.order.splice(e,1);for(var r=0;r<this.ranks.length;r++)this.ranks[r]>e&&this.ranks[r]--;this.maxRank--}var i=this.order.removeUnplugged().sort(function(e,t){return e-t});console.log("Removing unnecessary long edge pieces: "+n.stringifyObject(i));for(var t=0;t<i.length;t++){var s=i[t]-t;this.ranks.splice(s,1),this.GG.remove(s)}},improveOrdering:function(){for(var e=1;e<=this.maxRank;e+=1)for(var t=0;t<this.order.order[e].length;t++){var n=this.order.order[e][t];if(!this.GG.isPerson(n))continue;if(this.GG.getInEdges(n).length!=0)continue;var r=this.GG.getOutEdges(n);if(r.length!=1)continue;var i=r[0];if(this.ranks[i]!=e)continue;var s=this.order.vOrder[n],o=this.order.vOrder[i];Math.abs(o-s)!=1&&(o>s?this.order.move(e,s,o-s-1):this.order.move(e,s,o-s+1))}for(var e=2;e<=this.maxRank;e+=2)this.isChhubsOrderOK(e,this.order)||this.placeChhubsInCorrectOrder(e,this.order)},findConnectedComponent:function(e,t,n,r){var s={},o=0,u=!1;Object.prototype.toString.call(e)!=="[object Array]"&&(e=[e]);var a=new i;for(var f=0;f<e.length;f++)a.push(e[f]),s[e[f]]=!0;while(a.size()>0){var l=a.pop(),c=this.GG.getAllEdgesWithWeights(l);for(var h in c){if(!c.hasOwnProperty(h))continue;var p=c[h].out?l:h,d=c[h].out?h:l;if(t(p,d)&&!s.hasOwnProperty(h)){s[h]=!0,a.push(h),o++;if(n.hasOwnProperty(h)){u=!0;break}}if(o>r){a.clear();break}}}return{component:s,size:o,stopSetReached:u}},findAllAncestors:function(){var e={},t={};for(var n=1;n<=this.maxRank;n++){var r=this.order.order[n];for(var i=0;i<r.length;i++){var s=this.order.order[n][i];if(!this.GG.isPerson(s))continue;e[s]={},e[s][s]=0;if(this.GG.isAdoptedIn(s))continue;var o=this.GG.getParents(s);for(var u=0;u<o.length;u++){var a=e[o[u]];for(var f in a)a.hasOwnProperty(f)&&(e[s].hasOwnProperty(f)?e[s][f]=Math.min(a[f]+1,e[s][f]):e[s][f]=a[f]+1)}}}for(var n=1;n<=this.maxRank;n++){var r=this.order.order[n];for(var i=0;i<r.length;i++){var s=this.order.order[n][i];if(!this.GG.isRelationship(s))continue;e[s]={},e[s][s]=0;var o=this.GG.getParents(s);for(var u=0;u<o.length;u++){var a=e[o[u]];for(var f in a)a.hasOwnProperty(f)&&(e[s].hasOwnProperty(f)?(t[s]=!0,e[s][f]=Math.min(a[f]+1,e[s][f])):e[s][f]=a[f]+1)}}}return{ancestors:e,consangr:t}},positionVertically:function(){var e=new VerticalLevels,n=2,r=2;for(var i=1;i<=this.maxRank;i+=1)e.rankVerticalLevels[i]=1;if(this.GG.v.length<=1)return e;for(var i=n;i<=this.maxRank;i+=r){var s=[],o=[],u=this.order.order[i].length;for(var a=0;a<u;a++){var f=this.order.order[i][a];if(this.GG.isVirtual(f))continue;if(!this.GG.isChildhub(f))throw"Assertion failed: childhub nodes at every other rank ("+f+")";var l=this.GG.getInEdges(f)[0],c=this.positions[l],h=c,p=c,d=[],v=this.GG.getOutEdges(f);for(var m=0;m<v.length;m++){var g=this.positions[v[m]];d.push(g),h=Math.min(h,g),p=Math.max(p,g)}if(h==p)e.childEdgeLevel[f]=0;else{var y=v.length==1&&(this.order.vOrder[v[0]]==0&&c>this.positions[v[0]]||this.order.vOrder[v[0]]==this.order.vOrder.length-1&&c<this.positions[v[0]]);o.push({childhub:f,top_x:c,left_x:h,right_x:p,childCoords:d,needTopmost:y}),s.push(1)}}var b=function(e,t,n,r){if(o[e].right_x<o[t].left_x||o[e].left_x>o[t].right_x)return 0;if(n==r)return Infinity;if(n>r){var i=e,s=n;e=t,n=r,t=i,r=s}var u=0;o[t].top_x>=o[e].left_x&&o[t].top_x<=o[e].right_x&&u++;for(var a=0;a<o[e].childCoords.length;a++){var f=o[e].childCoords[a];f>=o[t].left_x&&f<=o[t].right_x&&u++}return o[t].needTopmost?u+=.1:u},w=new t(b,s),E=w.computeVerticalPositions(5,600);for(var f=0;f<o.length;f++)e.childEdgeLevel[o[f].childhub]=E[f],E[f]>e.rankVerticalLevels[i]&&(e.rankVerticalLevels[i]=E[f])}for(var i=1;i<=this.maxRank;i++){var S=1,s=[],o=[],x={},u=this.order.order[i].length;for(var a=0;a<u;a++){var f=this.order.order[i][a];if(this.GG.isPerson(f)){var v=this.GG.getOutEdges(f);if(v.length<=0)continue;var T=this.positions[f];e.outEdgeVerticalLevel[f]={};var N=this.order.vOrder,C=function(t){var n=0,r=0;for(var u=0;u<t.length;u++){var a=this.GG.downTheChainUntilNonVirtual(t[u]),l=t[u],c=Math.min(N[l],N[f])+1,h=Math.max(N[l],N[f]),p=c==h?0:1,d=!1,v=[];for(var m=c;m<h;m++){var g=this.order.order[i][m];if(this.GG.isPlaceholder(g))continue;this.GG.isRelationship(g)&&(p=Math.max(p,2)),this.GG.isPerson(g)&&(p=Math.max(p,3)),this.GG.isVirtual(g)&&this.GG.getInEdges(g)[0]!=f&&(d=!0),v.push(g)}r=Math.max(r,p),e.outEdgeVerticalLevel[f][a]={attachlevel:n,verticalLevel:r,numAttachLevels:t.length};if(p>=2||p==1&&d){var y=Math.min(T,this.positions[l]),b=Math.max(T,this.positions[l]),w=this.positions[l],E=Infinity;if(l==a){var S=this.GG.getInEdges(a),C=S[0]==f?S[1]:S[0];this.GG.isVirtual(C)&&(E=this.positions[C],E>b&&(b=E),E<y&&(y=E))}o.push({v:f,u:a,v_x:T,left_x:y,right_x:b,down_x:w,top_x:E,over:v}),s.push(r),x.hasOwnProperty(a)||(x[a]=[]),x[a].push(o.length-1)}n++,r++}return r-1}.bind(this),k=this._findLeftAndRightPartners(f),L=C(k.leftPartners),A=C(k.rightPartners);S=Math.max(S,Math.max(L,A))}}if(o.length>1){for(var O=0;O<o.length;O++)if(!o[O].hasOwnProperty("edgeComplement")){var M=o[O].u,_=x[M];if(_.length>1){var D=_[0]==O?_[1]:_[0];o[O].edgeComplement=D,o[D].edgeComplement=O}}var b=function(e,t,n,r,i){if(o[e].right_x<=o[t].left_x||o[e].left_x>=o[t].right_x)return 0;if(n==r)return Infinity;if(r>n){var s=e,u=n;e=t,n=r,t=s,r=u}if(o[e].v==o[t].v&&o[e].direction==o[t].direction&&o[e].attachLevel<o[t].attachLevel)return Infinity;if(o[e].left_x<=o[t].left_x&&o[e].right_x>=o[t].right_x)return 0;if(o[e].left_x>=o[t].left_x&&o[e].right_x<=o[t].right_x)return 2;var a=1;return o[t].top_x>=o[e].left_x&&o[t].top_x<=o[e].right_x&&a++,o[e].hasOwnProperty("edgeComplement")&&(!i||i[o[e].edgeComplement]>r)&&o[e].down_x>=o[t].left_x&&o[e].down_x<=o[t].right_x&&(a-=.4),a},w=new t(b,s,s),P=w.computeVerticalPositions(5,500);S=0;for(var a=0;a<o.length;a++)e.outEdgeVerticalLevel[o[a].v][o[a].u].verticalLevel=P[a],P[a]>S&&(S=P[a]);for(var a=0;a<o.length;a++){var H=P[a];if(H>1){var B=!0;for(var O=0;O<o[a].over.length;O++){var j=o[a].over[O];if(!this.GG.isRelationship(j)){B=!1;break}var F=this.GG.getParents(j);if(e.outEdgeVerticalLevel[F[0]][j].verticalLevel<=H||e.outEdgeVerticalLevel[F[1]][j].verticalLevel<=H){B=!1;break}}B&&(e.outEdgeVerticalLevel[o[a].v][o[a].u].verticalLevel=1)}}}e.rankVerticalLevels[i-1]+=Math.max(0,S-2)}return e},_findLeftAndRightPartners:function(e,t){var n=t?t.vOrder:this.order.vOrder,r=this.ranks[e],i=n[e],s=this.GG.getOutEdges(e),o=[],u=[];for(var a=0;a<s.length;a++){var f=s[a];if(this.ranks[f]!=r)continue;n[f]<i?o.push(f):u.push(f)}var l=function(e,t){var r=Math.abs(n[e]-i),s=Math.abs(n[t]-i);return r-s};return o.sort(l),u.sort(l),{leftPartners:o,rightPartners:u}},findBestTwinInsertPosition:function(e,t,r){var i=this.GG.getAllTwinsOf(e),s=this.ranks[e],o=r?r.order[s]:this.order.order[s],u=r?r.vOrder:this.order.vOrder,a=function(e,t){return u[e]-u[t]};i.sort(a);var f=[];for(var l=0;l<=i.length;l++)f[l]=0;var c=u[i[0]];for(var l=0;l<t.length;l++){var h=t[l],p=u[h];if(p<c)for(var d=1;d<=i.length;d++)f[d]+=d;else for(var d=0;d<i.length;d++)f[d]+=i.length-d}for(var l=0;l<i.length;l++){var v=this._findLeftAndRightPartners(i[l],r),m=v.leftPartners.length,g=v.rightPartners.length;for(var d=0;d<=l;d++)f[d]+=m;for(var d=l+1;d<=i.length;d++)f[d]+=g}var y=u[i[0]],b=n.indexOfLastMinElementInArray(f),w=y+b;for(var l=y+1;l<w;l++){var E=o[l];this.GG.isRelationship(E)&&w++}return w},computeRankY:function(e,t){var n=[0,0];for(var r=2;r<=this.maxRank;r++){var i=this.isChildhubRank(r)?this._computePersonRankHeight(r-1):this.yDistanceChildhubToNode;n[r]=n[r-1]+i+this.yExtraPerHorizontalLine*(Math.max(this.vertLevel.rankVerticalLevels[r-1],1)-1)}if(e&&t){var s=e[0],o=this.ranks[0],u=t[s],a=n[o],f=a-u;for(var r=0;r<=this.maxRank;r++)n[r]-=f}return n},isChildhubRank:function(e){for(var t=0;t<this.order.order[e].length;t++){if(this.GG.isPerson(this.order.order[e][t])||this.GG.isRelationship(this.order.order[e][t]))return!1;if(this.GG.isChildhub(this.order.order[e][t]))return!0}return!0},_computePersonRankHeight:function(t){var n=this.yDistanceNodeToChildhub,r=0;for(var i=0;i<this.order.order[t].length;i++)if(this.GG.isPerson(this.order.order[t][i])){var s=this.order.order[t][i],u=0;if(this.GG.properties[s].hasOwnProperty("comments")){var a=this.GG.properties[s].comments.replace(/^\s+|\s+$/g,"");u+=(a.match(/\n/g)||[]).length+1}var f=this.GG.properties[s].hasOwnProperty("dob")?new e(this.GG.properties[s].dob):null,l=this.GG.properties[s].hasOwnProperty("dod")?new e(this.GG.properties[s].dod):null;f!==null&&f.isComplete()&&u++,l!==null&&l.isComplete()&&u++;if(f!==null&&f.isComplete()&&l!==null&&l.isComplete()){var c=o.getAge(f,l);(c.length<2||c.indexOf(" y")<0)&&u--}(this.GG.properties[s].hasOwnProperty("lName")||this.GG.properties[s].hasOwnProperty("fName"))&&u++,this.GG.properties[s].hasOwnProperty("externalID")&&u++,u>r&&(r=u)}return r>4&&(n+=(r-4)*this.yCommentLineHeight),n},computeNodeY:function(e,t){return this.rankY[e]+(t-1)*this.yExtraPerHorizontalLine},computeRelLineY:function(e,t,n){var r=this.rankY[e]-t*this.yAttachPortHeight,i=this.rankY[e];return n==1?i-=t*this.yAttachPortHeight:n==2?i-=this.yExtraPerHorizontalLine*1.25:i-=n*this.yExtraPerHorizontalLine,{attachY:r,relLineY:i}},displayGraph:function(e,t){a=0;if(!u)return;var r=new n.Timer,i={convertedG:this.GG,ranks:this.ranks,ordering:this.order,positions:e,consangr:this.consangr};debug_display_processed_graph(i,"output",!0,t),a=r.report()},position:function(){var e=this.find_long_edges(),t=new s(null,this);this.try_shift_right(t,!0,!1),this.try_shift_right(t,!1,!0),t.normalize(),n.printObject(t.xcoord);var r=t.copy(),i=this.xcoord_score(r);for(var o=0;o<=this.maxXcoordIterations;o++){this.try_shift_right(t,!0,!0),this.try_straighten_long_edges(e,t),t.normalize();var u=this.xcoord_score(t);if(!u.isBettertThan(i))break;r=t.copy(),i=u}return n.printObject(r.xcoord),r.xcoord},xcoord_score:function(e,t,n,r,i){var s=new XCoordScore(this.GG.getMaxRealVertexId()),o=1,u=this.maxRank;typeof t!="undefined"&&(o=t-1,u=t,o==0&&(o=1),n||(o=t));for(var a=o;a<=u;a++){var f=this.order.order[a].length,l=0;typeof t!="undefined"&&a==t&&(l=i);for(var c=l;c<f;++c){var h=this.order.order[a][c],p=this.GG.getOutEdges(h),d=p.length;for(var v=0;v<d;++v){var m=p[v];if(typeof t!="undefined"){if(!r&&this.ranks[m]!=t)continue;if(this.ranks[m]==t&&this.order.vOrder[m]<i)continue}var g=this.edge_importance_to_straighten(h,m),y=this.xCoordEdgeWeightValue?this.GG.weights[h][m]:1,b=Math.abs(e.xcoord[h]-e.xcoord[m]),w=g*y*b;s.add(w),s.addEdge(h,m,b)}}}return s},edge_importance_to_straighten:function(e,t){return this.GG.isRelationship(t)?1:!this.GG.isVirtual(e)&&this.GG.isVirtual(t)?1.5:this.GG.isRelationship(e)?8:this.GG.isVirtual(e)?this.GG.isVirtual(t)?16:4:2},try_shift_right:function(e,t,n){for(var r=0;r<=this.maxRank;r++){var i;n?i=r:i=this.maxRank-r;if(i==0)continue;var s=(t||i==1)&&i!=this.maxRank,o=(n||i==this.maxRank)&&i!=1,u=0,a=this.order.order[i].length-1;for(var f=a;f>=u;f--){var l=this.order.order[i][f],c=this.compute_median(l,e,o,s);c!=c&&(c=e.xcoord[l]);var h=c-e.xcoord[l],p=e.getRightMostNoDisturbPosition(l),d=p<c?p-e.xcoord[l]:h;if(h<=0)continue;var v=0,m=this.xcoord_score(e,i,o,s,f),g=h;do{var y;if(g<=d)e.xcoord[l]+=g,y=this.xcoord_score(e,i,o,s,f),e.xcoord[l]-=g;else{var b=e.copy();b.shiftRightAndShiftOtherIfNecessary(l,g),y=this.xcoord_score(b,i,o,s,f)}y.isBettertThan(m)&&(v=g,m=y),g-=1}while(g>=Math.max(0,d));v>0&&e.shiftRightAndShiftOtherIfNecessary(l,v)}}},compute_median:function(e,t,n,r){var i=[],s=[],o=this.GG.getAllEdgesWithWeights(e);for(var u in o)if(o.hasOwnProperty(u)){if(u==e)continue;var a=o[u].weight,f=o[u].out?this.edge_importance_to_straighten(e,u):this.edge_importance_to_straighten(u,e),l=this.xCoordEdgeWeightValue?a:1,c=f*l;for(var h=0;h<c;h++)this.ranks[u]<=this.ranks[e]&&i.push(t.xcoord[u]),this.ranks[u]>=this.ranks[e]&&s.push(t.xcoord[u])}var p=function(e,t){return e-t},d=undefined,v=undefined,m=undefined;if((n||this.GG.isVirtual(e))&&i.length>0){i.sort(p);var g=Math.ceil(i.length/2);g>=i.length&&(g=i.length-1),i.length%2==0?v=Math.floor((i[g]+i[g-1])/2):v=i[g]}if((r||this.GG.isVirtual(e))&&s.length>0){s.sort(p);var g=Math.ceil(s.length/2);g>=s.length&&(g=s.length-1),s.length%2==0?m=Math.floor((s[g]+s[g-1])/2):m=s[g]}return v!==undefined&&m!==undefined?d=Math.max(v,m):v!==undefined?d=v:d=m,Math.ceil(d)},try_straighten_long_edges:function(e,t){var n=!1;for(var r=0;r<e.length;++r){var i=e[r],s=t.xcoord[i[0]],o=t.getLeftMostNoDisturbPosition(i[0]),u=t.getRightMostNoDisturbPosition(i[0]);for(var a=1;a<i.length;++a){var f=i[a],l=t.xcoord[f];if(l!=s){if(!(l>=o&&l<=u))break;for(var c=0;c<a;++c)t.xcoord[i[c]]=l;n=!0,s=l}o=Math.max(o,t.getLeftMostNoDisturbPosition(f)),u=Math.min(u,t.getRightMostNoDisturbPosition(f));if(u<o)break}var h=i.length-1,s=t.xcoord[i[h]],o=t.getLeftMostNoDisturbPosition(i[h]),u=t.getRightMostNoDisturbPosition(i[h]);for(var a=h-1;a>=0;--a){var f=i[a],l=t.xcoord[f];if(l!=s){if(!(l>=o&&l<=u))break;for(var c=h;c>a;c--)t.xcoord[i[c]]=l;n=!0,s=l}o=Math.max(o,t.getLeftMostNoDisturbPosition(f)),u=Math.min(u,t.getRightMostNoDisturbPosition(f));if(u<o)break}}return n},find_long_edges:function(){var e=[],t=this.GG.getMaxRealVertexId(),r=this.GG.getNumVertices(),i=[];for(var s=t+1;s<r;s++)i[s]=!1;for(var s=t+1;s<r;s++){if(i[s]||this.ranks[s]==0)continue;var o=s;while(this.GG.isVirtual(this.GG.getInEdges(o)[0]))o=this.GG.getInEdges(o)[0];var u=[],a=o;do i[a]=!0,u.push(a),a=this.GG.getOutEdges(a)[0];while(this.GG.isVirtual(a));console.log("Found long edge "+n.stringifyObject(u)),e.push(u)}return e}};var u=!1,a=0;return PositionedGraph}),define("pedigree/model/import",["pedigree/pedigreeDate","pedigree/model/baseGraph","pedigree/model/helpers"],function(e,t,n){return PedigreeImport=function(){},PedigreeImport.prototype={},PedigreeImport.initFromPhenotipsInternal=function(e){var n=new t,r={},i={};for(var s=0;s<e.length;s++){if(!e[s].hasOwnProperty("name")&&!e[s].hasOwnProperty("id"))throw"Invalid inpiut: a node without id and without name";var o=t.TYPE.PERSON;if(e[s].hasOwnProperty("relationship")||e[s].hasOwnProperty("rel")){o=t.TYPE.RELATIONSHIP;if(e[s].hasOwnProperty("hub")||e[s].hasOwnProperty("haschhub"))i[s]=!0}else if(e[s].hasOwnProperty("chhub"))o=t.TYPE.CHILDHUB;else if(e[s].hasOwnProperty("virtual")||e[s].hasOwnProperty("virt"))o=t.TYPE.VIRTUALEDGE;var u={};if(e[s].hasOwnProperty("properties")||e[s].hasOwnProperty("prop"))u=e[s].hasOwnProperty("properties")?e[s].properties:e[s].prop;if(o==t.TYPE.PERSON){u.hasOwnProperty("sex")&&!u.hasOwnProperty("gender")&&(u.gender=u.sex),u.hasOwnProperty("gender")||(u.gender="U");if(e[s].hasOwnProperty("gender")){var a=e[s].gender.toLowerCase();if(a=="female"||a=="f")u.gender="F";if(a=="other"||a=="o")u.gender="O";else if(a=="male"||a=="m")u.gender="M"}}var f=e[s].hasOwnProperty("width")?e[s].width:o==t.TYPE.PERSON?n.defaultPersonNodeWidth:n.defaultNonPersonNodeWidth,l=n._addVertex(null,o,u,f);if(e[s].hasOwnProperty("name")){if(r[e[s].name])throw"Invalid user input: multiple nodes with the same name";o==t.TYPE.PERSON&&(n.properties[l].fName=e[s].name),r[e[s].name]=l}if(o==t.TYPE.RELATIONSHIP&&!i.hasOwnProperty(s)){var c=n._addVertex(null,t.TYPE.CHILDHUB,null,f);r["_chhub_"+l]=c}}for(var s=0;s<e.length;s++){var h=e[s],p=h.hasOwnProperty("id")?h.id:r[h.name],d=p,v=!1;if(n.type[p]==t.TYPE.RELATIONSHIP&&!i.hasOwnProperty(p)){var m=r["_chhub_"+p];p=m,v=!0}var g=0;if(h.outedges)for(var y=0;y<h.outedges.length;y++){var b=h.outedges[y].to,w=r[b]?r[b]:b;if(!n.isValidId(w))throw"Invalid input: invalid edge target ("+b+")";var E=1;h.outedges[y].hasOwnProperty("weight")&&(E=h.outedges[y].weight),E>g&&(g=E),n.addEdge(p,w,E)}v&&n.addEdge(d,p,g)}return n.validate(),n},PedigreeImport.initFromPED=function(e,n,r,i,s,o){var u=e.match(/[^\r\n]+/g);if(u.length==0)throw"Unable to import: no data";var a=!1;u[0].indexOf("Ped:")>0&&u[0].indexOf("Per:")>0&&(a=!0);var f="",l=new t,c={},h={},p=!1,d=a?1:0;for(var v=0;v<u.length;v++){u[v]=u[v].replace(/[^a-zA-Z0-9_.\-\s*]/g," "),u[v]=u[v].replace(/^\s+|\s+$/g,"");var m=u[v].split(/\s+/);if(m.length<6||a&&m.length<10)throw"Input line has not enough columns: ["+u[v]+"]";if(f=="")f=m[0];else if(m[0]!=f)throw"Unsupported feature: multiple families detected within the same pedigree";var g=m[1];if(c.hasOwnProperty(g))throw"Multiple persons with the same ID ["+g+"]";var y=a?m[7]:m[4],b="U";y==1?b="M":y==2&&(b="F");var w={gender:b};i&&(w.externalID=g);var E=a&&m[8]==1?0:d++;v==u.length-1&&l.v[0]===undefined&&(E=0);var S=l._addVertex(E,t.TYPE.PERSON,w,l.defaultPersonNodeWidth);c[g]=S;var x=a?m[9]:m[5];h[x]=!0,n&&x!="-9"&&x!="0"&&x!="1"&&x!="2"&&(p=!0)}if(s){if(p||h.hasOwnProperty("2"))throw"Phenotypes with codes other than 0 or 1 were found";var T={1:!0},N={"-9":!0},C={0:!0}}else var T={2:!0},N={0:!0,"-9":!0},C={1:!0};if(!o){o={};if(p)for(var x in h)h.hasOwnProperty(x)&&x!="-9"&&x!="0"&&x!="1"&&(o[x]="affected (phenotype "+x+")",T[x]=!0)}var k=1,L=new RelationshipTracker(l,k);for(var v=0;v<u.length;v++){var m=u[v].split(/\s+/),A=m[1],O=c[A],x=a?m[9]:m[5];if(T.hasOwnProperty(x)){var M=o.hasOwnProperty(x)?o[x]:"affected";l.properties[O].carrierStatus="affected",l.properties[O].disorders=[M],r&&(l.properties[O].evaluated=!0)}else C.hasOwnProperty(x)?(l.properties[O].carrierStatus="",r&&(l.properties[O].evaluated=!0)):!N.hasOwnProperty(x);var _=m[2],D=m[3];if(_==0&&D==0)continue;if(_==0)_=l._addVertex(null,t.TYPE.PERSON,{gender:"M",comments:"unknown"},l.defaultPersonNodeWidth);else{_=c[_];if(l.properties[_].gender=="F")throw"Unable to import pedigree: a person declared as female [id: "+_+"] is also declared as being a father for [id: "+A+"]"}if(D==0)D=l._addVertex(null,t.TYPE.PERSON,{gender:"F",comments:"unknown"},l.defaultPersonNodeWidth);else{D=c[D];if(l.properties[D].gender=="M")throw"Unable to import pedigree: a person declared as male [id: "+D+"] is also declared as being a mother for [id: "+A+"]"}var P=L.createOrGetChildhub(D,_);l.addEdge(P,O,k)}return PedigreeImport.validateBaseGraph(l),l},PedigreeImport.initFromBOADICEA=function(e,r){var i=e.match(/[^\r\n]+/g);if(i.length<=2)throw"Unable to import: no data";if(i[0].match(/^BOADICEA import pedigree file format 2/i)===null)throw"Unable to import: unsupported version of the BOADICEA format";i.splice(0,2);var s="",o=new t,u={},a=1;for(var f=0;f<i.length;f++){i[f]=i[f].replace(/[^a-zA-Z0-9_.\-\s*]/g," "),i[f]=i[f].replace(/^\s+|\s+$/g,"");var l=i[f].split(/\s+/);if(l.length<24)throw"Input line has not enough columns: ["+i[f]+"]";if(s=="")s=l[0];else if(l[0]!=s)throw"Unsupported feature: multiple families detected within the same pedigree";var c=l[3];if(u.hasOwnProperty(c))throw"Multiple persons with the same ID ["+c+"]";var h=l[6],p="M";h=="F"&&(p="F");var d=l[1],v={gender:p,fName:d};r&&(v.externalID=c);var m=l[8];m=="1"&&(v.lifeStatus="deceased");var g=l[10];g!="0"&&n.isInt(g)&&(v.dob={decade:g+"s",year:parseInt(g)});var y=function(e,t){if(!t||t=="")return;e.hasOwnProperty("comments")?e.comments+="\n"+t:e.comments=t},b=[{column:11,label:"Breast",comment:""},{column:12,label:"Breast",comment:"Contralateral breast cancer",onlySetComment:!0},{column:13,label:"Ovarian",comment:""},{column:14,label:"Prostate",comment:""},{column:15,label:"Pancreatic",comment:""}];for(var w=0;w<b.length;w++){var E=b[w];v.hasOwnProperty("cancers")||(v.cancers={});var S={};if(l[E["column"]]=="0"){if(!E.hasOwnProperty("onlySetComment")||!E.onlySetComment)S.affected=!1}else{S.affected=!0;var x=l[E.column];if(n.isInt(x)){var T=parseInt(x);S.numericAgeAtDiagnosis=T,T>100&&(x="after_100"),S.ageAtDiagnosis=x}y(v,E.comment)}E.onlySetComment||(v.cancers[E.label]=S)}var N=l[17];N=="1"||N=="2"||N=="3"?(v.candidateGenes=[],(N==1||N==3)&&v.candidateGenes.push("BRCA1"),(N==2||N==3)&&v.candidateGenes.push("BRCA2")):N=="N"&&y(v,"BRCA tested: no mutations");var C=l[18];C!="0"&&(v.ethnicities=["Ashkenazi Jews"]);var k=l[2]==1,L=k?0:a++;f==i.length-1&&o.v[0]===undefined&&(L=0);var A=o._addVertex(L,t.TYPE.PERSON,v,o.defaultPersonNodeWidth);u[c]=A}var O=1,M=new RelationshipTracker(o,O);for(var f=0;f<i.length;f++){var l=i[f].split(/\s+/),c=l[3],_=u[c],D=l[4],P=l[5];if(D==0&&P==0)continue;if(D==0)D=o._addVertex(null,t.TYPE.PERSON,{gender:"M",comments:"unknown"},o.defaultPersonNodeWidth);else{D=u[D];if(o.properties[D].gender=="F")throw"Unable to import pedigree: a person declared as female [id: "+D+"] is also declared as being a father for [id: "+c+"]"}if(P==0)P=o._addVertex(null,t.TYPE.PERSON,{gender:"F",comments:"unknown"},o.defaultPersonNodeWidth);else{P=u[P];if(o.properties[P].gender=="M")throw"Unable to import pedigree: a person declared as male [id: "+P+"] is also declared as being a mother for [id: "+c+"]"}var H=M.createOrGetChildhub(P,D);o.addEdge(H,_,O)}return PedigreeImport.validateBaseGraph(o),o},PedigreeImport.validateBaseGraph=function(e){try{e.validate()}catch(t){throw t.indexOf("disconnected component")?"Unsupported pedigree: some components of the imported pedigree are disconnected from each other":"Unable to import pedigree"}},PedigreeImport.initFromSimpleJSON=function(e){try{var n=JSON.parse(e)}catch(r){throw"Unable to import pedigree: input is not a valid JSON string "+r}if(typeof n!="object"||Object.prototype.toString.call(n)!=="[object Array]")throw"Unable to import pedigree: JSON does not represent an array of objects";if(n.length==0)throw"Unable to import pedigree: input is empty";var i=new t,s={},o={},u={},a={};for(var f=0;f<n.length;f++){var l=n[f];if(typeof l!="object")throw"Unable to import pedigree: JSON does not represent an array of objects";if(!l.hasOwnProperty("id")&&!l.hasOwnProperty("name")&&!l.hasOwnProperty("firstName")&&!l.hasOwnProperty("externalId"))throw"Unable to import pedigree: a node with no ID or name is found";var c=i._addVertex(null,t.TYPE.PERSON,{},i.defaultPersonNodeWidth),h={};h.gender="U";for(var p in l)if(l.hasOwnProperty(p)){var d=l[p],p=p.toLowerCase();if(p=="mother"||p=="father")continue;if(p=="sex"){var v=d.toLowerCase();if(v=="female"||v=="f")h.gender="F";else if(v=="male"||v=="m")h.gender="M";else if(v=="other"||v=="o")h.gender="O"}else if(p=="id"){if(o.hasOwnProperty(d))throw"Unable to import pedigree: multiple persons with the same ID ["+d+"]";s.hasOwnProperty(d)&&s[d]!=c?(delete s[d],u[d]=!0):(o[d]=c,a[c]=!0)}else if(p=="name"||p=="firstname")h.fName=d,s.hasOwnProperty(d)&&s[d]!=c?(delete s[d],u[d]=!0):o.hasOwnProperty(d)&&o[d]!=c?(delete o[d],u[d]=!0):s[d]=c;else{var m=PedigreeImport.convertProperty(p,d);m!==null&&(h[m.propertyName]=m.value)}}l.hasOwnProperty("externalId")&&!a.hasOwnProperty(c)&&(o[l.externalId]=c,a[c]=!0),i.properties[c]=h}var g=function(e){if(e.hasOwnProperty("id"))return o[e.id];if(e.hasOwnProperty("firstName"))return s[e.firstName];if(e.hasOwnProperty("name"))return s[e.name]},y=function(e,t){if(u.hasOwnProperty(e))throw"Unable to import pedigree: ambiguous reference to ["+e+"]";if(o.hasOwnProperty(e))return o[e];if(s.hasOwnProperty(e))return s[e];throw"Unable to import pedigree: ["+e+"] is not a valid "+t+" reference (does not correspond to a name or an ID of another person)"},b=1,w=new RelationshipTracker(i,b);for(var f=0;f<n.length;f++){var l=n[f],E=g(l),S=l.hasOwnProperty("mother")?l.mother:null,x=l.hasOwnProperty("father")?l.father:null;if(S==null&&x==null)continue;if(x==null)var T=i._addVertex(null,t.TYPE.PERSON,{gender:"M",comments:"unknown"},i.defaultPersonNodeWidth);else{var T=y(x,"father");if(i.properties[T].gender=="F")throw"Unable to import pedigree: a person declared as female is also declared as being a father ("+x+")"}if(S==null)var N=i._addVertex(null,t.TYPE.PERSON,{gender:"F",comments:"unknown"},i.defaultPersonNodeWidth);else{var N=y(S,"mother");if(i.properties[N].gender=="M")throw"Unable to import pedigree: a person declared as male is also declared as being a mother ("+S+")"}if(T==E||N==E)throw"Unable to import pedigree: a person is declared to be his or hew own parent";var C=w.createOrGetChildhub(N,T);i.addEdge(C,E,b)}return PedigreeImport.validateBaseGraph(i),i},PedigreeImport.initFromGEDCOM=function(r,i,s){var o=r.match(/[^\r\n]+/g);if(o.length==0)throw"Unable to import: no data";var u=function(e){var t={header:{},individuals:[],families:[]},n=[];for(var r=0;r<e.length;r++){var i=e[r].replace(/[^a-zA-Z0-9.\@\/\-\s*]/g," ").replace(/^\s+|\s+$/g,""),s=e[r].split(/\s+/),o=s.splice(0,2);o.push(s.join(" "));var u=parseInt(o[0]);n.splice(u);if(u==0)o[1]=="HEAD"?n[0]=t.header:o[1][0]=="@"&&o[2]=="INDI"?(t.individuals.push({}),n[0]=t.individuals[t.individuals.length-1],n[0].id=o[1]):o[1][0]=="@"&&o[2]=="FAM"?(t.families.push({}),n[0]=t.families[t.families.length-1],n[0].id=o[1]):n[0]={};else{if(n.length<u-1)throw"Unable to import GEDCOM: a multi-level jump detected in line: ["+e[r]+"]";n[u-1].hasOwnProperty(o[1])||(n[u-1][o[1]]=[]),n.length<u+1&&(n[u]={},n[u-1][o[1]].push(n[u])),o[2]!=""&&(n[u].value=o[2])}currentLevel=o[0]}return t},a=u(o);console.log("GEDCOM object: "+n.stringifyObject(a)),a.header.hasOwnProperty("GEDC")&&a.header.GEDC.hasOwnProperty("VERS")&&a.header.GEDC.VERS!="5.5"&&a.header.GEDC.VERS!="5.5.1"&&alert("Unsupported GEDCOM version detected: ["+a.header.GEDC.VERS+"]. "+"Import will continue but the correctness is not guaranteed. Supportede versions are 5.5 and 5.5.1");if(a.individuals.length==0)throw"Unable to create a pedigree from GEDCOM: no individuals are defined in the import data";var f=new t,l={};for(var c=0;c<a.individuals.length;c++){var h=a.individuals[c],p=f._addVertex(null,t.TYPE.PERSON,{},f.defaultPersonNodeWidth);l[h.id]=p;var d=h.id.replace(/@/g,""),v=s?{externalID:d}:{};v.gender="U";var m=function(e){return e[0].value},g=function(t){t=t[0].value,t=t.replace(/^(\s*)ABT(\s*)/,""),t=t.replace(/^(\s*)EST(\s*)/,""),t=t.replace(/^(\s*)BEF(\s*)/,""),t=t.replace(/^(\s*)AFT(\s*)/,"");var n=/^\s*BET\s+(.+)\s+AND.*/,r=n.exec(t);r!=null&&(t=r[1]);if(t=="?")return null;var i=Date.parse(t);return isNaN(i)==0?new e(new Date(i)):null};for(var y in h)if(h.hasOwnProperty(y))if(y=="SEX"){var b=m(h[y])[0].toLowerCase();if(b=="female"||b=="f")v.gender="F";else if(b=="male"||b=="m")v.gender="M"}else if(y=="BIRT"){if(h[y][0].hasOwnProperty("DATE")){var w=g(h[y][0].DATE);w!==null&&(v.dob=(new e(w)).getSimpleObject())}}else if(y=="DEAT"){if(v.hasOwnProperty("lifeStatus")&&v["lifeStatus"]=="stillborn")continue;v.lifeStatus="deceased";if(h[y][0].hasOwnProperty("DATE")){var w=g(h[y][0].DATE);w!==null&&(v.dod=(new e(w)).getSimpleObject())}}else if(y=="ADOP")v.adoptedStatus="adoptedIn";else if(y=="_INFO")v.hasOwnProperty("comments")||(v.comments=""),v.comments+="(Info: "+m(h[y])+")\n";else if(y=="NOTE"||y=="_COMMENT"){v.hasOwnProperty("comments")||(v.comments=""),v.comments+=m(h[y])+"\n";if(h[y][0].hasOwnProperty("CONT")){var E=h[y][0].CONT;for(var S=0;S<E.length;S++)v.comments+=E[S].value+"\n"}}else if(y=="NAME"){var x=m(h[y]).split("/"),T=x[0].replace(/^\s+|\s+$/g,""),N=x.length>1?x[1].replace(/^\s+|\s+$/g,""):"";v.fName=T,N!=""&&(v.lName=N)}else if(y=="_MAIDEN"){var x=m(h[y]).split("/"),T=x[0].replace(/^\s+|\s+$/g,""),N=x.length>1?x[1].replace(/^\s+|\s+$/g,""):"";v.lNameAtB=T,N!=""&&(v.lNameAtB+=" "+N)}else if(y=="_GENSTAT"){var C=m(h[y]).split("");for(var k=0;k<C.length;k++){var L=C[k];if(L.charCodeAt(0)==65533||L.charCodeAt(0)==172)L="HEARSAY";switch(L){case"O":v.carrierStatus="affected",v.disorders=["affected"],i&&(v.evaluated=!0);break;case"HEARSAY":v.carrierStatus="presymptomatic",i&&(v.evaluated=!0);break;case"K":v.lifeStatus="stillborn";break;case"M":v.childlessStatus="infertile";break;case"E":v.hasOwnProperty("comments")?v.comments="(untested)\n"+v.comments:v.comments="(untested)";break;case"O":}}}v.hasOwnProperty("comments")&&(v.comments=v.comments.replace(/^\s+|\s+$/g,""),v.comments==""&&delete v.comments),f.properties[p]=v}var A=1,O=new RelationshipTracker(f,A);for(var c=0;c<a.families.length;c++){var M=a.families[c],_=M.hasOwnProperty("WIFE")?m(M.WIFE):null,D=M.hasOwnProperty("HUSB")?m(M.HUSB):null;if(D==null)var P=f._addVertex(null,t.TYPE.PERSON,{gender:"M",comments:"unknown"},f.defaultPersonNodeWidth);else{var P=l[D];if(f.properties[P].gender=="F")throw"Unable to import pedigree: a person declared as female is also declared as being a father ("+D+")"}if(_==null)var H=f._addVertex(null,t.TYPE.PERSON,{gender:"F",comments:"unknown"},f.defaultPersonNodeWidth);else{var H=l[_];if(f.properties[H].gender=="M")throw"Unable to import pedigree: a person declared as male is also declared as being a mother ("+_+")"}var B=O.createOrGetChildhub(H,P),j=M.hasOwnProperty("CHIL")?M.CHIL:null;if(j==null){var F=f._addVertex(null,t.TYPE.PERSON,{gender:"U",placeholder:!0},f.defaultPersonNodeWidth);l[F]=F,j=[{value:F}]}for(var I=0;I<j.length;I++){var q=j[I].value,F=l.hasOwnProperty(q)?l[q]:null;if(F==null)throw"Unable to import pedigree: child link does not point to an existing individual: ["+q+"]";f.addEdge(B,F,A)}}return PedigreeImport.validateBaseGraph(f),f},PedigreeImport.JSONToInternalPropertyMapping={proband:"proband",lastname:"lName",lastnameatbirth:"lNameAtB",comments:"comments",twingroup:"twinGroup",monozygotic:"monozygotic",adoptedstatus:"adoptedStatus",evaluated:"evaluated",birthdate:"dob",deathdate:"dod",gestationage:"gestationAge",lifestatus:"lifeStatus",disorders:"disorders",hpoterms:"hpoTerms",candidategenes:"candidateGenes",ethnicities:"ethnicities",carrierstatus:"carrierStatus",externalid:"externalID",numpersons:"numPersons",lostcontact:"lostContact",nodenumber:"nodeNumber",cancers:"cancers"},PedigreeImport.convertProperty=function(e,t){if(!PedigreeImport.JSONToInternalPropertyMapping.hasOwnProperty(e))return null;var n=PedigreeImport.JSONToInternalPropertyMapping[e];return{propertyName:n,value:t}},RelationshipTracker=function(e,t){this.newG=e,this.defaultEdgeWeight=t,this.relationships={},this.relChildHubs={}},RelationshipTracker.prototype={createOrGetChildhub:function(e,n){if(this.relationships.hasOwnProperty(e)&&this.relationships[e].hasOwnProperty(n))var r=this.relationships[e][n],i=this.relChildHubs[r];else{this.relationships[e]===undefined&&(this.relationships[e]={}),this.relationships[n]===undefined&&(this.relationships[n]={});var r=this.newG._addVertex(null,t.TYPE.RELATIONSHIP,{},this.newG.defaultNonPersonNodeWidth),i=this.newG._addVertex(null,t.TYPE.CHILDHUB,{},this.newG.defaultNonPersonNodeWidth);this.newG.addEdge(r,i,this.defaultEdgeWeight),this.newG.addEdge(e,r,this.defaultEdgeWeight),this.newG.addEdge(n,r,this.defaultEdgeWeight),this.relationships[e][n]=r,this.relationships[n][e]=r,this.relChildHubs[r]=i}return i}},PedigreeImport}),define("pedigree/model/dynamicGraph",["pedigree/pedigreeDate","pedigree/model/baseGraph","pedigree/model/positionedGraph","pedigree/model/helpers","pedigree/model/import"],function(e,t,n,r,i){return DynamicPositionedGraph=function(e){this.DG=e,this._heuristics=new Heuristics(e),this._heuristics.improvePositioning(),this._onlyProbandGraph=[{name:"proband"}]},DynamicPositionedGraph.makeEmpty=function(e,r){var i=new t(e,r),s=new n(i);return new DynamicPositionedGraph(s)},DynamicPositionedGraph.prototype={isValidID:function(e){return e<0||e>this.DG.GG.getMaxRealVertexId()?!1:!this.DG.GG.isPerson(e)&&!this.DG.GG.isRelationship(e)?!1:!0},getMaxNodeId:function(){return this.DG.GG.getMaxRealVertexId()},isPersonGroup:function(e){return this.getProperties(e).hasOwnProperty("numPersons")},isPerson:function(e){return this.DG.GG.isPerson(e)},isRelationship:function(e){return this.DG.GG.isRelationship(e)},isPlaceholder:function(e){return this.DG.GG.isPlaceholder(e)},isAdoptedIn:function(e){if(!this.isPerson(e))throw"Assertion failed: isAdopted() is applied to a non-person";return this.DG.GG.isAdoptedIn(e)},isAdoptedOut:function(e){if(!this.isPerson(e))throw"Assertion failed: isAdopted() is applied to a non-person";return this.DG.GG.isAdoptedOut(e)},getGeneration:function(e){var t=Math.min.apply(null,this.DG.ranks);return(this.DG.ranks[e]-t)/2+1},getOrderWithinGeneration:function(e){if(!this.isPerson(e))throw"Assertion failed: getOrderWithinGeneration() is applied to a non-person";var t=0,n=this.DG.ranks[e];for(var r=0;r<this.DG.order.order[n].length;r++){var i=this.DG.order.order[n][r];this.DG.GG.isPerson(i)&&t++;if(i==e)break}return t},getTwinGroupId:function(e){return this.DG.GG.getTwinGroupId(e)},getAllTwinsSortedByOrder:function(e){var t=this.DG.GG.getAllTwinsOf(e),n=this.DG.order.vOrder,r=function(e,t){return n[e]-n[t]};return t.sort(r),t},isChildless:function(e){if(!this.getProperties(e).hasOwnProperty("childlessStatus"))return!1;var t=this.getProperties(e).childlessStatus!==null;return t},isChildlessByChoice:function(e){if(!this.getProperties(e).hasOwnProperty("childlessStatus"))return!1;var t=this.getProperties(e)["childlessStatus"]=="childless";return t},isInfertile:function(e){if(!this.getProperties(e).hasOwnProperty("childlessStatus"))return!1;var t=this.getProperties(e)["childlessStatus"]=="infertile";return t},isConsangrRelationship:function(e){if(!this.isRelationship(e))throw"Assertion failed: isConsangrRelationship() is applied to a non-relationship";return this.DG.consangr.hasOwnProperty(e)},getProperties:function(e){return this.DG.GG.properties[e]},setProperties:function(e,t){this.DG.GG.properties[e]=t},setProbandData:function(t){t.hasOwnProperty("patient_name")&&(t.patient_name.hasOwnProperty("first_name")&&(this.DG.GG.properties[0].fName=t.patient_name.first_name),t.patient_name.hasOwnProperty("last_name")&&(this.DG.GG.properties[0].lName=t.patient_name.last_name));var n=!0;if(t.hasOwnProperty("sex")){var i=t.sex,s=this.getPossibleGenders(0);if(!s.hasOwnProperty(i)||!s[i])i="U",n=!1;this.DG.GG.properties[0].gender=i}if(t.hasOwnProperty("date_of_birth")){var o=new e(t.date_of_birth);this.DG.GG.properties[0].dob=o.getSimpleObject()}if(t.hasOwnProperty("date_of_death")){var u=new e(t.date_of_death);this.DG.GG.properties[0].dod=u.getSimpleObject()}if(t.hasOwnProperty("life_status")){var a=t.life_status;if(a=="deceased"||a=="alive")this.DG.GG.properties[0].lifeStatus=a}if(t.hasOwnProperty("ethnicity")){var f=[];t.ethnicity.hasOwnProperty("maternal_ethnicity")&&(f=t.ethnicity.maternal_ethnicity.slice(0)),t.ethnicity.hasOwnProperty("paternal_ethnicity")&&(f=f.concat(t.ethnicity.paternal_ethnicity.slice(0))),f.length>0&&(this.DG.GG.properties[0].ethnicities=r.filterUnique(f))}t.hasOwnProperty("external_id")&&(this.DG.GG.properties[0].externalID=t.external_id);var l=[];if(t.hasOwnProperty("features"))for(var c=0;c<t.features.length;c++)t.features[c].observed&&t.features[c].type=="phenotype"&&l.push(t.features[c].id);if(t.hasOwnProperty("nonstandard_features"))for(var c=0;c<t.nonstandard_features.length;c++)t.nonstandard_features[c].observed&&t.nonstandard_features[c].type=="phenotype"&&l.push(t.nonstandard_features[c].label);l.length>0&&(this.DG.GG.properties[0].hpoTerms=l);var h=[];if(t.hasOwnProperty("disorders"))for(var c=0;c<t.disorders.length;c++){var p=t.disorders[c].id,d=p.match(/^MIM:(\d+)$/);d&&(p=d[1]),h.push(p)}h.length>0&&(this.DG.GG.properties[0].disorders=h);var v=[];if(t.hasOwnProperty("genes"))for(var c=0;c<t.genes.length;c++)v.push(t.genes[c].gene);return v.length>0&&(this.DG.GG.properties[0].candidateGenes=v),n},getPosition:function(e){var t=this.DG.positions[e],n=this.DG.ranks[e],r=this.DG.GG.isChildhub(e)?this.DG.vertLevel.childEdgeLevel[e]:1,i=this.DG.computeNodeY(n,r);if(this.DG.GG.isVirtual(e)){var s=this.DG.GG.downTheChainUntilNonVirtual(e),o=this.DG.GG.upTheChainUntilNonVirtual(e),u=this.DG.ranks[o];if(n==u){var a=this.DG.vertLevel.outEdgeVerticalLevel[o][s].verticalLevel;i=this.DG.computeRelLineY(n,0,a).relLineY}var f=this.DG.ranks[s];n==f&&(i=this.getPosition(s).y)}else if(this.isRelationship(e)){var l=this.DG.GG.getParents(e),c=this.DG.vertLevel.outEdgeVerticalLevel[l[0]].hasOwnProperty(e)?this.DG.vertLevel.outEdgeVerticalLevel[l[0]][e].verticalLevel:0,h=this.DG.vertLevel.outEdgeVerticalLevel[l[1]].hasOwnProperty(e)?this.DG.vertLevel.outEdgeVerticalLevel[l[1]][e].verticalLevel:0,a=Math.min(c,h),p=this.DG.vertLevel.outEdgeVerticalLevel[l[0]].hasOwnProperty(e)?this.DG.vertLevel.outEdgeVerticalLevel[l[0]][e].attachlevel:0,d=this.DG.vertLevel.outEdgeVerticalLevel[l[1]].hasOwnProperty(e)?this.DG.vertLevel.outEdgeVerticalLevel[l[1]][e].attachlevel:0,v=Math.min(p,d);i=this.DG.computeRelLineY(n,v,a).relLineY}return{x:t,y:i}},getRelationshipChildLastName:function(e){if(!this.isRelationship(e))throw"Assertion failed: getRelationshipChildLastName() is applied to a non-relationship";var t=null,n=this.DG.GG.getParents(e);if(this.getGender(n[0])=="M")t=this.DG.GG.getLastName(n[0]);else{if(this.getGender(n[1])!="M")return null;t=this.DG.GG.getLastName(n[1])}if(t=="")return null;var r=this.DG.GG.getRelationshipChildhub(e),i=this.DG.GG.getOutEdges(r);for(var s=0;s<i.length;s++){var o=this.DG.GG.getLastNameAtBirth(i[s]);if(o!=""&&o!=t)return null}return t},getRelationshipChildhubPosition:function(e){if(!this.isRelationship(e))throw"Assertion failed: getRelationshipChildhubPosition() is applied to a non-relationship";var t=this.DG.GG.getRelationshipChildhub(e);return this.getPosition(t)},getRelationshipLineInfo:function(e,t){if(!this.isRelationship(e))throw"Assertion failed: getRelationshipToPersonLinePosition() is applied to a non-relationship";if(!this.isPerson(t))throw"Assertion failed: getRelationshipToPersonLinePosition() is applied to a non-person";var n=this.DG.vertLevel.outEdgeVerticalLevel[t].hasOwnProperty(e)?this.DG.vertLevel.outEdgeVerticalLevel[t][e]:{attachlevel:0,verticalLevel:0,numAttachLevels:1},r=this.DG.computeRelLineY(this.DG.ranks[t],n.attachlevel,n.verticalLevel),i={attachmentPort:n.attachlevel,attachY:r.attachY,verticalLevel:n.verticalLevel,verticalY:r.relLineY,numAttachPorts:n.numAttachLevels};return i},getRelationshipChildrenSortedByOrder:function(e){if(!this.isRelationship(e))throw"Assertion failed: getRelationshipChildren() is applied to a non-relationship";var t=this.DG.GG.getRelationshipChildhub(e),n=this.DG.GG.getOutEdges(t),r=this.DG.order.vOrder,i=function(e,t){return r[e]-r[t]};return n.sort(i),n},getAllChildren:function(e){if(!this.isPerson(e)&&!this.isRelationship(e))throw"Assertion failed: getAllChildren() is applied to a non-person non-relationship node";var t=this.isRelationship(e)?[e]:this.DG.GG.getAllRelationships(e),n=[];for(var r=0;r<t.length;r++){var i=this.DG.GG.getOutEdges(t[r])[0],s=this.DG.GG.getOutEdges(i);n=n.concat(s)}return n},isChildOfProband:function(e){var t=this.DG.GG.getParents(e);return r.arrayContains(t,0)?!0:!1},isSiblingOfProband:function(e){var t=this.DG.GG.getAllSiblingsOf(e);return r.arrayContains(t,0)?!0:!1},isPartnershipRelatedToProband:function(e){var t=this.DG.GG.getParents(e);return r.arrayContains(t,0)?!0:e==this.DG.GG.getProducingRelationship(0)?!0:!1},isRelatedToProband:function(e){var t=this.getAllRelatedRelationships(0);for(var n=0;n<t.length;n++){var i=t[n],s=this.DG.GG.getParents(i);if(r.arrayContains(s,e))return!0;var o=this.getAllChildren(i);if(r.arrayContains(o,e))return!0}return!1},getAllRelatedRelationships:function(e){var t=this.DG.GG.getAllRelationships(e),n=this.DG.GG.getProducingRelationship(e);return n!=null&&t.push(n),t},getAllSiblings:function(e){if(!this.isPerson(e))throw"Assertion failed: getAllSiblings() is applied to a non-person";if(this.DG.GG.getInEdges(e).length==0)return[];var t=this.DG.GG.getInEdges(e)[0],n=this.DG.GG.getOutEdges(t).slice(0);return r.removeFirstOccurrenceByValue(n,e),n},isOnlyChild:function(e){if(!this.isPerson(e))throw"Assertion failed: isOnlyPartnerlessChild() is applied to a non-person";return this.DG.GG.getInEdges(e).length==0?!1:this.getAllSiblings(e).length==0?!0:!1},hasNonPlaceholderNonAdoptedChildren:function(e){var t=[];this.isRelationship(e)?t=this.getRelationshipChildrenSortedByOrder(e):this.isPerson(e)&&(t=this.getAllChildren(e));for(var n=0;n<t.length;n++){var r=t[n];if(!this.isPlaceholder(r)&&!this.isAdoptedIn(r))return!0}return!1},hasNoNonPlaceholderChildren:function(e){var t=[];this.isRelationship(e)?t=this.getRelationshipChildrenSortedByOrder(e):this.isPerson(e)&&(t=this.getAllChildren(e));for(var n=0;n<t.length;n++){var r=t[n];if(!this.isPlaceholder(r))return!1}return!0},getParentRelationship:function(e){if(!this.isPerson(e))throw"Assertion failed: getParentRelationship() is applied to a non-person";return this.DG.GG.getProducingRelationship(e)},hasToBeAdopted:function(e){if(!this.isPerson(e))throw"Assertion failed: hasToBeAdopted() is applied to a non-person";var t=this.getParentRelationship(e);return t!==null&&this.isChildless(t)?!0:!1},hasRelationships:function(e){if(!this.isPerson(e))throw"Assertion failed: hasRelationships() is applied to a non-person";return this.DG.GG.v[e].length>0},getPossibleGenders:function(e){var t={M:!0,F:!0,O:!0,U:!0},n=this.DG.GG.getAllPartners(e);for(var r=0;r<n.length;r++){var i=this.getGender(n[r]);i!="U"&&(t[i]=!1)}return t},getPossibleChildrenOf:function(e){var t=[];for(var n=0;n<=this.DG.GG.getMaxRealVertexId();n++){if(!this.isPerson(n))continue;if(this.DG.GG.inedges[n].length!=0)continue;if(this.DG.ancestors[e].hasOwnProperty(n))continue;t.push(n)}return t},getPossibleSiblingsOf:function(e){var t=this.getParentRelationship(e)!==null,n=[];for(var r=0;r<=this.DG.GG.getMaxRealVertexId();r++){if(!this.isPerson(r))continue;if(this.DG.ancestors[e].hasOwnProperty(r))continue;if(this.DG.ancestors[r].hasOwnProperty(e))continue;if(t&&this.DG.GG.inedges[r].length!=0)continue;n.push(r)}return n},getPossibleParentsOf:function(e){var t=[];for(var n=0;n<=this.DG.GG.getMaxRealVertexId();n++){if(!this.isRelationship(n)&&!this.isPerson(n))continue;if(this.isPersonGroup(n))continue;if(this.isPlaceholder(n))continue;if(this.DG.ancestors[n].hasOwnProperty(e))continue;if(this.isPerson(n)&&this.isAdoptedOut(n))continue;t.push(n)}return t},getPossiblePartnersOf:function(e){var t=this.DG.GG.getOppositeGender(e),n=t=="U"?["M","F","U"]:[t,"U"],i=this._getAllPersonsOfGenders(n,!0),s=this.DG.GG.getAllPartners(e);s.push(e);for(var o=0;o<s.length;o++)r.removeFirstOccurrenceByValue(i,s[o]);return i},getOppositeGender:function(e){if(!this.isPerson(e))throw"Assertion failed: getOppositeGender() is applied to a non-person";return this.DG.GG.getOppositeGender(e)},getGender:function(e){if(!this.isPerson(e))throw"Assertion failed: getGender() is applied to a non-person";return this.DG.GG.getGender(e)},getLastName:function(e){if(!this.isPerson(e))throw"Assertion failed: getLastName() is applied to a non-person";return this.DG.GG.getLastName(e)},getDisconnectedSetIfNodeRemoved:function(e){var t={};t[e]=!0;if(this.isPerson(e)){var n=this.DG.GG.getAllRelationships(e);for(var i=0;i<n.length;i++)t[n[i]]=!0}for(var s in t)if(t.hasOwnProperty(s)&&this.isRelationship(s)){var o=this.DG.GG.getOutEdges(s)[0];t[o]=!0}var u={},a=new Queue;a.push(0);while(a.size()>0){var f=parseInt(a.pop());if(u.hasOwnProperty(f))continue;u[f]=!0;var l=this.DG.GG.getOutEdges(f);for(var i=0;i<l.length;i++)t.hasOwnProperty(l[i])||a.push(l[i]);var c=this.DG.GG.getInEdges(f);for(var i=0;i<c.length;i++)t.hasOwnProperty(c[i])||a.push(c[i])}console.log("Connected nodes: "+r.stringifyObject(u));var h=[];for(var i=0;i<this.DG.GG.getNumVertices();i++)if(this.isPerson(i)||this.isRelationship(i))u.hasOwnProperty(i)||h.push(i);return console.log("Affected nodes: "+r.stringifyObject(h)),h},_debugPrintAll:function(e){console.log("========== "+e+" ==========")},updateAncestors:function(){var e=this.DG.findAllAncestors();this.DG.ancestors=e.ancestors,this.DG.consangr=e.consangr;var t=[];for(var n=0;n<=this.DG.GG.getMaxRealVertexId();n++){if(!this.isRelationship(n))continue;t.push(n)}return{moved:t}},addNewChild:function(e,n,i){this._debugPrintAll("before");var s=new r.Timer;if(!this.DG.GG.isChildhub(e)){if(!this.DG.GG.isRelationship(e))throw"Assertion failed: adding children to a non-childhub node";e=this.DG.GG.getRelationshipChildhub(e)}var o=this.DG.positions.slice(0),u=this.DG.ranks.slice(0),a=this.DG.vertLevel.copy(),f=this.DG.rankY.slice(0),l=this.DG.GG.getMaxRealVertexId();n||(n={}),i||(i=1);var c=this.DG.ranks[e]+1,h=this._findBestInsertPosition(c,e),p=this._insertVertex(t.TYPE.PERSON,n,1,e,null,c,h),d=[p];for(var v=0;v<i-1;v++){var m=this.addTwin(p,n);d.push(m["new"][0])}this.DG.GG.validate(),this._heuristics.improvePositioning(u,f),this.updateAncestors(),s.printSinceLast("=== AddChild runtime: "),this._debugPrintAll("after");var g=this._findMovedNodes(l,o,u,a,f),y=this.DG.GG.getInEdges(e)[0];r.arrayContains(g,y)||g.push(y);var b=this.DG.GG.getInEdges(y);return{"new":d,moved:g,animate:b}},addNewParents:function(e){this._debugPrintAll("before");var n=new r.Timer;if(!this.DG.GG.isPerson(e))throw"Assertion failed: adding parents to a non-person node";if(this.DG.GG.getInEdges(e).length>0)throw"Assertion failed: adding parents to a person with parents";var i=this.DG.positions.slice(0),s=this.DG.ranks.slice(0),o=this.DG.vertLevel.copy(),u=this.DG.rankY.slice(0),a=this.DG.GG.getMaxRealVertexId();this._heuristics.swapBeforeParentsToBringToSideIfPossible(e);var f=this.DG.ranks[e]-1,l=this._findBestInsertPosition(f,e),c=this._insertVertex(t.TYPE.CHILDHUB,{},1,null,e,f,l),h=this.DG.ranks[c]-1,p=this._findBestInsertPosition(h,c),d=this._insertVertex(t.TYPE.RELATIONSHIP,{},1,null,c,h,p);h=this.DG.ranks[d];var v=this._insertVertex(t.TYPE.PERSON,{gender:"F"},1,null,d,h,p+1),m=this._insertVertex(t.TYPE.PERSON,{gender:"M"},1,null,d,h,p);this.DG.GG.validate(),this._heuristics.improvePositioning(s,u),this.updateAncestors(),n.printSinceLast("=== NewParents runtime: "),this._debugPrintAll("after");var g=this.DG.GG.getAllPartners(e);g.length==1?g.push(e):g=[e];var y=this._findMovedNodes(a,i,s,o,u),b=[d,v,m];return{"new":b,moved:y,highlight:[e],animate:g}},addNewRelationship:function(e,n,i,s){this._debugPrintAll("before");var o=new r.Timer;if(!this.DG.GG.isPerson(e))throw"Assertion failed: adding relationship to a non-person node";var u=this.DG.positions.slice(0),a=this.DG.ranks.slice(0),f=this.DG.vertLevel.copy(),l=this.DG.rankY.slice(0),c=this.DG.consangr,h=this.DG.GG.getMaxRealVertexId();n||(n={}),s||(s=1);var p={gender:this.DG.GG.getOppositeGender(e)},d=this.DG.ranks[e],v=this.DG.order.vOrder[e],m=!0,g={};if(n.hasOwnProperty("placeholder")&&n.placeholder){g.childlessStatus="childless";var m=!1}this._heuristics.swapPartnerToBringToSideIfPossible(e),this._heuristics.swapTwinsToBringToSideIfPossible(e);var y=this._findBestInsertPosition(d,e,i);console.log("vOrder: "+v+", inserting @ "+y),console.log("Orders before: "+r.stringifyObject(this.DG.order.order[this.DG.ranks[e]]));var b=this._insertVertex(t.TYPE.RELATIONSHIP,g,1,e,null,d,y);console.log("Orders after: "+r.stringifyObject(this.DG.order.order[this.DG.ranks[e]]));var w=y>v?y+1:y,E=this._insertVertex(t.TYPE.PERSON,p,1,null,b,d,w),S=d+1,x=this._findBestInsertPosition(S,b),T=this._insertVertex(t.TYPE.CHILDHUB,{},1,b,null,S,x),N=S+1,C=this._findBestInsertPosition(N,T),k=this._insertVertex(t.TYPE.PERSON,n,1,T,null,N,C),L=[b,E,k];for(var A=0;A<s-1;A++){var O=this.addTwin(k,n);L.push(O["new"][0])}console.log("Orders after all: "+r.stringifyObject(this.DG.order.order[this.DG.ranks[e]])),this.DG.GG.validate(),this._heuristics.improvePositioning(a,l),this.updateAncestors(),o.printSinceLast("=== NewRelationship runtime: "),this._debugPrintAll("after");var M=this._findMovedNodes(h,u,a,f,l,c);return{"new":L,moved:M,highlight:[e]}},assignParent:function(e,n){if(this.isRelationship(e)){var i=this.DG.GG.getRelationshipChildhub(e),s=this.DG.ranks[i],o=this.DG.ranks[n],u=this.getAllChildren(e),a=1;this.DG.GG.addEdge(i,n,a);if(u.length==1&&this.isPlaceholder(u[0]))var f=this.removeNodes([u[0]]);var l=[n];if(s!=o-1){var c=f?f.removed:[];return this.redrawAll(c,l)}var h=this.DG.positions.slice(0),p=this.DG.ranks.slice(0),d=this.DG.vertLevel.copy(),v=this.DG.rankY.slice(0),m=this.DG.consangr,g=this.DG.GG.getMaxRealVertexId();this.DG.GG.validate(),this._updateauxiliaryStructures(p,v),h[e]=Infinity;var y=this._findMovedNodes(g,h,p,d,v,m);return f?(f.moved=f.moved.concat(y),f.moved=r.filterUnique(f.moved),f.animate=[n],f):{moved:y,animate:[n]}}var b=this.DG.ranks[e],o=this.DG.ranks[n],w={gender:this.DG.GG.getOppositeGender(e)};if(b>=o){var p=this.DG.ranks.slice(0),E=o-1,S=this._insertVertex(t.TYPE.CHILDHUB,{},1,null,n,E,0),x=this.DG.ranks[S]-1,T=this._insertVertex(t.TYPE.RELATIONSHIP,{},1,null,S,x,0),N=this._insertVertex(t.TYPE.PERSON,w,1,null,T,x,0);this.DG.GG.addEdge(e,T,1);var l=[n,e],C=[T,N];return this.redrawAll(null,l,C,p)}this._debugPrintAll("before");var k=new r.Timer,h=this.DG.positions.slice(0),p=this.DG.ranks.slice(0),d=this.DG.vertLevel.copy(),v=this.DG.rankY.slice(0),m=this.DG.consangr,g=this.DG.GG.getMaxRealVertexId(),L=this.DG.positions[e],A=this.DG.positions[n];if(b==o-2){var O=A<L,M=this._findBestInsertPosition(b,e,O),T=this._insertVertex(t.TYPE.RELATIONSHIP,{},1,e,null,b,M),_=this.DG.order.vOrder[e]>this.DG.order.vOrder[T]?M:M+1,N=this._insertVertex(t.TYPE.PERSON,w,1,null,T,b,_),E=o-1,D=this._findBestInsertPosition(E,T),S=this._insertVertex(t.TYPE.CHILDHUB,{},1,T,null,E,D);this.DG.GG.addEdge(S,n,1)}else{var E=o-1,D=this._findBestInsertPosition(E,n),S=this._insertVertex(t.TYPE.CHILDHUB,{},1,null,n,E,D),x=o-2,M=this._findBestInsertPosition(x,S),T=this._insertVertex(t.TYPE.RELATIONSHIP,{},1,null,S,x,M),_=this.DG.positions[e]>this.DG.positions[T]?M:M+1,N=this._insertVertex(t.TYPE.PERSON,w,1,null,T,x,_);this._addMultiRankEdge(e,T)}this.DG.GG.validate(),this._heuristics.improvePositioning(p,v),this.updateAncestors(),k.printSinceLast("=== DragToParentOrChild runtime: "),this._debugPrintAll("after"),this.DG.positions.length>=31&&console.log("position of node 32: "+this.DG.positions[32]+", was: "+h[32]);var y=this._findMovedNodes(g,h,p,d,v,m),P=[T,N];return{"new":P,moved:y,highlight:[e,N,n]}},assignPartner:function(e,n,r){var i=this.DG.positions.slice(0),s=this.DG.ranks.slice(0),o=this.DG.vertLevel.copy(),u=this.DG.rankY.slice(0),a=this.DG.consangr,f=this.DG.GG.getMaxRealVertexId(),l=this.DG.ranks[e],c=this.DG.ranks[n];if(l<c||l==c&&this.DG.order.vOrder[n]<this.DG.order.vOrder[e]){var h=n;n=e,e=h,l=c,c=this.DG.ranks[n]}var p=this.DG.positions[e],d=this.DG.positions[n],v=1,m=d<p,g=l==c?this._findBestRelationshipPosition(e,!1,n):this._findBestRelationshipPosition(e,m),y={};r.hasOwnProperty("placeholder")&&r.placeholder&&(y.childlessStatus="childless");var b=this._insertVertex(t.TYPE.RELATIONSHIP,y,v,e,null,l,g),w=this.DG.ranks[b]+1,E=this._findBestInsertPosition(w,b),S=this._insertVertex(t.TYPE.CHILDHUB,{},1,b,null,w,E),x=w+1,T=this._findBestInsertPosition(x,S),N=this._insertVertex(t.TYPE.PERSON,r,1,S,null,x,T);l==c?this.DG.GG.addEdge(n,b,v):this._addMultiRankEdge(n,b),this.DG.GG.validate(),this._heuristics.improvePositioning(s,u),this.updateAncestors(),this._debugPrintAll("after");var C=this._findMovedNodes(f,i,s,o,u,a),k=[b,N];return{"new":k,moved:C,highlight:[e,n,N]}},addTwin:function(e,n){var i=this.DG.positions.slice(0),s=this.DG.ranks.slice(0),o=this.DG.vertLevel.copy(),u=this.DG.rankY.slice(0),a=this.DG.GG.getMaxRealVertexId(),f=this.DG.GG.getProducingRelationship(e),l=this.DG.GG.getTwinGroupId(e);l===null&&(l=this.DG.GG.getUnusedTwinGroupId(f),console.log("new twin id: "+l),this.DG.GG.properties[e].twinGroup=l),n.twinGroup=l;var c=this.DG.ranks[e],h=this.DG.findBestTwinInsertPosition(e,[]),p=this.DG.GG.getInEdges(e)[0],d=this._insertVertex(t.TYPE.PERSON,n,1,p,null,c,h);this.DG.GG.validate(),this._heuristics.improvePositioning(s,u);var v=this._findMovedNodes(a,i,s,o,u);r.arrayContains(v,f)||v.push(f);var m=this.DG.GG.getInEdges(f).slice(0);m.push(e);var g=[d];return{"new":g,moved:v,animate:m}},convertPlaceholderTo:function(e,t){var n=this.DG.positions.slice(0),i=this.DG.ranks.slice(0),s=this.DG.vertLevel.copy(),o=this.DG.rankY.slice(0),u=this.DG.GG.getMaxRealVertexId();if(!this.isPlaceholder(e))throw"Attemp to access a non-paceholder node as a placeholder";t.hasOwnProperty("gender")||(t.gender="U"),this.setProperties(e,t),this._heuristics.improvePositioning(i,o);var a=this.getParentRelationship(e),f=[a],l=this.DG.ranks[e];for(var c=0;c<this.DG.order.order[l].length-1;c++){var h=this.DG.order.order[l][c];this.DG.GG.isRelationship(h)&&!r.arrayContains(f,h)&&f.push(h)}var p=this._findMovedNodes(u,n,i,s,o);return f=f.concat(p),f=r.filterUnique(f),r.removeFirstOccurrenceByValue(f,e),{removed:[e],"new":[e],moved:f}},removeNodes:function(e){this._debugPrintAll("before");var t=this.getMaxNodeId(),n=e.slice(0);n.sort();var r=[];for(var i=0;i<e.length;i++)if(this.isRelationship(e[i])){var s=this.DG.GG.getOutEdges(e[i])[0];e.push(s);var o=this.getPathToParents(e[i]);for(var u=0;u<o.length;u++)for(var a=0;a<o[u].length;a++)this.DG.GG.isVirtual(o[u][a])&&e.push(o[u][a])}e.sort(function(e,t){return e-t});var f={};for(var i=e.length-1;i>=0;i--){var l=e[i];this.DG.GG.remove(l),this.DG.order.remove(l,this.DG.ranks[l]),this.DG.ranks.splice(l,1),this.DG.positions.splice(l,1);for(var c=l+1;c<=t;c++)f.hasOwnProperty(c)?f[c]--:f[c]=c-1}this.DG.maxRank=Math.max.apply(null,this.DG.ranks),this.DG.GG.validate(),this.DG.vertLevel=this.DG.positionVertically(),this.updateAncestors();for(var i=0;i<=this.getMaxNodeId();i++)this.isRelationship(i)&&r.push(i);return{removed:n,changedIDSet:f,moved:r}},improvePosition:function(){var e=this.DG.positions.slice(0),t=this.DG.ranks.slice(0),n=this.DG.vertLevel.copy(),r=this.DG.rankY.slice(0),i=this.DG.GG.getMaxRealVertexId();this._heuristics.improvePositioning(t,r);var s=this._findMovedNodes(i,e,t,n,r);return{moved:s}},updateYPositioning:function(){var e=this.DG.positions,t=this.DG.ranks,n=this.DG.vertLevel,r=this.DG.rankY.slice(0),i=this.DG.GG.getMaxRealVertexId();this.DG.rankY=this.DG.computeRankY(t,r);var s=this._findMovedNodes(i,e,t,n,r,null,!0);return s.length==0?{}:{moved:s}},clearAll:function(){var e=this._getAllNodes(1),t=this.DG.GG.getNumVertices()==0,n=t?{}:this.getProperties(0),r=i.initFromPhenotipsInternal(this._onlyProbandGraph);return this._recreateUsingBaseGraph(r),this.setProperties(0,n),t?{"new":[0],makevisible:[0]}:{removed:e,moved:[0],makevisible:[0]}},redrawAll:function(e,t,n,i){var i=i?i:this.DG.ranks.slice(0);this._debugPrintAll("before");var s=this.DG.GG.makeGWithCollapsedMultiRankEdges(),o=r.clone2DArray(this.DG.order.order);for(var u=o.length-1;u>=0;u--)o[u]=o[u].filter(this.DG.GG.isPerson.bind(this.DG.GG)),o[u].length==0&&o.splice(u,1);if(!this._recreateUsingBaseGraph(s,o))return{};var a=this._getAllNodes(),f=i[0]-this.DG.ranks[0],l=[],c=[];for(var u=0;u<=this.DG.GG.getMaxRealVertexId();u++)this.DG.GG.isPerson(u)&&(this.DG.ranks[u]!=i[u]&&c.push(u),i[u]-this.DG.ranks[u]!=f&&l.push(u));l.length<c.length&&(c=l),t||(t=[]),e||(e=[]);if(!n)n=[];else for(var u=0;u<n.length;u++)r.removeFirstOccurrenceByValue(a,n[u]);return this._debugPrintAll("after"),{"new":n,moved:a,highlight:c,animate:t,removed:e}},stripUnusedProperties:function(){for(var e=0;e<=this.DG.GG.getMaxRealVertexId();e++)this.isPerson(e)&&(this.deleteEmptyProperty(e,"fName"),this.deleteEmptyProperty(e,"lName"),this.deleteEmptyProperty(e,"gestationAge"),this.deleteEmptyProperty(e,"carrierStatus"),this.deleteEmptyProperty(e,"comments"),this.deleteEmptyProperty(e,"disorders"))},deleteEmptyProperty:function(e,t){this.DG.GG.properties[e].hasOwnProperty(t)&&(Object.prototype.toString.call(this.DG.GG.properties[e][t])==="[object Array]"&&this.DG.GG.properties[e][t].length==0?delete this.DG.GG.properties[e][t]:this.DG.GG.properties[e][t]==""&&delete this.DG.GG.properties[e][t])},toJSONObject:function(){this.stripUnusedProperties();var e={};return e.GG=this.DG.GG.serialize(),e.ranks=this.DG.ranks,e.order=this.DG.order.serialize(),e.positions=this.DG.positions,console.log("JSON represenation: "+JSON.stringify(e)),e},fromJSONObject:function(e){var t=this._getAllNodes();this.DG.GG=i.initFromPhenotipsInternal(e.GG),this.DG.ranks=e.ranks,this.DG.maxRank=Math.max.apply(null,this.DG.ranks),this.DG.order.deserialize(e.order),this.DG.positions=e.positions,this._updateauxiliaryStructures(),this.screenRankShift=0;var n=this._getAllNodes();return{"new":n,removed:t}},fromImport:function(e,t,n){var r=this._getAllNodes();if(t=="ped"){var s=i.initFromPED(e,n.acceptUnknownPhenotypes,n.markEvaluated,n.externalIdMark);if(!this._recreateUsingBaseGraph(s))return null}else if(t=="BOADICEA"){var s=i.initFromBOADICEA(e,n.externalIdMark);if(!this._recreateUsingBaseGraph(s))return null}else if(t=="gedcom"){var s=i.initFromGEDCOM(e,n.markEvaluated,n.externalIdMark);if(!this._recreateUsingBaseGraph(s))return null}else if(t=="simpleJSON"){var s=i.initFromSimpleJSON(e);if(!this._recreateUsingBaseGraph(s))return null}else t=="phenotipsJSON";var o=this._getAllNodes();return{"new":o,removed:r}},getPathToParents:function(e){return this.DG.GG.getPathToParents(e)},_recreateUsingBaseGraph:function(e,t){try{var r=new n(e,this.DG.horizontalPersonSeparationDist,this.DG.horizontalRelSeparationDist,this.DG.maxInitOrderingBuckets,this.DG.maxOrderingIterations,this.DG.maxXcoordIterations,!1,t)}catch(i){return!1}return this.DG=r,this._heuristics=new Heuristics(this.DG),this._heuristics.improvePositioning(),!0},_insertVertex:function(e,t,n,r,i,s,o){if(r===null&&i===null)throw"Assertion failed: each node should be connected to at least one other node";if(r!==null&&i!==null)throw"Assertion failed: not clear which edge crossing to optimize, can only insert one edge";var u=r!==null?[r]:[],a=i!==null?[i]:[],f=this.DG.GG.insertVertex(e,t,n,u,a);if(s==0){for(var l=0;l<this.DG.ranks.length;l++)this.DG.ranks[l]++;this.DG.maxRank++,this.DG.order.insertRank(1),s=1}else s>this.DG.maxRank&&(this.DG.maxRank=s,this.DG.order.insertRank(s));this.DG.ranks.splice(f,0,s),this.DG.order.insertAndShiftAllIdsAboveVByOne(f,s,o),this.DG.positions.splice(f,0,-Infinity);var c=r!=null?r:i;return this._heuristics.moveToCorrectPositionAndMoveOtherNodesAsNecessary(f,c),f},_updateauxiliaryStructures:function(e,t){var n=new r.Timer;this.DG.vertLevel=this.DG.positionVertically(),this.DG.rankY=this.DG.computeRankY(e,t),this.updateAncestors(),n.printSinceLast("=== Vertical spacing + ancestors runtime: ")},_getAllNodes:function(e,n){var r=[],e=e?e:0,n=n?Math.min(n,this.DG.GG.getMaxRealVertexId()):this.DG.GG.getMaxRealVertexId();for(var i=e;i<=n;i++)(this.DG.GG.type[i]==t.TYPE.PERSON||this.DG.GG.type[i]==t.TYPE.RELATIONSHIP)&&r.push(i);return r},_findMovedNodes:function(e,n,i,s,o,u,a){var f=Math.min.apply(Math,n),l=Math.min.apply(Math,this.DG.positions);if(l>f){var c=r.arrayIndexOf(n,f);c>e&&(c+=this.DG.GG.getMaxRealVertexId()-e);var h=this.DG.positions[c],p=h-f;for(var d=0;d<this.DG.positions.length;d++)this.DG.positions[d]-=p}var v={};for(var d=0;d<=e;d++)if(this.DG.GG.type[d]==t.TYPE.RELATIONSHIP||this.DG.GG.type[d]==t.TYPE.PERSON){var m=this.DG.ranks[d];if(o&&this.DG.rankY[m]!=o[i[d]]){this._addNodeAndAssociatedRelationships(d,v,e);continue}if(this.DG.positions[d]!=n[d]){this._addNodeAndAssociatedRelationships(d,v,e);continue}if(this.DG.GG.type[d]==t.TYPE.RELATIONSHIP){if(u&&!u.hasOwnProperty(d)&&this.DG.consangr.hasOwnProperty(d)){v[d]=!0;continue}if(!a){var g=this.DG.GG.getInEdges(d);if(g[0]>this.DG.GG.maxRealVertexId||g[1]>this.DG.GG.maxRealVertexId){v[d]=!0;continue}}var y=this.DG.GG.getParents(d);if(s.outEdgeVerticalLevel[y[0]]!==undefined&&s.outEdgeVerticalLevel[y[1]]!==undefined)if(s.outEdgeVerticalLevel[y[0]][d].verticalLevel!=this.DG.vertLevel.outEdgeVerticalLevel[y[0]][d].verticalLevel||s.outEdgeVerticalLevel[y[1]][d].verticalLevel!=this.DG.vertLevel.outEdgeVerticalLevel[y[1]][d].verticalLevel){v[d]=!0;continue}var b=this.DG.GG.getRelationshipChildhub(d);if(s.childEdgeLevel[b]!==undefined&&s.childEdgeLevel[b]!=this.DG.vertLevel.childEdgeLevel[b]){v[d]=!0;continue}}}for(var d=this.DG.GG.getMaxRealVertexId()+1;d<=this.DG.GG.getNumVertices();d++){var m=this.DG.ranks[d];if(o&&o.length>=m&&this.DG.rankY[m]!=o[m]){var w=this.DG.GG.downTheChainUntilNonVirtual(d);w<=e&&(v[w]=!0)}}var E=[];for(var S in v)v.hasOwnProperty(S)&&E.push(parseInt(S));return E},_addNodeAndAssociatedRelationships:function(e,n,r){n[e]=!0;if(this.DG.GG.type[e]!=t.TYPE.PERSON)return;var i=this.DG.GG.getInEdges(e);if(i.length>0){var s=i[0],o=this.DG.GG.getInEdges(s)[0];o<=r&&(n[o]=!0)}var u=this.DG.GG.getOutEdges(e);for(var a=0;a<u.length;a++)u[a]<=r&&(n[u[a]]=!0)},_addMultiRankEdge:function(e,n,r){var i=r?r:1,s=this.DG.ranks[e],o=this.DG.ranks[n];if(s>o-2)throw"Assertion failed: attempt to make a multi-rank edge between non-multirank ranks";var u=this.DG.GG.getInEdges(n)[0],a=this.DG.order.vOrder[e],f=this.DG.order.vOrder[n],l=this.DG.positions[u],c=this.DG.positions[n],h=l<c?f+1:f,p=this._insertVertex(t.TYPE.VIRTUALEDGE,{},i,null,n,o,h),d=o;while(--d>s){var v=this.DG.positions[p],m=this.DG.order.order[d].length;for(var g=0;g<this.DG.order.order[d].length;g++)if(this.DG.positions[this.DG.order.order[d][g]]>=v){m=g;break}console.log("adding piece @ rank: "+d+" @ order "+m),p=this._insertVertex(t.TYPE.VIRTUALEDGE,{},i,null,p,d,m)}this.DG.GG.addEdge(e,p,i)},_findBestInsertPosition:function(e,n,r,i,s){if(e==0||e>this.DG.maxRank)return 0;var o=this.DG.ranks[n],u=this.DG.order.vOrder[n];if(o==e&&this.isPerson(n))return this._findBestRelationshipPosition(n,r);var a=0,f=Infinity,l=Infinity,c=!1;this.DG.GG.type[n]==t.TYPE.CHILDHUB&&(c=!0);var h=0,p=this.DG.positions[n];for(var d=0;d<this.DG.order.order[e].length;d++){var v=this.DG.order.order[e][d],m=this.DG.positions[v];if(!(m<p))break;h=d+1}this.DG.GG.type[n]==t.TYPE.CHILDHUB&&e>o&&this.DG.GG.getOutEdges(n).length>0&&(h=this._findRightmostChildPosition(n)+1);var g=i?Math.max(i,0):0,y=s?Math.min(s,this.DG.order.order[e].length):this.DG.order.order[e].length;for(var d=g;d<=y;d++){if(d>0&&d<this.DG.order.order[e].length){var b=d-1;while(b>0&&this.DG.GG.isVirtual(this.DG.order.order[e][b]))b--;rightNodePos=d;while(rightNodePos<this.DG.order.order[e].length-1&&this.DG.GG.isVirtual(this.DG.order.order[e][rightNodePos]))rightNodePos--;var w=this.DG.order.order[e][b],E=this.DG.order.order[e][rightNodePos];if(this.isPerson(w)&&this.isPerson(E)){var S=this.DG.GG.getProducingRelationship(w),x=this.DG.GG.getProducingRelationship(E);if(S==x){var T=this.DG.GG.getTwinGroupId(w),N=this.DG.GG.getTwinGroupId(E);if(T!==null&&T==N)continue}}}var C=this._edgeCrossingsByFutureEdge(e,d-.5,o,u,c,n);if(C<f||C==f&&Math.abs(d-h)<=l)a=d,f=C,l=Math.abs(d-h)}return a},_findRightmostChildPosition:function(e){var t=this._heuristics.analizeChildren(e);return t.rightMostChildOrder},_edgeCrossingsByFutureEdge:function(e,t,n,r,i,s){var o=Math.min(e,n),u=Math.max(e,n),a=e<n?t:r,f=e<n?r:t,l=undefined;if(this.DG.GG.isChildhub(s)&&e>n&&this.DG.GG.getOutEdges(s).length>0){l=this._heuristics.analizeChildren(s);if(l.numWithTwoPartners<l.orderedChildren.length){var c=!1;if(t>0){var h=this.DG.order.order[e][Math.floor(t)],p=this.DG.GG.getInEdges(h);p.length==1&&p[0]==s&&(c=!0)}if(t<this.DG.order.order[e].length-1){var d=this.DG.order.order[e][Math.ceil(t)],p=this.DG.GG.getInEdges(d);p.length==1&&p[0]==s&&(c=!0)}if(!c)return Infinity}}var v=0;if(o==u)throw"TODO: probably not needed";var m=this.DG.order.order[u];for(var g=0;g<m.length;g++){if(g==f)continue;var y=m[g],b=this.DG.GG.getInEdges(y),w=b.length;for(var E=0;E<w;E++){var S=b[E],x=1;if(i&&this.DG.GG.isChildhub(S)){x=1e5;if(l){var T=this._heuristics.analizeChildren(S);T.leftMostChildOrder<l.rightMostChildOrder&&T.rightMostChildOrder>l.leftMostChildOrder&&(x=1)}}var N=this.DG.order.vOrder[S],C=this.DG.ranks[S];if(C==u){if(g<f&&N>f||g>f&&N<f)v+=2}else if(g<f&&N>a||g>f&&N<a)v+=x}}var k=this.DG.order.order[e];for(var g=0;g<k.length;g++){if(g==t)continue;var y=k[g],L=this.DG.GG.getOutEdges(y),w=L.length;for(var E=0;E<w;E++){var S=L[E],N=this.DG.order.vOrder[S],C=this.DG.ranks[S];C==e&&(t<g&&t>N||t>g&&t<N)&&(v+=.1)}}return v},_findBestRelationshipPosition:function(e,t,n){var i=this.DG.ranks[e],s=this.DG.order.order[i],o=this.DG.GG.getTwinGroupId(e)!=null,u=this.DG.order.vOrder[e],a=[],f=[];for(var l=0;l<=s.length;l++)a[l]=0,f[l]=0;for(var l=0;l<s.length;l++){var c=s[l];if(!this.isRelationship(c))continue;var h=this._heuristics.analizeChildren(c);h.leftMostHasLParner&&(a[l]+=1,a[l-1]+=.25),h.rightMostHasRParner&&(a[l+1]+=1,a[l+2]+=.25)}for(var l=0;l<s.length;l++){var c=s[l];if(!this.isRelationship(c))continue;var p=this.DG.order.vOrder[c],d=this.DG.GG.getInEdges(c);for(var v=0;v<d.length;v++){var m=d[v];if(m!=e&&this.DG.ranks[m]==i&&m!=n){var g=this.DG.order.vOrder[m],y=g>p?p+1:g+1,b=g>p?g:p;for(var w=y;w<=b;w++)f[w]=Infinity}}}for(var l=0;l<s.length;l++){if(l==u)continue;var c=s[l];if(!this.isPerson(c))continue;var E=this.getAllTwinsSortedByOrder(c);if(E.length>1){var S=this.DG.order.vOrder[E[0]],x=this.DG.order.vOrder[E[E.length-1]];for(var w=S+1;w<=x;w++)f[w]=Infinity;l=x}if(this.DG.GG.getProducingRelationship(c)!=null)if(l<u)for(var w=0;w<=l;w++)f[w]++;else for(var w=l+1;w<=s.length;w++)f[w]++}console.log("Insertion same rank penalties: "+r.stringifyObject(f)),console.log("Insertion below penalties:     "+r.stringifyObject(a));if(n===undefined){if(t&&u==0)return 0;var T=this.DG._findLeftAndRightPartners(e),N=T.leftPartners.length,C=T.rightPartners.length;console.log("v: "+e+", vOrder: "+u+", numL: "+N+", numR: "+C);if(!o&&N==0&&(t||C>0))return u;if(!o&&C==0)return u+1;var k=u+1,L=Infinity;for(var l=0;l<=s.length;l++){var A=a[l]+f[l];l<=u?(A+=N+(u-l),t?A-=.5:A+=.5):A+=C+(l-u-1),A<L&&(L=A,k=l)}return k}if(this.DG.order.vOrder[e]>this.DG.order.vOrder[n]){var O=n;n=e,e=O}var M=this.DG.order.vOrder[e],_=this.DG.order.vOrder[n],D=this.DG._findLeftAndRightPartners(e),C=D.rightPartners.length,P=this.DG._findLeftAndRightPartners(n),N=P.leftPartners.length;if(C==0&&N>0)return M+1;if(C>0&&N==0)return _;var k=M+1,L=Infinity;for(var l=M+1;l<=_;l++){var A=a[l]+f[l];for(var v=0;v<D.rightPartners.length;v++){var H=D.rightPartners[v];l<=this.DG.order.vOrder[H]&&A++}for(var v=0;v<P.leftPartners.length;v++){var H=P.leftPartners[v];l>this.DG.order.vOrder[H]&&A++}A<=L&&(L=A,k=l)}return k},_getAllPersonsOfGenders:function(e,t){for(var n=0;n<e.length;n++){e[n]=e[n].toLowerCase();if(e[n]!="u"&&e[n]!="m"&&e[n]!="f")throw"Invalid gender: "+e[n]}var i=[];for(var n=0;n<=this.DG.GG.getMaxRealVertexId();n++){if(!this.isPerson(n))continue;if(this.isPersonGroup(n))continue;if(this.isPlaceholder(n))continue;if(t&&this.isAdoptedOut(n))continue;var s=this.getProperties(n).gender.toLowerCase();r.arrayContains(e,s)&&i.push(n)}return i}},Heuristics=function(e){this.DG=e},Heuristics.prototype={swapPartnerToBringToSideIfPossible:function(e){if(this.DG.GG.getTwinGroupId(e)!==null)return;var t=this.DG.ranks[e],n=this.DG.order.vOrder[e];if(n==0||n==this.DG.order.order[t].length-1)return;var r=this.DG.GG.getAllRelationships(e);if(r.length!=1)return;var i=r[0],s=this.DG.order.vOrder[i],o=this.DG.GG.getParents(i),u=o[0]==e?o[1]:o[0],a=this.DG.GG.getOutEdges(u);if(a.length!=1)return;if(this.DG.ranks[e]!=this.DG.ranks[u])return;var f=this.DG.order.vOrder[u];if(f!=n-2&&f!=n+2)return;if(this.DG.GG.getInEdges(e).length!=0&&this.DG.GG.getInEdges(u).length!=0)return;var l=this.DG.GG.getOutEdges(i)[0],c=this.DG.GG.getOutEdges(l);if(c.length==0)return;var h=n<f,p=this.analizeChildren(l);(h&&p.leftMostHasLParner&&!p.rightMostHasRParner||!h&&p.rightMostHasRParner&&!p.leftMostHasLParner||n==2&&p.rightMostHasRParner||n==this.DG.order.order[t].length-3&&p.leftMostHasLParner)&&this.swapPartners(e,u,i)},swapTwinsToBringToSideIfPossible:function(e){var t=this.DG.GG.getTwinGroupId(e);if(t===null)return},analizeChildren:function(e){this.DG.GG.isRelationship(e)&&(e=this.DG.GG.getOutEdges(e)[0]);if(!this.DG.GG.isChildhub(e))throw"Assertion failed: applying analizeChildren() not to a childhub";var t=this.DG.GG.getOutEdges(e);if(t.length==0)return;var n={},r=0,i=0,s=undefined,o=Infinity,u=!1,a=undefined,f=-Infinity,l=!1,c=!1;t.length==1&&this.DG.GG.isPlaceholder(t[0])&&(c=!0);for(var h=0;h<t.length;h++){var p=t[h],d=this.DG.order.vOrder[p];d<o&&(s=p,o=d,u=this.hasParnerBetweenOrders(p,0,d-1)),d>f&&(a=p,f=d,l=this.hasParnerBetweenOrders(p,d+1,Infinity)),this.DG.GG.getOutEdges(p).length>0&&(n[p]=!0,r++,this.DG.GG.getOutEdges(p).length>1&&i++)}var v=this.DG.order.sortByOrder(t);return{leftMostHasLParner:u,leftMostChildId:s,leftMostChildOrder:o,rightMostHasRParner:l,rightMostChildId:a,rightMostChildOrder:f,withPartnerSet:n,numWithPartners:r,numWithTwoPartners:i,orderedChildren:v,onlyPlaceholder:c}},hasParnerBetweenOrders:function(e,t,n){var r=this.DG.ranks[e],i=this.DG.order.vOrder[e],s=this.DG.GG.getOutEdges(e);for(var o=0;o<s.length;o++){var u=s[o],a=this.DG.ranks[u];if(a!=r)continue;var f=this.DG.order.vOrder[u];if(f>=t&&f<=n)return!0}return!1},swapPartners:function(e,t,n){var r=this.DG.ranks[e];if(this.DG.ranks[t]!=r||this.DG.ranks[n]!=r)throw"Assertion failed: swapping nodes of different ranks";var i=this.DG.order.vOrder[e],s=this.DG.order.vOrder[t],o=this.DG.order.vOrder[n];if(i>s){var u=i,a=e;i=s,e=t,s=u,t=a}if(i+1!=o||o+1!=s)return;this.DG.order.exchange(r,i,s);var f=this.DG.GG.getVertexWidth(e)-this.DG.GG.getVertexWidth(t),l=this.DG.positions[t];this.DG.positions[t]=this.DG.positions[e],this.DG.positions[e]=l-f,this.DG.positions[n]-=f},moveSiblingPlusPartnerToOrder:function(e,t,n,r){var i=this.DG.ranks[t],s=this.DG.order.vOrder[t],o=this.DG.order.vOrder[e],u=this.DG.order.vOrder[n],a=r-o,f=this.DG.positions[this.DG.order.order[i][r]]-this.DG.positions[e],l=r>o,c=l?this.DG.order.order[i][o+1]:this.DG.order.order[i][o-1],h=this.DG.positions[c]-this.DG.positions[t];this.DG.order.move(i,o,a),this.DG.order.move(i,u,a),this.DG.order.move(i,s,a),this.DG.positions[e]+=f,this.DG.positions[t]+=f,this.DG.positions[n]+=f;var p=l?s:r+3,d=l?r-3:s;for(var v=p;v<=d;v++){var m=this.DG.order.order[i][v];console.log("moving: "+m),this.DG.positions[m]-=h}},swapBeforeParentsToBringToSideIfPossible:function(e){var t=this.DG.GG.getAllRelationships(e);if(t.length!=1)return;var n=t[0],i=this.DG.GG.getParents(n),s=i[0]==e?i[1]:i[0];if(this.DG.GG.getInEdges(s).length==0)return;if(this.DG.ranks[e]!=this.DG.ranks[s])return;if(this.DG.GG.getOutEdges(s).length>1)return;var o=this.DG.order.vOrder[e],u=this.DG.order.vOrder[s];if(u!=o-2&&u!=o+2)return;var a=o<u,f=this.DG.GG.getInEdges(s)[0],l=this.analizeChildren(f);if(l.orderedChildren.length>1){if(l.leftMostChildId==s){a||this.swapPartners(e,s,n);return}if(l.rightMostChildId==s){a&&this.swapPartners(e,s,n);return}}var c=this.DG.GG.getInEdges(this.DG.GG.getInEdges(f)[0]),h=this.DG.order.vOrder[c[0]],p=this.DG.order.vOrder[c[1]],d=h>p?c[1]:c[0],v=h>p?c[0]:c[1];console.log("parents: "+r.stringifyObject(c));var m=this.DG.GG.getOutEdges(d).length,g=this.DG.GG.getOutEdges(v).length;console.log("num left: "+m+", numRight: "+g);if(m>1&&g>1)return;if(l.orderedChildren.length==1){if(m==1&&g==1)return;m==1&&!a&&this.swapPartners(e,s,n),g==1&&a&&this.swapPartners(e,s,n);return}var y=this.DG.GG.getRelationshipChildhub(n),b=this.analizeChildren(y);if(b.numWithPartners>0)return;if(g==1&&!l.rightMostHasRParner)for(var w=l.orderedChildren.length-1;w>=0;w--){var E=l.orderedChildren[w];if(E==s){a&&this.swapPartners(e,s,n),this.moveSiblingPlusPartnerToOrder(e,s,n,l.rightMostChildOrder);return}if(l.withPartnerSet.hasOwnProperty(E))break}if(m==1&&!l.leftMostHasLParner)for(var w=0;w<l.orderedChildren.length;w++){var E=l.orderedChildren[w];if(E==s){a||this.swapPartners(e,s,n),this.moveSiblingPlusPartnerToOrder(e,s,n,l.leftMostChildOrder);return}if(l.withPartnerSet.hasOwnProperty(E))break}},improvePositioning:function(e,n){var i=new r.Timer,s=!1;for(var o=0;o<=this.DG.GG.getMaxRealVertexId();o++){if(!this.DG.GG.isPerson(o))continue;var u=this.DG.ranks[o],a=this.DG.order.vOrder[o],f=this.DG.GG.getOutEdges(o),l=0,c=0,h=[];for(var p=0;p<f.length;p++){var d=f[p];this.DG.ranks[d]!=u?h.push(d):this.DG.order.vOrder[d]<a?l++:c++}if(h.length==0)continue;var v=this;byXcoord=function(e,t){var n=v.DG.GG.downTheChainUntilNonVirtual(e),r=v.DG.GG.downTheChainUntilNonVirtual(t),i=v.DG.positions[n],s=v.DG.positions[r],u=v.DG.positions[o];return i>=u&&s>=u?s-i:i-s},h.sort(byXcoord),console.log("multi-rank edges: "+r.stringifyObject(h));for(var m=0;m<h.length;m++){var g=h[m],y=this.DG.GG.downTheChainUntilNonVirtual(g),b=this.DG.GG.removeEdge(o,g),w=this.DG.GG.insertVertex(t.TYPE.VIRTUALEDGE,{},b,[o],[g]);this.DG.ranks.splice(w,0,u);var E=this.DG.positions[y]<this.DG.positions[o]?!1:!0;this.DG.positions[y]==this.DG.positions[o]&&c>0&&l==0&&h.length==1&&(E=!1);var S=this.DG.order.vOrder[o],x=E?S+1:S;if(E){while(x<this.DG.order.order[u].length&&this.DG.positions[g]>this.DG.positions[this.DG.order.order[u][x]])x++;var T=this.DG.order.order[u][x-1],N=this.DG.order.order[u][x];this.DG.GG.isRelationship(T)&&this.DG.GG.isPerson(N)&&this.DG.GG.hasEdge(N,T)&&this.DG.GG.getOutEdges(N).length==1&&x++,this.DG.GG.isRelationship(N)&&this.DG.GG.isPerson(T)&&this.DG.GG.hasEdge(T,N)&&this.DG.GG.getOutEdges(T).length==1&&x--}else{while(x>0&&this.DG.positions[g]<this.DG.positions[this.DG.order.order[u][x-1]])x--;var T=this.DG.order.order[u][x-1],N=this.DG.order.order[u][x];this.DG.GG.isRelationship(N)&&this.DG.GG.isPerson(T)&&this.DG.GG.hasEdge(T,N)&&this.DG.GG.getOutEdges(T).length==1&&x--,this.DG.GG.isRelationship(T)&&this.DG.GG.isPerson(N)&&this.DG.GG.hasEdge(N,T)&&this.DG.GG.getOutEdges(N).length==1&&x++}this.DG.order.insertAndShiftAllIdsAboveVByOne(w,u,x),this.DG.positions.splice(w,0,-Infinity);var C=g;this.moveToCorrectPositionAndMoveOtherNodesAsNecessary(w,C),s=!0}}this.optimizeLongEdgePlacement(),i.printSinceLast("=== Long edge handling runtime: ");var k=new XCoord(this.DG.positions,this.DG);for(var L=0;L<=this.DG.GG.getMaxRealVertexId();L++){if(!this.DG.GG.isRelationship(L))continue;var A=this.DG.GG.getRelationshipChildhub(L),O=k.xcoord[L],M=k.xcoord[A];M!=O&&(j=k.moveNodeAsCloseToXAsPossible(A,O))}for(var L=0;L<=this.DG.GG.getMaxRealVertexId();L++){if(!this.DG.GG.isChildhub(L))continue;var _=this.DG.GG.getOutEdges(L);if(_.length<2)continue;var D=this.DG.order.sortByOrder(_);for(var p=D.length-1;p>=0;p--)if(p==0||this.DG.GG.getOutEdges(D[p]).length>0){for(var P=p+1;P<D.length;P++)k.shiftLeftOneVertex(D[P],Infinity);break}for(var p=0;p<D.length;p++)if(p==D.length-1||this.DG.GG.getOutEdges(D[p]).length>0){for(var P=p-1;P>=0;P--)k.shiftRightOneVertex(D[P],Infinity);break}}this._compactGraph(k,5);var H=this.DG.order.getLeftToRightTopToBottomOrdering(t.TYPE.RELATIONSHIP,this.DG.GG),B=0,j=!0;while(j&&B<20){j=!1,B++;for(var F=0;F<H.length;F++){var L=H[F],I=this.DG.GG.getInEdges(L),A=this.DG.GG.getRelationshipChildhub(L),O=k.xcoord[L],M=k.xcoord[A],q=this.analizeChildren(A),R=0;if(q.orderedChildren.length==1){var U=q.orderedChildren[0];if(k.xcoord[U]==M)continue;j=k.moveNodeAsCloseToXAsPossible(U,M);if(k.xcoord[U]==M)continue;R=k.xcoord[U]-M}else{var z=this._computeDesiredChildhubLocation(q,k);if(z.minPreferred<=M&&M<=z.maxPreferred)continue;var W=M>z.maxPreferred?z.maxPreferred:z.minPreferred,X=M-W;if(q.numWithPartners==0)if(X<0){var V=q.leftMostChildId,$=k.getSlackOnTheLeft(V),J=Math.min(Math.abs(X),$);if(J>0){for(var p=0;p<q.orderedChildren.length;p++)k.xcoord[q.orderedChildren[p]]-=J;j=!0,X+=J}}else{var K=q.rightMostChildId,Q=k.getSlackOnTheRight(K),J=Math.min(X,Q);if(J>0){for(var p=0;p<q.orderedChildren.length;p++)k.xcoord[q.orderedChildren[p]]+=J;j=!0,X-=J}}R=-X}if(R==0)continue;var G=k.xcoord[I[0]]<k.xcoord[I[1]]?I[0]:I[1],Y=k.xcoord[I[0]]<k.xcoord[I[1]]?I[1]:I[0],Z=[L,A];this.DG.order.vOrder[G]==this.DG.order.vOrder[L]-1&&!this.DG.GG.isVirtual(G)&&(R>0||k.getSlackOnTheLeft(L)<-R)&&Z.unshift(G),this.DG.order.vOrder[Y]==this.DG.order.vOrder[L]+1&&!this.DG.GG.isVirtual(Y)&&(R<0||k.getSlackOnTheRight(L)<R)&&Z.push(Y);var et={};et[L]=!0;var tt=this._findAffectedSet(Z,{},et,r.toObjectWithTrue(Z),r.toObjectWithTrue(q.orderedChildren),R,k,!0,!1,7,3),Z=q.orderedChildren,nt=[L,A],rt=this._findAffectedSet(Z,{},r.toObjectWithTrue(q.orderedChildren),{},r.toObjectWithTrue(nt),-R,k,!0,!1,7,3),it=this._isShiftSizeAcceptable(tt,!1,7,3),st=this._isShiftSizeAcceptable(rt,!1,7,3);if(it||st){j=!0;if(it&&(!st||this._isShiftBetter(tt,rt))){var ot=tt.nodes;for(var p=0;p<ot.length;p++)k.xcoord[ot[p]]+=R}else{var ot=rt.nodes;for(var p=0;p<ot.length;p++)k.xcoord[ot[p]]-=R}continue}if(R<0){var ut=this.DG.order.vOrder[G]==this.DG.order.vOrder[L]-1?G:L,at=Math.max(-k.getSlackOnTheLeft(ut),R);if(at==0||at==R)continue}else{var ft=this.DG.order.vOrder[Y]==this.DG.order.vOrder[L]+1?Y:L,at=Math.min(k.getSlackOnTheLeft(ft),R);if(at==0||at==R)continue}var Z=[L,A];this.DG.order.vOrder[G]==this.DG.order.vOrder[L]-1&&!this.DG.GG.isVirtual(G)&&Z.unshift(G),this.DG.order.vOrder[Y]==this.DG.order.vOrder[L]+1&&!this.DG.GG.isVirtual(Y)&&Z.push(Y);var et={};et[L]=!0;var tt=this._findAffectedSet(Z,{},et,r.toObjectWithTrue(Z),r.toObjectWithTrue(q.orderedChildren),at,k,!0,!1,3,2);if(this._isShiftSizeAcceptable(tt,!1,3,2)){var ot=tt.nodes;for(var p=0;p<ot.length;p++)k.xcoord[ot[p]]+=at;continue}}}this._compactGraph(k);var B=0,j=!0;while(j&&B<20){j=!1,B++;for(var F=0;F<H.length;F++){var L=H[F],I=this.DG.GG.getInEdges(L),lt=this.DG.order.sortByOrder(I);if(Math.abs(this.DG.order.vOrder[I[0]]-this.DG.order.vOrder[I[1]])!=2)continue;var ct=k.getRightEdge(lt[0]),ht=k.getLeftEdge(lt[1]),O=k.xcoord[L],pt=Math.floor((ct+ht)/2);if(O==pt)continue;var A=this.DG.GG.getRelationshipChildhub(L),dt=pt-O,Z=[L,A],et={};et[L]=!0;var vt=this._findAffectedSet(Z,{},et,{},{},dt,k,!0,!1,5,3,this.DG.ranks[L]);if(this._isShiftSizeAcceptable(vt,!1,5,3)&&vt.minAffectedRank>this.DG.ranks[L]){var ot=vt.nodes;for(var p=0;p<ot.length;p++)k.xcoord[ot[p]]+=dt;j=!0}}}this.DG.positions=k.xcoord,i.printSinceLast("=== Improvement runtime: "),this.DG.vertLevel=this.DG.positionVertically(),this.DG.rankY=this.DG.computeRankY(e,n),i.printSinceLast("=== Vertical spacing runtime: ")},_compactGraph:function(e,t){t||(t=Infinity);var n=0,i=!0;while(i&&n<20){i=!1,n++;for(var s=1;s<this.DG.order.order.length;s++)for(var o=0;o<this.DG.order.order[s].length-1;o++){var u=this.DG.order.order[s][o];if(this.DG.GG.isChildhub(u))break;var a=e.getSlackOnTheRight(u);if(a==0)continue;var f=this.DG,l=function(e,t){if(f.ranks[e]==s&&f.ranks[t]==s){var n=f.order.vOrder[e],r=f.order.vOrder[t];if(n<=o&&r>o||r<=o&&n>o)return!1}return!0},c=this.DG.order.order[s][o+1],h={};h[c]=!0;var p=this.DG.findConnectedComponent(u,l,h,t),d=!0;if(p.stopSetReached)continue;if(p.size>t){p=this.DG.findConnectedComponent(c,l,{},t);if(p.size>t)continue;d=!1}a=d?e.findVertexSetSlacks(p.component).rightSlack:-e.findVertexSetSlacks(p.component).leftSlack;if(a==0)continue;console.log("Moving: "+r.stringifyObject(p.component)+" by "+a),i=!0;for(var v in p.component)p.component.hasOwnProperty(v)&&(e.xcoord[v]+=a)}if(!isFinite(t))for(var s=1;s<this.DG.order.order.length;s++)for(var o=0;o<this.DG.order.order[s].length;o++){var u=this.DG.order.order[s][o];if(this.DG.GG.isPerson(u))break;if(this.DG.GG.isRelationship(u))break;if(!this.DG.GG.isChildhub(u))continue;var m=e.xcoord[u],g=this.analizeChildren(u),y=this._computeDesiredChildhubLocation(g,e);if(m>=y.leftX&&m<=y.rightX)continue;var b=m>y.maxPreferred?y.maxPreferred-m:y.minPreferred-m,w=function(e,t){return e==u?!1:!0},h=r.toObjectWithTrue(this.DG.GG.getOutEdges(u)),p=this.DG.findConnectedComponent(u,w,h,Infinity);if(p.stopSetReached)continue;var a=b>0?Math.min(b,e.findVertexSetSlacks(p.component).rightSlack):Math.max(b,-e.findVertexSetSlacks(p.component).leftSlack);if(a==0)continue;console.log("Moving chhub: "+r.stringifyObject(p.component)+" by "+a),i=!0;for(var v in p.component)p.component.hasOwnProperty(v)&&(e.xcoord[v]+=a)}}},_findAffectedSet:function(e,t,n,i,s,o,u,a,f,l,c,h){var p=r.toObjectWithTrue(e),d=r.toObjectWithTrue(e);if(f){for(var v=0;v<e.length;v++)n[e[v]]=!0,i[e[v]]=!0;for(var m in t)if(t.hasOwnProperty(m)){var g=this.DG.ranks[m],y=this.DG.order.vOrder[m],b=o>0?0:y+1,w=o>0?y:this.DG.order.order[g].length;for(var v=b;v<w;v++){var E=this.DG.order.order[g][v];t[E]=!0,n[E]=!0,i[E]=!0}}}var S=0,x=0,T=0,N=Infinity,C=!1,k=new Queue;k.setTo(e);while(k.size()>0){if(l&&S>l)break;if(c&&x>c)break;var L=k.pop();if(s&&s.hasOwnProperty(L)){C=!0;break}if(o>0){var A=u.getSlackOnTheRight(L);if(A<o){var O=this.DG.order.getRightNeighbour(L,this.DG.ranks[L]);p.hasOwnProperty(O)||(p[O]=!0,k.push(O))}}else{var A=u.getSlackOnTheLeft(L);if(A<-o){var M=this.DG.order.getLeftNeighbour(L,this.DG.ranks[L]);p.hasOwnProperty(M)||(p[M]=!0,k.push(M))}}if(n.hasOwnProperty(L)&&i.hasOwnProperty(L))continue;if(this.DG.ranks[L]<N&&!d.hasOwnProperty(L)){N=this.DG.ranks[L];if(h&&N<h)break}if(this.DG.GG.isRelationship(L)){d.hasOwnProperty(L)||x++;var _=this.DG.GG.getOutEdges(L)[0];p.hasOwnProperty(_)||(p[_]=!0,k.push(_));if(f||n.hasOwnProperty(L))continue;var D=this.DG.GG.getInEdges(L);for(var v=0;v<D.length;v++)!t.hasOwnProperty(D[v])&&!p.hasOwnProperty(D[v])&&(this.DG.order.vOrder[D[v]]==this.DG.order.vOrder[L]+1&&o<0||this.DG.order.vOrder[D[v]]==this.DG.order.vOrder[L]-1&&o>0)&&(p[D[v]]=!0,k.push(D[v]))}else if(this.DG.GG.isChildhub(L)){var P=this.DG.GG.getInEdges(L)[0];p.hasOwnProperty(P)||(p[P]=!0,k.push(P));if(f||i.hasOwnProperty(L))continue;var H=this.analizeChildren(L),B=this._computeDesiredChildhubLocation(H,u,p,o),j=u.xcoord[L],F=j+o;if(F==B.minPreferredWithShift||F==B.maxPreferredWithShift)continue;if(j<B.minPreferredWithShift&&o>0&&F<B.minPreferredWithShift)continue;if(j>B.maxPreferredWithShift&&o<0&&F>B.maxPreferredWithShift)continue;var I=this.DG.GG.getOutEdges(L);for(var q=0;q<I.length;q++)!t.hasOwnProperty(I[q])&&!p.hasOwnProperty(I[q])&&(p[I[q]]=!0,k.push(I[q]))}else if(this.DG.GG.isPerson(L)){!d.hasOwnProperty(L)&&!this.DG.GG.isPlaceholder(L)&&S++;if(!i.hasOwnProperty(L)){var R=this.DG.GG.getOutEdges(L);for(var q=0;q<R.length;q++)!t.hasOwnProperty(R[q])&&!p.hasOwnProperty(R[q])&&(this.DG.order.vOrder[R[q]]==this.DG.order.vOrder[L]+1&&o<0||this.DG.order.vOrder[R[q]]==this.DG.order.vOrder[L]-1&&o>0)&&(o>0&&u.getSlackOnTheLeft(L)==0||o<0&&u.getSlackOnTheRight(L)==0)&&(p[R[q]]=!0,k.push(R[q]))}var U=this.DG.GG.getAllTwinsOf(L);if(U.length>1)for(var z=0;z<U.length;z++){var W=U[z];if(t.hasOwnProperty(W)||p.hasOwnProperty(W))continue;k.push(W)}if(n.hasOwnProperty(L))continue;var X=this.DG.GG.getInEdges(L);if(X.length>0){var _=X[0];if(t.hasOwnProperty(_)||p.hasOwnProperty(_))continue;var H=this.analizeChildren(_),B=this._computeDesiredChildhubLocation(H,u,p,o),j=u.xcoord[_];if(j==B.minPreferredWithShift||j==B.maxPreferredWithShift)continue;if(j<B.minPreferred&&o<0&&j<B.minPreferredWithShift)continue;if(j>B.maxPreferred&&o>0&&j>B.maxPreferredWithShift)continue;p[_]=!0,k.push(_)}}else if(this.DG.GG.isVirtual(L)){d.hasOwnProperty(L)||T++;if(a&&T>0)break;if(!n.hasOwnProperty(L)){var V=this.DG.GG.getInEdges(L)[0];!this.DG.GG.isPerson(V)&&!p.hasOwnProperty(V)&&!t.hasOwnProperty(V)&&(p[V]=!0,k.push(V))}if(!i.hasOwnProperty(L)){var $=this.DG.GG.getOutEdges(L)[0];!this.DG.GG.isRelationship($)&&!p.hasOwnProperty($)&&!t.hasOwnProperty($)&&(p[$]=!0,k.push($))}}}var J=[];for(var m in p)p.hasOwnProperty(m)&&J.push(m);return{nodes:J,numPersons:S,numRelationships:x,numVirtual:T,minAffectedRank:N,forbiddenMoved:C}},_computeDesiredChildhubLocation:function(e,t,n,r){var i=e.leftMostChildId,s=e.rightMostChildId,o=t.xcoord[i],u=t.xcoord[s],a=(o+u)/2,f=e.orderedChildren.length==3?t.xcoord[e.orderedChildren[1]]:a,l=Math.min(a,f),c=Math.max(a,f),h={leftX:o,rightX:u,middle:a,median:f,minPreferred:l,maxPreferred:c};if(n){var p=o+(n.hasOwnProperty(i)?r:0),d=u+(n.hasOwnProperty(s)?r:0),v=(p+d)/2,m=e.orderedChildren.length==3?t.xcoord[e.orderedChildren[1]]+(n.hasOwnProperty(e.orderedChildren[1])?r:0):v,g=Math.min(v,m),y=Math.max(v,m);h.minPreferredWithShift=g,h.maxPreferredWithShift=y}return h},optimizeLongEdgePlacement:function(){var e=new XCoord(this.DG.positions,this.DG),t=this.DG.find_long_edges();this.DG.try_straighten_long_edges(t,e);var n=this.straighten_long_edges(t,e);this.DG.try_straighten_long_edges(n,e),this.DG.positions=e.xcoord},straighten_long_edges:function(e,t){var n=[];for(var i=0;i<e.length;i++){var s=e[i];do{var o=!1,u=t.xcoord[s[0]];for(var a=1;a<s.length;a++){var f=s[a],l=t.xcoord[f];if(l!=u){var c=s.slice(0,a),h=s.slice(a),p=l-u,d=r.toObjectWithTrue(h),v=this._findAffectedSet(c,d,{},{},{},p,t,!0,!0,5,3),m=u-l,d=r.toObjectWithTrue(c),g=this._findAffectedSet(h,d,{},{},{},m,t,!0,!0,5,3);if(!this._isShiftSizeAcceptable(v,!1,5,3)&&!this._isShiftSizeAcceptable(g,!1,5,3)){n.push(s);break}o=!0;if(this._isShiftBetter(g,v)){var y=g.nodes;for(var a=0;a<y.length;a++)t.xcoord[y[a]]+=m}else{var y=v.nodes;for(var a=0;a<y.length;a++)t.xcoord[y[a]]+=p}break}}}while(o)}return n},_isShiftSizeAcceptable:function(e,t,n,r){return e.forbiddenMoved?!1:!t&&e.numVirtual>0?!1:e.numPersons>n?!1:e.numRelationships>r?!1:!0},_isShiftBetter:function(e,t){return t.numVirtual>e.numVirtual?!0:t.numVirtual<e.numVirtual?!1:t.numPersons>e.numPersons?!0:t.numPersons<e.numPersons?!1:t.numRelationships>e.numRelationships?!0:!1},moveToCorrectPositionAndMoveOtherNodesAsNecessary:function(e,n){console.log("========== PLACING "+e);var r=this.DG.ranks[e],i=new XCoord(this.DG.positions,this.DG),s=i.getLeftMostNoDisturbPosition(e),o=i.getRightMostNoDisturbPosition(e),u=this.DG.positions[n];n!=e&&(this.DG.ranks[n]==r?this.DG.order.vOrder[e]>this.DG.order.vOrder[n]?u=i.getRightEdge(n)+i.getSeparation(e,n)+i.halfWidth[e]:(u=i.getLeftEdge(n)-i.getSeparation(e,n)-i.halfWidth[e],u>o&&(u=o)):this.DG.GG.isPerson(e)&&u>o&&(u=o));var a=u<s?s:u;i.xcoord[e]=a;var f=0;a>u&&(f=a-u);var l=new Queue;l.push([e,f]);var c=0,h=0,p={},d=this.DG.GG.getAllAncestors(e);for(var v in d){p[v]=!0;var m=this.DG.ranks[v],g=this.DG.order.vOrder[v];for(var y=0;y<g;y++){var b=this.DG.order.order[m][y];p[b]=!0}}var w={};while(l.size()>0&&c<5){c++;var E={},S=this.DG.ranks.length,x=S*5;while(l.size()>0&&h<x){h++;var T=l.pop(),N=T[0];f=T[1];var C=this.DG.GG.type[N],k=this.DG.ranks[N],L=this.DG.order.vOrder[N],A=i.xcoord[N],O=i.getRightMostNoDisturbPosition(N);if(A>O){var M=this.DG.order.order[k][L+1],_=A-O;i.xcoord[M]+=_,w[M]=w.hasOwnProperty(M)?w[M]+_:_,l.push([M,_])}if(N==e&&C!=t.TYPE.VIRTUALEDGE)continue;var D=this.DG.GG.getInEdges(N),P=this.DG.GG.getOutEdges(N),H=!1;(C==t.TYPE.PERSON||C==t.TYPE.VIRTUALEDGE)&&N==e&&(H=!0);if(C==t.TYPE.VIRTUALEDGE){var B=D[0];this.DG.ranks[B]==k&&(H=!0)}if(C==t.TYPE.RELATIONSHIP){H=!0;if(D.length==2){var j=D[0],F=D[1],I=this.DG.order.vOrder[j],q=this.DG.order.vOrder[F];if(I==L-1&&this.DG.GG.getOutEdges(j).length==1&&this.DG.GG.getInEdges(j).length==0&&!p.hasOwnProperty(j)){if(!w.hasOwnProperty(j)||w[j]<w[N])i.xcoord[j]+=f,w[j]=w.hasOwnProperty(j)?w[j]+f:f}else q==L-1&&this.DG.GG.getOutEdges(F).length==1&&this.DG.GG.getInEdges(F).length==0&&!p.hasOwnProperty(F)&&(!w.hasOwnProperty(F)||w[F]<w[N])&&(i.xcoord[F]+=f,w[F]=w.hasOwnProperty(F)?w[F]+f:f)}}if(!H)for(var y=0;y<D.length;y++){var b=D[y],R=this.DG.GG.type[b];if(p.hasOwnProperty(b))continue;if(w.hasOwnProperty(b)&&w[b]>=w[N])continue;if(C==t.TYPE.PERSON&&R==t.TYPE.CHILDHUB){E.hasOwnProperty(b)?E[b]++:E[b]=1;continue}if(R==t.TYPE.VIRTUALEDGE&&i.xcoord[b]==i.xcoord[N])continue;var U=w.hasOwnProperty(b)?Math.min(f,Math.max(w[N]-w[b],0)):f;i.xcoord[b]+=U,w[b]=w.hasOwnProperty(b)?w[b]+U:U,l.push([b,U])}if(C==t.TYPE.CHILDHUB){var z=0;for(var y=0;y<P.length;y++){var b=P[y],W=i.xcoord[b];W>z&&(z=W)}if(z>=i.xcoord[N])continue}for(var y=0;y<P.length;y++){var b=P[y],U=w.hasOwnProperty(b)?Math.min(f,Math.max(w[N]-w[b],0)):f;if(p.hasOwnProperty(b))continue;if(w.hasOwnProperty(b)&&w[b]>=w[N])continue;if(this.DG.ranks[b]==k)continue;if(C==t.TYPE.RELATIONSHIP||C==t.TYPE.VIRTUALEDGE){var X=i.xcoord[N]-i.xcoord[b];if(X<=0)continue;X<U&&(U=X)}i.xcoord[b]+=U,w[b]=w.hasOwnProperty(b)?w[b]+U:U,l.push([b,U])}}for(var V in E)if(E.hasOwnProperty(V)){V=parseInt(V);if(p.hasOwnProperty(V))continue;var $=this.DG.GG.getOutEdges(V);if($.length>0&&$.length==E[V]){var J=Infinity;for(var K=0;K<$.length;K++)w[$[K]]<J&&(J=w[$[K]]);if(w.hasOwnProperty(V)){if(w[V]>J)continue;J-=w[V]}i.xcoord[V]+=J,w[V]=w.hasOwnProperty(V)?w[V]+J:J,l.push([V,J])}}}this.DG.positions=i.xcoord,console.log("PLACED/MOVED: "+e+" @ position "+this.DG.positions[e])}},DynamicPositionedGraph}),define("pedigree/view/workspace",[],function(){var e=Class.create({initialize:function(){var e=this;this.canvas=new Element("div",{id:"canvas"}),this.workArea=(new Element("div",{id:"work-area"})).update(this.canvas),$("body").update(this.workArea);var t=document.viewport.getDimensions();this.generateTopMenu(),this.width=t.width,this.height=t.height-this.canvas.cumulativeOffset().top-4,this._paper=Raphael("canvas",this.width,this.height),this.viewBoxX=0,this.viewBoxY=0,this.zoomCoefficient=1,this.background=this.getPaper().rect(0,0,this.width,this.height).attr({fill:"blue",stroke:"none",opacity:0}).toBack(),this.background.node.setAttribute("class","panning-background"),this.adjustSizeToScreen=this.adjustSizeToScreen.bind(this),Event.observe(window,"resize",e.adjustSizeToScreen),this.generateViewControls();var n=function(){if(editor.isAnyMenuVisible())return;e.background.ox=e.background.attr("x"),e.background.oy=e.background.attr("y"),e.background.attr({cursor:"move"})},r=function(t,n){var r=e.viewBoxX-t/e.zoomCoefficient,i=e.viewBoxY-n/e.zoomCoefficient;e.getPaper().setViewBox(r,i,e.width/e.zoomCoefficient,e.height/e.zoomCoefficient),e.background.ox=r,e.background.oy=i,e.background.attr({x:r,y:i})},i=function(){e.viewBoxX=e.background.ox,e.viewBoxY=e.background.oy,e.background.attr({cursor:"default"})};e.background.drag(r,n,i),document.addEventListener&&(e.handleMouseWheel=function(e){e.preventDefault?e.preventDefault():e.returnValue=!1;if(editor.isAnyMenuVisible())return;var t;e.wheelDelta?t=-e.wheelDelta:t=e.detail;if(t>0){var n=$$(".zoom-out")[0];$$(".zoom-out")[0].click()}else $$(".zoom-in")[0].click()},navigator.userAgent.toLowerCase().indexOf("webkit")>=0?this.canvas.addEventListener("mousewheel",e.handleMouseWheel,!1):this.canvas.addEventListener("DOMMouseScroll",e.handleMouseWheel,!1))},getPaper:function(){return this._paper},getWorkArea:function(){return this.workArea},getWidth:function(){return this.width},getHeight:function(){return this.height},generateTopMenu:function(){var e=new Element("div",{id:"editor-menu"});this.getWorkArea().insert({before:e});var t=[];editor.isUnsupportedBrowser()?t=[{name:"input",items:[{key:"readonlymessage",label:"Unsuported browser mode",icon:"exclamation-triangle"}]},{name:"output",items:[{key:"export",label:"Export",icon:"download"},{key:"reload",label:"Reload",icon:"refresh"},{key:"close",label:"Close",icon:"sign-out"}]}]:t=[{name:"input",items:[{key:"templates",label:"Templates",icon:"copy"},{key:"import",label:"Import",icon:"upload"}]},{name:"edit",items:[{key:"undo",label:"Undo",icon:"undo"},{key:"redo",label:"Redo",icon:"repeat"},{key:"layout",label:"Automatic layout",icon:"sitemap"},{key:"number",label:"Renumber",icon:"sort-numeric-asc"}]},{name:"reset",items:[{key:"clear",label:"Clear all",icon:"times-circle"},{key:"reload",label:"Reload",icon:"refresh"}]},{name:"output",items:[{key:"save",label:"Save",icon:"check"},{key:"export",label:"Export",icon:"download"},{key:"close",label:"Close",icon:"sign-out"}]}];var n=function(t){var n=new Element("div",{"class":t.name+"-actions action-group"});e.insert(n),t.items.each(function(e){n.insert(r(e))})},r=function(e){var t=(new Element("span",{id:"action-"+e.key,"class":"field-no-user-select menu-item "+e.key})).insert(new Element("span",{"class":"fa fa-"+e.icon})).insert(" ").insert(e.label);return e.callback&&typeof this[e.callback]=="function"&&t.observe("click",function(){this[e.callback]()}),t};t.each(n)},zoom:function(e){e<.15&&(e=.15),e>.15&&e<.25&&(e=.25),e=Math.round(e/.05)/20;var t=this.width/e,n=this.height/e;this.viewBoxX=this.viewBoxX+(this.width/this.zoomCoefficient-t)/2,this.viewBoxY=this.viewBoxY+(this.height/this.zoomCoefficient-n)/2,this.getPaper().setViewBox(this.viewBoxX,this.viewBoxY,t,n),this.zoomCoefficient=e,this.background.attr({x:this.viewBoxX,y:this.viewBoxY,width:t,height:n})},generateViewControls:function(){var e=this;this.__controls=new Element("div",{"class":"view-controls"}),this.__pan=new Element("div",{"class":"view-controls-pan",title:"Pan"}),this.__controls.insert(this.__pan),["up","right","down","left","home"].each(function(t){var n=t=="home"?"fa-user":"fa-arrow-"+t;e.__pan[t]=new Element("span",{"class":"view-control-pan pan-"+t+" fa fa-fw "+n,title:"Pan "+t}),e.__pan.insert(e.__pan[t]),e.__pan[t].observe("click",function(n){t=="home"?e.centerAroundNode(0):t=="up"?e.panTo(e.viewBoxX,e.viewBoxY-150):t=="down"?e.panTo(e.viewBoxX,e.viewBoxY+150):t=="left"?e.panTo(e.viewBoxX-150,e.viewBoxY):e.panTo(e.viewBoxX+150,e.viewBoxY)})});var t=200;this.__zoom=new Element("div",{"class":"view-controls-zoom",title:"Zoom"}),this.__controls.insert(this.__zoom),this.__zoom.track=new Element("div",{"class":"zoom-track"}),this.__zoom.handle=new Element("div",{"class":"zoom-handle",title:"Drag to zoom"}),this.__zoom["in"]=new Element("div",{"class":"zoom-button zoom-in fa fa-fw fa-search-plus",title:"Zoom in"}),this.__zoom.out=new Element("div",{"class":"zoom-button zoom-out fa fa-fw fa-search-minus",title:"Zoom out"}),this.__zoom.label=new Element("div",{"class":"zoom-crt-value"}),this.__zoom.insert(this.__zoom["in"]),this.__zoom.insert(this.__zoom.track),this.__zoom.track.insert(this.__zoom.handle),this.__zoom.track.style.height=t+"px",this.__zoom.insert(this.__zoom.out),this.__zoom.insert(this.__zoom.label),this.zoomSlider=new Control.Slider(this.__zoom.handle,this.__zoom.track,{axis:"vertical",minimum:0,maximum:t,increment:1,alignY:6,onSlide:function(t){t<=.9?e.zoom(-t/.9+1.25):e.zoom(.15)},onChange:function(t){t<=.9?e.zoom(-t/.9+1.25):e.zoom(.15)}}),editor.isUnsupportedBrowser()?this.zoomSlider.setValue(.225):this.zoomSlider.setValue(.45),this.__zoom["in"].observe("click",function(t){e.zoomCoefficient<.25?e.zoomSlider.setValue(.9):e.zoomSlider.setValue(-(e.zoomCoefficient-1)*.9)}),this.__zoom.out.observe("click",function(t){e.zoomCoefficient<=.25?e.zoomSlider.setValue(1):e.zoomSlider.setValue(-(e.zoomCoefficient-1.5)*.9)}),this.getWorkArea().insert(this.__controls)},getSizeNormalizedToDefaultZoom:function(e){return e},getCurrentZoomLevel:function(e){return this.zoomCoefficient},canvasToDiv:function(e,t){return{x:this.zoomCoefficient*(e-this.viewBoxX),y:this.zoomCoefficient*(t-this.viewBoxY)}},divToCanvas:function(e,t){return{x:e/this.zoomCoefficient+this.viewBoxX,y:t/this.zoomCoefficient+this.viewBoxY}},viewportToDiv:function(e,t){return{x:+e-this.canvas.cumulativeOffset().left,y:t-this.canvas.cumulativeOffset().top}},panTo:function(e,t,n){var r=this,i=this.viewBoxX,s=this.viewBoxY,o=e-i,u=t-s;editor.isUnsupportedBrowser()&&(n=!0);var a=n?0:.4,f=n?1:11,l=o/f,c=u/f;if(l==0&&c==0)return;var h=0;(function p(){setTimeout(function(){h++<f&&(r.viewBoxX+=l,r.viewBoxY+=c,r.getPaper().setViewBox(r.viewBoxX,r.viewBoxY,r.width/r.zoomCoefficient,r.height/r.zoomCoefficient),r.background.attr({x:r.viewBoxX,y:r.viewBoxY}),p())},1e3*a/f)})()},panByX:function(e,t){this.panTo(this.viewBoxX+Math.floor(e/this.zoomCoefficient),this.viewBoxY,t)},adjustSizeToScreen:function(){var e=document.viewport.getDimensions();this.width=e.width,this.height=e.height-this.canvas.cumulativeOffset().top-4,this.getPaper().setSize(this.width,this.height),this.getPaper().setViewBox(this.viewBoxX,this.viewBoxY,this.width/this.zoomCoefficient,this.height/this.zoomCoefficient),this.background&&this.background.attr({width:this.width,height:this.height}),editor.getNodeMenu()&&editor.getNodeMenu().reposition()},centerAroundNode:function(e,t,n,r){var i=editor.getNode(e);if(i){var s=i.getX(),o=i.getY();n||(n=0),r||(r=0);var u=this.getWidth()/this.zoomCoefficient,a=this.getHeight()/this.zoomCoefficient;this.panTo(s-u/2-n,o-a/2-r,t)}}});return e}),define("pedigree/disorder",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(t,n,r){n==null&&!e.isInt(t)&&(n=t),this._disorderID=t,this._name=n?n:"loading...",!n&&r&&this.load(r)},getDisorderID:function(){return this._disorderID},getName:function(){return this._name},load:function(e){var n=t.getOMIMServiceURL(),r=n+"&q=id:"+this._disorderID;new Ajax.Request(r,{method:"GET",onSuccess:this.onDataReady.bind(this),onComplete:e?e:{}})},onDataReady:function(e){try{var t=JSON.parse(e.responseText);console.log("LOADED DISORDER: disorder id = "+this._disorderID+", name = "+t.rows[0].name),this._name=t.rows[0].name}catch(n){console.log("[LOAD DISORDER] Error: "+n)}}});return t.getOMIMServiceURL=function(){return(new XWiki.Document("OmimService","PhenoTips")).getURL("get","outputSyntax=plain")},t}),define("pedigree/view/legend",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(e,t){this._affectedNodes={},this._objectColors={},this._preferredColors={},this._previousHighightedNode=null;var n=$("legend-container");if(n==undefined){editor.isReadOnlyMode()||(this._legendInfo=(new Element("div",{"class":"legend-box legend-info",id:"legend-info"})).insert((new Element("div",{"class":"infomessage"})).insert("You can drag and drop all items from the list(s) below onto individuals in the pedigree to mark them as affected.")),this.closeButton=(new Element("span",{"class":"close-button"})).update("x"),this.closeButton.observe("click",this.hideDragHint.bindAsEventListener(this)),this._legendInfo.insert({top:this.closeButton}),this._legendInfo.hide());var n=(new Element("div",{"class":"legend-container",id:"legend-container"})).insert(this._legendInfo);editor.getWorkspace().getWorkArea().insert(n)}else editor.isReadOnlyMode()||(this._legendInfo=n.down("#legend-info"));this._legendBox=new Element("div",{"class":"legend-box",id:this._getPrefix()+"-legend-box"}),this._legendBox.hide(),n.insert(this._legendBox);var r=(new Element("h2",{"class":"legend-title"})).update(e);this._legendBox.insert(r),this._list=new Element("ul",{"class":this._getPrefix()+"-list abnormality-list"}),this._legendBox.insert(this._list),Element.observe(this._legendBox,"mouseover",function(){$$(".menu-box").invoke("setOpacity",.1)}),Element.observe(this._legendBox,"mouseout",function(){$$(".menu-box").invoke("setOpacity",1)}),t&&Droppables.add(editor.getWorkspace().canvas,{accept:"drop-"+this._getPrefix(),onDrop:this._onDropWrapper.bind(this),onHover:this._onHoverWrapper.bind(this)})},_getPrefix:function(e){throw"prefix not defined"},hideDragHint:function(){editor.getPreferencesManager().setConfigurationOption("user","hideDraggingHint",!0),this._legendInfo.hide()},getObjectColor:function(e){return this._objectColors.hasOwnProperty(e)?this._objectColors[e]:"#ff0000"},getAllColors:function(){return this._objectColors},setAllPreferredColors:function(e){for(id in e)e.hasOwnProperty(id)&&this.addPreferredColor(id,e[id])},addPreferredColor:function(e,t){this._preferredColors[e]=t},getPreferedColor:function(e){return this._preferredColors.hasOwnProperty(e)?this._preferredColors[e]:null},_hasAffectedNodes:function(e){return this._affectedNodes.hasOwnProperty(e)},addCase:function(e,t,n){Object.keys(this._affectedNodes).length==0&&(this._legendBox.show(),!editor.getPreferencesManager().getConfigurationOption("hideDraggingHint")&&this._legendInfo&&this._legendInfo.show());if(!this._hasAffectedNodes(e)){this._affectedNodes[e]=[n];var r=this._generateElement(e,t);this._list.insert(r)}else this._affectedNodes[e].push(n);this._updateCaseNumbersForObject(e)},removeCase:function(e,t){if(this._hasAffectedNodes(e)){this._affectedNodes[e]=this._affectedNodes[e].without(t);if(this._affectedNodes[e].length==0){delete this._affectedNodes[e],delete this._objectColors[e];var n=this._getListElementForObjectWithID(e);n.remove(),Object.keys(this._affectedNodes).length==0&&(this._legendBox.hide(),this._legendBox.up().select(".abnormality").size()==0&&this._legendInfo&&this._legendInfo.hide())}else this._updateCaseNumbersForObject(e)}},replaceIDs:function(e){for(var t in this._affectedNodes)if(this._affectedNodes.hasOwnProperty(t)){var n=this._affectedNodes[t];for(var r=0;r<n.length;r++){var i=n[r],s=e.hasOwnProperty(i)?e[i]:i;n[r]=s}}},_getListElementForObjectWithID:function(t){var n=e.isInt(t)?t:this._hashID(t);return $(this._getPrefix()+"-"+n)},_updateCaseNumbersForObject:function(t){var n=e.isInt(t)?t:this._hashID(t),r=this._legendBox.down("li#"+this._getPrefix()+"-"+n+" .abnormality-cases");if(r){var i=this._affectedNodes.hasOwnProperty(t)?this._affectedNodes[t].length:0;r.update(i+"&nbsp;case"+(i-1&&"s"||""))}},_generateElement:function(t,n){var r=this.getObjectColor(t),i=e.isInt(t)?t:this._hashID(t),s=(new Element("li",{"class":"abnormality drop-"+this._getPrefix(),id:this._getPrefix()+"-"+i})).update((new Element("span",{"class":"disorder-name"})).update(n.escapeHTML()));s.insert(new Element("input",{type:"hidden",value:t}));var o=new Element("span",{"class":"abnormality-color"});o.style.backgroundColor=r,s.insert({top:o});var u=new Element("span",{"class":"abnormality-cases"}),a=(new Element("span",{"class":"abnormality-cases-container"})).insert("(").insert(u).insert(")");s.insert(" ").insert(a);var f=this;return Element.observe(s,"mouseover",function(){s.down(".disorder-name").setStyle({background:r,cursor:"default"}),f._affectedNodes[t]&&f._affectedNodes[t].forEach(function(e){var t=editor.getNode(e);t&&t.getGraphics().highlight()})}),Element.observe(s,"mouseout",function(){s.down(".disorder-name").setStyle({background:"",cursor:"default"}),f._affectedNodes[t]&&f._affectedNodes[t].forEach(function(e){var t=editor.getNode(e);t&&t.getGraphics().unHighlight()})}),new Draggable(s,{revert:!0,reverteffect:function(e){e.setStyle({height:"",left:"",position:"",top:"",zIndex:"",width:""})},ghosting:!0}),s},_onDropWrapper:function(e,t,n){if(editor.isReadOnlyMode())return;var r=editor.getWorkspace().viewportToDiv(n.pointerX(),n.pointerY()),i=editor.getWorkspace().divToCanvas(r.x,r.y),s=editor.getView().getPersonNodeNear(i.x,i.y);if(s){var o=e.select("input")[0].value;this._onDropObject(s,o)}},_onHoverWrapper:function(e,t,n,r){if(editor.isReadOnlyMode())return;var i=editor.getWorkspace().viewportToDiv(r.pointerX(),r.pointerY()),s=editor.getWorkspace().divToCanvas(i.x,i.y),o=editor.getView().getPersonNodeNear(s.x,s.y);o?(editor.getView().setCurrentDraggable(null),o.getGraphics().getHoverBox().setHighlighted(!0),this._previousHighightedNode=o):this._previousHighightedNode&&(this._previousHighightedNode.getGraphics().getHoverBox().setHighlighted(!1),this._previousHighightedNode=null)},_onDropObject:function(e,t){throw"drop functionality is not defined"},_hashID:function(e){return e.toLowerCase(),"c"+e.split("").reduce(function(e,t){return e=(e<<5)-e+t.charCodeAt(0),e&e},0)}});return t}),define("pedigree/view/disorderLegend",["pedigree/disorder","pedigree/view/legend"],function(e,t){var n=Class.create(t,{initialize:function($super){$super("Disorders",!0),this._disorderCache={}},_getPrefix:function(e){return"disorder"},getDisorder:function(t){if(!this._disorderCache.hasOwnProperty(t)){var n=function(){this._updateDisorderName(t)};this._disorderCache[t]=new e(t,null,n.bind(this))}return this._disorderCache[t]},getAllNames:function(){var e={};for(var t in this._affectedNodes)this._affectedNodes.hasOwnProperty(t)&&(e[t]=this.getDisorder(t).getName());return e},addCase:function($super,t,n,r){this._disorderCache.hasOwnProperty(t)||(this._disorderCache[t]=new e(t,n)),$super(t,n,r)},_updateDisorderName:function(e){var t=this._legendBox.down("li#"+this._getPrefix()+"-"+e+" .disorder-name");t.update(this.getDisorder(e).getName())},_generateElement:function($super,e,t){if(!this._objectColors.hasOwnProperty(e)){var n=this._generateColor(e);this._objectColors[e]=n,document.fire("disorder:color",{id:e,color:n})}return $super(e,t)},_onDropObject:function(e,t){var n=e.getDisorders().slice(0);if(n.indexOf(t)==-1){n.push(t),editor.getView().unmarkAll();var r={setDisorders:n},i={nodeID:e.getID(),properties:r};document.fire("pedigree:node:setproperty",i)}else alert("This person already has the specified disorder")},_generateColor:function(e){if(this._objectColors.hasOwnProperty(e))return this._objectColors[e];var t=Object.values(this._objectColors),n=["#E0F8F8","#92c0db","#4575B4","#949ab8","#FEE090","#bf6632","#fca860","#9a4500","#d12943","#00a2bf"];e=="affected"&&(n=["#FEE090","#dbad71"]),this.getPreferedColor(e)!==null&&n.unshift(this.getPreferedColor(e)),t.each(function(e){n=n.without(e)});if(n.length>0)return n[0];var r=Raphael.getColor();while(r=="#ffffff"||t.indexOf(r)!=-1)r="#"+((1<<24)*Math.random()|0).toString(16);return r}});return n}),function(e){e.URL=e.URL||e.webkitURL;if(e.Blob&&e.URL)try{new Blob;return}catch(t){}var n=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||function(e){var t=function(e){return Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1]},n=function(){this.data=[]},r=function(t,n,r){this.data=t,this.size=t.length,this.type=n,this.encoding=r},i=n.prototype,s=r.prototype,o=e.FileReaderSync,u=function(e){this.code=this[this.name=e]},a="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),f=a.length,l=e.URL||e.webkitURL||e,c=l.createObjectURL,h=l.revokeObjectURL,p=l,d=e.btoa,v=e.atob,m=e.ArrayBuffer,g=e.Uint8Array,y=/^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/;r.fake=s.fake=!0;while(f--)u.prototype[a[f]]=f+1;return l.createObjectURL||(p=e.URL=function(e){var t=document.createElementNS("http://www.w3.org/1999/xhtml","a"),n;return t.href=e,"origin"in t||(t.protocol.toLowerCase()==="data:"?t.origin=null:(n=e.match(y),t.origin=n&&n[1])),t}),p.createObjectURL=function(e){var t=e.type,n;t===null&&(t="application/octet-stream");if(e instanceof r)return n="data:"+t,e.encoding==="base64"?n+";base64,"+e.data:e.encoding==="URI"?n+","+decodeURIComponent(e.data):d?n+";base64,"+d(e.data):n+","+encodeURIComponent(e.data);if(c)return c.call(l,e)},p.revokeObjectURL=function(e){e.substring(0,5)!=="data:"&&h&&h.call(l,e)},i.append=function(e){var n=this.data;if(g&&(e instanceof m||e instanceof g)){var i="",s=new g(e),a=0,f=s.length;for(;a<f;a++)i+=String.fromCharCode(s[a]);n.push(i)}else if(t(e)==="Blob"||t(e)==="File"){if(!o)throw new u("NOT_READABLE_ERR");var l=new o;n.push(l.readAsBinaryString(e))}else e instanceof r?e.encoding==="base64"&&v?n.push(v(e.data)):e.encoding==="URI"?n.push(decodeURIComponent(e.data)):e.encoding==="raw"&&n.push(e.data):(typeof e!="string"&&(e+=""),n.push(unescape(encodeURIComponent(e))))},i.getBlob=function(e){return arguments.length||(e=null),new r(this.data.join(""),e,"raw")},i.toString=function(){return"[object BlobBuilder]"},s.slice=function(e,t,n){var i=arguments.length;return i<3&&(n=null),new r(this.data.slice(e,i>1?t:this.data.length),n,this.encoding)},s.toString=function(){return"[object Blob]"},s.close=function(){this.size=0,delete this.data},n}(e);e.Blob=function(e,t){var r=t?t.type||"":"",i=new n;if(e)for(var s=0,o=e.length;s<o;s++)i.append(e[s]);return i.getBlob(r)}}(typeof self!="undefined"&&self||typeof window!="undefined"&&window||this.content||this),define("pedigree/filesaver/Blob",function(){}),define("pedigree/filesaver/FileSaver",["pedigree/filesaver/Blob"],function(){var e=e||typeof navigator!="undefined"&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){if(typeof navigator!="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent))return;var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),i=!e.externalHost&&"download"in r,s=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)},o=e.webkitRequestFileSystem,u=e.requestFileSystem||o||e.mozRequestFileSystem,a=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},f="application/octet-stream",l=0,c=[],h=function(){var e=c.length;while(e--){var t=c[e];typeof t=="string"?n().revokeObjectURL(t):t.remove()}c.length=0},p=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i=="function")try{i.call(e,n||e)}catch(s){a(s)}}},d=function(t,a){var h=this,d=t.type,v=!1,m,g,y=function(){var e=n().createObjectURL(t);return c.push(e),e},b=function(){p(h,"writestart progress write writeend".split(" "))},w=function(){if(v||!m)m=y(t);g?g.location.href=m:window.open(m,"_blank"),h.readyState=h.DONE,b()},E=function(e){return function(){if(h.readyState!==h.DONE)return e.apply(this,arguments)}},S={create:!0,exclusive:!1},x;h.readyState=h.INIT,a||(a="download");if(i){m=y(t),r.href=m,r.download=a,s(r),h.readyState=h.DONE,b();return}e.chrome&&d&&d!==f&&(x=t.slice||t.webkitSlice,t=x.call(t,0,t.size,f),v=!0),o&&a!=="download"&&(a+=".download");if(d===f||o)g=e;if(!u){w();return}l+=t.size,u(e.TEMPORARY,l,E(function(e){e.root.getDirectory("saved",S,E(function(e){var n=function(){e.getFile(a,S,E(function(e){e.createWriter(E(function(n){n.onwriteend=function(t){g.location.href=e.toURL(),c.push(e),h.readyState=h.DONE,p(h,"writeend",t)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&w()},"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=h["on"+e]}),n.write(t),h.abort=function(){n.abort(),h.readyState=h.DONE},h.readyState=h.WRITING}),w)}),w)};e.getFile(a,{create:!1},E(function(e){e.remove(),n()}),E(function(e){e.code===e.NOT_FOUND_ERR?n():w()}))}),w)}),w)},v=d.prototype,m=function(e,t){return new d(e,t)};return v.abort=function(){var e=this;e.readyState=e.DONE,p(e,"abort")},v.readyState=v.INIT=0,v.WRITING=1,v.DONE=2,v.error=v.onwritestart=v.onprogress=v.onwrite=v.onabort=v.onerror=v.onwriteend=null,e.addEventListener("unload",h,!1),m.unload=function(){h(),e.removeEventListener("unload",h,!1)},m}(typeof self!="undefined"&&self||typeof window!="undefined"&&window||this.content),t=t||function(t,n,r){n=n||"pedigree.txt",r=r||"utf-8",t=(t||"").replace(/\r?\n/g,"\r\n");if(e&&Blob){var i=new Blob([t],{type:"text/plain;charset="+r});return e(i,n),!0}var s=window.frames.saveTxtWindow;if(!s){s=document.createElement("iframe"),s.id="saveTxtWindow",s.style.display="none",document.body.insertBefore(s,null),s=window.frames.saveTxtWindow;if(!s){s=window.open("","_temp","width=100,height=100");if(!s)return window.alert("Sorry, download file could not be created."),!1}}var o=s.document;o.charset=r,browser.versionMajor<=8?o.open("text/plain","replace"):o.open(),o.write(t),o.close(),n+=".txt";var u=o.execCommand("SaveAs",null,n);return s.close(),u},n={};return n.saveAs=e,n.saveTextAs=t,n}),define("pedigree/model/export",["pedigree/pedigreeDate","pedigree/model/helpers"],function(e,t){return PedigreeExport=function(){},PedigreeExport.prototype={},PedigreeExport.exportAsSimpleJSON=function(e,t){var n=[];for(var r=0;r<=e.GG.getMaxRealVertexId();r++){if(!e.GG.isPerson(r))continue;var i={id:r},s=e.GG.getParents(r);if(s.length>0){var o=s[0],u=s[1];if(e.GG.properties[s[0]]["gender"]=="F"||e.GG.properties[s[1]]["gender"]=="M")o=s[1],u=s[0];i.father=o,i.mother=u}var a=e.GG.properties[r];for(var f in a)if(a.hasOwnProperty(f)){if(t!="all"){if(f=="lName"||f=="fName"||f=="lNameAtB"||f=="dob"||f=="bob")continue;if(t=="minimal"&&f=="comments")continue}var l=PedigreeExport.convertProperty(f,a[f]);l!==null&&(i[l.propertyName]=l.value)}n.push(i)}return JSON.stringify(n)},PedigreeExport.exportAsPED=function(e,t){var n="",r=XWiki.currentDocument.page,i=PedigreeExport.createNewIDs(e,t);for(var s=0;s<=e.GG.getMaxRealVertexId();s++){if(!e.GG.isPerson(s))continue;if(e.GG.isPlaceholder(s))continue;n+=r+" "+i[s]+" ";var o=e.GG.getParents(s);if(o.length>0){var u=o[0],a=o[1];if(e.GG.properties[o[0]]["gender"]=="F"||e.GG.properties[o[1]]["gender"]=="M")u=o[1],a=o[0];n+=i[u]+" "+i[a]+" "}else n+="0 0 ";var f=3;e.GG.properties[s]["gender"]=="M"?f=1:e.GG.properties[s]["gender"]=="F"&&(f=2),n+=f+" ";var l=-9;e.GG.properties[s].hasOwnProperty("carrierStatus")&&(e.GG.properties[s]["carrierStatus"]=="affected"||e.GG.properties[s]["carrierStatus"]=="carrier"||e.GG.properties[s]["carrierStatus"]=="presymptomatic"?l=2:l=1),n+=l+"\n"}return n},PedigreeExport.exportAsBOADICEA=function(n,r){var i=n.DG,s="BOADICEA import pedigree file format 2.0\n";s+="FamID		Name	Target	IndivID	FathID	MothID	Sex	Twin	Dead	Age	Yob	1BrCa	2BrCa	OvCa	ProCa	PanCa	Gtest	Mutn	Ashkn	Not_implemented_yet\n";var o=XWiki.currentDocument.page,u=PedigreeExport.createNewIDs(i,r,7,!0),a=!1,f=!1;for(var l=0;l<=i.GG.getMaxRealVertexId();l++){if(!i.GG.isPerson(l))continue;if(i.GG.isPlaceholder(l))continue;var c=u[l],h=i.GG.properties[l].hasOwnProperty("fName")?i.GG.properties[l].fName.substring(0,8).replace(/[^A-Za-z0-9]/g,""):c,p=l==0?"1":"0";s+=o+"	"+h+"	"+p+"	"+c+"	";var d=i.GG.getParents(l);if(d.length>0){if(i.GG.properties[d[0]]["gender"]=="U"&&i.GG.properties[d[1]]["gender"]=="U")return editor.getOkCancelDialogue().showCustomized("Unable to export in BOADICEA format when both parents of any node are of unknown gender","Can't export: missing gender data","OK",null),"";var v=d[0],m=d[1];if(i.GG.properties[d[0]]["gender"]=="F"||i.GG.properties[d[1]]["gender"]=="M")v=d[1],m=d[0];s+=u[v]+"	"+u[m]+"	"}else s+="0	0	";var g="M",y=i.GG.properties[l].gender;if(y=="F")g="F";else if(y=="U"||y=="O"){var b=n.getPossibleGenders(l);if(!b.F&&!b.M)return editor.getOkCancelDialogue().showCustomized("Unable to export in BOADICEA format since gender assignment in pedigree is inconsistent","Can't export: gender inconsistency in pedigree","OK",null),"";b.F&&!b.M?g="F":b.M&&!b.F?g="M":g="M",a=!0}s+=g+"	",i.GG.getTwinGroupId(l)!==null?s+="1	":s+="0	";var w="0";if(i.GG.properties[l].hasOwnProperty("lifeStatus")&&i.GG.properties[l]["lifeStatus"]!="alive")var w="1";s+=w+"	";var E="0",S="0";if(i.GG.properties[l].hasOwnProperty("dob")){var x=new e(i.GG.properties[l].dob);S=parseInt(x.getMostConservativeYearEstimate()),E=(new Date).getFullYear()-S}s+=E+"	"+S+"	";var T=["Breast","","Ovarian","Prostate","Pancreatic"];for(var N=0;N<T.length;N++){cancer=T[N];if(cancer==""||!i.GG.properties[l].hasOwnProperty("cancers")){s+="0	";continue}if(i.GG.properties[l].cancers.hasOwnProperty(cancer)){var C=i.GG.properties[l].cancers[cancer];if(!C.affected)s+="0	";else{var k=C.hasOwnProperty("numericAgeAtDiagnosis")&&C.numericAgeAtDiagnosis>0?C.numericAgeAtDiagnosis:"AU";s+=k.toString()+"	",S=="0"&&(f=!0)}}else s+="0	"}s+="0	";if(i.GG.properties[l].hasOwnProperty("candidateGenes")){var L=i.GG.properties[l].candidateGenes,A="0";t.arrayIndexOf(L,"BRCA1")>=0&&(A="1"),t.arrayIndexOf(L,"BRCA2")>=0&&(A=="1"?A="3":A="2"),s+=A+"	"}else s+="0	";var O="0";if(i.GG.properties[l].hasOwnProperty("ethnicities")){var M=i.GG.properties[l].ethnicities;for(var _=0;_<M.length;_++)if(M[_].match(/ashkenaz/i)!==null){O="1";break}}s+=O+"	",s+="0	0	0	0	0",s+="\n"}if(a||f){var D="Pedigree can be exported, but there are warnings:\n\n\n",P=!1;a&&f&&(P=!0),a&&(D+=(P?"1) ":"")+"BOADICEA format does not support unknown or other genders.\n\n"+"All persons of unknown or other gender were either assigned a gender "+"opposite to their partner's gender or saved as male in the export file"),f&&(D+=(P?"\n\n\n2) ":"")+"BOADICEA requires that all individuals with cancer have their age specified or estimated.\n\n"+"A person with cancer is missing age data, data will be exported but may not be accepted by BOADICEA"),alert(D)}return s},PedigreeExport.internalToJSONPropertyMapping={proband:"proband",fName:"firstName",lName:"lastName",lNameAtB:"lastNameAtBirth",comments:"comments",twinGroup:"twinGroup",monozygotic:"monozygotic",adoptedStatus:"adoptedStatus",evaluated:"evaluated",dob:"birthDate",dod:"deathDate",gestationAge:"gestationAge",lifeStatus:"lifeStatus",disorders:"disorders",ethnicities:"ethnicities",carrierStatus:"carrierStatus",externalID:"externalId",gender:"sex",numPersons:"numPersons",hpoTerms:"hpoTerms",candidateGenes:"candidateGenes",lostContact:"lostContact",nodeNumber:"nodeNumber",cancers:"cancers"},PedigreeExport.convertProperty=function(e,t){if(!PedigreeExport.internalToJSONPropertyMapping.hasOwnProperty(e))return null;var n=PedigreeExport.internalToJSONPropertyMapping[e];return n=="sex"&&(t=="M"?t="male":t=="F"?t="female":t=="O"?t="other":t="unknown"),{propertyName:n,value:t}},PedigreeExport.createNewIDs=function(e,t,n,r){var i={},s={},o=1;for(var u=0;u<=e.GG.getMaxRealVertexId();u++){if(!e.GG.isPerson(u))continue;if(e.GG.isPlaceholder(u))continue;var a=o++;t=="external"&&e.GG.properties[u].hasOwnProperty("externalID")?(o--,a=e.GG.properties[u].externalID.replace(/\s/g,"_")):t=="name"&&e.GG.properties[u].hasOwnProperty("fName")&&(o--,a=e.GG.properties[u].fName.replace(/\s/g,"_")),a=String(a),r&&(a=a.replace(/[^A-Za-z0-9]/g,"")),n&&a.length>n&&(a=a.substring(0,n));var f=a,l=2;while(s.hasOwnProperty(a)){if(n){var c=f.length+String(l).length,h=c-n;a=f.substring(0,a.length-h)}else a=f;a+=String(l),l++}i[u]=a,s[a]=!0}return i},PedigreeExport}),define("pedigree/view/exportSelector",["pedigree/filesaver/FileSaver","pedigree/model/export"],function(e,t){var n=Class.create({initialize:function(){var e=this,t=new Element("div",{"class":"import-selector"}),n=function(t,n,r){var i=new Element("tr"),s=new Element("input",{type:"radio",value:r,name:"export-type"});s.observe("click",e.disableEnableOptions),t&&(s.checked=!0);var o=(new Element("label",{"class":"import-type-label"})).insert(s).insert(n);return i.insert(o.wrap("td")),i},r=new Element("table");r.insert(n(!0,"PED","ped")),r.insert(n(!1,"BOADICEA","BOADICEA")),r.insert(n(!1,"Simple JSON","simpleJSON"));var i=new Element("a",{id:"downloadLink",style:"display:none"});t.insert(i);var s=(new Element("div",{"class":"import-section"})).update("Data format:"),o=new Element("div",{"class":"import-block"});o.insert(s).insert(r),t.insert(o);var u=function(e,t,n,r,i){var s=new Element("tr"),o=new Element("input",{type:"radio",value:i,name:t});e&&(o.checked=!0);var u=(new Element("label",{"class":n})).insert(o).insert(r);return s.insert(u.wrap("td")),s},a=new Element("table",{id:"jsonOptions",style:"display:none"});a.insert(u(!0,"export-options","import-config-label","All data","all")),a.insert(u(!1,"export-options","import-config-label","Remove personal information (name and age)","nopersonal")),a.insert(u(!1,"export-options","import-config-label","Remove personal information and free-form comments","minimal"));var f=new Element("table",{id:"pedOptions"}),l=(new Element("label",{"class":"export-config-header"})).insert("How should person IDs be assigned in the generated file?");f.insert(l.wrap("td").wrap("tr")),f.insert(u(!0,"ped-options","export-subconfig-label","Using External IDs (when available)","external")),f.insert(u(!1,"ped-options","export-subconfig-label","Generate new numeric IDs","newid")),f.insert(u(!1,"ped-options","export-subconfig-label","Using Names (when available)","name"));var c=(new Element("div",{"class":"import-section"})).update("Options:"),h=new Element("div",{"class":"import-block"});h.insert(c).insert(a).insert(f),t.insert(h);var p=new Element("div",{"class":"buttons import-block-bottom"});p.insert((new Element("input",{type:"button",name:"export",value:"Export","class":"button",id:"export_button"})).wrap("span",{"class":"buttonwrapper"})),p.insert((new Element("input",{type:"button",name:"cancel",value:"Cancel","class":"button secondary"})).wrap("span",{"class":"buttonwrapper"})),t.insert(p);var d=p.down('input[name="cancel"]');d.observe("click",function(t){e.hide()});var v=p.down('input[name="export"]');v.observe("click",function(t){e._onExportStarted()});var m=["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(t,{close:{method:this.hide.bind(this),keys:m}},{extraClassName:"pedigree-import-chooser",title:"Pedigree export",displayCloseButton:!0})},disableEnableOptions:function(){var e=$$('input:checked[type=radio][name="export-type"]')[0].value,t=$("pedOptions"),n=$("jsonOptions");if(e=="ped"||e=="BOADICEA"){t.show();var r=$$('input[type=radio][name="ped-options"]')[2];e=="BOADICEA"?(r.checked&&($$('input[type=radio][name="ped-options"]')[0].checked=!0),r.up().hide()):r.up().show(),n.hide()}else t.hide(),n.show()},_onExportStarted:function(){this.hide();var n=XWiki.currentDocument.page+" pedigree",r=$$('input:checked[type=radio][name="export-type"]')[0].value;if(r=="simpleJSON")var i=$$('input:checked[type=radio][name="export-options"]')[0].value,s=t.exportAsSimpleJSON(editor.getGraph().DG,i),o=n+".json",u="application/json";else{var a=$$('input:checked[type=radio][name="ped-options"]')[0].value;if(r=="ped")var s=t.exportAsPED(editor.getGraph().DG,a),o=n+".ped";else if(r=="BOADICEA")var s=t.exportAsBOADICEA(editor.getGraph(),a),o=n+".txt";var u="text/plain"}console.log("Export data: >>"+s+"<<"),s!=""&&e.saveTextAs(s,o)},show:function(){this.dialog.show()},hide:function(){this.dialog.closeDialog()}});return n}),define("pedigree/view/geneLegend",["pedigree/view/legend"],function(e){var t=Class.create(e,{initialize:function($super){$super("Candidate Genes",!0)},_getPrefix:function(e){return"gene"},_generateElement:function($super,e,t){if(!this._objectColors.hasOwnProperty(e)){var n=this._generateColor(e);this._objectColors[e]=n,document.fire("gene:color",{id:e,color:n})}return $super(e,t)},_onDropObject:function(e,t){if(e.isPersonGroup())return;var n=e.getGenes().slice(0);if(n.indexOf(t)==-1){n.push(t),editor.getView().unmarkAll();var r={setGenes:n},i={nodeID:e.getID(),properties:r};document.fire("pedigree:node:setproperty",i)}else alert("This person already has the selected candidate gene")},_generateColor:function(e){if(this._objectColors.hasOwnProperty(e))return this._objectColors[e];var t=Object.values(this._objectColors),n=["#81a270","#c4e8c4","#56a270","#b3b16f","#4a775a","#65caa3"];this.getPreferedColor(e)!==null&&n.unshift(this.getPreferedColor(e)),t.each(function(e){n=n.without(e)});if(n.length>0)return n[0];var r=Raphael.getColor();while(r=="#ffffff"||t.indexOf(r)!=-1)r="#"+((1<<24)*Math.random()|0).toString(16);return r}});return t}),define("pedigree/hpoTerm",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(e,n,r){n==null&&!t.isValidID(e)&&(n=e),this._hpoID=e,this._name=n?n:"loading...",!n&&r&&this.load(r)},getID:function(){return this._hpoID},getName:function(){return this._name},load:function(e){var n=t.getServiceURL(),r=n+"&q="+this._hpoID.replace(":","%3A");new Ajax.Request(r,{method:"GET",onSuccess:this.onDataReady.bind(this),onComplete:e?e:{}})},onDataReady:function(e){try{var t=JSON.parse(e.responseText);console.log("LOADED HPO TERM: id = "+this._hpoID+", name = "+t.rows[0].name),this._name=t.rows[0].name}catch(n){console.log("[LOAD HPO TERM] Error: "+n)}}});return t.isValidID=function(e){var t=/^HP\:(\d)+$/i;return t.test(e)},t.getServiceURL=function(){return(new XWiki.Document("SolrService","PhenoTips")).getURL("get")+"?"},t}),define("pedigree/view/hpoLegend",["pedigree/hpoTerm","pedigree/view/legend"],function(e,t){var n=Class.create(t,{initialize:function($super){$super("Phenotypes",!0),this._termCache={}},_getPrefix:function(e){return"phenotype"},getTerm:function(t){if(!this._termCache.hasOwnProperty(t)){var n=function(){this._updateTermName(t)};this._termCache[t]=new e(t,null,n.bind(this))}return this._termCache[t]},getObjectColor:function(e){return"#CCCCCC"},addCase:function($super,t,n,r){this._termCache.hasOwnProperty(t)||(this._termCache[t]=new e(t,n)),$super(t,n,r)},_updateTermName:function(e){var t=this,n=this._legendBox.down("li#"+this._getPrefix()+"-"+t._hashID(e)+" .disorder-name");n.update(this.getTerm(e).getName())},_onDropObject:function(e,t){if(e.isPersonGroup())return;var n=e.getHPO().slice(0);if(n.indexOf(t)==-1){n.push(t),editor.getView().unmarkAll();var r={setHPO:n},i={nodeID:e.getID(),properties:r};document.fire("pedigree:node:setproperty",i)}else alert("This person already has the selected phenotype")}});return n}),define("pedigree/view/importSelector",[],function(){var e=Class.create({initialize:function(){if(editor.isReadOnlyMode())return;var e=this,t=new Element("div",{"class":"import-selector"}),n=(new Element("div",{"class":"import-section"})).update("Import data:");this.importValue=new Element("textarea",{id:"import",value:"","class":"import-textarea"}),t.insert(n).insert(this.importValue);if(!!window.FileReader&&!!window.FileList){var r=new Element("input",{type:"file",id:"pedigreeInputFile",style:"display:none"});r.observe("change",function(t){e.handleFileUpload(this.files);try{this.value=""}catch(n){}});var i=(new Element("input",{type:"button",value:"Select a local file to be imported","class":"button"})).wrap("span",{"class":"buttonwrapper"});i.observe("click",function(e){var t=document.getElementById("pedigreeInputFile");t.click()}),t.insert(r).insert(i)}var s=function(t,n,r){var i=new Element("tr"),s=new Element("input",{type:"radio",value:r,name:"select-type"});s.observe("click",e.disableEnableOptions),t&&(s.checked=!0);var o=(new Element("label",{"class":"import-type-label"})).insert(s).insert(n);return i.insert(o.wrap("td")),i},o=new Element("table");o.insert(s(!0,"PED or LINKAGE (pre- or post- makeped)","ped")),o.insert(s(!1,"GEDCOM","gedcom")),o.insert(s(!1,"BOADICEA","BOADICEA")),o.insert(s(!1,"Simple JSON","simpleJSON"));var u=(new Element("div",{"class":"import-section"})).update("Data format:"),a=new Element("div",{"class":"import-block"});a.insert(u).insert(o),t.insert(a);var f=function(e,t,n){var r=new Element("tr"),i=new Element("input",{type:"radio",value:n,name:"select-options"});e&&(i.checked=!0);var s=(new Element("label",{"class":"import-config-label"})).insert(i).insert(t);return r.insert(s.wrap("td")),r},l=new Element("table",{id:"import-type"});l.insert(f(!0,"Treat non-standard phenotype values as new disorders","accept")),l.insert(f(!1,'Treat non-standard phenotype values as "no information"',"dontaccept"));var c=new Element("input",{type:"checkbox",value:"1",name:"mark-evaluated"}),h=(new Element("label",{"class":"import-mark-label1"})).insert(c).insert("Mark all patients with known disorder status with 'documented evaluation' mark").wrap("td").wrap("tr");l.insert(h);var p=new Element("input",{type:"checkbox",value:"1",name:"mark-external"});p.checked=!0;var d=(new Element("label",{"class":"import-mark-label2"})).insert(p).insert("Save individual IDs as given in the input data as 'external ID'").wrap("td").wrap("tr");l.insert(d);var v=(new Element("div",{"class":"import-section"})).update("Options:"),m=new Element("div",{"class":"import-block"});m.insert(v).insert(l),t.insert(m);var g=new Element("div",{"class":"buttons import-block-bottom"});g.insert((new Element("input",{type:"button",name:"import",value:"Import","class":"button",id:"import_button"})).wrap("span",{"class":"buttonwrapper"})),g.insert((new Element("input",{type:"button",name:"cancel",value:"Cancel","class":"button secondary"})).wrap("span",{"class":"buttonwrapper"})),t.insert(g);var y=g.down('input[name="cancel"]');y.observe("click",function(t){e.hide()});var b=g.down('input[name="import"]');b.observe("click",function(t){e._onImportStarted()});var w=["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(t,{close:{method:this.hide.bind(this),keys:w}},{extraClassName:"pedigree-import-chooser",title:"Pedigree import",displayCloseButton:!0})},handleFileUpload:function(e){for(var t=0,n=e.length;t<n;t++){var r=e[t];console.log("loading file: "+r.name+", size: "+r.size);var i=this,s=new FileReader;s.onload=function(e){i.importValue.value=e.target.result},s.readAsText(r)}},disableEnableOptions:function(){var e=$$('input:checked[type=radio][name="select-type"]')[0].value,t=$$('input[type=radio][name="select-options"]');for(var n=0;n<t.length;n++)e!="ped"?t[n].disabled=!0:t[n].disabled=!1;var r=$$('input[type=checkbox][name="mark-evaluated"]')[0];e!="ped"&&e!="gedcom"?r.disabled=!0:r.disabled=!1;var i=$$('input[type=checkbox][name="mark-external"]')[0];e=="simpleJSON"?i.disabled=!0:i.disabled=!1},_onImportStarted:function(){var e=this.importValue.value;console.log("Importing:\n"+e),this.hide();if(!e||e==""){alert("Nothing to import!");return}var t=$$('input:checked[type=radio][name="select-type"]')[0].value;console.log("Import type: "+t);var n=$$('input[type=checkbox][name="mark-evaluated"]')[0].checked,r=$$('input[type=checkbox][name="mark-external"]')[0].checked,i=$$('input:checked[type=radio][name="select-options"]')[0].value,s=i=="accept",o={markEvaluated:n,externalIdMark:r,acceptUnknownPhenotypes:s};editor.getSaveLoadEngine().createGraphFromImportData(e,t,o,!1,!0)},show:function(){this.dialog.show()},hide:function(){this.importValue.value="",this.dialog.closeDialog()}});return e}),define("pedigree/view/cancersLegend",["pedigree/model/helpers","pedigree/view/legend"],function(e,t){var n=Class.create(t,{initialize:function($super){this._cancerColors={Breast:"#e267a3",Ovarian:"#9370DB",Colon:"#945d34",Uterus:"#c93320",Prostate:"#ecb739",Pancreatic:"#4657dc",Melanoma:"#444444",Kidney:"#197419",Gastric:"#9aac8c",Lung:"#008080",Brain:"#F5DEB3",Oesophagus:"#BC8F8F"},this._cancerLabels={Breast:"Breast cancer",Ovarian:"Ovarian cancer",Colon:"Colon cancer",Uterus:"Uterus cancer",Prostate:"Prostate cancer",Pancreatic:"Pancreatic cancer",Melanoma:"Melanoma",Kidney:"Kidney cancer",Gastric:"Gastric cancer",Lung:"Lung cancer",Brain:"Brain cancer",Oesophagus:"Oesophagus cancer"},$super("Cancers",!0)},_getPrefix:function(e){return"cancers"},_getAllSupportedCancers:function(){var e=[];for(var t in this._cancerColors)this._cancerColors.hasOwnProperty(t)&&e.push(t);return e},addCase:function($super,e,t,n){var t=this._cancerLabels.hasOwnProperty(t)?this._cancerLabels[t]:t;$super(e,t,n)},_generateElement:function($super,e,t){if(!this._objectColors.hasOwnProperty(e)){var n=this._generateColor(e);this._objectColors[e]=n,document.fire("cancer:color",{id:e,color:n})}return $super(e,t)},_onDropObject:function(t,n){if(t.isPersonGroup())return;var r=e.cloneObject(t.getCancers());if(!r.hasOwnProperty(n)||!r[n].affected){r[n]={affected:!0},editor.getView().unmarkAll();var i={setCancers:r},s={nodeID:t.getID(),properties:i};document.fire("pedigree:node:setproperty",s)}else alert("This person already has the selected cancer")},_generateColor:function(e){if(this._objectColors.hasOwnProperty(e))return this._objectColors[e];if(this._cancerColors.hasOwnProperty(e))return this._cancerColors[e];var t=Object.values(this._objectColors),n=["#f8ebb7","#eac080","#bf6632","#a47841","#c95555","#ae6c57"];t.each(function(e){n=n.without(e)});if(n.length>0)return n[0];var r=Raphael.getColor();while(r=="#ffffff"||t.indexOf(r)!=-1)r="#"+((1<<24)*Math.random()|0).toString(16);return r}});return n}),define("pedigree/view/datepicker",["pedigree/model/helpers"],function(e){var t=Class.create({initialize:function(e){this.span=new Element("span"),this.options=e,this.callback=null},populate:function(e){var t=this.dropdown?this.dropdown.selectedIndex||this._tmpSelectedIndex:0,n='<select name="'+this.options.name+'" class="'+(this.options.cssClass||this.options.name||"")+'" placeholder="'+(this.options.hint||this.options.name||"")+'" title="'+(this.options.hint||this.options.name||"")+'">';n+='<option value="" class="empty"></option>';var r=this;e.each(function(e){n+='<option value="'+e.value+'"',e.cssClass&&(n+=' class="'+e.cssClass+'"'),n+=">"+(e.text||e.value||"")+"</option>"}),n+="</select>",this.span.innerHTML=n,this.dropdown=this.span.firstChild,this.callback&&this.onSelect(this.callback),this.dropdown.selectedIndex<=0&&t>=0&&t<this.dropdown.options.length&&(this.dropdown.selectedIndex=t)},enable:function(){if(!this.options.alwaysEnabled){this.dropdown.enable();if(this.dropdown.selectedIndex<=0&&this._tmpSelectedIndex<this.dropdown.options.length)return this.dropdown.selectedIndex=this._tmpSelectedIndex,this._tmpSelectedIndex>0}return!1},disable:function(){this.options.alwaysEnabled||(this.dropdown.disable(),this._tmpSelectedIndex=this.dropdown.selectedIndex,this.dropdown.selectedIndex=0)},getElement:function(){return this.span},onSelect:function(e){var t=this;this.callback=e;var n=["change"];browser.isGecko&&n.push("keyup"),n.each(function(n){t.dropdown.observe(n,function(){e(),t._tmpSelectedIndex=t.dropdown.selectedIndex})})},onFocus:function(e){var t=this;this.dropdown.observe("focus",function(){e(),t.dropdown.selectedIndex==-1&&t._tmpSelectedIndex<t.dropdown.options.size()&&(t.dropdown.selectedIndex=t._tmpSelectedIndex)})},onBlur:function(e){this.dropdown.observe("blur",e)},getSelectedValue:function(){return this.dropdown.selectedIndex>=0?this.dropdown.options[this.dropdown.selectedIndex].value:""},getSelectedOption:function(){return this.dropdown.selectedIndex>=0?this.dropdown.options[this.dropdown.selectedIndex].innerHTML:""}}),n=Class.create({initialize:function(e,t){this.inputFormat=t?t:"YMD";if(!e)return;this.__input=e,this.__input.hide(),this.container=new Element("div",{"class":"fuzzy-date-picker"}),this.__input.insert({after:this.container}),this.inputFormat=="DMY"?(this.container.insert(this.createDayDropdown()),this.container.insert(this.createMonthDropdown()),this.container.insert(this.createYearDropdown())):(this.container.insert(this.createYearDropdown()),this.container.insert(this.createMonthDropdown()),this.container.insert(this.createDayDropdown())),this.container.observe("datepicker:date:changed",this.onProgrammaticUpdate.bind(this))},onProgrammaticUpdate:function(){this.yearSelected(!0),this.monthSelected(!0),this.updateDate(!0)},createYearDropdown:function(){this.yearSelector=new t({name:"year",alwaysEnabled:this.inputFormat=="DMY"});var e=new Date,n=e.getYear()+1900,r=1900,i=[];for(var s=n;s>=r;--s)i.push({value:s}),s%10==0&&i.push({value:s+"s",cssClass:"decade",text:s+"s"});return i.push({value:"1800s",cssClass:"decade"}),i.push({value:"1700s",cssClass:"decade"}),i.push({value:"1600s",cssClass:"decade"}),this.yearSelector.populate(i),this.yearSelector.onSelect(this.yearSelected.bind(this)),this.yearSelector.getElement()},yearSelected:function(e){this.yearSelector.getSelectedValue()>0?(this.monthSelector.enable(),this.monthSelected(e)):(this.monthSelector.disable(),this.daySelector.disable()),this.updateDate(e)},createMonthDropdown:function(){return this.monthSelector=new t({name:"month",alwaysEnabled:this.inputFormat=="DMY"}),this.monthSelector.populate(this.getZeroPaddedValueRange(1,12)),this.monthSelector.disable(),this.monthSelector.onSelect(this.monthSelected.bind(this)),this.monthSelector.getElement()},monthSelected:function(e){this.monthSelector.getSelectedValue()>0?(this.daySelector.populate(this.getAvailableDays()),this.daySelector.enable()):this.inputFormat=="DMY"?this.daySelector.populate(this.getZeroPaddedValueRange(1,31)):this.daySelector.disable(),this.updateDate(e)},createDayDropdown:function(){return this.daySelector=new t({name:"day",alwaysEnabled:this.inputFormat=="DMY"}),this.daySelector.populate(this.getZeroPaddedValueRange(1,31)),this.daySelector.disable(),this.daySelector.onSelect(this.updateDate.bind(this)),this.daySelector.getElement()},getAvailableDays:function(){var e=this.yearSelector.getSelectedValue()*1,t=this.monthSelector.getSelectedValue()*1,n=0;return[1,3,5,7,8,10,12].indexOf(t)>=0?n=31:[4,6,9,11].indexOf(t)>=0?n=30:t==2&&(e%4!=0||e%100==0&&e%400!=0?n=28:n=29),this.getZeroPaddedValueRange(1,n)},getZeroPaddedValueRange:function(e,t){var n=[];if(e<=t)for(var r=e;r<=t;++r)n.push({value:r,text:("0"+r).slice(-2)});else for(var r=t;r<=e;--r)n.push({value:r,text:("0"+r).slice(-2)});return n},updateDate:function(e){var t={},n=this.yearSelector.getSelectedValue();n.match(/\d\d\d\ds$/)?t.decade=n:n!=""&&(t.year=n);if(n>0||this.inputFormat=="DMY"){var r=this.monthSelector.getSelectedValue();r>0&&(t.month=this.monthSelector.getSelectedOption());if(r>0||this.inputFormat=="DMY"){var i=this.daySelector.getSelectedValue();i>0&&(t.day=this.daySelector.getSelectedOption())}}var s=JSON.stringify(t);s!=this.__input.value&&(this.__input.value=JSON.stringify(t),e||this.__input.fire("xwiki:date:changed"))}});return n}),define("pedigree/view/nodeMenu",["pedigree/disorder","pedigree/hpoTerm","pedigree/pedigreeDate","pedigree/model/helpers","pedigree/view/datepicker","pedigree/view/graphicHelpers"],function(e,t,n,r,i,s){return NodeMenu=Class.create({initialize:function(e,t,n){this.canvas=editor.getWorkspace().canvas||$("body");var r="menu-box";n&&(r+=" "+n),this.menuBox=new Element("div",{"class":r}),this.closeButton=(new Element("span",{"class":"close-button"})).update(""),this.menuBox.insert({top:this.closeButton}),this.closeButton.observe("click",this.hide.bindAsEventListener(this)),this.form=new Element("form",{method:"get",action:"","class":"tabs-content"}),this.tabs={},this.tabHeaders={};if(t&&t.length>0){this.tabTop=new Element("dl",{"class":"tabs"});for(var i=0;i<t.length;i++){var s=t[i],o=i==0?"active":"";this.tabs[s]=new Element("div",{id:"tab_"+s,"class":"content "+o}),this.form.insert(this.tabs[s]),this.tabHeaders[s]=(new Element("dd",{"class":o})).insert("<a>"+s+"</a>");var u=this,a=function(e){return function(){for(var t in u.tabs)u.tabs.hasOwnProperty(t)&&(t!=e?(u.tabs[t].className="content",u.tabHeaders[t].className=""):(u.tabs[t].className="content active",u.tabHeaders[t].className="active"));u.reposition()}};this.tabHeaders[s].observe("click",a(s)),this.tabTop.insert(this.tabHeaders[s])}var f=(new Element("div",{"class":"tabholder"})).insert(this.tabTop).insert(this.form);this.menuBox.insert({bottom:f})}else this.singleTab=(new Element("div",{"class":"tabholder"})).insert(this.form),this.menuBox.insert({bottom:this.singleTab}),this.closeButton.addClassName("close-button-old"),this.form.addClassName("content");this.fieldMap={};var u=this;e.each(function(e){if(typeof u._generateField[e.type]=="function"){var t=u.form;e.tab&&u.tabs.hasOwnProperty(e.tab)&&(t=u.tabs[e.tab]),t.insert(u._generateField[e.type].call(u,e))}}),this.hide(),editor.getWorkspace().getWorkArea().insert(this.menuBox),this._onClickOutside=this._onClickOutside.bindAsEventListener(this),this._generatePickersAndSuggests(),this._updateDisorderColor=function(e,t){this.menuBox.select('.field-disorders li input[value="'+e+'"]').each(function(e){var n=e.up("li").down(".abnormality-color");n||(n=new Element("span",{"class":"abnormality-color"}),e.up("li").insert({top:n})),n.setStyle({background:t})})}.bind(this),document.observe("disorder:color",function(e){if(!e.memo||!e.memo.id||!e.memo.color)return;u._updateDisorderColor(e.memo.id,e.memo.color)}),this._updateGeneColor=function(e,t){this.menuBox.select('.field-candidate_genes li input[value="'+e+'"]').each(function(e){var n=e.up("li").down(".abnormality-color");n||(n=new Element("span",{"class":"abnormality-color"}),e.up("li").insert({top:n})),n.setStyle({background:t})})}.bind(this),document.observe("gene:color",function(e){if(!e.memo||!e.memo.id||!e.memo.color)return;u._updateGeneColor(e.memo.id,e.memo.color)})},_generatePickersAndSuggests:function(){this.form.select(".fuzzy-date").each(function(e){if(!e.__datePicker){var t=editor.getPreferencesManager().getConfigurationOption("dateEditFormat");e.__datePicker=new i(e,t)}}),this.form.select("input.suggest-omim").each(function(t){t.hasClassName("initialized")||(t._suggest=new PhenoTips.widgets.Suggest(t,{script:e.getOMIMServiceURL()+"&",queryProcessor:typeof PhenoTips.widgets.SolrQueryProcessor=="undefined"?null:new PhenoTips.widgets.SolrQueryProcessor({name:{wordBoost:20,phraseBoost:40},nameSpell:{wordBoost:50,phraseBoost:100,stubBoost:20},keywords:{wordBoost:2,phraseBoost:6,stubBoost:2},text:{wordBoost:1,phraseBoost:3,stubBoost:1},textSpell:{wordBoost:2,phraseBoost:5,stubBoost:2,stubTrigger:!0}},{"-nameSort":["\\**","\\+*","\\^*"]}),varname:"q",noresults:"No matching terms",json:!0,resultsParameter:"rows",resultId:"id",resultValue:"name",resultInfo:{},enableHierarchy:!1,fadeOnClear:!1,timeout:3e4,tooltip:"omim-disease-info",parentContainer:$("body")}),t.hasClassName("multi")&&typeof PhenoTips.widgets.SuggestPicker!="undefined"&&(t._suggestPicker=new PhenoTips.widgets.SuggestPicker(t,t._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0})),t.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(e){e.memo&&e.memo.suggest===t._suggest&&t._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-t._suggest.container.cumulativeOffset().top+"px"})}))}),this.form.select("input.suggest-ethnicity").each(function(e){if(!e.hasClassName("initialized")){var t=(new XWiki.Document("EthnicitySearch","PhenoTips")).getURL("get","outputSyntax=plain");e._suggest=new PhenoTips.widgets.Suggest(e,{script:t+"&json=true&",varname:"input",noresults:"No matching terms",resultsParameter:"rows",json:!0,resultId:"id",resultValue:"ethnicity",resultInfo:{},enableHierarchy:!1,fadeOnClear:!1,timeout:3e4,parentContainer:$("body")}),e.hasClassName("multi")&&typeof PhenoTips.widgets.SuggestPicker!="undefined"&&(e._suggestPicker=new PhenoTips.widgets.SuggestPicker(e,e._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0})),e.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(t){t.memo&&t.memo.suggest===e._suggest&&e._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-e._suggest.container.cumulativeOffset().top+"px"})})}}),this.form.select("input.suggest-genes").each(function(e){if(!e.hasClassName("initialized")){var t=(new XWiki.Document("GeneNameService","PhenoTips")).getURL("get","outputSyntax=plain");e._suggest=new PhenoTips.widgets.Suggest(e,{script:t+"&json=true&",varname:"q",noresults:"No matching terms",resultsParameter:"docs",json:!0,resultId:"symbol",resultValue:"symbol",resultInfo:{},enableHierarchy:!1,tooltip:"gene-info",fadeOnClear:!1,timeout:3e4,parentContainer:$("body")}),e.hasClassName("multi")&&typeof PhenoTips.widgets.SuggestPicker!="undefined"&&(e._suggestPicker=new PhenoTips.widgets.SuggestPicker(e,e._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0})),e.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(t){t.memo&&t.memo.suggest===e._suggest&&e._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-e._suggest.container.cumulativeOffset().top+"px"})})}}),this.form.select("input.suggest-hpo").each(function(e){if(!e.hasClassName("initialized")){var n=t.getServiceURL();e._suggest=new PhenoTips.widgets.Suggest(e,{script:n+"rows=100&",varname:"q",noresults:"No matching terms",json:!0,resultsParameter:"rows",resultId:"id",resultValue:"name",resultAltName:"synonym",resultCategory:"term_category",resultInfo:{},enableHierarchy:!1,resultParent:"is_a",tooltip:"phenotype-info",fadeOnClear:!1,timeout:3e4,parentContainer:$("body")}),e.hasClassName("multi")&&typeof PhenoTips.widgets.SuggestPicker!="undefined"&&(e._suggestPicker=new PhenoTips.widgets.SuggestPicker(e,e._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0})),e.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(t){t.memo&&t.memo.suggest===e._suggest&&e._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-e._suggest.container.cumulativeOffset().top+"px"})})}}),this.form.select("input.suggest-patients").each(function(e){if(!e.hasClassName("initialized")){var t=(new XWiki.Document("SuggestPatientsService","PhenoTips")).getURL("get","outputSyntax=plain")+"&permission=edit&";console.log("PatientSuggest URL: "+t),e._suggest=new PhenoTips.widgets.Suggest(e,{script:t,varname:"input",noresults:"No matching patients",json:!1,resultsParameter:"rs",resultId:"id",resultValue:"name",resultInfo:"info",enableHierarchy:!1,fadeOnClear:!1,timeout:3e4,parentContainer:$("body")}),e.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(t){t.memo&&t.memo.suggest===e._suggest&&e._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-e._suggest.container.cumulativeOffset().top+"px"})})}})},_generateEmptyField:function(e){var t=new Element("div",{"class":"field-box field-"+e.name}),n="field-name";e.type=="radio"&&(n+=" field-no-user-select");var r=(new Element("label",{"class":n})).update(e.label);return t.inputsContainer=new Element("div",{"class":"field-inputs"}),t.insert(r).insert(t.inputsContainer),this.fieldMap[e.name]={type:e.type,element:t,"default":e["default"]||"",crtValue:e["default"]||"","function":e["function"],inactive:!1},t},_attachFieldEventListeners:function(e,t,n){var r=this;t.each(function(t){e.observe(t,function(t){r._saveCursorPositionIfNecessary(e);if(r._updating)return;var n=r.targetNode;if(!n)return;r.fieldMap[e.name].crtValue=e._getValue&&e._getValue()[0];var i=r.fieldMap[e.name]["function"];if(n.getSummary()[e.name].value==r.fieldMap[e.name].crtValue)return;if(i.indexOf("set")==0&&typeof n[i]=="function"){var s={};s[i]=r.fieldMap[e.name].crtValue;var t={nodeID:n.getID(),properties:s};document.fire("pedigree:node:setproperty",t)}else{var s={};s[i]=r.fieldMap[e.name].crtValue;var t={nodeID:n.getID(),modifications:s};document.fire("pedigree:node:modify",t)}e.fire("pedigree:change")})})},_saveCursorPositionIfNecessary:function(e){this.__lastSelectedField=e.name,this.__lastNodeID=this.targetNode;if(e.type=="text"||document.selection&&e.type=="textarea")this.__lastCursorPosition=s.getCaretPosition(e)},_restoreCursorPositionIfNecessary:function(e){this.targetNode==this.__lastNodeID&&e.name==this.__lastSelectedField&&(e.type=="text"||document.selection&&e.type=="textarea")&&s.setCaretPosition(e,this.__lastCursorPosition)},update:function(e){e&&(this.targetNode=e),this.targetNode&&(this._updating=!0,this._setCrtData(this.targetNode.getSummary()),this.reposition(),delete this._updating)},_attachDependencyBehavior:function(e,t){if(t.dependency){var n=t.dependency.split(" ",3),r=this.fieldMap[n[0]].element;n[0]=this.form[n[0]],r.inputsContainer.insert(e.up()),this.fieldMap[e.name].element=r,this._updatedDependency(e,n),n[0].observe("pedigree:change",function(){this._updatedDependency(e,n),e.value=""}.bindAsEventListener(this))}},_updatedDependency:function(e,t){switch(t[1]){case"!=":e.disabled=t[0].value==t[2];break;default:e.disabled=t[0].value==t[2]}},_generateField:{radio:function(e){var t=this._generateEmptyField(e),n=e.columns?"field-values-"+e.columns+"-columns":"field-values";n+=" field-no-user-select";var r=new Element("div",{"class":n});t.inputsContainer.insert(r);var i=this,s=function(t){var n=(new Element("label",{"class":e.name+"_"+t.actual})).update(t.displayed);t.hasOwnProperty("columnshiftPX")&&n.setStyle({marginLeft:""+t.columnshiftPX+"px"});var s=new Element("input",{type:"radio",name:e.name,value:t.actual});n.insert({top:s}),s._getValue=function(){return[this.value]}.bind(s),r.insert(n),i._attachFieldEventListeners(s,["click"]),i._attachDependencyBehavior(s,e)};return e.hasOwnProperty("valuesIE9")&&navigator&&navigator.appVersion.indexOf("MSIE 9")!=-1?e.valuesIE9.each(s):e.values.each(s),t},checkbox:function(e){var t=this._generateEmptyField(e),n=new Element("input",{type:"checkbox",name:e.name,value:"1"});return t.down("label").insert({top:n}),n._getValue=function(){return[this.checked]}.bind(n),this._attachFieldEventListeners(n,["click"]),t},text:function(e){var t=this._generateEmptyField(e),n=new Element("input",{type:"text",name:e.name});return e.tip&&(n.placeholder=e.tip),t.inputsContainer.insert(n),n.wrap("span"),n._getValue=function(){return[this.value]}.bind(n),this._attachFieldEventListeners(n,["keyup"],[!0]),this._attachDependencyBehavior(n,e),t},textarea:function(e){var t=this._generateEmptyField(e),n={name:e.name};n["class"]="textarea-"+e.rows+"-rows";var r=new Element("textarea",n);return t.inputsContainer.insert(r),r._getValue=function(){return[this.value]}.bind(r),this._attachFieldEventListeners(r,["keyup"],[!0]),this._attachDependencyBehavior(r,e),t},"date-picker":function(e){var t=this._generateEmptyField(e),r=new Element("input",{type:"text","class":"fuzzy-date",name:e.name,title:e.format||"",alt:""});return t.inputsContainer.insert(r),r._getValue=function(){return[new n(JSON.parse(this.value))]}.bind(r),this._attachFieldEventListeners(r,["xwiki:date:changed"]),t},"disease-picker":function(t){var n=this._generateEmptyField(t),r=new Element("input",{type:"text","class":"suggest multi suggest-omim",name:t.name});n.insert(r),r._getValue=function(){var n=[],r=this.up(".field-box");return r&&r.select("input[type=hidden][name="+t.name+"]").each(function(t){n.push(new e(t.value,t.next(".value")&&t.next(".value").firstChild.nodeValue||t.value))}),[n]}.bind(r);var i=this;return document.observe("custom:selection:changed",function(e){e.memo&&e.memo.fieldName==t.name&&e.memo.trigger&&e.findElement()!=e.memo.trigger&&!e.memo.trigger._silent&&(Event.fire(e.memo.trigger,"custom:selection:changed"),i.reposition())}),this._attachFieldEventListeners(r,["custom:selection:changed"]),n},"ethnicity-picker":function(e){var t=this._generateEmptyField(e),n=new Element("input",{type:"text","class":"suggest multi suggest-ethnicity",name:e.name});t.insert(n),n._getValue=function(){var t=[],n=this.up(".field-box");return n&&n.select("input[type=hidden][name="+e.name+"]").each(function(e){t.push(e.next(".value")&&e.next(".value").firstChild.nodeValue||e.value)}),[t]}.bind(n);var r=this;return document.observe("custom:selection:changed",function(t){t.memo&&t.memo.fieldName==e.name&&t.memo.trigger&&t.findElement()!=t.memo.trigger&&!t.memo.trigger._silent&&(Event.fire(t.memo.trigger,"custom:selection:changed"),r.reposition())}),this._attachFieldEventListeners(n,["custom:selection:changed"]),t},"hpo-picker":function(e){var n=this._generateEmptyField(e),r=new Element("input",{type:"text","class":"suggest multi suggest-hpo",name:e.name});n.insert(r),r._getValue=function(){var n=[],r=this.up(".field-box");return r&&r.select("input[type=hidden][name="+e.name+"]").each(function(e){n.push(new t(e.value,e.next(".value")&&e.next(".value").firstChild.nodeValue||e.value))}),[n]}.bind(r);var i=this;return document.observe("custom:selection:changed",function(t){t.memo&&t.memo.fieldName==e.name&&t.memo.trigger&&t.findElement()!=t.memo.trigger&&!t.memo.trigger._silent&&(Event.fire(t.memo.trigger,"custom:selection:changed"),i.reposition())}),this._attachFieldEventListeners(r,["custom:selection:changed"]),n},"phenotipsid-picker":function(e){var t=this._generateEmptyField(e),n=new Element("input",{type:"text","class":"suggest multi suggest-patients",name:e.name});t.insert(n),n._getValue=function(){var t=[],n=this.up(".field-box");return n&&n.select("input[type=hidden][name="+e.name+"]").each(function(e){t.push(e.next(".value")&&e.next(".value").firstChild.nodeValue||e.value)}),[t]}.bind(n);var r=this;return document.observe("custom:selection:changed",function(t){t.memo&&t.memo.fieldName==e.name&&t.memo.trigger&&t.findElement()!=t.memo.trigger&&!t.memo.trigger._silent&&(Event.fire(t.memo.trigger,"custom:selection:changed"),r.reposition())}),this._attachFieldEventListeners(n,["custom:selection:changed"]),t},"gene-picker":function(e){var t=this._generateEmptyField(e),n=new Element("input",{type:"text","class":"suggest multi suggest-genes",name:e.name});t.insert(n),n._getValue=function(){var t=[],n=this.up(".field-box");return n&&n.select("input[type=hidden][name="+e.name+"]").each(function(e){t.push(e.next(".value")&&e.next(".value").firstChild.nodeValue||e.value)}),[t]}.bind(n);var r=this;return document.observe("custom:selection:changed",function(t){t.memo&&t.memo.fieldName==e.name&&t.memo.trigger&&t.findElement()!=t.memo.trigger&&!t.memo.trigger._silent&&(Event.fire(t.memo.trigger,"custom:selection:changed"),r.reposition())}),this._attachFieldEventListeners(n,["custom:selection:changed"]),t},select:function(e){var t=this._generateEmptyField(e),n=new Element("span"),r='<select name="'+e.name+'">',i=function(e){r+='<option value="'+e.actual+'">'+e.displayed+"</option>"};return e.nullValue&&i({actual:"",displayed:"-"}),e.values?e.values.each(i):e.range&&$A($R(e.range.start,e.range.end)).each(function(t){i({actual:t,displayed:t+" "+e.range.item[+(t!=1)]})}),r+="</select>",n.innerHTML=r,select=n.firstChild,t.inputsContainer.insert(n),select._getValue=function(){return[this.selectedIndex>=0&&this.options[this.selectedIndex].value||""]}.bind(select),this._attachFieldEventListeners(select,["change"]),t},cancerlist:function(e){var t=this._generateEmptyField(e),n=editor.getCancerLegend()._getAllSupportedCancers(),i=new Element("div",{"class":"cancer_field cancer-header"}),s=(new Element("label",{"class":"cancer_label_field"})).update("Name"),o=(new Element("label",{"class":"cancer_status_select"})).update("Status"),u=(new Element("label",{"class":""})).update("Age at diagnosis");i.insert(s).insert(o).insert(u),t.inputsContainer.insert(i);var a=new Element("span"),f='<select name="'+e.name+'"><option value=""></option>',l=100;for(var c=1;c<=l;c++){if(c%10==0||c==1)f+='<option value="before_'+c+'">before age '+c+"</option>";f+='<option value="'+c+'">at age '+c+"</option>"}f+='<option value="after_'+l+'">after age '+l+"</option></select>",a.innerHTML=f;var h=new Element("span");h.innerHTML="<select name='"+e.name+"' class='cancer_status_select'>"+"<option value=''>Not tested</option>"+"<option value='affected'>Affected</option>"+"<option value='unaffected'>Unaffected</option></select>";var p=[];for(var d=0;d<n.length;d++){var v=n[d],i=new Element("div",{"class":"cancer_field"}),m=(new Element("label",{"class":"cancer_label_field"})).update(v),g=a.cloneNode(!0),y=g.firstChild;y.disable(),y.id="cancer_age_"+v;var b=h.cloneNode(!0),w=b.firstChild;w.id="cancer_status_"+v,p.push({name:v,status:w,age:y}),w._getValue=function(){var e={};for(var t=0;t<p.length;t++){var n=p[t],i=n.status.selectedIndex>=0?n.status.options[n.status.selectedIndex].value:"",s=n.age.selectedIndex>=0?n.age.options[n.age.selectedIndex].value:"";if(i&&i!=""){var o=i=="affected"?!0:!1,u=0;if(r.isInt(s))u=parseInt(s);else{var a=s.match(/before_(\d+)/);a&&(u=a[1]-5,u<0&&(u=0));var f=s.match(/after_(\d+)/);f&&(u=f[1])}e[n.name]={affected:o,ageAtDiagnosis:s,numericAgeAtDiagnosis:u}}}return[e]},y._getValue=w._getValue,this._attachFieldEventListeners(w,["change"]),this._attachFieldEventListeners(y,["change"]);var E=function(e,t){return function(){e.selectedIndex>0?t.enable():(t.selectedIndex=0,t.disable())}},S=["change"];browser.isGecko&&S.push("keyup"),S.each(function(e){var t=E(w,y);w.observe(e,function(){t()})}),i.insert(m).insert(b).insert(g),t.inputsContainer.insert(i)}return t},hidden:function(e){var t=this._generateEmptyField(e);t.addClassName("hidden");var n=new Element("input",{type:"hidden",name:e.name,value:""});return t.update(n),t}},show:function(e,t,n){this._onscreen=!0,this.targetNode=e,this._setCrtData(e.getSummary()),this.menuBox.show(),this.reposition(t,n),document.observe("mousedown",this._onClickOutside)},hide:function(){this.hideSuggestPicker(),this._onscreen=!1,document.stopObserving("mousedown",this._onClickOutside),this.targetNode&&(this.targetNode.onWidgetHide(),delete this.targetNode),this.menuBox.hide(),this._clearCrtData()},hideSuggestPicker:function(){this.form.select("input.suggest").each(function(e){e._suggest&&e._suggest.clearSuggestions()})},isVisible:function(){return this._onscreen},_onClickOutside:function(e){e.findElement(".suggestItems")||this.hideSuggestPicker(),!e.findElement(".menu-box")&&!e.findElement(".suggestItems")&&this.hide()},reposition:function(e,t){e=Math.floor(e);if(e!==undefined&&isFinite(e)){if(this.canvas&&e+this.menuBox.getWidth()>this.canvas.getWidth()+10){var n=e+this.menuBox.getWidth()-this.canvas.getWidth();editor.getWorkspace().panByX(n,!0),e-=n}this.menuBox.style.left=e+"px"}this.menuBox.style.height="";var r="",i="";if(t!==undefined&&isFinite(t))t=Math.floor(t);else if(this.menuBox.style.top.length>0)try{t=parseInt(this.menuBox.style.top.match(/^(\d+)/g)[0])}catch(s){}if(t===undefined||!isFinite(t)||t<0)t=0;if(this.canvas&&this.menuBox.getHeight()>=this.canvas.getHeight()-1)i=0,r=this.canvas.getHeight()-1+"px";else if(this.canvas.getHeight()<t+this.menuBox.getHeight()+1){var o=t+this.menuBox.getHeight()-this.canvas.getHeight()+1,u=t-o;u<0?(i=0,r=this.canvas.getHeight()-1+"px"):(i=u+"px",r="")}else i=t+"px",r="";this.menuBox.style.top=i,this.menuBox.style.height=r,this.menuBox.style.overflow="auto"},_clearCrtData:function(){var e=this;Object.keys(this.fieldMap).each(function(t){e.fieldMap[t].crtValue=e.fieldMap[t]["default"],e._setFieldValue[e.fieldMap[t].type].call(e,e.fieldMap[t].element,e.fieldMap[t].crtValue),e.fieldMap[t].inactive=!1})},_setCrtData:function(e){var t=this;Object.keys(this.fieldMap).each(function(n){t.fieldMap[n].crtValue=e&&e[n]&&typeof e[n].value!="undefined"?e[n].value:t.fieldMap[n].crtValue||t.fieldMap[n]["default"],t.fieldMap[n].inactive=e&&e[n]&&(typeof e[n].inactive=="boolean"||typeof e[n].inactive=="object")?e[n].inactive:t.fieldMap[n].inactive,t.fieldMap[n].disabled=e&&e[n]&&(typeof e[n].disabled=="boolean"||typeof e[n].disabled=="object")?e[n].disabled:t.fieldMap[n].disabled,t._setFieldValue[t.fieldMap[n].type].call(t,t.fieldMap[n].element,t.fieldMap[n].crtValue),t._setFieldInactive[t.fieldMap[n].type].call(t,t.fieldMap[n].element,t.fieldMap[n].inactive),t._setFieldDisabled[t.fieldMap[n].type].call(t,t.fieldMap[n].element,t.fieldMap[n].disabled)})},_setFieldValue:{radio:function(e,t){var n=e.down("input[type=radio][value="+t+"]");n&&(n.checked=!0)},checkbox:function(e,t){var n=e.down("input[type=checkbox]");n&&(n.checked=t)},text:function(e,t){var n=e.down("input[type=text]");n&&(n.value=t),this._restoreCursorPositionIfNecessary(n)},textarea:function(e,t){var n=e.down("textarea");n&&(n.value=t),this._restoreCursorPositionIfNecessary(n)},"date-picker":function(e,t){t||(t={decade:"",year:"",month:"",day:""});var n="",r="",i="";t.decade&&!t.year?n=t.decade:t.year&&(n=t.year.toString());var s=editor.getPreferencesManager().getConfigurationOption("dateEditFormat")=="DMY";(s||t.year)&&t.month&&(r=t.month.toString()),(s||t.year&&t.month)&&t.day&&(i=t.day.toString());var o=!1,u=e.down("select.year");if(u){var a=u.down("option[value="+n+"]");a||(a=(new Element("option",{value:n})).update(n.toString()),u.insert(a)),a&&!a.selected&&(a.selected=!0,o=!0)}var f=e.down("select.month");if(f){var a=f.down("option[value="+r+"]");a&&!a.selected&&(a.selected=!0,o=!0)}var l=e.down("select.day");if(l){var a=l.down("option[value="+i+"]");a&&!a.selected&&(a.selected=!0,o=!0)}if(o){var c=e.down(".fuzzy-date-picker");c&&Event.fire(c,"datepicker:date:changed")}},"disease-picker":function(e,t){var n=this,r=e.down("input[type=text].suggest-omim");r&&r._suggestPicker&&(r._silent=!0,r._suggestPicker.clearAcceptedList(),t&&t.each(function(e){r._suggestPicker.addItem(e.id,e.value,""),n._updateDisorderColor(e.id,editor.getDisorderLegend().getObjectColor(e.id))}),r._silent=!1)},"ethnicity-picker":function(e,t){var n=this,r=e.down("input[type=text].suggest-ethnicity");r&&r._suggestPicker&&(r._silent=!0,r._suggestPicker.clearAcceptedList(),t&&t.each(function(e){r._suggestPicker.addItem(e,e,"")}),r._silent=!1)},"hpo-picker":function(e,t){var n=this,r=e.down("input[type=text].suggest-hpo");r&&r._suggestPicker&&(r._silent=!0,r._suggestPicker.clearAcceptedList(),t&&t.each(function(e){r._suggestPicker.addItem(e.id,e.value,"")}),r._silent=!1)},"gene-picker":function(e,t){var n=this,r=e.down("input[type=text].suggest-genes");r&&r._suggestPicker&&(r._silent=!0,r._suggestPicker.clearAcceptedList(),t&&t.each(function(e){r._suggestPicker.addItem(e,e,""),n._updateGeneColor(e,editor.getGeneLegend().getObjectColor(e))}),r._silent=!1)},"phenotipsid-picker":function(e,t){var n=this,r=e.down("input[type=text].suggest-genes");r&&r._suggestPicker&&(r._silent=!0,r._suggestPicker.clearAcceptedList(),t&&t.each(function(e){r._suggestPicker.addItem(e,e,"")}),r._silent=!1)},select:function(e,t){var n=e.down("select option[value="+t+"]");n&&(n.selected="selected")},cancerlist:function(e,t){var n=editor.getCancerLegend()._getAllSupportedCancers();for(var r=0;r<n.length;r++){var i=n[r],s=e.down('select[id="cancer_status_'+i+'"]'),o=e.down('select[id="cancer_age_'+i+'"]');if(!s){alert("This patient is reported to have an unsupported cancer '"+i+"'");continue}if(t.hasOwnProperty(i)){if(t[i].hasOwnProperty("affected")&&t[i].affected)var u=s.down('option[value="affected"]');else var u=s.down('option[value="unaffected"]');if(t[i].hasOwnProperty("ageAtDiagnosis"))var a=o.down('option[value="'+t[i].ageAtDiagnosis+'"]');else var a=o.down('option[value=""]');o.enable()}else{var u=s.down('option[value=""]'),a=o.down('option[value=""]');o.disable()}u&&(u.selected="selected"),a&&(a.selected="selected")}},hidden:function(e,t){var n=e.down("input[type=hidden]");n&&(n.value=t)}},_toggleFieldVisibility:function(e,t){t?e.addClassName("hidden"):e.removeClassName("hidden")},_setFieldInactive:{radio:function(e,t){t===!0?e.addClassName("hidden"):(e.removeClassName("hidden"),e.select("input[type=radio]").each(function(e){if(t&&Object.prototype.toString.call(t)==="[object Array]"){var n=t.indexOf("disableViaOpacity")>=0;t.indexOf(e.value)>=0?(e.disable(),n?Element.setOpacity(e.up(),0):e.up().addClassName("hidden")):(e.enable(),n?Element.setOpacity(e.up(),1):e.up().removeClassName("hidden"))}else t||(e.enable(),Element.setOpacity(e.up(),1),e.up().removeClassName("hidden"))}))},checkbox:function(e,t){this._toggleFieldVisibility(e,t)},text:function(e,t){this._toggleFieldVisibility(e,t)},textarea:function(e,t){this._toggleFieldVisibility(e,t)},"date-picker":function(e,t){this._toggleFieldVisibility(e,t)},"disease-picker":function(e,t){this._toggleFieldVisibility(e,t)},"ethnicity-picker":function(e,t){this._toggleFieldVisibility(e,t)},"hpo-picker":function(e,t){this._toggleFieldVisibility(e,t)},"gene-picker":function(e,t){this._toggleFieldVisibility(e,t)},"phenotipsid-picker":function(e,t){this._toggleFieldVisibility(e,t)},select:function(e,t){t===!0?e.addClassName("hidden"):(e.removeClassName("hidden"),e.select("option").each(function(e){t&&Object.prototype.toString.call(t)==="[object Array]"?t.indexOf(e.value)>=0?e.addClassName("hidden"):e.removeClassName("hidden"):t||e.removeClassName("hidden")}))},cancerlist:function(e,t){this._toggleFieldVisibility(e,t)},hidden:function(e,t){this._toggleFieldVisibility(e,t)}},_setFieldDisabled:{radio:function(e,t){t&&Object.prototype.toString.call(t)==="[object Array]"&&e.select("input[type=radio]").each(function(e){e.disabled=t.indexOf(e.value)>=0})},checkbox:function(e,t){var n=e.down("input[type=checkbox]");n&&(n.disabled=t)},text:function(e,t){var n=e.down("input[type=text]");n&&(n.disabled=t)},textarea:function(e,t){},"date-picker":function(e,t){},"disease-picker":function(e,t){},"ethnicity-picker":function(e,t){},"hpo-picker":function(e,t){},"gene-picker":function(e,t){},"phenotipsid-picker":function(e,t){},select:function(e,t){},cancerlist:function(e,t){},hidden:function(e,t){}}}),NodeMenu}),define("pedigree/view/nodetypeSelectionBubble",[],function(){var e=Class.create({buttonsDefs:[{key:"M",type:"person",label:"Male",tip:"Create a person of male gender",symbol:"<span></span>",cssclass:"square",callback:"CreateChild",params:{parameters:{gender:"M"}},inSiblingMode:!0},{key:"F",type:"person",label:"Female",tip:"Create a person of female gender",symbol:"<span></span>",cssclass:"circle",callback:"CreateChild",params:{parameters:{gender:"F"}},inSiblingMode:!0},{key:"O",type:"person",label:"Other",tip:"Create a person of other gender",symbol:"<span></span>",cssclass:"diamond",callback:"CreateChild",params:{parameters:{gender:"O"}},inSiblingMode:!0},{key:"U",type:"person",label:"Unknown",tip:"Create a person of unknown gender",symbol:"<span></span>",cssclass:"diamond",callback:"CreateChild",params:{parameters:{gender:"U"}},inSiblingMode:!0},{key:"P",type:"person",label:"Pregnancy",tip:"Create a pregnancy",symbol:"<span></span><strong>P</strong>",cssclass:"diamond text-in-middle",callback:"CreateChild",params:{parameters:{lifeStatus:"unborn"}},inSiblingMode:!0},{key:"T",type:"person",label:"Twins",tip:"Create twins (expandable to triplets or more)",symbol:"",cssclass:"",callback:"CreateChild",params:{twins:!0,parameters:{gender:"U"}},expandsTo:"expandTwins",inSiblingMode:!0},{key:"m",type:"person",label:"Multiple",tip:"Create a node representing multiple siblings",symbol:"<span></span><strong>n</strong>",cssclass:"diamond text-in-middle",callback:"CreateChild",params:{group:!0},expandsTo:"expandPersonGroup",inSiblingMode:!0},{type:"separator"},{key:"n",type:"marker",label:"No children",tip:"Mark as childless by choice",symbol:"",cssclass:"",callback:"setProperty",params:{setChildlessStatus:"childless"},inSiblingMode:!1},{key:"i",type:"marker",label:"Infertile",tip:"Mark as infertile",symbol:"",cssclass:"",callback:"setProperty",params:{setChildlessStatus:"infertile"},inSiblingMode:!1}],initialize:function(e){this._siblingMode=e,this.element=new Element("div",{"class":"callout"}),this.element.insert(new Element("span",{"class":"callout-handle"}));var t=new Element("div",{"class":"node-type-options field-no-user-select"});this.expandedOptionsContainer=new Element("div",{"class":"node-type-options-extended field-no-user-select"}),this.element.insert(t),this.element.insert(this.expandedOptionsContainer);var n=this;this.buttonsDefs.each(function(r){(!e||r.hasOwnProperty("inSiblingMode")&&r.inSiblingMode)&&t.insert(r.type=="separator"?n._generateSeparator():n._createOption(r))}),this.element.hide(),editor.getWorkspace().getWorkArea().insert(this.element),this._onClickOutside=this._onClickOutside.bindAsEventListener(this),this.resetParameters()},resetParameters:function(){this.numPersonsInGroup=1,this.numTwinNodes=2},_createOption:function(e){var t=1;if(!e)return null;var n=typeof this[e.expandsTo]=="function"?"expandable-":"",r=(new Element("a",{"class":e.cssclass+" "+n+"node-type-option "+(e.type||"")+"-type-option node-type-"+e.key,title:e.tip,href:"#"})).update(e.symbol),i=this;r.observe("click",function(t){t.stop();if(!i._node)return;console.log("observe nodetype click: "+e.callback);if(e.callback=="setProperty"){var t={nodeID:i._node.getID(),properties:e.params};document.fire("pedigree:node:setproperty",t)}else e.callback=="CreateChild"&&i.handleCreateAction(e);i.hide()});var s=new Element("span");return s.insert(r),n&&s.insert(this.generateExpandArrow(e)),s},handleCreateAction:function(e){var t=this._node.getID(),n=this._node.getType();if(n=="Person"){var r={personID:t,childParams:e.params.parameters,preferLeft:!1};e.params.twins&&(r.twins=this.numTwinNodes),e.params.group&&(r.groupSize=this.numPersonsInGroup),this._siblingMode?document.fire("pedigree:person:newsibling",r):document.fire("pedigree:person:newpartnerandchild",r)}else if(n=="Partnership"){var r={partnershipID:t,childParams:e.params.parameters};e.params.twins&&(r.twins=this.numTwinNodes),e.params.group&&(r.groupSize=this.numPersonsInGroup),document.fire("pedigree:partnership:newchild",r)}this.hide()},generateExpandArrow:function(e){var t=(new Element("span",{"class":"expand-arrow collapsed",title:"show more options",href:"#"})).update("");return t.expand=function(){$$(".expand-arrow").forEach(function(e){e.collapse()}),this[e.expandsTo](e),t.update(""),Element.removeClassName(t,"collapsed")}.bind(this),t.collapse=function(){this.expandedOptionsContainer.update(""),t.update(""),Element.addClassName(t,"collapsed")}.bind(this),t.observe("click",function(){console.log("observe2"),t.hasClassName("collapsed")?t.expand():t.collapse()}),t},_generateSeparator:function(){return(new Element("span",{"class":"separator"})).update(" | ")},_positionAt:function(e,t){t=Math.round(t),t+this.element.getHeight()>editor.getWorkspace().getWorkArea().getHeight()&&(this.element.addClassName("upside"),t=Math.round(t-this.element.getHeight())),this.element.style.top=t+"px";var n=Math.round(this.element.getWidth()/2);e-n+this.element.getWidth()>editor.getWorkspace().getWorkArea().getWidth()?n=Math.round(this.element.getWidth()-(editor.getWorkspace().getWorkArea().getWidth()-e)):n>e&&(n=Math.round(e)),this.element.down(".callout-handle").style.left=n+"px",this.element.style.left=Math.round(e-n)+"px"},show:function(e,t,n){this._node=e;if(!this._node)return;this._node.onWidgetShow(),this.element.show(),this.expandedOptionsContainer.update(""),this._positionAt(t,n),document.observe("mousedown",this._onClickOutside)},hide:function(){document.stopObserving("mousedown",this._onClickOutside),$$(".expand-arrow").forEach(function(e){e.collapse()}),this._node&&(this._node.onWidgetHide(),delete this._node,this.element.select(".node-type-option").invoke("show"),this.element.removeClassName("upside")),this.element.hide(),this.resetParameters()},_onClickOutside:function(e){e.findElement(".callout")||this.hide()},_decrementNumNodes:function(){return this.numPersonsInGroup>1?--this.numPersonsInGroup:this.numPersonsInGroup},_incrementNumNodes:function(){return this.numPersonsInGroup<9?++this.numPersonsInGroup:this.numPersonsInGroup},_decrementNumTwins:function(){return this.numTwinNodes>2?--this.numTwinNodes:this.numTwinNodes},_incrementNumTwins:function(){return this.numTwinNodes<9?++this.numTwinNodes:this.numTwinNodes},expandPersonGroup:function(e){var t=this,n=function(){var e=t.numPersonsInGroup>1?String(t.numPersonsInGroup):"n";return'<svg version="1.1" viewBox="0.0 0.0 100.0 100.0" width=50 height=50 fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><clipPath id="p.0"><path d="m0 0l960.0 0l0 720.0l-960.0 0l0 -720.0z" clip-rule="nonzero"></path></clipPath><g clip-path="url(#p.0)"><path fill="#000000" fill-opacity="0.0" d="m0 0l960.0 0l0 720.0l-960.0 0z" fill-rule="nonzero"></path><path fill="#cfe2f3" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path stroke="#000000" stroke-width="2.0" stroke-linejoin="round" stroke-linecap="butt" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path fill="#000000" fill-opacity="0.0" d="m20.661417 22.068241l58.204727 0l0 48.000004l-58.204727 0z" fill-rule="nonzero"></path></g><desc>Number of children</desc><text x="35" y="60" font-family="Verdana" font-size="40" fill="black">'+e+"</text></svg>"},r=new Element("input",{type:"button",value:"create","class":"button"}),i=(new Element("span")).update(n()),s=(new Element("span",{"class":"minus-button value-control-button"})).update("-"),o=(new Element("span",{"class":"plus-button value-control-button"})).update("+");s.observe("click",function(){t._decrementNumNodes(),i.update(n())}),o.observe("click",function(){t._incrementNumNodes(),i.update(n())}),r.observe("click",function(){t.handleCreateAction(e)}),this.expandedOptionsContainer.insert(s),this.expandedOptionsContainer.insert(i),this.expandedOptionsContainer.insert(o),this.expandedOptionsContainer.insert(r)},expandTwins:function(e){var t=this,n=function(){var e=t._siblingMode&&t._node.getType()!="Partnership",n=e?t.numTwinNodes-1:t.numTwinNodes;return'<svg version="1.1" viewBox="0.0 0.0 100.0 100.0" width=50 height=50 fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><clipPath id="p.0"><path d="m0 0l960.0 0l0 720.0l-960.0 0l0 -720.0z" clip-rule="nonzero"></path></clipPath><g clip-path="url(#p.0)"><path fill="#000000" fill-opacity="0.0" d="m0 0l960.0 0l0 720.0l-960.0 0z" fill-rule="nonzero"></path><path fill="#cfe2f3" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path stroke="#000000" stroke-width="2.0" stroke-linejoin="round" stroke-linecap="butt" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path fill="#000000" fill-opacity="0.0" d="m20.661417 22.068241l58.204727 0l0 48.000004l-58.204727 0z" fill-rule="nonzero"></path></g><desc>Number of children</desc><text x="35" y="60" font-family="Verdana" font-size="40" fill="black">'+n+"</text></svg>"};if(this._siblingMode)var r=new Element("input",{type:"button",value:"add twins","class":"button"});else var r=new Element("input",{type:"button",value:"create twins","class":"button"});var i=(new Element("span")).update(n()),s=(new Element("span",{"class":"minus-button value-control-button"})).update("-"),o=(new Element("span",{"class":"plus-button value-control-button"})).update("+");s.observe("click",function(){t._decrementNumTwins(),i.update(n())}),o.observe("click",function(){t._incrementNumTwins(),i.update(n())}),r.observe("click",function(){t.handleCreateAction(e)}),this.expandedOptionsContainer.insert(s),this.expandedOptionsContainer.insert(i),this.expandedOptionsContainer.insert(o),this.expandedOptionsContainer.insert(r)}});return e}),define("pedigree/view/okCancelDialogue",[],function(){var e=Class.create({initialize:function(){var e=this;this._onButtonActions=[undefined,undefined,undefined],this._buttons=[undefined,undefined,undefined];var t=new Element("div",{"class":"ok-cancel-dialogue"});this._promptBody=new Element("div",{"class":"ok-cancel-body"}),t.insert(this._promptBody),this._buttons[0]=new Element("input",{type:"button",name:"ok",value:"OK","class":"button min-width80px",id:"OK_button"}),this._buttons[1]=new Element("input",{type:"button",name:"cancel",value:"Cancel","class":"button secondary min-width80px"}),this._buttons[2]=new Element("input",{type:"button",name:"other",value:"Other","class":"button secondary min-width80px"});var n=new Element("div",{"class":"buttons import-block-bottom"});for(var r=0;r<this._buttons.length;r++)n.insert(this._buttons[r].wrap("span",{"class":"buttonwrapper"})),this._buttons[r].index=r,this._buttons[r].observe("click",function(t){e.hide(),e._onButtonActions[this.index]&&e._onButtonActions[this.index]()});t.insert(n);var i=["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(t,{close:{method:this.hide.bind(this),keys:i}},{extraClassName:"pedigree-okcancel",title:"?",displayCloseButton:!1})},show:function(e,t,n,r){this.showCustomized(e,t,"OK",n,"Cancel",r)},showCustomized:function(e,t,n,r,i,s,o,u,a){this._configButton(0,n,r),this._configButton(1,i,s),this._configButton(2,o,u,a),this._promptBody.update(e),this.dialog.show(),this.dialog.dialogBox.down("div.msdialog-title").update(t)},hide:function(){this.dialog.closeDialog()},_configButton:function(e,t,n,r){!t||t==""?this._buttons[e].hide():(this._buttons[e].show(),this._buttons[e].writeAttribute("value",t),this._onButtonActions[e]=n),r?this._buttons[e].setStyle({marginLeft:"-200px",marginRight:"10px","float":"right"}):this._buttons[e].setStyle({marginLeft:"0px",marginRight:"0px","float":"none"})}});return e}),define("pedigree/view/saveLoadIndicator",[],function(){var e=Class.create({initialize:function(){var e=this,t=new Element("div",{"class":"load-status-container"});this._isHidden=!0,this.dialog=new PhenoTips.widgets.ModalPopup(t,!1,{extraClassName:"loading-indicator",displayCloseButton:!1}),document.observe("pedigree:load:start",function(t){e._isHidden&&e.show()}),document.observe("pedigree:load:finish",function(t){e._isHidden||e.hide()})},show:function(){this.dialog.show(),this._isHidden=!1},hide:function(){this.dialog.close(),this._isHidden=!0}});return e}),define("pedigree/pedigree",["pedigree/undoRedoManager","pedigree/controller","pedigree/pedigreeEditorParameters","pedigree/preferencesManager","pedigree/probandDataLoader","pedigree/saveLoadEngine","pedigree/versionUpdater","pedigree/view","pedigree/model/dynamicGraph","pedigree/model/helpers","pedigree/view/workspace","pedigree/view/disorderLegend","pedigree/view/exportSelector","pedigree/view/geneLegend","pedigree/view/hpoLegend","pedigree/view/importSelector","pedigree/view/cancersLegend","pedigree/view/nodeMenu","pedigree/view/nodetypeSelectionBubble","pedigree/view/okCancelDialogue","pedigree/view/saveLoadIndicator","pedigree/view/templateSelector"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E){var S=Class.create({initialize:function(){window.editor=this,this._defaultPreferences={global:{nonStandardAdoptedOutGraphic:!1,propagateFatherLastName:!0,dateDisplayFormat:"YMD",dateEditFormat:"YMD"},user:{hideDraggingHint:!1},pedigree:{}},this._preferencesManager=new r(this._defaultPreferences),this._graphModel=a.makeEmpty(n.attributes.layoutRelativePersonWidth,n.attributes.layoutRelativeOtherWidth),this._workspace=new l,this._disorderLegend=new c,this._geneLegend=new p,this._hpoLegend=new d,this._cancerLegend=new m,this._nodetypeSelectionBubble=new y(!1),this._siblingSelectionBubble=new y(!0),this._okCancelDialogue=new b,this._view=new u,this._actionStack=new e,this._templateSelector=new E,this._saveLoadIndicator=new w,this._versionUpdater=new o,this._saveLoadEngine=new s,this._probandData=new i,this._preferencesManager.load(function(){editor.getPreferencesManager().getConfigurationOption("useGradientOnNodes")?f.copyProperties(n.styles.gradient,n.attributes):f.copyProperties(n.styles.blackAndWhite,n.attributes),this._probandData.load(this._saveLoadEngine.load.bind(this._saveLoadEngine)),this._nodeMenu=this.generateNodeMenu(),this._nodeGroupMenu=this.generateNodeGroupMenu(),this._partnershipMenu=this.generatePartnershipMenu(),this._importSelector=new v,this._exportSelector=new h}.bind(this)),this._controller=new t;var g=$("action-undo");g&&g.on("click",function(e){document.fire("pedigree:undo")});var S=$("action-redo");S&&S.on("click",function(e){document.fire("pedigree:redo")});var x=$("action-layout");x&&x.on("click",function(e){document.fire("pedigree:autolayout")});var T=$("action-clear");T&&T.on("click",function(e){document.fire("pedigree:graph:clear")});var N=$("action-save");N&&N.on("click",function(e){editor.getSaveLoadEngine().save()});var C=$("action-reload");C&&C.on("click",function(e){editor.getSaveLoadEngine().load()});var k=$("action-templates");k&&k.on("click",function(e){editor.getTemplateSelector().show()});var L=$("action-import");L&&L.on("click",function(e){editor.getImportSelector().show()});var A=$("action-export");A&&A.on("click",function(e){editor.getExportSelector().show()});var O=function(){if(editor.getUndoRedoManager().hasUnsavedChanges())return"All changes will be lost when navigating away from this page."};window.onbeforeunload=O;var M=$("action-close");this._afterSaveFunc=null,M&&M.on("click",function(e){var t=function(){window.onbeforeunload=O},n=function(){window.location=XWiki.currentDocument.getURL(XWiki.contextaction)},r=function(){editor._afterSaveFunc=n,editor.getSaveLoadEngine().save()};editor.isReadOnlyMode()?n():(window.onbeforeunload=undefined,editor.getUndoRedoManager().hasUnsavedChanges()?editor.getOkCancelDialogue().showCustomized("There are unsaved changes, do you want to save the pedigree before closing the pedigree editor?","Save before closing?","Save",r,"Don't save",n,"Don't quit",t,!0):n())});var _=$("action-number");_&&_.on("click",function(e){document.fire("pedigree:renumber")});var D=$("action-readonlymessage");D&&D.on("click",function(e){alert("Your browser does not support all the features required for Pedigree Editor, so pedigree is displayed in read-only mode (and may have quirks).\n\nSupported browsers include Firefox v3.5+, Internet Explorer v9+, Chrome, Safari v4+, Opera v10.5+ and most mobile browsers.")})},getPreferencesManager:function(){return this._preferencesManager},getNode:function(e){return this.getView().getNode(e)},getView:function(){return this._view},getVersionUpdater:function(){return this._versionUpdater},getGraph:function(){return this._graphModel},getController:function(){return this._controller},getUndoRedoManager:function(){return this._actionStack},getAfterSaveAction:function(){return this._afterSaveFunc},getOkCancelDialogue:function(){return this._okCancelDialogue},getNodetypeSelectionBubble:function(){return this._nodetypeSelectionBubble},getSiblingSelectionBubble:function(){return this._siblingSelectionBubble},getWorkspace:function(){return this._workspace},getDisorderLegend:function(){return this._disorderLegend},getHPOLegend:function(){return this._hpoLegend},getGeneLegend:function(){return this._geneLegend},getCancerLegend:function(){return this._cancerLegend},getPaper:function(){return this.getWorkspace().getPaper()},isReadOnlyMode:function(){return this.isUnsupportedBrowser()?!0:!1},isUnsupportedBrowser:function(){return document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?window.JSON?!1:(alert("Your browser is not supported and is unable to load and display any pedigrees.\n\nSuported browsers include Internet Explorer version 9 and higher, Safari version 4 and higher, Firefox version 3.6 and higher, Opera version 10.5 and higher, any version of Chrome and most other modern browsers (including mobile). IE8 is able to display pedigrees in read-only mode."),window.stop&&window.stop(),!0):!0},getSaveLoadEngine:function(){return this._saveLoadEngine},getProbandDataFromPhenotips:function(){return this._probandData.probandData},getTemplateSelector:function(){return this._templateSelector},getImportSelector:function(){return this._importSelector},getExportSelector:function(){return this._exportSelector},isAnyMenuVisible:function(){if(this.getNodeMenu().isVisible()||this.getNodeGroupMenu().isVisible()||this.getPartnershipMenu().isVisible())return},generateNodeMenu:function(){if(this.isReadOnlyMode())return null;var e=this;return new g([{name:"identifier",label:"",type:"hidden",tab:"Personal"},{name:"gender",label:"Gender",type:"radio",tab:"Personal",columns:3,values:[{actual:"M",displayed:"Male"},{actual:"F",displayed:"Female"},{actual:"O",displayed:"Other"},{actual:"U",displayed:"Unknown"}],"default":"U","function":"setGender"},{name:"first_name",label:"First name",type:"text",tab:"Personal","function":"setFirstName"},{name:"last_name",label:"Last name",type:"text",tab:"Personal","function":"setLastName"},{name:"last_name_birth",label:"Last name at birth",type:"text",tab:"Personal","function":"setLastNameAtBirth"},{name:"external_id",label:"External ID",type:"text",tab:"Personal","function":"setExternalID"},{name:"ethnicity",label:"Ethnicities",type:"ethnicity-picker",tab:"Personal","function":"setEthnicities"},{name:"carrier",label:"Carrier status",type:"radio",tab:"Clinical",values:[{actual:"",displayed:"Not affected"},{actual:"carrier",displayed:"Carrier"},{actual:"uncertain",displayed:"Uncertain"},{actual:"affected",displayed:"Affected"},{actual:"presymptomatic",displayed:"Pre-symptomatic"}],"default":"","function":"setCarrierStatus"},{name:"disorders",label:"Known disorders of this individual",type:"disease-picker",tab:"Clinical","function":"setDisorders"},{name:"hpo_positive",label:"Clinical symptoms: observed phenotypes",type:"hpo-picker",tab:"Clinical","function":"setHPO"},{name:"candidate_genes",label:"Genotype information: candidate genes",type:"gene-picker",tab:"Clinical","function":"setGenes"},{name:"date_of_birth",label:"Date of birth",type:"date-picker",tab:"Personal","function":"setBirthDate"},{name:"date_of_death",label:"Date of death",type:"date-picker",tab:"Personal","function":"setDeathDate"},{name:"gestation_age",label:"Gestation age",type:"select",tab:"Personal",range:{start:0,end:50,item:["week","weeks"]},nullValue:!0,"function":"setGestationAge"},{name:"state",label:"Individual is",type:"radio",tab:"Personal",columns:3,valuesIE9:[{actual:"alive",displayed:"Alive"},{actual:"deceased",displayed:"Deceased"},{actual:"stillborn",displayed:"Stillborn"},{actual:"unborn",displayed:"Unborn"},{actual:"miscarriage",displayed:"Miscarried"},{actual:"aborted",displayed:"Elective abortion"}],values:[{actual:"alive",displayed:"Alive"},{actual:"stillborn",displayed:"Stillborn"},{actual:"deceased",displayed:"Deceased",columnshiftPX:-2},{actual:"miscarriage",displayed:"Miscarried",columnshiftPX:-2},{actual:"unborn",displayed:"Unborn",columnshiftPX:8},{actual:"aborted",displayed:"Aborted",columnshiftPX:8}],"default":"alive","function":"setLifeStatus"},{label:"Heredity options",name:"childlessSelect",values:[{actual:"none",displayed:"None"},{actual:"childless",displayed:"Childless"},{actual:"infertile",displayed:"Infertile"}],type:"select",tab:"Personal","function":"setChildlessStatus"},{name:"childlessText",type:"text",dependency:"childlessSelect != none",tip:"Reason",tab:"Personal","function":"setChildlessReason"},{name:"adopted",label:"Adopted status",type:"radio",tab:"Personal",columns:3,values:[{actual:"",displayed:"Not adopted"},{actual:"adoptedIn",displayed:"Adopted in"},{actual:"adoptedOut",displayed:"Adopted out"}],"default":"","function":"setAdopted"},{name:"monozygotic",label:"Monozygotic twin",type:"checkbox",tab:"Personal","function":"setMonozygotic"},{name:"nocontact",label:"Not in contact with proband",type:"checkbox",tab:"Personal","function":"setLostContact"},{name:"placeholder",label:"Placeholder node",type:"checkbox",tab:"Personal","function":"makePlaceholder"},{name:"comments",label:"Comments",type:"textarea",tab:"Clinical",rows:4,"function":"setComments"},{name:"evaluated",label:"Documented evaluation",type:"checkbox",tab:"Clinical","function":"setEvaluated"},{name:"cancers",label:"Common Cancers",type:"cancerlist",tab:"Cancers","function":"setCancers"}],["Personal","Clinical","Cancers"])},getNodeMenu:function(){return this._nodeMenu},generateNodeGroupMenu:function(){if(this.isReadOnlyMode())return null;var e=this;return new g([{name:"identifier",label:"",type:"hidden",tab:"Personal"},{name:"gender",label:"Gender",type:"radio",columns:3,values:[{actual:"M",displayed:"Male"},{actual:"F",displayed:"Female"},{actual:"O",displayed:"Other"},{actual:"U",displayed:"Unknown"}],"default":"U",tab:"Personal","function":"setGender"},{name:"numInGroup",label:"Number of persons in this group",type:"select",values:[{actual:1,displayed:"N"},{actual:2,displayed:"2"},{actual:3,displayed:"3"},{actual:4,displayed:"4"},{actual:5,displayed:"5"},{actual:6,displayed:"6"},{actual:7,displayed:"7"},{actual:8,displayed:"8"},{actual:9,displayed:"9"}],tab:"Personal","function":"setNumPersons"},{name:"external_ids",label:"External ID(s)",type:"text",tab:"Personal","function":"setExternalID"},{name:"ethnicity",label:"Ethnicities<br>(common to all individuals in the group)",type:"ethnicity-picker",tab:"Personal","function":"setEthnicities"},{name:"disorders",label:"Known disorders<br>(common to all individuals in the group)",type:"disease-picker",tab:"Clinical","function":"setDisorders"},{name:"comments",label:"Comments",type:"textarea",rows:4,tab:"Clinical","function":"setComments"},{name:"state",label:"All individuals in the group are",type:"radio",values:[{actual:"alive",displayed:"Alive"},{actual:"aborted",displayed:"Aborted electively"},{actual:"deceased",displayed:"Deceased"},{actual:"miscarriage",displayed:"Miscarried"}],"default":"alive",tab:"Personal","function":"setLifeStatus"},{name:"evaluatedGrp",label:"Documented evaluation",type:"checkbox",tab:"Clinical","function":"setEvaluated"},{name:"adopted",label:"Adopted status",type:"radio",tab:"Personal",columns:3,values:[{actual:"",displayed:"Not adopted"},{actual:"adoptedIn",displayed:"Adopted in"},{actual:"adoptedOut",displayed:"Adopted out"}],"default":"",tab:"Personal","function":"setAdopted"}],["Personal","Clinical"])},getNodeGroupMenu:function(){return this._nodeGroupMenu},generatePartnershipMenu:function(){if(this.isReadOnlyMode())return null;var e=this;return new g([{label:"Heredity options",name:"childlessSelect",values:[{actual:"none",displayed:"None"},{actual:"childless",displayed:"Childless"},{actual:"infertile",displayed:"Infertile"}],type:"select","function":"setChildlessStatus"},{name:"childlessText",type:"text",dependency:"childlessSelect != none",tip:"Reason","function":"setChildlessReason"},{name:"consangr",label:"Consanguinity of this relationship",type:"radio",values:[{actual:"A",displayed:"Automatic"},{actual:"Y",displayed:"Yes"},{actual:"N",displayed:"No"}],"default":"A","function":"setConsanguinity"},{name:"broken",label:"Separated",type:"checkbox","function":"setBrokenStatus"}],[],"relationship-menu")},getPartnershipMenu:function(){return this._partnershipMenu},convertGraphCoordToCanvasCoord:function(e,t){var r=n.attributes.layoutScale;return{x:e*r.xscale,y:t*r.yscale}},startAutoSave:function(e){setInterval(function(){editor.getSaveLoadEngine().save()},e*1e3)}});return S}),require(["pedigree/pedigree"],function(e){XWiki&&XWiki.domIsLoaded&&new e||document.observe("xwiki:dom:loaded",function(){new e})}),define("pedigreeApp",function(){});