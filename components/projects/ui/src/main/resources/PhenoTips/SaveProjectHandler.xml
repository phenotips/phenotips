<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>SaveProjectHandler</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1443127461000</creationDate>
  <parent>Main.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1443648267000</date>
  <contentUpdateDate>1443648267000</contentUpdateDate>
  <version>1.1</version>
  <title>SaveProjectHandler</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity wwiki="false"}}
{{html wiki="false" clean="false"}}
#set ($_service = $services.projects)
#set ($discard = $response.setContentType('application/json'))
#set ($project = $_service.getProjectById($request.projectId))
#if ("$!{request.xaction}" == 'get')
  #set ($data = {})
  #set ($observers = [])
  #set ($contributors = [])
  #set ($leaders = [])
  #set ($templates = [])
  ##
  #if ($project)
    #set ($rawCollaborators = $project.getCollaborators())
    ##
    ## Format collaborators for UI side
    #foreach ($c in $rawCollaborators)
      #set ($collaborator = {})
      #set ($userDoc = $!{xwiki.getDocument($c.user)})
      #set ($discard = $collaborator.put('id', $c.user.toString()))
      #set ($discard = $collaborator.put('type', $c.type))
      #if ($c.isUser())
        #set ($discard = $collaborator.put('name', $xwiki.getUserName("${c.user}", false)))
      #else
        #set ($discard = $collaborator.put('name', "$!{userDoc.plainTitle}"))
      #end
      #set ($icon = "$!{userDoc.getObject('XWiki.XWikiUsers').getProperty('avatar').value}")
      #if ($icon != "" &amp;&amp; !$icon.toLowerCase().contains('@noavatargroup.png') &amp;&amp; !$icon.toLowerCase().contains('@noavatar.png'))
        #set ($discard = $collaborator.put('icon', "$!{userDoc.getAttachmentURL($icon, 'download', 'width=80&amp;height=80&amp;keepAspectRatio=true')}"))
      #else
        #set ($discard = $collaborator.put('icon', "$!{xwiki.getSkinFile('icons/xwiki/noavatar.png', true)}"))
      #end
      #if ($c.accessLevel.name == "leader")
        #set ($discard = $collaborator.put('email', "$!{userDoc.getObject('XWiki.XWikiUsers').getProperty('email').value}"))
        #set ($discard = $collaborator.put('comment', "$!{userDoc.getObject('XWiki.XWikiUsers').getProperty('comment').value}"))
        #set ($discard = $collaborator.put('link', $xwiki.getURL($userDoc)))

        #set ($discard = $leaders.add($collaborator))
      #elseif ($c.accessLevel.name == "observer")
        #set ($discard = $observers.add($collaborator))
      #else
        #set ($discard = $contributors.add($collaborator))
      #end
    #end
    ##
    #set ($rawTempaltes = $project.getTemplates())
      #foreach ($t in $rawTempaltes)
      #set ($template = {})
      #set ($discard = $template.put('id', $t.id))
      #set ($discard = $template.put('value', $t.name))
      #set ($discard = $templates.add($template))
    #end
  #end
  #set ($discard = $data.put('observers', $observers))
  #set ($discard = $data.put('contributors', $contributors))
  #set ($discard = $data.put('leaders', $leaders))
  #set ($discard = $data.put('templates', $templates))
  ##
  $jsontool.serialize($data)
#elseif ("$!{request.xaction}" == 'update')
  #set ($collaborators = $request.getParameterValues('collaborators'))
  #set ($discard = $_service.setCollaboratorsInProject($collaborators, $project))
  ##
  #set ($templateIds = [])
  #foreach ($id in $request.getParameterValues('templates'))
    #set ($discard = $templateIds.add($id))
  #end
  #set ($discard = $project.setTemplates($templateIds))
#end
{{/velocity}}</content>
</xwikidoc>
